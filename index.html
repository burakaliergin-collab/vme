<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Verb Matrix â€” v2.9.2 (Final GÃ¼ncelleme)</title>

<link rel="icon" href="favicon.ico" type="image/x-icon">

<link rel="manifest" href="manifest.json"> 

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#667eea">

<style>
  /* --- Genel --- */
  *{box-sizing:border-box;margin:0;padding:0}
  body{font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); min-height:100vh;padding:18px; transition: background .25s,color .25s;}
  .container{max-width:1200px;margin:0 auto;background:#fff;border-radius:16px;padding:28px;box-shadow:0 18px 50px rgba(0,0,0,.18);transition:background .25s,color .25s}
  header{text-align:center;margin-bottom:18px}
  .subtitle{color:#6b7280;margin-top:6px}
   
  /* BÃ¶lÃ¼m BaÅŸlÄ±ÄŸÄ± */
  .section-title{font-size:1.25rem;color:#2d3748;margin:16px 0 10px;padding-bottom:8px;border-bottom:3px solid #667eea;font-weight:700}
   
  /* MODU SEÃ‡ iÃ§in bÃ¼yÃ¼k, ortalanmÄ±ÅŸ stil */
  .large-centered-title {
    text-align: center;
    font-size: 2.5rem; 
    color: #2d3748;
    font-weight: 800;
    margin: 24px 0;
    text-transform: uppercase;
  }
   
  .button-grid{display:grid;gap:12px;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));margin:12px 0}
   
  /* GRUP SEÃ‡Ä°M BAÅLIKLARI */
  .group-select-header { text-align: center; margin-bottom: 24px; padding-top: 18px; }
  .group-select-header h2 { font-size: 2.5rem; color: #2d3748; font-weight: 800; letter-spacing: 2px; margin-bottom: 18px; }
  .group-select-columns { display: flex; justify-content: space-between; margin-bottom: 12px; }
  .group-column-title { font-size: 1.4rem; color: #2d3748; font-weight: 700; display: inline-block; padding: 0 10px 8px; border-bottom: 3px solid #667eea; }
   
  /* --- GENEL BUTON STÄ°LLERÄ° --- */
  .btn{padding:10px 14px;border-radius:10px;border:0;font-weight:700;cursor:pointer; color:#fff}
  .btn-small{padding:8px 10px;font-size:.9rem}
   
  /* YENÄ°: PASTEL RENKLER VE BUTON STANDARTLAÅTIRMASI */
  .btn-danger {
    background: #f56565; /* KÄ±rmÄ±zÄ± kalacak */
    color: #fff;
  }
  .btn-danger:hover { background: #e53e3e; }

  /* PASTEL RENKLER (TÃ¼m ana menÃ¼ ve pastel aksiyon butonlarÄ±) */
  .btn-pastel, .btn-primary, .btn-secondary, .btn-info, .btn-warning {
    background: #aeb4c5; /* Pastel Gri/Mavi */
    color: #1e293b;
    border: 0;
  }
  .btn-pastel:hover, .btn-primary:hover, .btn-secondary:hover, .btn-info:hover, .btn-warning:hover {
    background: #949daf;
  }
   
  /* Ã‡alÄ±ÅŸma SayfasÄ± Buton Gridi */
  .button-grid-learning { 
      display: grid; 
      gap: 8px; 
      grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); 
      margin-top: 15px; 
      text-align: center;
  }
  .button-grid-learning .btn {
      min-width: 130px; /* ButonlarÄ±n aynÄ± boyutta olmasÄ±nÄ± saÄŸlar */
      padding: 10px 8px; 
      font-size: 0.9rem;
      font-weight: 700;
  }
   
  .btn.disabled, .btn:disabled{background:#cbd5e1;color:#718096;cursor:not-allowed;opacity:0.7}
   
  .hidden { display: none; }
   
  .view{display:none}
  .view.active{display:block;animation:slideIn .18s ease}
  @keyframes slideIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
   
  .group-story-grid { display: grid; gap: 12px; grid-template-columns: 1fr 1fr; }
  .button-group-row { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 12px; }

  /* YENÄ°: SRS Kontrol ButonlarÄ± */
  #srsControls {
      display: none; 
      justify-content: space-around;
      margin-top: 15px;
  }
  #srsControls .btn {
      flex: 1;
      margin: 0 5px;
  }

  .mode-toggle{position:fixed;right:18px;top:18px;border-radius:50%;padding:10px;border:0;background:#fff;cursor:pointer;box-shadow:0 10px 28px rgba(0,0,0,.12);z-index:1200}
  .lang-btn{padding:8px 12px;border-radius:8px;border:2px solid #667eea;background:#fff;color:#667eea;cursor:pointer}
  .lang-btn.active{background:#667eea;color:#fff}
  .score-display{font-size:1.6rem;font-weight:800;color:#667eea;text-align:center;margin:12px 0}
  .small-muted{color:#6b7280;font-size:.9rem}
  .toggle-hint-btn{padding:8px 10px;border-radius:8px;border:0;background:#34495e;color:#fff;cursor:pointer}
  .content-box{background:#f9fafb;padding:16px;border-radius:12px;margin:12px 0;border-left:5px solid #667eea}
  .input-field{width:100%;padding:10px;border-radius:8px;border:2px solid #e5e7eb;margin-top:8px;font-size:1rem;background:#fff;color:#0f1724}
  .select-field{width:100%;padding:10px;border-radius:8px;border:2px solid #e5e7eb;background:#fff;color:#0f1724}
  .progress-container{margin:12px 0}
  .progress-bar{height:28px;background:#e6eefc;border-radius:14px;overflow:hidden}
  .progress-fill{height:100%;background:linear-gradient(90deg,#667eea,#764ba2);width:0;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:800; transition: width .2s;}
   
  /* Ã–ÄŸrenme iÃ§eriÄŸi ortalandÄ± ve bÃ¼yÃ¼tÃ¼ldÃ¼ */
  .sentence{padding:12px;border-radius:8px;background:#fff;border-left:4px solid #667eea;margin:10px 0;font-weight:700;color:#0f1724; text-align: center;}
   
  #learningContent .sentence { font-size: 1.6rem; line-height: 1.4; }
  #learningContent #answerDisplay.sentence { font-size: 1.3rem; line-height: 1.4; background: #f0f4f8; }
   
  /* YENÄ°: Kelime SÄ±ralama (WordOrder) Modunda dikey sÄ±ralama iÃ§in flex-direction column kullanÄ±ldÄ± */
  .word-order-area {
    display: flex;
    flex-direction: column; /* Yan yana deÄŸil, alt alta sÄ±rala */
    gap: 12px;
    flex-wrap: nowrap; /* SarÄ±lmayÄ± engelle */
    justify-content: center;
    align-items: center; /* Merkezi ortala */
    padding: 10px 0;
  }
  .word-pool, .word-selected {
    width: 95%; /* Tam geniÅŸlik kullan */
    min-width: 95%;
    text-align: center;
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 8px;
  }
   
  .word-item{display:inline-block;padding:8px 12px;border-radius:8px;background:#667eea;color:#fff;margin:6px;cursor:pointer;user-select:none}
  .word-item.top{background:#10b981}
  .word-item.disabled{background:#cbd5e1;color:#2d3748;cursor:not-allowed}
  .hint-area{margin-top:10px}
  .hint-item{background:#e6f3ff;padding:10px;border-left:4px solid #4299e1;border-radius:8px;margin:8px 0;color:#0f1724}
  .result{padding:10px;border-radius:8px;margin:8px 0;font-weight:700}
  .result.correct{background:#c6f6d5;color:#22543d;border-left:4px solid #48bb78}
  .result.incorrect{background:#fed7d7;color:#742a2a;border-left:4px solid #f56565}
   
  /* GECE MODU */
  body.night-mode{background:linear-gradient(135deg,#0f1724 0%,#071226 100%);color:#e6eef8}
  body.night-mode .container{background:#071226;color:#e6eef8;box-shadow:none}
  body.night-mode .section-title{border-bottom-color:#3b82f6;color:#e6eef8}
  body.night-mode .large-centered-title{color: #e6eef8;} 
  body.night-mode .group-column-title{color: #e6eef8;border-bottom-color: #3b82f6;}
  body.night-mode .content-box{background:#071831;border-left-color:#3b82f6}
  body.night-mode .input-field,.night-mode .select-field{background:#041226;color:#e6eef8;border-color:#082036}
  body.night-mode .sentence{background:#071226;color:#e6eef8;border-left-color:#3b82f6}
  body.night-mode #learningContent #answerDisplay.sentence { background: #0f2742; }
  body.night-mode .word-item{background:#3b82f6;color:#fff}
  body.night-mode .word-item.top{background:#10b981}
  body.night-mode .hint-item{background:#052033;color:#c8ecff;border-left-color:#3b82f6}
   
  /* GECE MODU PASTEL RENKLER */
  body.night-mode .btn-pastel, body.night-mode .btn-primary, body.night-mode .btn-secondary, body.night-mode .btn-info, body.night-mode .btn-warning {
    background: #334155; 
    color: #e2e8f0; 
  }
  body.night-mode .btn-pastel:hover, body.night-mode .btn-primary:hover, body.night-mode .btn-secondary:hover, body.night-mode .btn-info:hover, body.night-mode .btn-warning:hover {
    background: #475569;
  }

  body.night-mode .btn.disabled, body.night-mode .btn:disabled {background:#1f2937;color:#4b5563;}
  body.night-mode .toggle-hint-btn{ background:#1f2937 }
  body.night-mode .group-story-grid .btn .small-muted { color: #9ca3af; }
   
  @media(max-width:768px){.container{padding:14px}}

  /* --- MÃ¼zik Ã‡alar Stilleri --- */
  .music-player-container {
    position: fixed;
    left: 18px;
    top: 18px;
    z-index: 1200;
    background: rgba(255, 255, 255, 0.9);
    border-radius: 25px;
    padding: 5px;
    box-shadow: 0 5px 15px rgba(0, 0, 0, .1);
    display: flex;
    align-items: center;
    transition: background .25s;
  }
  .music-toggle-btn {
    border: 0;
    background: #667eea;
    color: #fff;
    border-radius: 50%;
    width: 38px;
    height: 38px;
    font-size: 1.2rem;
    cursor: pointer;
    z-index: 2;
  }
  .music-volume-slider {
    display: none; 
    margin-left: 8px;
    margin-right: 10px;
    width: 80px;
    vertical-align: middle;
    z-index: 1;
    transition: opacity 0.3s;
  }
  .music-player-container:hover .music-volume-slider {
    display: inline-block;
  }
  body.night-mode .music-player-container {
    background: rgba(31, 41, 55, 0.9); 
  }
  body.night-mode .music-toggle-btn {
    background: #3b82f6;
  }
</style>
</head>
<body>
<button id="modeToggleBtn" class="mode-toggle" title="Gece/GÃ¼ndÃ¼z toggle">ğŸŒ™</button>

<div id="musicPlayerContainer" class="music-player-container">
    <button id="musicToggleBtn" class="music-toggle-btn" title="MÃ¼zik Ã‡al/Durdur">ğŸ”Š</button>
    <input type="range" id="musicVolumeSlider" min="0" max="100" value="70" class="music-volume-slider" style="display: none;">
</div>
<div class="container">
  <header>
    <img src="logo.png" alt="Verb Matrix Logo" style="max-width: 280px; height: auto; margin: 10px auto 0; display: block;">
    <div class="subtitle" id="appSubtitle" data-translate-key="app.subtitle">Fiiller Ä°le Almanca Ã–ÄŸrenme Platformu</div>
  </header>

  <div id="mainMenu" class="view active">
    <div class="button-grid">
      <button class="btn btn-primary" id="btnGroupSelect" data-translate-key="menu.start" onclick="loadAndShowGroupMenu()">ğŸ BAÅLA</button>
      <button class="btn btn-info" onclick="showView('settings')" data-translate-key="menu.settings">âš™ï¸ Ayarlar</button>
      <button class="btn btn-secondary" onclick="showView('progress')" data-translate-key="menu.progress">ğŸ“Š Ä°lerleme</button>
      <button class="btn btn-warning" onclick="showView('adminView')" data-translate-key="menu.admin">ğŸ”§ YÃ¶netici (Admin)</button>
    </div>
  </div>

  <div id="groupMenu" class="view">
    <div class="group-select-header">
      <h2 data-translate-key="titles.start">BAÅLA</h2>
    </div>
    <div class="group-select-columns">
      <div class="group-column-title-container">
        <div class="group-column-title" data-translate-key="titles.groupSelect">Fiil SeÃ§</div>
      </div>
      <div class="group-column-title-container">
        <div class="group-column-title" data-translate-key="titles.storySelect">Hikaye SeÃ§</div>
      </div>
    </div>
    <div id="groupButtons"></div>
    <div class="button-group-row">
      <button class="btn btn-danger btn-small" onclick="showView('mainMenu')" data-translate-key="buttons.mainMenu">â† Ana MenÃ¼</button>
    </div>
  </div>

  <div id="verbMenu" class="view">
    <h2 class="section-title" data-translate-key="titles.verbSelect">FÄ°Ä°L SEÃ‡</h2>
    <div id="verbButtons" class="button-grid"></div>
    <div class="button-group-row">
      <button class="btn btn-danger btn-small" onclick="showView('groupMenu')" data-translate-key="buttons.goBack">â† Geri</button>
    </div>
  </div>

  <div id="sectionMenu" class="view">
    <h2 class="section-title" data-translate-key="titles.sectionSelect">BÃ–LÃœM SEÃ‡</h2>
    <div id="sectionButtons" class="button-grid"></div>
    <div class="button-group-row">
      <button class="btn btn-danger btn-small" onclick="showView('verbMenu')" data-translate-key="buttons.goBack">â† Geri</button>
    </div>
  </div>

  <div id="modeMenu" class="view">
    <h2 class="large-centered-title" data-translate-key="titles.modeSelect">MODU SEÃ‡</h2>
    
    <div class="content-box" style="margin-bottom: 20px;">
      <h4 style="margin-bottom: 10px;">Ã‡eviri YÃ¶nÃ¼nÃ¼ SeÃ§in:</h4>
      <div class="button-group-row">
        <button class="btn btn-primary" id="modeTRDE" onclick="setConversionMode('tr-de')">ğŸ‡¹ğŸ‡· TR â†’ DE ğŸ‡©ğŸ‡ª</button>
        <button class="btn btn-info" id="modeDETR" onclick="setConversionMode('de-tr')">ğŸ‡©ğŸ‡ª DE â†’ TR ğŸ‡¹ğŸ‡·</button>
      </div>
    </div>

    <div id="modeButtons" class="button-grid"></div>
    <div class="button-group-row">
      <button class="btn btn-danger btn-small" onclick="showView('sectionMenu')" data-translate-key="buttons.goBack">â† Geri</button>
    </div>
  </div>

  <div id="learningView" class="view">
    <h2 class="section-title" id="learningTitle" data-translate-key="titles.learning">Ã‡alÄ±ÅŸma</h2>

    <div class="progress-container">
      <div class="progress-bar"><div id="progressFill" class="progress-fill">0%</div></div>
      <div style="text-align:center;margin-top:8px;font-weight:700;"><span id="progressText">0 / 0</span></div>
    </div>

    <div class="content-box">
      <div id="learningContent"></div>
      <div id="hintPanel" class="hint-area" style="display:none"></div>
      <div id="resultArea"></div>
      <div id="answerArea"></div>
    </div>

    <div id="srsControls" class="button-group-row">
        <button class="btn btn-danger" onclick="rateCard('hard')">Zor (5dk)</button>
        <button class="btn btn-warning" onclick="rateCard('medium')">Normal (20dk)</button>
        <button class="btn btn-secondary" onclick="rateCard('good')">Ä°yi (1saat)</button>
        <button class="btn btn-primary" onclick="rateCard('easy')">Ã‡ok Ä°yi (1gÃ¼n)</button>
    </div>

    <div id="quickEditPanel" class="content-box" style="display:none; margin-top: 15px;">
        <h4 id="quickEditTitle" style="margin-bottom: 10px;">Sayfa Ä°Ã§eriÄŸi HÄ±zlÄ± DÃ¼zenleme</h4>
        <label style="display:block;margin-top:12px;">TR CÃ¼mle:</label><textarea id="qe_tr" class="input-field" rows="3"></textarea>
        <label style="display:block;margin-top:12px;">DE CÃ¼mle:</label><textarea id="qe_de" class="input-field" rows="3"></textarea>
        <label style="display:block;margin-top:12px;">CÃ¼mle Ä°pucu:</label><textarea id="qe_hint" class="input-field" rows="3" placeholder="Bu cÃ¼mleye Ã¶zel ipucu ekleyin/dÃ¼zenleyin."></textarea>
        <div class="button-group-row">
            <button class="btn btn-secondary" onclick="saveQuickEdit()">âœ… Kaydet & Kapat</button>
            <button class="btn btn-danger" onclick="document.getElementById('quickEditPanel').style.display='none'">Ä°ptal</button>
        </div>
    </div>

    <div class="button-grid-learning">
      <button class="btn btn-pastel" id="actionBtn" data-translate-key="buttons.show" onclick="handleAction()">Kontrol Et / GÃ¶ster</button>
      <button class="btn btn-pastel" id="toggleHintBtn" data-translate-key="buttons.hintToggle" onclick="toggleHintPanel()">Ä°puÃ§larÄ± AÃ§ / Kapat</button>
      <button class="btn btn-pastel" id="btnQuickEdit" onclick="showQuickEditPanel()">âœï¸ DÃ¼zelt/Ekle</button>
      <button class="btn btn-danger" onclick="resetLearning()" data-translate-key="buttons.reset">BaÅŸa DÃ¶n</button>
      
      <button class="btn btn-pastel" id="slowModeToggleBtn" onclick="toggleSpeechSpeed()">ğŸ”Š YavaÅŸ Mod</button>
      <button class="btn btn-pastel" id="pauseBtn" onclick="toggleSpeechPause()">â¸ï¸ Durdur</button>
      <button class="btn btn-pastel" id="btnPlayDE" data-translate-key="buttons.playDE" onclick="playCurrentSentence('de')">ğŸ”Š Almanca Dinle</button>
      <button class="btn btn-pastel" id="btnPlayTR" data-translate-key="buttons.playTR" onclick="playCurrentSentence('tr')">ğŸ”Š TÃ¼rkÃ§e Dinle</button>
      
      <button class="btn btn-pastel" onclick="previousQuestion()" data-translate-key="buttons.previous">â† Ã–nceki</button>
      <button class="btn btn-danger" onclick="showView('modeMenu')" data-translate-key="buttons.menuReturn">MenÃ¼ye DÃ¶n</button>
    </div>

  </div>

  <div id="storyView" class="view">
    <h2 class="section-title" id="storyTitle" data-translate-key="titles.story">Hikaye</h2>
    <div class="content-box" id="storyContent"></div>
    <div class="button-grid-learning"> <button class="btn btn-warning" onclick="showStoryQuestions()" data-translate-key="buttons.questions">ğŸ“ Sorular</button>
      
      <button class="btn btn-pastel" id="storySlowModeToggleBtn" onclick="toggleSpeechSpeed()">ğŸ”Š YavaÅŸ Mod</button>
      <button class="btn btn-pastel" id="storyPauseBtn" onclick="toggleSpeechPause()">â¸ï¸ Durdur</button>
      
      <button class="btn btn-pastel" id="btnPlayDE" data-translate-key="buttons.playDE" onclick="playStoryAudio('de')">ğŸ”Š Almanca Dinle</button>
      <button class="btn btn-pastel" onclick="playStoryAudio('tr')" data-translate-key="buttons.playTR">ğŸ”Š TÃ¼rkÃ§e Dinle</button>
      <button class="btn btn-danger" onclick="showView('groupMenu')" data-translate-key="buttons.groupMenuReturn">â† Grup MenÃ¼sÃ¼ne DÃ¶n</button>
    </div>
  </div>

  <div id="storyQuestionsView" class="view">
    <h2 class="section-title" id="storyQuestionsTitle" data-translate-key="titles.storyQuestions">Hikaye SorularÄ±</h2>
    <div class="content-box" id="storyQuestionsContent"></div>
    <div class="button-group-row">
      <button class="btn btn-danger btn-small" onclick="showView('storyView')" data-translate-key="buttons.storyReturn">â† Hikayeye DÃ¶n</button>
    </div>
  </div>
  
  <div id="settings" class="view">
    <h2 class="section-title" data-translate-key="titles.settings">âš™ï¸ Ayarlar & Ä°Ã§erik YÃ¶netimi</h2>
    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:14px;">
      <div class="content-box">
        <h3 data-translate-key="settings.appearance">ğŸ¨ GÃ¶rÃ¼nÃ¼m ve Dil</h3>
        <label style="display:flex;align-items:center;gap:8px;margin-top:8px;">
          <input type="checkbox" id="nightModeToggle"> <span data-translate-key="settings.nightMode">Gece Modu</span>
        </label>
        <div style="margin-top:12px;">
          <label style="display:block;font-weight:700;margin-bottom:6px" data-translate-key="settings.language">Dil:</label>
          <div style="display:flex;gap:8px">
            <button class="lang-btn active" id="langTR" onclick="changeLanguage('tr', this)">TÃ¼rkÃ§e</button>
            <button class="lang-btn" id="langDE" onclick="changeLanguage('de', this)">Deutsch</button>
            <button class="lang-btn" id="langEN" onclick="changeLanguage('en', this)">English</button>
          </div>
        </div>
      </div>

      <div class="content-box">
        <h3 data-translate-key="settings.dataManagement">ğŸ’¾ Veri YÃ¶netimi</h3>
        <button class="btn btn-primary" style="width:100%;margin-bottom:8px" onclick="importData()" data-translate-key="buttons.importJSON">ğŸ“¥ JSON YÃ¼kle (Dosya)</button>
        <button class="btn btn-secondary" style="width:100%;margin-bottom:8px" onclick="exportData()" data-translate-key="buttons.exportJSON">ğŸ“¤ JSON Ä°ndir</button>
        <button class="btn btn-info" style="width:100%;margin-bottom:8px" onclick="debugData()" data-translate-key="buttons.debugJSON">ğŸ” JSON YapÄ±sÄ± Kontrol</button>
        <button class="btn btn-danger" style="width:100%" onclick="resetProgressStorage()" data-translate-key="buttons.resetProgress">Ä°lerlemeyi SÄ±fÄ±rla</button>
        <button class="btn btn-danger" style="width:100%;margin-top:8px;" onclick="resetContentOverride()" data-translate-key="buttons.resetOverride">âš ï¸ Ä°Ã§erik DÃ¼zeltmelerini SÄ±fÄ±rla</button>
        <button class="btn btn-danger" style="width:100%;margin-top:8px;" onclick="resetSrsData()" data-translate-key="buttons.resetSrs">âš ï¸ Ã‡alÄ±ÅŸma (SRS) Verisini SÄ±fÄ±rla</button>
      </div>
      
    </div>

    <div class="content-box" style="margin-top:12px">
      <h3 data-translate-key="settings.pasteJSONTitle">ğŸ“ JSON YapÄ±ÅŸtÄ±r (Dosya gÃ¶nderemeyen mobil kullanÄ±cÄ±lar iÃ§in)</h3>
      <p class="small-muted" data-translate-key="settings.pasteJSONDesc">JSON dosyanÄ±zÄ± buraya yapÄ±ÅŸtÄ±rabilirsiniz. (Uzun olabilir â€” iPhone/Android tarayÄ±cÄ±larÄ±nda kesme olmadan yapÄ±ÅŸtÄ±rÄ±n.)</p>
      <textarea id="jsonPaste" class="input-field" data-translate-key="placeholders.jsonPaste" placeholder="JSON iÃ§eriÄŸinizi buraya yapÄ±ÅŸtÄ±rÄ±n..." rows="10"></textarea>
      <div class="button-group-row" style="margin-top:8px">
        <button class="btn btn-primary" onclick="loadJsonFromTextarea()" data-translate-key="buttons.pasteAndLoad">ğŸ“¥ YapÄ±ÅŸtÄ±r & YÃ¼kle</button>
        <button class="btn btn-danger" onclick="document.getElementById('jsonPaste').value=''" data-translate-key="buttons.clear">Temizle</button>
      </div>
    </div>

    <div class="button-group-row" style="margin-top:12px">
      <button class="btn btn-danger btn-small" onclick="showView('mainMenu')" data-translate-key="buttons.mainMenu">â† Ana MenÃ¼</button>
    </div>
  </div>

  <div id="progress" class="view">
    <h2 class="section-title" data-translate-key="titles.progress">ğŸ“Š Ä°lerleme</h2>
    <div class="content-box" id="progressStats">
      <p class="small-muted" data-translate-key="messages.noProgress">HenÃ¼z ilerleme yok.</p>
    </div>
    <div class="button-group-row">
      <button class="btn btn-danger btn-small" onclick="showView('mainMenu')" data-translate-key="buttons.mainMenu">â† Ana MenÃ¼</button>
    </div>
  </div>

  <div id="adminView" class="view">
    <h2 class="section-title" data-translate-key="titles.adminPanel">ğŸ”§ YÃ¶netici Paneli</h2>
    <div class="button-grid">
      <button class="btn btn-primary" onclick="showView('adminContentView')" data-translate-key="admin.contentManagement">ğŸ“š Ä°Ã§erik YÃ¶netimi</button>
      <button class="btn btn-primary" onclick="showView('adminStoryView')" data-translate-key="admin.storyManagement">ğŸ“š Hikaye YÃ¶netimi</button>
      <button class="btn btn-primary" onclick="showView('adminHintView')" data-translate-key="admin.hintManagement">ğŸ’¡ Ä°pucu YÃ¶netimi</button>
      <button class="btn btn-primary" onclick="showView('adminSentenceListView')" data-translate-key="admin.listAllSentences">ğŸ“‹ TÃ¼m CÃ¼mleleri Listele</button>
    </div>
    <div class="button-group-row" style="margin-top:12px">
      <button class="btn btn-danger btn-small" onclick="showView('mainMenu')" data-translate-key="buttons.mainMenu">â† Ana MenÃ¼</button>
    </div>
  </div>

  <div id="adminContentView" class="view">
    <h2 class="section-title" data-translate-key="admin.contentManagement">ğŸ“š Ä°Ã§erik YÃ¶netimi</h2>
    <div class="content-box">
      
      <div style="margin-bottom:8px;">
        <button class="btn btn-primary" onclick="showAdminAddGroup()" data-translate-key="admin.addGroup">â• Grup Ekle</button>
        <button class="btn btn-info" onclick="showAdminAddVerb()" data-translate-key="admin.addVerb">â• Fiil Ekle</button>
        <button class="btn btn-secondary" onclick="showAdminEditSentence()" data-translate-key="admin.editSentence">âœï¸ CÃ¼mle DÃ¼zenle</button>
        <button class="btn btn-secondary" style="background-color:#10b981;" onclick="showTsvImporter()">ğŸ“Š Toplu CÃ¼mle YÃ¼kle</button>
      </div>
      
      <div id="adminContentArea"></div>

      <div id="adminTsvArea" class="content-box" style="display:none; margin-top: 15px; border-color: #10b981;">
          <h4>ğŸ“Š Toplu CÃ¼mle YÃ¼kleme (Excel'den Kopyala-YapÄ±ÅŸtÄ±r)</h4>
          <p class="small-muted">
            Excel veya Google E-Tablolar'da hazÄ±rladÄ±ÄŸÄ±nÄ±z veriyi buraya yapÄ±ÅŸtÄ±rÄ±n.<br>
            KullanmanÄ±z gereken sÃ¼tun sÄ±rasÄ± (BAÅLIK SATIRI OLMADAN):<br>
            <b>GrupID | FiilID | BÃ¶lÃ¼mNumarasÄ± | TR_CÃ¼mle | DE_CÃ¼mle | CÃ¼mleIpucu (Ä°steÄŸe baÄŸlÄ±)</b>
          </p>
          <textarea id="tsvPasteArea" class="input-field" rows="15" placeholder="GrupID (Tab) FiilID (Tab) BÃ¶lÃ¼mNo (Tab) TR CÃ¼mle (Tab) DE CÃ¼mle (Tab) Ä°pucu..."></textarea>
          <div class="button-group-row">
              <button class="btn btn-secondary" style="background-color:#10b981;" onclick="parseAndImportTsv()">âœ… YÃ¼kle ve Ä°ÅŸle</button>
              <button class="btn btn-danger" onclick="document.getElementById('adminTsvArea').style.display='none'">Ä°ptal</button>
          </div>
      </div>
      </div>
    <div class="button-group-row" style="margin-top:12px">
      <button class="btn btn-danger btn-small" onclick="showView('adminView')" data-translate-key="buttons.adminReturn">â† YÃ¶netici Paneline DÃ¶n</button>
    </div>
  </div>
  <div id="adminStoryView" class="view">
    <h2 class="section-title" data-translate-key="admin.storyManagement">ğŸ“š Hikaye YÃ¶netimi</h2>
    <div class="content-box">
      <div style="margin-bottom:8px;">
        <button class="btn btn-primary" onclick="showAdminAddStory()" data-translate-key="admin.addStory">â• Hikaye Ekle</button>
        <button class="btn btn-info" onclick="showAdminEditStory()" data-translate-key="admin.editStory">âœï¸ Hikaye DÃ¼zenle / Testler</button>
      </div>
      <div id="adminStoryArea"></div>
    </div>
    <div class="button-group-row" style="margin-top:12px">
      <button class="btn btn-danger btn-small" onclick="showView('adminView')" data-translate-key="buttons.adminReturn">â† YÃ¶netici Paneline DÃ¶n</button>
    </div>
  </div>
  <div id="adminHintView" class="view">
    <h2 class="section-title" data-translate-key="admin.hintManagement">ğŸ’¡ Ä°pucu YÃ¶netimi</h2>
    <div class="content-box" style="margin-bottom:12px">
      <h3 data-translate-key="admin.addNewHint">â• Yeni Ä°pucu Ekle</h3>
      <div class="button-group-row" style="display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn btn-info btn-small" onclick="showHintForm('sentence')" data-translate-key="admin.hintSentence">â• CÃ¼mle Ä°pucu</button>
        <button class="btn btn-info btn-small" onclick="showHintForm('verb')" data-translate-key="admin.hintVerb">â• Fiil Ä°pucu</button>
        <button class="btn btn-info btn-small" onclick="showHintForm('section')" data-translate-key="admin.hintSection">â• BÃ¶lÃ¼m Ä°pucu (B1, B2...)</button>
      </div>
      <div id="hintFormsArea" style="margin-top:12px"></div>
    </div>
    <div class="content-box">
      <h3 data-translate-key="admin.manageExistingHints">ğŸ“‹ Mevcut Ä°puÃ§larÄ±nÄ± YÃ¶net (DÃ¼zenle / Sil)</h3>
      <p class="small-muted" data-translate-key="admin.manageHintsDesc">Burada mevcut tÃ¼m ipuÃ§larÄ±nÄ± gÃ¶rebilir, dÃ¼zenleyebilir veya silebilirsiniz.</p>
      <div id="hintManagerArea" style="margin-top:12px"></div>
    </div>
    <div class="button-group-row" style="margin-top:12px">
      <button class="btn btn-danger btn-small" onclick="showView('adminView')" data-translate-key="buttons.adminReturn">â† YÃ¶netici Paneline DÃ¶n</button>
    </div>
  </div>
  <div id="adminSentenceListView" class="view">
    <h2 class="section-title" data-translate-key="admin.listAllSentences">ğŸ“‹ TÃ¼m CÃ¼mleleri Listele</h2>
    <div class="content-box">
      <div class="button-group-row" style="margin-bottom:8px;">
        <button class="btn btn-secondary" onclick="renderAllSentencesTable()" data-translate-key="buttons.refreshList">ğŸ”„ Yenile Liste</button>
        <button class="btn btn-warning" onclick="exportSentencesCsv()" data-translate-key="buttons.exportCSV">ğŸ“¤ CSV Ä°ndir (Tablo)</button>
      </div>
      <div id="allSentencesTable" style="max-height:60vh;overflow:auto"></div>
    </div>
    <div class="button-group-row" style="margin-top:12px">
      <button class="btn btn-danger btn-small" onclick="showView('adminView')" data-translate-key="buttons.adminReturn">â† YÃ¶netici Paneline DÃ¶n</button>
    </div>
  </div>


</div>

<input type="file" id="fileInput" accept=".json" style="display:none">

<script>
/* ===============================
    Verb Matrix â€” v2.9.3 (TTS GÃ¼ncellemesi)
    - Pastel butonlar, tek tip boyut ve hizalama uygulandÄ±.
    - TTS hÄ±z (YavaÅŸ/Normal) ve Durdurma/Oynatma (Pause) kontrolleri entegre.
    - Kelime SÄ±ralama (WordOrder) mantÄ±ÄŸÄ± DÄ°KEY sÄ±ralama iÃ§in dÃ¼zeltildi.
    - SRS AralÄ±klarÄ± revize edildi.
    - Ã‡alÄ±ÅŸma sayfalarÄ±nda logo gizlendi.
    - **TTS DÃ¼zeltmesi (v2.9.3): iOS/iPadOS'ta Shelly/DÃ¼ÅŸÃ¼k kaliteli ses yerine Anna/Markus gibi kaliteli sesleri bulmak iÃ§in geliÅŸmiÅŸ zorlama mantÄ±ÄŸÄ± ve onvoiceschanged entegrasyonu yapÄ±ldÄ±.**
    =============================== */

/* ---------------- Demo / default data (replace with your JSON) --------------- */
let data = {
  // Orijinal veriler (Uygulama ilk yÃ¼klendiÄŸinde hafÄ±zaya alÄ±nÄ±r. overrideData varsa geÃ§ersiz kÄ±lÄ±nÄ±r.)
  groups: [
    {
      id: "g1",
      name: "ALGI & Ä°LETÄ°ÅÄ°M",
      nameDE: "Wahrnehmung & Kommunikation",
      story: {
        title: "Maria und der Film",
        de: "Maria sieht einen interessanten Film im Fernsehen. Sie zeigt ihrem Bruder das neue Bild auf dem Bildschirm. Der Bruder hÃ¶rt aufmerksam zu und lÃ¤sselt. Am Ende sagen beide: 'Der Film war sehr spannend!'",
        tr: "Maria televizyonda ilginÃ§ bir film izliyor. Ekrandaki yeni gÃ¶rÃ¼ntÃ¼yÃ¼ kardeÅŸine gÃ¶steriyor. KardeÅŸi dikkatle dinliyor ve gÃ¼lÃ¼msÃ¼yor. Sonunda ikisi de diyor: 'Film Ã§ok heyecanlÄ±ydÄ±!'",
        quiz:[
          { q:"Maria ne izliyor?", options:["Bir film","Bir haber","Bir konser"], a:"Bir film" },
          { q:"KardeÅŸi ne yapÄ±yor?", options:["Uyuyor","Dinliyor","YazÄ±yor"], a:"Dinliyor" },
          { q:"Film hakkÄ±nda ne dÃ¼ÅŸÃ¼nÃ¼yorlar?", options:["SÄ±kÄ±cÄ±","HeyecanlÄ±","ÃœzÃ¼cÃ¼"], a:"HeyecanlÄ±" }
        ]
      }
    }
  ],
  verbs:{
    g1: [
      { id:'v1', verbTR:'gÃ¶stermek', verbDE:'zeigen' },
      { id:'v2', verbTR:'dinlemek', verbDE:'zuhÃ¶ren' }
    ]
  },
  content: {
    'v1_s1': [
      { tr:'Ben fotoÄŸrafÄ± gÃ¶steriyorum', de:'Ich zeige das Foto' },
      { tr:'Sen yolu gÃ¶steriyorsun', de:'Du zeigst den Weg' }
    ],
    'v1_s2': [
      { tr:'Bana yolu gÃ¶steriyor', de:'Er zeigt mir den Weg' }
    ],
    'v2_s1': [
      { tr:'Ben Ã¶ÄŸretmeni dinliyorum', de:'Ich hÃ¶re dem Lehrer zu' }
    ]
  },
  sections: {
    1: "KiÅŸi Zamiri",2: "Objektpronomen",3:"Singular Objekte",4:"Plural Objekte",
    5:"Imperative",6:"Adjektive",7:"Possessive",8:"W-Fragen",9:"Negation",10:"PrÃ¤positionen",
    11:"Adverbien",12:"Tenses",13:"Modalverben",14:"Akkusativ + Dativ"
  },
  sectionsHints: {
    "B1": "(KiÅŸi Zamiri): Fiiller kiÅŸi zamirleriyle Ã§ekimlenir (ich, du, er...)",
    "B2": "(Objektpronomen): Nesne zamirleri (mich, dich, ihm...)"
  },
  hints: {
    sentences: {},
    verbs: {},
    sections: {}
  },
  
  // GÃœNCELLENDÄ°: 'de' ve 'en' iÃ§in Ã¶rnek Ã§eviriler eklendi.
  translations: {
    tr: {
      app: { subtitle: 'Fiiller Ä°le Almanca Ã–ÄŸrenme Platformu' }, 
      menu: { 
        start: 'BAÅLA', 
        settings: 'âš™ï¸ Ayarlar', 
        progress: 'ğŸ“Š Ä°lerleme', 
        admin: 'ğŸ”§ YÃ¶netici (Admin)' 
      },
      titles: {
        start: 'BAÅLA', 
        groupSelect: 'Fiil SeÃ§', 
        storySelect: 'Hikaye SeÃ§', 
        verbSelect: 'FÄ°Ä°L SEÃ‡', 
        sectionSelect: 'BÃ–LÃœM SEÃ‡', 
        modeSelect: 'MODU SEÃ‡', 
        learning: 'Ã‡alÄ±ÅŸma', 
        story: 'Hikaye', 
        storyQuestions: 'Hikaye SorularÄ±',
        settings: 'âš™ï¸ Ayarlar & Ä°Ã§erik YÃ¶netimi', 
        progress: 'ğŸ“Š Ä°lerleme', 
        adminPanel: 'ğŸ”§ YÃ¶netici Paneli'
      },
      buttons: {
        mainMenu: 'â† Ana MenÃ¼', goBack: 'â† Geri', show: 'GÃ¶ster', next: 'â†’ Sonraki', check: 'Kontrol Et', start: 'BaÅŸla',
        previous: 'â† Ã–nceki', menuReturn: 'MenÃ¼ye DÃ¶n', reset: 'BaÅŸa DÃ¶n', hintToggle: 'Ä°puÃ§larÄ± AÃ§ / Kapat',
        questions: 'ğŸ“ Sorular', playDE: 'ğŸ”Š Almanca Dinle', playTR: 'ğŸ”Š TÃ¼rkÃ§e Dinle',
        groupMenuReturn: 'â† Grup MenÃ¼sÃ¼ne DÃ¶n', storyReturn: 'â† Hikayeye DÃ¶n', adminReturn: 'â† YÃ¶netici Paneline DÃ¶n',
        importJSON: 'ğŸ“¥ JSON YÃ¼kle (Dosya)', exportJSON: 'ğŸ“¤ JSON Ä°ndir', debugJSON: 'ğŸ” JSON YapÄ±sÄ± Kontrol',
        resetProgress: 'Ä°lerlemeyi SÄ±fÄ±rla (Quiz)', resetOverride: 'âš ï¸ Ä°Ã§erik DÃ¼zeltmelerini SÄ±fÄ±rla',
        resetSrs: 'âš ï¸ Ã‡alÄ±ÅŸma (SRS) Verisini SÄ±fÄ±rla',
        pasteAndLoad: 'ğŸ“¥ YapÄ±ÅŸtÄ±r & YÃ¼kle', clear: 'Temizle',
        refreshList: 'ğŸ”„ Yenile Liste', exportCSV: 'ğŸ“¤ CSV Ä°ndir (Tablo)',
        save: 'Kaydet', cancel: 'Ä°ptal', update: 'GÃ¼ncelle', add: 'Ekle', delete: 'Sil', edit: 'DÃ¼zenle',
        nextSection: 'â†’ Sonraki BÃ¶lÃ¼m' 
      },
      settings: {
        appearance: 'ğŸ¨ GÃ¶rÃ¼nÃ¼m ve Dil', nightMode: 'Gece Modu', language: 'Dil:',
        dataManagement: 'ğŸ’¾ Veri YÃ¶netimi',
        pasteJSONTitle: 'ğŸ“ JSON YapÄ±ÅŸtÄ±r (Dosya gÃ¶nderemeyen mobil kullanÄ±cÄ±lar iÃ§in)',
        pasteJSONDesc: 'JSON dosyanÄ±zÄ± buraya yapÄ±ÅŸtÄ±rabilirsiniz. (Uzun olabilir â€” iPhone/Android tarayÄ±cÄ±larÄ±nda kesme olmadan yapÄ±ÅŸtÄ±rÄ±n.)'
      },
      admin: {
        contentManagement: 'ğŸ“š Ä°Ã§erik YÃ¶netimi', storyManagement: 'ğŸ“š Hikaye YÃ¶netimi', hintManagement: 'ğŸ’¡ Ä°pucu YÃ¶netimi',
        listAllSentences: 'ğŸ“‹ TÃ¼m CÃ¼mleleri Listele', addGroup: 'â• Grup Ekle', addVerb: 'â• Fiil Ekle',
        editSentence: 'âœï¸ CÃ¼mle DÃ¼zenle', addStory: 'â• Hikaye Ekle', editStory: 'âœï¸ Hikaye DÃ¼zenle / Testler',
        addNewHint: 'â• Yeni Ä°pucu Ekle', hintSentence: 'â• CÃ¼mle Ä°pucu', hintVerb: 'â• Fiil Ä°pucu', hintSection: 'â• BÃ¶lÃ¼m Ä°pucu (B1, B2...)',
        manageExistingHints: 'ğŸ“‹ Mevcut Ä°puÃ§larÄ±nÄ± YÃ¶net (DÃ¼zenle / Sil)',
        manageHintsDesc: 'Burada mevcut tÃ¼m ipuÃ§larÄ±nÄ± gÃ¶rebilir, dÃ¼zenleyebilir veya silebilirsiniz.'
      },
      labels: {
        group: 'Grup:', verb: 'Fiil:', section: 'BÃ¶lÃ¼m:', sentence: 'CÃ¼mle:', index: 'Index:',
        hintText: 'Ä°pucu metni:', tr: 'TR:', de: 'DE:', title: 'BaÅŸlÄ±k:', deText: 'DE metin:', trText: 'TR metin:',
        groupID: 'Grup ID (Ã¶r: g5):', groupNameTR: 'Ad (TR):', groupNameDE: 'Ad (DE):',
        verbID: 'Fiil ID (Ã¶rn v10):', verbTR: 'Fiil TR:', verbDE: 'Fiil DE:',
        sectionCode: 'BÃ¶lÃ¼m Kodu (Ã¶rn: B1):', question: 'Soru:', options: 'SeÃ§enekler (virgÃ¼lle ayÄ±r):',
        correctAnswer: 'DoÄŸru cevap (tam metin):'
      },
      placeholders: {
        jsonPaste: 'JSON iÃ§eriÄŸinizi buraya yapÄ±ÅŸtÄ±rÄ±n...',
        notes: 'Notlar...',
        cloze: 'BoÅŸluÄŸu doldurun...',
        quiz: 'Ã‡eviriyi yazÄ±n...' 
      },
      messages: {
        noGroups: 'HenÃ¼z grup yok. JSON yÃ¼kleyin.',
        noVerbs: 'Bu grupta fiil bulunamadÄ±.',
        noSentences: 'Bu fiil ve bÃ¶lÃ¼m iÃ§in cÃ¼mle bulunamadÄ±!',
        noDueCards: 'BugÃ¼n iÃ§in tekrar edilecek kart kalmadÄ±! ğŸ‰',
        noStory: 'Bu grup iÃ§in hikaye bulunamadÄ±!',
        noStoryAvailable: 'Hikaye Yok',
        noStoryQuestions: 'Bu hikaye iÃ§in henÃ¼z soru yok.',
        noProgress: 'HenÃ¼z quiz ilerlemesi yok.',
        noHints: 'Yok',
        noStoryFound: 'Hikaye bulunamadÄ±',
        ttsNotSupported: 'TarayÄ±cÄ± TTS desteklemiyor.',
        dataLoaded: 'âœ“ Veriler yÃ¼klendi. Grup sayÄ±sÄ±:',
        invalidJSON: 'âœ— GeÃ§ersiz JSON formatÄ±. (groups, verbs, content gereklidir)',
        loadError: 'âœ— Hata:',
        dataExported: 'âœ“ Veriler indirildi!',
        progressReset: 'âœ“ Quiz ilerlemesi sÄ±fÄ±rlandÄ±',
        srsReset: 'âœ“ TÃ¼m Ã§alÄ±ÅŸma (SRS) verisi sÄ±fÄ±rlandÄ±.',
        jsonStatus: 'ğŸ“Š JSON DURUMU',
        allFieldsError: 'TÃ¼m alanlarÄ± doldurun',
        hintSaved: 'âœ… Ä°pucu kaydedildi',
        quickEditSaved: 'âœ… CÃ¼mle ve ipucu gÃ¼ncellendi (Yerel olarak kaydedildi)!',
        overrideReset: 'âœ… Ä°Ã§erik dÃ¼zeltmeleri silindi. Sayfa yenilendikten sonra varsayÄ±lan iÃ§eriÄŸe dÃ¶nÃ¼lecektir.'
      }
    },
    de: { // YENÄ°: Almanca Ã§eviriler eklendi
      app: { subtitle: 'Deutsch-Lernplattform mit Verben' },
      menu: { 
        start: 'START', 
        settings: 'âš™ï¸ Einstellungen', 
        progress: 'ğŸ“Š Fortschritt', 
        admin: 'ğŸ”§ Admin' 
      },
      titles: {
        start: 'START', 
        groupSelect: 'Verb wÃ¤hlen', 
        storySelect: 'Geschichte wÃ¤hlen',
        settings: 'âš™ï¸ Einstellungen & Inhaltsverwaltung',
        progress: 'ğŸ“Š Fortschritt',
        adminPanel: 'ğŸ”§ Admin-Panel'
      },
      buttons: {
        mainMenu: 'â† HauptmenÃ¼', goBack: 'â† ZurÃ¼ck', show: 'Zeigen', next: 'â†’ NÃ¤chste', check: 'PrÃ¼fen',
        playDE: 'ğŸ”Š Deutsch hÃ¶ren', playTR: 'ğŸ”Š TÃ¼rkisch hÃ¶ren',
        resetProgress: 'Fortschritt zurÃ¼cksetzen (Quiz)',
        resetSrs: 'âš ï¸ Lernfortschritt (SRS) zurÃ¼cksetzen'
      },
      settings: {
        appearance: 'ğŸ¨ Ansicht & Sprache', nightMode: 'Nachtmodus', language: 'Sprache:',
        dataManagement: 'ğŸ’¾ Datenverwaltung'
      }
      // NOT: DiÄŸer Ã§eviriler eksik, ancak bu kadarÄ± Ã§alÄ±ÅŸmasÄ± iÃ§in yeterli.
    },
    en: { // YENÄ°: Ä°ngilizce Ã§eviriler eklendi
        app: { subtitle: 'German Learning Platform with Verbs' },
        menu: { 
        start: 'START', 
        settings: 'âš™ï¸ Settings', 
        progress: 'ğŸ“Š Progress', 
        admin: 'ğŸ”§ Admin' 
      }
    }
  },
  settings:{ language:'tr', nightMode:false, conversionMode: 'tr-de' }
};

/* ---------------- State ---------------- */
let state = {
  currentView:'mainMenu',
  group:null, groupData:null,
  verb:null, section:null, mode:null,
  
  // --- SRS & Quiz State ---
  answers:[], 
  dueCards: [], 
  dueCardPos: 0, 

  showAnswer:false,
  wordPool:[], wordSelected:[], userAnswer:'', correctAnswer:'', showResult:false,
  hintPanelVisible: false,
  
  // YENÄ°: Ses HÄ±zÄ± KontrolÃ¼
  speechRate: 1.0, // 1.0 = Normal, 0.5 = YavaÅŸ
  isSpeaking: false 
};

/* ---------- YENÄ°: MÃ¼zik Ã‡alar MantÄ±ÄŸÄ± (HTML5 Audio) ---------- */
class MusicPlayer {
  constructor(streamUrl, volumeSliderId, toggleBtnId) {
    this.audio = new Audio(streamUrl);
    this.audio.crossOrigin = "anonymous";
    this.audio.loop = true; 

    this.isPlaying = false;
    this.currentVolume = 0.7; 
    this.dimmedVolume = 0.2;
    this.isDimmed = false;

    this.slider = document.getElementById(volumeSliderId);
    this.toggleBtn = document.getElementById(toggleBtnId);

    const savedVolume = parseFloat(localStorage.getItem('verbmatrix_music_volume')) || 0.7;
    this.currentVolume = savedVolume;
    this.audio.volume = this.currentVolume;
    if (this.slider) {
      this.slider.value = this.currentVolume * 100;
    }
  }

  toggleMusic() {
    if (this.isPlaying) {
      this.audio.pause();
      this.isPlaying = false;
      if (this.toggleBtn) this.toggleBtn.textContent = 'ğŸ”Š';
      console.log("MÃ¼zik duraklatÄ±ldÄ±.");
    } else {
      this.audio.load(); 
      
      this.audio.play().then(() => {
        this.isPlaying = true;
        if (this.toggleBtn) this.toggleBtn.textContent = 'â¸ï¸'; 
        console.log("MÃ¼zik Ã§alÄ±nÄ±yor.");
      }).catch(error => {
        console.error("MÃ¼zik Ã§alÄ±namadÄ±:", error);
        alert("MÃ¼zik dosyasÄ± yÃ¼klenemedi. (telifsiz-klasik.mp3 dosyasÄ±nÄ± kontrol edin.)");
      });
    }
  }

  setVolume(volumeValue) { 
    const newVolume = parseFloat(volumeValue) / 100;
    this.currentVolume = newVolume;
    
    if (!this.isDimmed) {
      this.audio.volume = this.currentVolume;
    }
    
    try {
      localStorage.setItem('verbmatrix_music_volume', this.currentVolume.toString());
    } catch (e) {}
  }

  dim_music(dim) {
    if (!this.isPlaying) return; 

    if (dim) {
      this.isDimmed = true;
      this.audio.volume = this.dimmedVolume;
      console.log("MÃ¼zik kÄ±sÄ±ldÄ± (dim).");
    } else {
      this.isDimmed = false;
      this.audio.volume = this.currentVolume; 
      console.log("MÃ¼zik normale dÃ¶ndÃ¼.");
    }
  }
}

let musicPlayer = null;

/* ---------- YENÄ°: HÄ±z ve Durdurma KontrolÃ¼ ---------- */
let speechUtterance = null; 

function toggleSpeechSpeed() {
    // GÃ¶rÃ¼nÃ¼r olan butonu bul
    const btnL = document.getElementById('slowModeToggleBtn');
    const btnS = document.getElementById('storySlowModeToggleBtn');
    const btn = btnL && btnL.offsetParent !== null ? btnL : btnS;
    
    if (!btn) return;

    // HÄ±zÄ± deÄŸiÅŸtir
    if (state.speechRate === 1.0) {
        state.speechRate = 0.5; // YavaÅŸ moda geÃ§
        btn.textContent = 'â–¶ï¸ Normal Mod';
        btn.classList.add('btn-warning');
        btn.classList.remove('btn-pastel');
        console.log("Sesli okuma hÄ±zÄ± YAVAÅ mod: 0.5");
    } else {
        state.speechRate = 1.0; // Normal moda geÃ§
        btn.textContent = 'ğŸ”Š YavaÅŸ Mod';
        btn.classList.remove('btn-warning');
        btn.classList.add('btn-pastel');
        console.log("Sesli okuma hÄ±zÄ± NORMAL mod: 1.0");
    }
    // HÄ±z deÄŸiÅŸtiÄŸinde aktif TTS varsa yeniden baÅŸlat
    if (speechUtterance && !speechSynthesis.paused) {
        speechSynthesis.cancel();
        speechSynthesis.speak(speechUtterance);
    }
}

function toggleSpeechPause() {
    if ('speechSynthesis' in window) {
        // GÃ¶rÃ¼nÃ¼r olan butonu bul
        const btnL = document.getElementById('pauseBtn');
        const btnS = document.getElementById('storyPauseBtn');
        const btn = btnL && btnL.offsetParent !== null ? btnL : btnS;

        if (!btn) return;
        
        if (speechSynthesis.paused) {
            speechSynthesis.resume();
            btn.textContent = 'â¸ï¸ Durdur';
            console.log("Sesli okuma devam ediyor.");
        } else {
            speechSynthesis.pause();
            btn.textContent = 'â–¶ï¸ Oynat';
            console.log("Sesli okuma duraklatÄ±ldÄ±.");
        }
    }
}

function resetSpeechButtons() {
    if ('speechSynthesis' in window) {
        window.speechSynthesis.cancel();
    }
    // Her iki pause butonunun metnini sÄ±fÄ±rla
    const pauseBtnL = document.getElementById('pauseBtn');
    const pauseBtnS = document.getElementById('storyPauseBtn');

    if (pauseBtnL) { pauseBtnL.textContent = 'â¸ï¸ Durdur'; }
    if (pauseBtnS) { pauseBtnS.textContent = 'â¸ï¸ Durdur'; }
}
/* ---------- HÄ±z ve Durdurma KontrolÃ¼ SONU ---------- */


/* ---------- SRS (AralÄ±klÄ± Tekrar) YardÄ±mcÄ± FonksiyonlarÄ± ---------- */

const MINUTE_MS = 60 * 1000;
const DAY_MS = 24 * 60 * MINUTE_MS;
const HOUR_MS = 60 * MINUTE_MS;

let srsData = {};

function getSrsKey(originalIndex) {
    return `${state.verb}_s${state.section}_${originalIndex}`;
}

function loadSrsData() {
    try {
        const data = localStorage.getItem('verbmatrix_srs_data');
        srsData = data ? JSON.parse(data) : {};
    } catch (e) {
        console.error("SRS verisi yÃ¼klenemedi", e);
        srsData = {};
    }
}

function saveSrsData() {
    try {
        localStorage.setItem('verbmatrix_srs_data', JSON.stringify(srsData));
    } catch (e) {
        console.error("SRS verisi kaydedilemedi", e);
    }
}

function getCardSrsData(originalIndex) {
    const key = getSrsKey(originalIndex);
    if (!srsData[key]) {
        srsData[key] = {
            interval: 0, 
            ease: 2.5,   
            nextReview: Date.now() 
        };
    }
    return srsData[key];
}

function updateCardSrsData(originalIndex, difficulty) {
    const cardData = getCardSrsData(originalIndex);
    let newInterval;
    const now = Date.now();

    // SRS AralÄ±klarÄ± revize edildi: Zor (5dk), Normal (20dk), Ä°yi (1saat), Ã‡ok Ä°yi (1gÃ¼n)
    if (difficulty === 'hard') {
        newInterval = 5 * MINUTE_MS; // 5 dakika
    } else if (difficulty === 'medium') {
        newInterval = 20 * MINUTE_MS; // 20 dakika
    } else if (difficulty === 'good') { 
        newInterval = 1 * HOUR_MS; // 1 saat
    } else { // 'easy'
        newInterval = 1 * DAY_MS; // 1 gÃ¼n
    }

    cardData.interval = newInterval;
    cardData.nextReview = now + newInterval;
    
    saveSrsData(); 
}

function resetSrsData() {
    const t = (data.translations[data.settings.language || 'tr'] && Object.keys(data.translations[data.settings.language || 'tr']).length > 0) ? data.translations[data.settings.language || 'tr'] : data.translations.tr;
    if (confirm(t.messages.srsResetConfirm || 'TÃ¼m Ã§alÄ±ÅŸma (AralÄ±klÄ± Tekrar) verilerinizi sÄ±fÄ±rlamak istediÄŸinizden emin misiniz? TÃ¼m kartlarÄ±n ilerlemesi sÄ±fÄ±rlanacaktÄ±r.')) {
        srsData = {};
        saveSrsData();
        alert(t.messages.srsReset);
    }
}


/* ---------- Content Override FonksiyonlarÄ± ---------- */

function loadDataOverride() {
    try {
        const override = localStorage.getItem('verbmatrix_content_override');
        if (override) {
            const overrideData = JSON.parse(override);
            data = deepMerge(data, overrideData);
            console.log('âœ… Yerel iÃ§erik dÃ¼zeltmeleri yÃ¼klendi (Override aktif).');
        }
    } catch (e) {
        console.error("Yerel iÃ§erik dÃ¼zeltmeleri yÃ¼klenirken hata:", e);
        localStorage.removeItem('verbmatrix_content_override');
    }
}

function saveDataOverride() {
    const contentToSave = {
        groups: data.groups,
        verbs: data.verbs,
        content: data.content,
        sections: data.sections,
        sectionsHints: data.sectionsHints,
        hints: data.hints
    };
    try {
        localStorage.setItem('verbmatrix_content_override', JSON.stringify(contentToSave));
        console.log('âœ… Ä°Ã§erik gÃ¼ncellendi ve yerel olarak kaydedildi.');
    } catch (e) {
        console.error("Ä°Ã§erik depolanamadÄ±:", e);
    }
}

function resetContentOverride() {
    const t = (data.translations[data.settings.language || 'tr'] && Object.keys(data.translations[data.settings.language || 'tr']).length > 0) ? data.translations[data.settings.language || 'tr'] : data.translations.tr;
    if (confirm(t.messages.overrideResetConfirm || 'TÃ¼m yerel iÃ§erik dÃ¼zeltmelerini silmek istediÄŸinizden emin misiniz? Uygulama varsayÄ±lan HTML iÃ§eriÄŸine dÃ¶necektir.')) {
        localStorage.removeItem('verbmatrix_content_override');
        alert(t.messages.overrideReset);
        window.location.reload(); 
    }
}

/* -------------------------------------------------------------------------- */

/* ---------- Conversion Mode FonksiyonlarÄ± ---------- */

function setConversionMode(mode) {
    data.settings.conversionMode = mode;
    saveSettings(); 
    updateConversionButtons();
}

function updateConversionButtons() {
    const trdeBtn = document.getElementById('modeTRDE');
    const detrBtn = document.getElementById('modeDETR');
    
    if (!trdeBtn || !detrBtn) return;
    
    if (data.settings.conversionMode === 'tr-de') {
        trdeBtn.classList.add('btn-primary');
        detrBtn.classList.remove('btn-primary');
    } else {
        trdeBtn.classList.remove('btn-primary');
        detrBtn.classList.add('btn-primary');
    }
}

/* -------------------------------------------------------- */


function showView(id){
  document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
  const el = document.getElementById(id);
  if(el) el.classList.add('active');
  state.currentView = id;
  
  // YENÄ°: Ã‡alÄ±ÅŸma/Hikaye modlarÄ±nda logoyu gizle
  const headerEl = document.querySelector('.container > header');
  const hideLogo = ['learningView', 'storyView', 'storyQuestionsView'].includes(id);
  if (headerEl) {
      headerEl.style.display = hideLogo ? 'none' : 'block';
  }

  resetSpeechButtons(); 

  if(id === 'modeMenu') { 
      updateConversionButtons();
  }
  if(id === 'adminContentView'){
    document.getElementById('adminTsvArea').style.display = 'none'; 
    document.getElementById('adminContentArea').innerHTML = '';
  }
  if(id === 'adminHintView'){
    showHintManager('hintManagerArea'); 
    document.getElementById('hintFormsArea').innerHTML = ''; 
  }
  if(id === 'adminSentenceListView'){
    renderAllSentencesTable(); 
  }
  if(id === 'progress') {
    loadProgressView();
  }
}

function getProperty(obj, keyString) {
  if (!keyString) return null;
  return keyString.split('.').reduce((acc, key) => (acc && acc[key] !== undefined) ? acc[key] : null, obj);
}

function updateUITexts(){
  const lang = data.settings.language || 'tr';
  
  const t = (data.translations[lang] && Object.keys(data.translations[lang]).length > 0) 
            ? data.translations[lang] 
            : data.translations.tr;

  document.querySelectorAll('[data-translate-key]').forEach(el => {
    const key = el.dataset.translateKey;
    const translation = getProperty(t, key);
    
    if (translation) {
      if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
        if (el.placeholder !== undefined) el.placeholder = translation;
      } else {
        el.textContent = translation;
      }
    } else {
      console.warn(`Translation key not found: ${key} for lang: ${lang}`);
    }
  });
}


function changeLanguage(lang, btnEl){
  data.settings.language = lang;
  document.querySelectorAll('.lang-btn').forEach(b=>b.classList.remove('active'));
  if(btnEl) btnEl.classList.add('active');
  updateUITexts();
  saveSettings();
}

function toggleNightMode(){
  const body = document.body;
  const on = body.classList.toggle('night-mode');
  data.settings.nightMode = on;
  const toggleCheckbox = document.getElementById('nightModeToggle');
  if(toggleCheckbox) toggleCheckbox.checked = on;
  saveSettings();
}

function saveSettings(){ try{ localStorage.setItem('verbmatrix_settings', JSON.stringify(data.settings)); }catch(e){} }
function loadSettings(){
  try{
    const s = JSON.parse(localStorage.getItem('verbmatrix_settings')||'{}');
    if(s.language) data.settings.language = s.language;
    if(typeof s.nightMode === 'boolean') data.settings.nightMode = s.nightMode;
    if(s.conversionMode) data.settings.conversionMode = s.conversionMode; 
  }catch(e){}
  const toggleCheckbox = document.getElementById('nightModeToggle');
  if(toggleCheckbox) {
      toggleCheckbox.checked = !!data.settings.nightMode;
  }
  if(data.settings.nightMode) document.body.classList.add('night-mode'); else document.body.classList.remove('night-mode');
  document.querySelectorAll('.lang-btn').forEach(b=>b.classList.remove('active'));
  const map = {tr:'langTR', de:'langDE', en:'langEN'};
  const btn = document.getElementById(map[data.settings.language]||'langTR');
  if(btn) btn.classList.add('active');
  updateUITexts();
}

/* ---------- Quiz Ä°lerleme KalÄ±cÄ±lÄ±ÄŸÄ± FonksiyonlarÄ± ---------- */
function saveProgress(){
  try {
    localStorage.setItem('verbmatrix_progress_answers', JSON.stringify(state.answers));
  } catch (e) {
    console.error("Quiz ilerlemesi kaydedilemedi:", e);
  }
}

function loadProgress(){
  try {
    const savedAnswers = localStorage.getItem('verbmatrix_progress_answers');
    if (savedAnswers) {
      state.answers = JSON.parse(savedAnswers);
    }
  } catch (e) {
    console.error("Quiz ilerlemesi yÃ¼klenemedi:", e);
  }
}
/* ---------------------------------------------------- */

function loadAndShowGroupMenu(){
  const container = document.getElementById('groupButtons');
  container.innerHTML = '';
  const lang = data.settings.language || 'tr';
  const t = (data.translations[lang] && Object.keys(data.translations[lang]).length > 0) ? data.translations[lang] : data.translations.tr;

  if(!data.groups || data.groups.length===0){
    container.innerHTML = `<div class="content-box">${t.messages.noGroups}</div>`;
    showView('groupMenu'); 
    return;
  }
  
  const grid = document.createElement('div');
  grid.className = 'group-story-grid';
  
  data.groups.forEach(g=>{
    const groupBtn = document.createElement('button');
    groupBtn.className = 'btn btn-primary';
    groupBtn.innerHTML = `<strong>${g.name}</strong><span class="small-muted">${g.nameDE || ''}</span>`;
    groupBtn.onclick = ()=>selectGroup(g.id);
    grid.appendChild(groupBtn);

    const storyBtn = document.createElement('button');
    storyBtn.className = 'btn btn-warning';
    if (g.story && g.story.title) {
      storyBtn.textContent = g.story.title;
      storyBtn.onclick = ()=>showGroupStory(g.id); 
    } else {
      storyBtn.textContent = t.messages.noStoryAvailable;
      storyBtn.classList.add('disabled');
      storyBtn.disabled = true;
    }
    grid.appendChild(storyBtn);
  });
  container.appendChild(grid);
  showView('groupMenu');
}


function selectGroup(id){
  state.group = id; state.groupData = data.groups.find(x=>x.id===id) || null;
  const verbs = (data.verbs[id]||[]).filter(v=>v.id);
  const container = document.getElementById('verbButtons'); container.innerHTML='';
  if(verbs.length===0){ 
    const lang = data.settings.language || 'tr';
    const t = (data.translations[lang] && Object.keys(data.translations[lang]).length > 0) ? data.translations[lang] : data.translations.tr;
    container.innerHTML = `<div class="content-box">${t.messages.noVerbs}</div>`; 
    showView('verbMenu'); 
    return; 
  }
  verbs.forEach(v=>{
    const b = document.createElement('button'); b.className='btn btn-primary'; b.textContent = `${v.verbTR || v.verbDE}` + (v.verbDE? ' ('+v.verbDE+')':''); b.onclick = ()=>selectVerb(v.id); container.appendChild(b);
  });
  showView('verbMenu');
}

function selectVerb(verbId){
  state.verb = verbId;
  const container = document.getElementById('sectionButtons'); container.innerHTML='';
  
  Object.entries(data.sections).forEach(([num,name])=>{
    const b = document.createElement('button');
    const key = `${verbId}_s${num}`;
    const contentArray = data.content[key] || [];
    const sentenceCount = contentArray.length;
    
    b.textContent = `${num}. ${name} (${sentenceCount})`;
    
    if (sentenceCount > 0) {
      b.className='btn btn-primary';
      b.onclick = ()=>selectSection(parseInt(num));
    } else {
      b.className='btn btn-danger disabled';
      b.disabled = true;
    }
    container.appendChild(b);
  });
  
  showView('sectionMenu');
}

function selectSection(sectionNum){
  state.section = sectionNum;
  const container = document.getElementById('modeButtons'); container.innerHTML='';
  
  const modes = [
    {id:'study', name:'ğŸ“– Ã‡alÄ±ÅŸma (SRS)'},
    {id:'cloze', name:'ğŸ”² BoÅŸluk Doldurma'},
    {id:'wordorder', name:'ğŸ”¤ Kelimeleri SÄ±ralama'},
    {id:'quiz', name:'ğŸ¯ Quiz'}
  ];
  
  modes.forEach(m=>{
    const b = document.createElement('button'); b.className='btn btn-secondary'; b.textContent = m.name; b.onclick = ()=>startMode(m.id); container.appendChild(b);
  });
  showView('modeMenu');
}
/* ---------- Learning flow ---------- */
function startMode(modeId){
  state.mode = modeId; 
  state.showAnswer=false; 
  state.userAnswer=''; 
  state.correctAnswer=''; 
  state.showResult=false;

  const verbObj = (data.verbs[state.group]||[]).find(v=>v.id===state.verb);
  const title = `${(verbObj && (verbObj.verbTR||verbObj.verbDE)) || 'Fiil'} - ${data.sections[state.section]} - ${modeId}`;
  document.getElementById('learningTitle').textContent = title;

  // --- SRS / QUIZ AYRIMI ---
  if (modeId === 'study') {
    loadSrsData(); 
    const sentences = getSentences();
    const now = Date.now();
    state.dueCards = []; 

    for (let i = 0; i < sentences.length; i++) {
        const cardData = getCardSrsData(i); 
        if (cardData.nextReview <= now) {
            state.dueCards.push(i); 
        }
    }
    
    state.dueCards = shuffle(state.dueCards); 
    state.dueCardPos = 0; 
    
    if (state.dueCards.length === 0) {
        const t = (data.translations[data.settings.language || 'tr'] && Object.keys(data.translations[data.settings.language || 'tr']).length > 0) ? data.translations[data.settings.language || 'tr'] : data.translations.tr;
        document.getElementById('learningContent').innerHTML = `<div class="content-box"><h3 style="text-align:center">${t.messages.noDueCards}</h3></div>`;
        document.getElementById('progressText').textContent = "0 / 0";
        document.getElementById('progressFill').style.width = '100%';
        document.getElementById('progressFill').textContent = '100%';
        showView('learningView');
        return;
    }

  } else {
    state.answers = []; 
    state.dueCards = []; 
    state.dueCardPos = 0; 
  }

  showLearning();
}

function showLearning(){
  const sentences = getSentences();
  const lang = data.settings.language || 'tr';
  const t = (data.translations[lang] && Object.keys(data.translations[lang]).length > 0) ? data.translations[lang] : data.translations.tr;
  
  resetSpeechButtons(); 

  if (sentences.length === 0) {
    alert(t.messages.noSentences); 
    showView('sectionMenu'); 
    return;
  }
  
  if (state.mode === 'study') {
      if (state.dueCardPos >= state.dueCards.length) {
          showCompletion(state.dueCards.length);
          return;
      }
      updateProgress(state.dueCards.length);
  } else {
      if (state.dueCardPos >= sentences.length) {
          showCompletion(sentences.length);
          return;
      }
      updateProgress(sentences.length);
  }
  
  renderSentence(sentences); 
  showView('learningView');
}

function updateProgress(total){
  const currQuestionNum = Math.min(state.dueCardPos + 1, total); 
  const completedCount = state.dueCardPos; 
  
  const percent = total === 0 ? 0 : Math.round((completedCount / total) * 100); 
  
  document.getElementById('progressFill').style.width = percent + '%';
  document.getElementById('progressFill').textContent = percent + '%';
  document.getElementById('progressText').textContent = `${currQuestionNum} / ${total}`;
}

function getSentences(){ return data.content[`${state.verb}_s${state.section}`] || []; }
function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]] } return a; }

function buildHintHtml(verbId, sectionNum, sentenceIndex){
  let html = '';
  const sentKey = `${verbId}_s${sectionNum}_${sentenceIndex}`;
  const secKey = `${verbId}_s${sectionNum}`;
  const secCode = 'B' + sectionNum;

  if(data.hints && data.hints.sentences && data.hints.sentences[sentKey]){
    html += `<div class="hint-item"><strong>Ä°pucu (CÃ¼mle):</strong> ${escapeHtml(data.hints.sentences[sentKey])}</div>`;
  }
  if(data.hints && data.hints.sections && data.hints.sections[secKey]){
    html += `<div class="hint-item"><strong>Ä°pucu (BÃ¶lÃ¼m - Fiil):</strong> ${escapeHtml(data.hints.sections[secKey])}</div>`;
  }
  if(data.hints && data.hints.verbs && data.hints.verbs[verbId]){
    html += `<div class="hint-item"><strong>Ä°pucu (Fiil):</strong> ${escapeHtml(data.hints.verbs[verbId])}</div>`;
  }
  if(data.sectionsHints && data.sectionsHints[secCode]) {
      html += `<div class="hint-item"><strong>Ä°pucu (Genel BÃ¶lÃ¼m):</strong> ${escapeHtml(data.sectionsHints[secCode])}</div>`;
  }
  
  return html;
}

function renderSentence(sentences){
  const container = document.getElementById('learningContent');
  document.getElementById('resultArea').innerHTML=''; document.getElementById('answerArea').innerHTML=''; 
  const hintPanelEl = document.getElementById('hintPanel');
  const quickEditPanel = document.getElementById('quickEditPanel');
  
  quickEditPanel.style.display = 'none';
  hintPanelEl.style.display = state.hintPanelVisible ? 'block' : 'none';
  hintPanelEl.innerHTML = ''; 
  state.showResult = false;

  let originalIndex; 
  if (state.mode === 'study') {
      if(state.dueCardPos >= state.dueCards.length){ 
          showCompletion(state.dueCards.length); 
          return; 
      }
      originalIndex = state.dueCards[state.dueCardPos];
  } else {
      if(state.dueCardPos >= sentences.length){ 
          showCompletion(sentences.length); 
          return; 
      }
      originalIndex = state.dueCardPos; 
  }
  
  const sent = sentences[originalIndex];
  if (!sent) { 
      console.error("CÃ¼mle bulunamadÄ±, index:", originalIndex);
      return; 
  }
  
  container.innerHTML = '';
  const hintHtml = buildHintHtml(state.verb, state.section, originalIndex);

  const lang = data.settings.language || 'tr';
  const t = (data.translations[lang] && Object.keys(data.translations[lang]).length > 0) ? data.translations[lang] : data.translations.tr;

  const isTrDe = data.settings.conversionMode === 'tr-de';
  const questionText = isTrDe ? sent.tr : sent.de;
  const answerText = isTrDe ? sent.de : sent.tr;
  const questionLang = isTrDe ? 'TR' : 'DE';
  const answerLang = isTrDe ? 'DE' : 'TR';
  const placeholderKey = 'quiz'; 

  if(state.mode === 'study'){
    container.innerHTML = `<div class="sentence"><strong>${questionLang}:</strong> ${escapeHtml(questionText)}</div>
                             <div id="answerDisplay" class="sentence hidden"><strong>${answerLang}:</strong> ${escapeHtml(answerText)}</div>`;
  } else if(state.mode === 'cloze'){
    const words = sent.de.split(/\s+/).filter(Boolean);
    const idx = Math.floor(Math.random()*words.length);
    const correct = words[idx].replace(/[.,!?;:]$/,'');
    words[idx] = '_____';
    state.correctAnswer = correct;
    container.innerHTML = `<div class="sentence"><b>TR:</b> ${escapeHtml(sent.tr)}</div>
                             <div class="sentence"><b>DE:</b> ${escapeHtml(words.join(' '))}</div>
                             <input id="clozeInput" class="input-field" placeholder="${t.placeholders?.cloze || 'BoÅŸluÄŸu doldurun...'}">`;
  } else if(state.mode === 'wordorder'){
    const words = sent.de.split(/\s+/).filter(Boolean);
    
    // YENÄ° WORD ORDER MANTIÄI: Kelimeleri havuzda karÄ±ÅŸtÄ±r
    if (state.wordPool.length === 0) {
      state.wordPool = shuffle([...words]);
    }
    state.wordSelected = []; 
    state.correctAnswer = words.join(' ');
    
    // YENÄ°: SatÄ±rlarÄ± DÄ°KEY sÄ±rada (TR -> KarÄ±ÅŸÄ±k -> SeÃ§ilen) gÃ¶ster
    container.innerHTML = `<div class="sentence"><b>TR:</b> ${escapeHtml(sent.tr)}</div>
                             <div class="word-order-area">
                               <div class="word-pool"><strong>KarÄ±ÅŸÄ±k Kelimeler:</strong><div id="wordPoolArea"></div></div>
                               <div class="word-selected"><strong>DÃ¼zenleme SatÄ±rÄ±:</strong><div id="wordSelectedArea"></div></div>
                             </div>`;
    renderWordOrder();
  } else if(state.mode === 'quiz'){
    state.correctAnswer = answerText; 
    container.innerHTML = `<div class="sentence"><b>${questionLang}:</b> ${escapeHtml(questionText)}</div>
                             <input id="quizInput" class="input-field" placeholder="${t.placeholders?.[placeholderKey] || 'Ã‡eviriyi yazÄ±n...'}">`;
  }
  
  if(hintHtml && state.hintPanelVisible){ 
    hintPanelEl.innerHTML = hintHtml; 
    hintPanelEl.style.display = 'block'; 
  } else {
    hintPanelEl.innerHTML = '';
    hintPanelEl.style.display = 'none';
  }

  const btnDE = document.getElementById('btnPlayDE');
  const btnTR = document.getElementById('btnPlayTR');
  
  if (state.mode !== 'study' && !state.showResult) {
      btnDE.disabled = true; btnDE.classList.add('disabled');
      btnTR.disabled = true; btnTR.classList.add('disabled');
  } else {
      btnDE.disabled = false; btnDE.classList.remove('disabled');
      btnTR.disabled = false; btnTR.classList.remove('disabled');
  }

  const actionBtn = document.getElementById('actionBtn');
  const srsControls = document.getElementById('srsControls');

  if (state.mode === 'study') {
      if (state.showAnswer) {
          actionBtn.style.display = 'none';
          srsControls.style.display = 'flex';
      } else {
          actionBtn.style.display = 'block';
          srsControls.style.display = 'none';
          actionBtn.textContent = t.buttons.show;
          actionBtn.onclick = handleAction;
      }
      document.querySelector('[onclick="previousQuestion()"]').style.display = 'none';
  } else {
      actionBtn.style.display = 'block';
      srsControls.style.display = 'none';
      actionBtn.textContent = t.buttons.check;
      actionBtn.onclick = handleAction;
      document.querySelector('[onclick="previousQuestion()"]').style.display = 'block';
  }
  
  if (state.mode === 'study') {
      updateProgress(state.dueCards.length);
  } else {
      updateProgress(sentences.length);
  }
}


function showQuickEditPanel(){
    if (!state.verb || !state.section) return;
    const sentences = getSentences();
    let originalIndex;

    if (state.mode === 'study') {
        if (state.dueCardPos >= state.dueCards.length) return;
        originalIndex = state.dueCards[state.dueCardPos];
    } else {
        if (state.dueCardPos >= sentences.length) return;
        originalIndex = state.dueCardPos;
    }

    const sent = sentences[originalIndex];
    const hintKey = getSrsKey(originalIndex);
    const currentHint = (data.hints && data.hints.sentences && data.hints.sentences[hintKey]) || '';

    document.getElementById('qe_tr').value = sent.tr || '';
    document.getElementById('qe_de').value = sent.de || '';
    document.getElementById('qe_hint').value = currentHint;
    document.getElementById('quickEditTitle').textContent = `HÄ±zlÄ± DÃ¼zenle (Soru ${originalIndex + 1})`;
    document.getElementById('quickEditPanel').style.display = 'block';
}

function saveQuickEdit(){
    if (!state.verb || !state.section) return;
    const sentences = getSentences();
    let originalIndex;

    if (state.mode === 'study') {
        originalIndex = state.dueCards[state.dueCardPos];
    } else {
        originalIndex = state.dueCardPos;
    }
    
    const hintKey = getSrsKey(originalIndex);

    const newTr = document.getElementById('qe_tr').value.trim();
    const newDe = document.getElementById('qe_de').value.trim();
    const newHint = document.getElementById('qe_hint').value.trim();

    sentences[originalIndex].tr = newTr;
    sentences[originalIndex].de = newDe;

    if(!data.hints) data.hints = {sentences:{}, verbs:{}, sections:{}};
    if(!data.hints.sentences) data.hints.sentences = {};
    
    if (newHint) { data.hints.sentences[hintKey] = newHint; } 
    else { delete data.hints.sentences[hintKey]; }
    
    saveDataOverride();
    document.getElementById('quickEditPanel').style.display = 'none';
    renderSentence(sentences);
    
    const t = (data.translations[data.settings.language || 'tr'] && Object.keys(data.translations[data.settings.language || 'tr']).length > 0) ? data.translations[data.settings.language || 'tr'] : data.translations.tr;
    alert(t.messages.quickEditSaved);
}


function renderWordOrder(){
  const pool = document.getElementById('wordPoolArea'); 
  const sel = document.getElementById('wordSelectedArea');
  pool.innerHTML=''; 
  sel.innerHTML='';
  
  // Ãœst satÄ±rdaki seÃ§ilen kelimeler (DÃ¼zenleme SatÄ±rÄ±)
  state.wordSelected.forEach((w,i)=>{
    const d = document.createElement('div'); 
    d.className='word-item top'; 
    d.textContent = w; 
    d.onclick = ()=> unselectWord(i, w); 
    sel.appendChild(d);
  });
  
  // Alt satÄ±rdaki kelime havuzu (KarÄ±ÅŸÄ±k Kelimeler)
  state.wordPool.forEach((w,i)=>{
    const d = document.createElement('div'); 
    d.className='word-item'; 
    d.textContent = w; 
    d.onclick = ()=> selectWordFromPool(i); 
    pool.appendChild(d);
  });
}
function selectWordFromPool(index){ 
    const word = state.wordPool[index];
    state.wordSelected.push(word); 
    state.wordPool.splice(index, 1); 
    renderWordOrder(); 
}
function unselectWord(index, word){ 
    const removedWord = state.wordSelected.splice(index, 1)[0]; 
    state.wordPool.push(removedWord); 
    renderWordOrder(); 
}

function rateCard(difficulty) {
    const sentences = getSentences();
    const originalIndex = state.dueCards[state.dueCardPos];

    updateCardSrsData(originalIndex, difficulty);

    state.dueCardPos++;
    state.showAnswer = false;
    
    renderSentence(sentences);
}


function handleAction(){
  const sents = getSentences();
  const btn = document.getElementById('actionBtn');
  const resultArea = document.getElementById('resultArea'), answerArea = document.getElementById('answerArea');
  const lang = data.settings.language || 'tr';
  const t = (data.translations[lang] && Object.keys(data.translations[lang]).length > 0) ? data.translations[lang] : data.translations.tr;

  const btnDE = document.getElementById('btnPlayDE');
  const btnTR = document.getElementById('btnPlayTR');

  if(state.mode === 'study'){
    if(state.showAnswer){
      rateCard('medium'); 
    } else {
      const ad = document.getElementById('answerDisplay'); 
      if(ad) ad.classList.remove('hidden'); 
      state.showAnswer = true; 
      
      btn.style.display = 'none';
      document.getElementById('srsControls').style.display = 'flex';
    }

  } else if(state.mode === 'cloze'){
    const input = document.getElementById('clozeInput'); const answer = (input && input.value.trim())||'';
    state.userAnswer = answer;
    const correct = state.correctAnswer || '';
    const ok = answer.toLowerCase() === correct.toLowerCase();
    resultArea.innerHTML = ok ? '<div class="result correct">âœ“ DoÄŸru!</div>' : '<div class="result incorrect">âœ— YanlÄ±ÅŸ!</div>';
    answerArea.innerHTML = `<div class="result"><strong>Sizin:</strong> ${escapeHtml(answer||'(boÅŸ)')}</div><div class="result"><strong>DoÄŸru:</strong> ${escapeHtml(correct)}</div>`;
    state.answers.push(!!ok);
    saveProgress(); 
    state.showResult=true; btn.textContent = t.buttons.next;
    btnDE.disabled = false; btnDE.classList.remove('disabled');
    btnTR.disabled = false; btnTR.classList.remove('disabled');
    btn.onclick = ()=>{ state.dueCardPos++; state.showAnswer=false; state.showResult=false; renderSentence(sents); };
  } else if(state.mode === 'wordorder'){
    const user = state.wordSelected.join(' ').trim();
    const ok = user === state.correctAnswer;
    resultArea.innerHTML = ok ? '<div class="result correct">âœ“ DoÄŸru!</div>' : '<div class="result incorrect">âœ— YanlÄ±ÅŸ!</div>';
    answerArea.innerHTML = `<div class="result"><strong>Sizin:</strong> ${escapeHtml(user||'(boÅŸ)')}</div><div class="result"><strong>DoÄŸru:</strong> ${escapeHtml(state.correctAnswer)}</div>`;
    state.answers.push(!!ok);
    saveProgress(); 
    state.showResult=true; btn.textContent = t.buttons.next;
    btnDE.disabled = false; btnDE.classList.remove('disabled');
    btnTR.disabled = false; btnTR.classList.remove('disabled');
    btn.onclick = ()=>{ state.dueCardPos++; state.showAnswer=false; state.showResult=false; state.wordSelected=[]; state.wordPool=[]; renderSentence(sents); };
  } else if(state.mode === 'quiz'){
    const input = document.getElementById('quizInput'); const answer = (input && input.value.trim())||'';
    const ok = answer.toLowerCase() === (state.correctAnswer||'').toLowerCase();
    resultArea.innerHTML = ok ? '<div class="result correct">âœ“ DoÄŸru! +3 Puan</div>' : '<div class="result incorrect">âœ— YanlÄ±ÅŸ!</div>';
    answerArea.innerHTML = `<div class="result"><strong>Sizin:</strong> ${escapeHtml(answer||'(boÅŸ)')}</div><div class="result"><strong>DoÄŸru:</strong> ${escapeHtml(state.correctAnswer)}</div>`;
    state.answers.push(ok?3:0);
    saveProgress(); 
    state.showResult=true; btn.textContent = t.buttons.next;
    btnDE.disabled = false; btnDE.classList.remove('disabled');
    btnTR.disabled = false; btnTR.classList.remove('disabled');
    btn.onclick = ()=>{ state.dueCardPos++; state.showAnswer=false; state.showResult=false; renderSentence(sents); };
  }
}

function previousQuestion(){ 
  if (state.mode === 'study') return; 

  if(state.dueCardPos > 0){ 
      state.dueCardPos--; 
      state.showAnswer=false; 
      state.showResult=false; 
      renderSentence(getSentences()); 
  } 
}

function resetLearning(){ 
  const t = (data.translations[data.settings.language || 'tr'] && Object.keys(data.translations[data.settings.language || 'tr']).length > 0) ? data.translations[data.settings.language || 'tr'] : data.translations.tr;

  if (state.mode === 'study') {
      state.dueCardPos = 0;
      state.dueCards = shuffle(state.dueCards); 
  } else {
      state.dueCardPos = 0;
      state.answers = []; 
      saveProgress(); 
      alert(t.messages.progressReset); 
  }
  state.showAnswer=false; state.showResult=false; 
  renderSentence(getSentences()); 
}


function goToNextSection(sectionNum) {
    state.section = sectionNum;
    startMode(state.mode); 
}

function showCompletion(total){
  const t = (data.translations[data.settings.language || 'tr'] && Object.keys(data.translations[data.settings.language || 'tr']).length > 0) ? data.translations[data.settings.language || 'tr'] : data.translations.tr;
  let correctCount = 0;
  let scoreHtml = '';
  
  if (state.mode === 'study') {
      scoreHtml = `<p style="text-align:center">BugÃ¼n iÃ§in ${total} kartÄ± tekrar ettiniz!</p>`;
  } else {
      if(state.mode === 'quiz'){
        correctCount = state.answers.filter(a=>a>0).length;
      } else {
        correctCount = state.answers.filter(a=>a===true).length;
      }
      const percent = total===0?0:Math.round((correct/total)*100);
      scoreHtml = `<div class="score-display">${percent}%</div>
                   <p style="text-align:center">BaÅŸarÄ±: ${correctCount} / ${total}</p>`;
      saveProgress(); 
  }
  
  let nextButtonHtml = '';
  const sectionKeys = Object.keys(data.sections).map(Number).sort((a, b) => a - b);
  const currentSectionIndex = sectionKeys.indexOf(state.section);
  let nextSectionNum = null;
  if (currentSectionIndex > -1 && currentSectionIndex < sectionKeys.length - 1) {
      for (let i = currentSectionIndex + 1; i < sectionKeys.length; i++) {
          const potentialNextSec = sectionKeys[i];
          const contentKey = `${state.verb}_s${potentialNextSec}`;
          if (data.content[contentKey] && data.content[contentKey].length > 0) {
              nextSectionNum = potentialNextSec;
              break;
          }
      }
  }
  if (nextSectionNum) {
      nextButtonHtml = `<button class="btn btn-secondary" style="margin-top:10px;" onclick="goToNextSection(${nextSectionNum})">${t.buttons.nextSection} (${data.sections[nextSectionNum]})</button>`;
  }
  
  document.getElementById('learningContent').innerHTML = `<div class="content-box"><h3 style="text-align:center">ğŸ‰ TamamladÄ±nÄ±z!</h3>
    ${scoreHtml}
    ${nextButtonHtml} </div>`;
  
  document.getElementById('actionBtn').textContent='Tekrar BaÅŸla'; 
  document.getElementById('actionBtn').onclick = resetLearning;
  
  document.getElementById('actionBtn').style.display = 'block';
  document.getElementById('srsControls').style.display = 'none';

  document.getElementById('progressFill').style.width = '100%';
  document.getElementById('progressFill').textContent = '100%';
  document.getElementById('progressText').textContent = `${total} / ${total}`;
  
  document.getElementById('btnPlayDE').disabled = true; document.getElementById('btnPlayDE').classList.add('disabled');
  document.getElementById('btnPlayTR').disabled = true; document.getElementById('btnPlayTR').classList.add('disabled');
}

// GÃœNCELLENDÄ°: Hem playCurrentSentence hem de playStoryAudio'ya geliÅŸtirilmiÅŸ ses seÃ§imi uygulandÄ±.
function playCurrentSentence(lang) {
    resetSpeechButtons(); 

    const sentences = getSentences();
    if (!sentences || sentences.length === 0) return;

    let originalIndex;
    if (state.mode === 'study') {
        if (state.dueCardPos >= state.dueCards.length) return;
        originalIndex = state.dueCards[state.dueCardPos];
    } else {
        if (state.dueCardPos >= sentences.length) return;
        originalIndex = state.dueCardPos;
    }
    
    const sent = sentences[originalIndex];
    if (!sent) return;

    const text = (lang === 'de') ? sent.de : sent.tr;
    const langCode = (lang === 'de') ? 'de-DE' : 'tr-TR';
    
    if (!text) return; 

    if (lang === 'de' && musicPlayer && musicPlayer.isPlaying) {
        musicPlayer.dim_music(true);
    }

    if('speechSynthesis' in window){
        const speakNow = () => {
            const voices = window.speechSynthesis.getVoices();
            const utter = new SpeechSynthesisUtterance(text);
            utter.lang = langCode;
            utter.rate = state.speechRate || 1;
            utter.pitch = 1; 
            utter.volume = 1; 
            
            // Yeni Ses SeÃ§imi MantÄ±ÄŸÄ±: Anna/Markus'u zorla
            let voice = null;
            if (lang === 'de') {
                // 1. Anna veya Markus'u dene (yÃ¼ksek kaliteli sesler)
                voice = voices.find(v => v.lang.toLowerCase() === langCode.toLowerCase() && /anna|markus/i.test(v.name));
            }
            if (!voice) {
                // 2. Tam dil kodu eÅŸleÅŸmesini dene
                voice = voices.find(v => v.lang.toLowerCase() === langCode.toLowerCase());
            }
            if (!voice && lang === 'de') {
                 // 3. BÃ¶lge olmadan Almanca eÅŸleÅŸmesini dene
                 voice = voices.find(v => v.lang.toLowerCase().startsWith('de'));
            }

            if (voice) {
                utter.voice = voice;
            } else {
                console.warn("Uygun Almanca ses bulunamadÄ±, varsayÄ±lan kullanÄ±lacak.");
            }

            utter.onend = utter.onerror = () => {
                if (musicPlayer && musicPlayer.isPlaying) {
                    musicPlayer.dim_music(false);
                }
                resetSpeechButtons();
            };

            window.speechSynthesis.cancel();
            window.speechSynthesis.speak(utter);
        };

        // iOS/iPadOS iÃ§in kritik: Sesler yÃ¼klenmeden Ã¶nce boÅŸ dÃ¶nebilir
        if (window.speechSynthesis.getVoices().length === 0) {
            window.speechSynthesis.onvoiceschanged = function handler() {
                window.speechSynthesis.onvoiceschanged = null; 
                speakNow();
            };
        } else {
            speakNow();
        }

    } else {
        const t = (data.translations[data.settings.language || 'tr'] && Object.keys(data.translations[data.settings.language || 'tr']).length > 0) ? data.translations[data.settings.language || 'tr'] : data.translations.tr;
        alert(t.messages.ttsNotSupported);
        
        if (lang === 'de' && musicPlayer && musicPlayer.isPlaying) {
            musicPlayer.dim_music(false);
        }
    }
}

/* ---------- Story functions ---------- */
function showGroupStory(groupId){
  state.group = groupId; state.groupData = data.groups.find(g=>g.id===groupId) || null;
  const lang = data.settings.language || 'tr';
  const t = (data.translations[lang] && Object.keys(data.translations[lang]).length > 0) ? data.translations[lang] : data.translations.tr;
  if(!state.groupData || !state.groupData.story){ alert(t.messages.noStory); return; }
  
  document.getElementById('storyTitle').textContent = state.groupData.story.title || t.titles.story;
  renderStoryContent();
  showView('storyView');
}
function renderStoryContent(){
  const sc = document.getElementById('storyContent'); const s = state.groupData.story;
  sc.innerHTML = `<div class="story-section"><h3>Almanca</h3><div class="story-content">${escapeHtml(s.de||'').replace(/\n/g,'<br>')}</div></div>
                   <div class="story-section"><h3>TÃ¼rkÃ§e</h3><div class="story-content">${escapeHtml(s.tr||'').replace(/\n/g,'<br>')}</div></div>`;
}

// GÃœNCELLENDÄ°: Hem playCurrentSentence hem de playStoryAudio'ya geliÅŸtirilmiÅŸ ses seÃ§imi uygulandÄ±.
function playStoryAudio(lang) {
    resetSpeechButtons(); 

    const s = state.groupData && state.groupData.story;
    const t = (data.translations[data.settings.language || 'tr'] &&
               Object.keys(data.translations[data.settings.language || 'tr']).length > 0)
              ? data.translations[data.settings.language || 'tr']
              : data.translations.tr;

    if (!s) { alert(t.messages.noStoryFound); return; }

    const text = (lang === 'de') ? s.de : s.tr;
    const langCode = (lang === 'de') ? 'de-DE' : 'tr-TR';
    
    if (!text) return;

    if (lang === 'de' && musicPlayer && musicPlayer.isPlaying) {
        musicPlayer.dim_music(true);
    }

    if ('speechSynthesis' in window) {
        const speakNow = () => {
            const voices = window.speechSynthesis.getVoices();
            const utter = new SpeechSynthesisUtterance(text);
            utter.lang = langCode;
            utter.rate = state.speechRate || 1;
            utter.pitch = 1; // Ses tonunu normal tut
            utter.volume = 1; // Ses seviyesini tam tut

            // Yeni Ses SeÃ§imi MantÄ±ÄŸÄ±: Anna/Markus'u zorla
            let voice = null;
            if (lang === 'de') {
                // 1. Anna veya Markus'u dene (yÃ¼ksek kaliteli sesler)
                voice = voices.find(v => v.lang.toLowerCase() === langCode.toLowerCase() && /anna|markus/i.test(v.name));
            }
            if (!voice) {
                // 2. Tam dil kodu eÅŸleÅŸmesini dene
                voice = voices.find(v => v.lang.toLowerCase() === langCode.toLowerCase());
            }
            if (!voice && lang === 'de') {
                 // 3. BÃ¶lge olmadan Almanca eÅŸleÅŸmesini dene
                 voice = voices.find(v => v.lang.toLowerCase().startsWith('de'));
            }

            if (voice) {
                utter.voice = voice;
            } else {
                console.warn("Uygun Almanca ses bulunamadÄ±, varsayÄ±lan kullanÄ±lacak.");
            }


            utter.onend = utter.onerror = () => {
                if (musicPlayer && musicPlayer.isPlaying) {
                    musicPlayer.dim_music(false);
                }
                resetSpeechButtons();
            };

            window.speechSynthesis.cancel();
            window.speechSynthesis.speak(utter);
        };

        // iOS/iPadOS iÃ§in kritik: Sesler yÃ¼klenmeden Ã¶nce boÅŸ dÃ¶nebilir
        if (window.speechSynthesis.getVoices().length === 0) {
            window.speechSynthesis.onvoiceschanged = function handler() {
                window.speechSynthesis.onvoiceschanged = null; // Sadece bir kere Ã§alÄ±ÅŸsÄ±n
                speakNow();
            };
        } else {
            speakNow();
        }

    } else {
        alert(t.messages.ttsNotSupported);
        if (lang === 'de' && musicPlayer && musicPlayer.isPlaying) {
            musicPlayer.dim_music(false);
        }
    }
}

function showStoryQuestions(){
  const story = state.groupData && state.groupData.story;
  const container = document.getElementById('storyQuestionsContent');
  const lang = data.settings.language || 'tr';
  const t = (data.translations[lang] && Object.keys(data.translations[lang]).length > 0) ? data.translations[lang] : data.translations.tr;

  container.innerHTML = '';
  if(!story || !story.quiz || !Array.isArray(story.quiz) || story.quiz.length===0){ 
    container.innerHTML = `<p>${t.messages.noStoryQuestions}</p>`; 
    showView('storyQuestionsView'); 
    return; 
  }
  
  const quiz = story.quiz;
  let html = '<form id="storyQuizForm">';
  quiz.forEach((q,i)=>{
    html += `<div style="margin:10px 0;padding:10px;border-radius:8px;background:#fff;color:#0f1724"><b>${i+1}. ${escapeHtml(q.q)}</b><div style="margin-top:8px">`;
    q.options.forEach((opt,j)=>{
      html += `<label style="display:block;margin:6px 0"><input type="radio" name="sq${i}" value="${escapeHtml(opt)}"> ${escapeHtml(opt)}</label>`;
    });
    html += `</div></div>`;
  });
  html += `<div class="button-group-row"><button type="button" class="btn btn-primary" onclick="checkStoryAnswers()">${t.buttons.show}</button></div></form>`;
  container.innerHTML = html;
  showView('storyQuestionsView');
}
function checkStoryAnswers(){
  const story = state.groupData.story; const quiz = story.quiz;
  let correct=0;
  quiz.forEach((q,i)=>{
    const sel = document.querySelector(`input[name="sq${i}"]:checked`);
    if(sel && sel.value === q.a) correct++;
  });
  alert(`ğŸ¯ ${correct} / ${quiz.length} doÄŸru`);
}

/* ---------- Data import/export/debug ---------- */
function importData(){
  const input = document.getElementById('fileInput');
  input.onchange = async (e)=>{ 
    const t = (data.translations[data.settings.language || 'tr'] && Object.keys(data.translations[data.settings.language || 'tr']).length > 0) ? data.translations[data.settings.language || 'tr'] : data.translations.tr;
    try{
      const file = e.target.files[0]; if(!file) return;
      const text = await file.text(); const imported = JSON.parse(text);
      
      const defaultTranslations = JSON.parse(JSON.stringify(data.translations));

      data.groups = imported.groups;
      data.verbs = imported.verbs;
      data.content = imported.content;
      if(imported.sections) data.sections = imported.sections;
      if(imported.sectionsHints) data.sectionsHints = imported.sectionsHints;
      if(imported.hints) data.hints = imported.hints;
      if(imported.settings) data.settings = Object.assign(data.settings || {}, imported.settings);

      if (imported.translations) {
        data.translations = deepMerge(defaultTranslations, imported.translations);
      } else {
        data.translations = defaultTranslations;
      }
      
      saveDataOverride();
      
      alert(`${t.messages.dataLoaded} ${data.groups.length}`);
      loadSettings(); 
      showView('mainMenu');
    }catch(err){ 
      alert(`${t.messages.loadError} ${err.message}`); 
    } 
    input.value=''; 
  };
  input.click();
}
function exportData(){
  const json = JSON.stringify(data,null,2);
  const blob = new Blob([json],{type:'application/json'}); const url = URL.createObjectURL(blob); const a = document.createElement('a');
  a.href = url; a.download = 'verbmatrix_data.json'; a.click(); URL.revokeObjectURL(url); 
  const t = (data.translations[data.settings.language || 'tr'] && Object.keys(data.translations[data.settings.language || 'tr']).length > 0) ? data.translations[data.settings.language || 'tr'] : data.translations.tr;
  alert(t.messages.dataExported);
}
function debugData(){
  const t = (data.translations[data.settings.language || 'tr'] && Object.keys(data.translations[data.settings.language || 'tr']).length > 0) ? data.translations[data.settings.language || 'tr'] : data.translations.tr;
  let msg = `${t.messages.jsonStatus}\n\n`;
  msg += `Gruplar: ${(data.groups||[]).length}\n`;
  msg += `Verbs grup count: ${Object.keys(data.verbs||{}).length}\n`;
  msg += `Content keys: ${Object.keys(data.content||{}).length}\n`;
  msg += `SectionsHints (B#): ${Object.keys((data.sectionsHints||{})).length}\n`;
  msg += `Hints sentences: ${Object.keys((data.hints&&data.hints.sentences)||{}).length}\n`;
  
  loadSrsData();
  const srsCount = Object.keys(srsData).length;
  msg += `\nSRS Veri KayÄ±tlarÄ±: ${srsCount}\n`;
  
  alert(msg);
}
function resetProgressStorage(){ 
  state.answers=[]; 
  saveProgress(); 
  const t = (data.translations[data.settings.language || 'tr'] && Object.keys(data.translations[data.settings.language || 'tr']).length > 0) ? data.translations[data.settings.language || 'tr'] : data.translations.tr;
  alert(t.messages.progressReset); 
}
function loadProgressView(){
  loadProgress(); 
  const total = state.answers.length; const correct = state.answers.filter(a=> a===true || a>0 ).length;
  const percent = total===0?0:Math.round((correct/total)*100);
  const t = (data.translations[data.settings.language || 'tr'] && Object.keys(data.translations[data.settings.language || 'tr']).length > 0) ? data.translations[data.settings.language || 'tr'] : data.translations.tr;
  
  if (total === 0) {
    document.getElementById('progressStats').innerHTML = `<p class="small-muted">${t.messages.noProgress}</p>`;
  } else {
    document.getElementById('progressStats').innerHTML = `<div style="text-align:center"><h3>Quiz Ä°lerlemesi</h3><div class="score-display">${percent}%</div><p>Toplam: ${total} | DoÄŸru: ${correct} | YanlÄ±ÅŸ: ${total-correct}</p></div>`;
  }
}

/* ---------- Hint forms & manager (Admin paneline taÅŸÄ±ndÄ±) ---------- */
function showHintForm(type){
  const area = document.getElementById('hintFormsArea'); area.innerHTML = '';
  const lang = data.settings.language || 'tr';
  const t = (data.translations[lang] && Object.keys(data.translations[lang]).length > 0) ? data.translations[lang] : data.translations.tr;

  if(type==='sentence'){
    area.innerHTML = `<div class="content-box"><h4>${t.admin.hintSentence}</h4>
      <label>${t.labels.group}</label><select id="hf_group" class="select-field"></select>
      <label>${t.labels.verb}</label><select id="hf_verb" class="select-field"></select>
      <label>${t.labels.section}</label><select id="hf_section" class="select-field"></select>
      <label>${t.labels.sentence}</label><select id="hf_sentence" class="select-field"></select>
      <label>${t.labels.hintText}</label><textarea id="hf_text" class="input-field"></textarea>
      <div class="button-group-row"><button class="btn btn-primary" onclick="saveSentenceHint()">${t.buttons.save}</button><button class="btn btn-danger" onclick="document.getElementById('hintFormsArea').innerHTML=''">${t.buttons.cancel}</button></div></div>`;
    fillSelect('hf_group', data.groups.map(g=>({v:g.id,t:g.name})), true); document.getElementById('hf_group').addEventListener('change', hf_loadVerbs);
  } else if(type==='verb'){
    area.innerHTML = `<div class="content-box"><h4>${t.admin.hintVerb}</h4>
      <label>${t.labels.group}</label><select id="vh_group" class="select-field"></select>
      <label>${t.labels.verb}</label><select id="vh_verb" class="select-field"></select>
      <label>${t.labels.hintText}</label><textarea id="vh_text" class="input-field"></textarea>
      <div class="button-group-row"><button class="btn btn-primary" onclick="saveVerbHint()">${t.buttons.save}</button><button class="btn btn-danger" onclick="document.getElementById('hintFormsArea').innerHTML=''">${t.buttons.cancel}</button></div></div>`;
    fillSelect('vh_group', data.groups.map(g=>({v:g.id,t:g.name})), true); document.getElementById('vh_group').addEventListener('change', vh_loadVerbs);
  } else if(type==='section'){
    area.innerHTML = `<div class="content-box"><h4>${t.admin.hintSection}</h4>
      <label>${t.labels.sectionCode}</label><input id="sh_section_code" class="input-field" placeholder="Ã¶rn: B1">
      <label>${t.labels.hintText}</label><textarea id="sh_text" class="input-field"></textarea>
      <div class="button-group-row"><button class="btn btn-primary" onclick="saveSectionHint()">${t.buttons.save}</button><button class="btn btn-danger" onclick="document.getElementById('hintFormsArea').innerHTML=''">${t.buttons.cancel}</button></div></div>`;
  }
}
function fillSelect(id, items, addEmpty){
  const s = document.getElementById(id); s.innerHTML=''; 
  if(addEmpty){ 
    const o=document.createElement('option'); o.value=''; o.textContent='SeÃ§in...'; s.appendChild(o); 
  }
  items.forEach(it=>{ const o=document.createElement('option'); o.value=it.v; o.textContent=it.t; s.appendChild(o); });
}
function hf_loadVerbs(){ const gid=document.getElementById('hf_group').value; const sel=document.getElementById('hf_verb'); sel.innerHTML=''; if(!gid) return; (data.verbs[gid]||[]).forEach(v=>{ const o=document.createElement('option'); o.value=v.id; o.textContent=(v.verbTR||v.verbDE); sel.appendChild(o); }); hf_loadSections(); }
function hf_loadSections(){ const verbId=document.getElementById('hf_verb').value; const sel=document.getElementById('hf_section'); sel.innerHTML=''; if(!verbId) return; Object.entries(data.sections).forEach(([num,name])=>{ const key = `${verbId}_s${num}`; if(data.content[key] && data.content[key].length>0){ const o=document.createElement('option'); o.value=num; o.textContent=`${num}. ${name}`; sel.appendChild(o); } }); hf_loadSentences(); }
function hf_loadSentences(){ const verbId=document.getElementById('hf_verb').value; const section=document.getElementById('hf_section').value; const sel=document.getElementById('hf_sentence'); sel.innerHTML=''; if(!verbId||!section) return; const arr = data.content[`${verbId}_s${section}`]||[]; arr.forEach((s,i)=>{ const o=document.createElement('option'); o.value=i; o.textContent = (s.tr||s.de||'').substring(0,80); sel.appendChild(o); }); }

function saveSentenceHint(){ 
    const verbId=document.getElementById('hf_verb').value; const section=document.getElementById('hf_section').value; const idx=document.getElementById('hf_sentence').value; const txt=document.getElementById('hf_text').value.trim(); 
    const t = (data.translations[data.settings.language || 'tr'] && Object.keys(data.translations[data.settings.language || 'tr']).length > 0) ? data.translations[data.settings.language || 'tr'] : data.translations.tr;
    if(!verbId||!section||idx===''||!txt){ alert(t.messages.allFieldsError); return; } 
    const key = `${verbId}_s${section}_${idx}`; 
    if(!data.hints) data.hints={sentences:{},verbs:{},sections:{}}; 
    data.hints.sentences[key] = txt; alert(t.messages.hintSaved); 
    document.getElementById('hintFormsArea').innerHTML=''; 
    if (state.currentView === 'adminHintView') { showHintManager('hintManagerArea'); }
    saveDataOverride(); 
}
function vh_loadVerbs(){ const gid=document.getElementById('vh_group').value; const sel=document.getElementById('vh_verb'); sel.innerHTML=''; if(!gid) return; (data.verbs[gid]||[]).forEach(v=>{ const o=document.createElement('option'); o.value=v.id; o.textContent=(v.verbTR||v.verbDE); sel.appendChild(o); }); }
function saveVerbHint(){ 
    const verbId = document.getElementById('vh_verb').value; const txt = document.getElementById('vh_text').value.trim(); 
    const t = (data.translations[data.settings.language || 'tr'] && Object.keys(data.translations[data.settings.language || 'tr']).length > 0) ? data.translations[data.settings.language || 'tr'] : data.translations.tr;
    if(!verbId||!txt){ alert(t.messages.allFieldsError); return; } 
    if(!data.hints) data.hints={sentences:{},verbs:{},sections:{}}; 
    data.hints.verbs[verbId] = txt; alert(t.messages.hintSaved); 
    document.getElementById('hintFormsArea').innerHTML=''; 
    if (state.currentView === 'adminHintView') { showHintManager('hintManagerArea'); }
    saveDataOverride(); 
}
function saveSectionHint(){ 
    const code=document.getElementById('sh_section_code').value.trim(); const txt=document.getElementById('sh_text').value.trim(); 
    const t = (data.translations[data.settings.language || 'tr'] && Object.keys(data.translations[data.settings.language || 'tr']).length > 0) ? data.translations[data.settings.language || 'tr'] : data.translations.tr;
    if(!code||!txt){ alert(t.messages.allFieldsError); return; } 
    if(!data.sectionsHints) data.sectionsHints={}; 
    data.sectionsHints[code] = txt; alert(t.messages.hintSaved + ': ' + code); 
    document.getElementById('hintFormsArea').innerHTML=''; 
    if (state.currentView === 'adminHintView') { showHintManager('hintManagerArea'); }
    saveDataOverride(); 
}

function adminEditHint(type, key) {
  const area = document.getElementById('hintFormsArea'); 
  area.innerHTML = ''; 
  const hintText = data.hints[type][key];
  const t = (data.translations[data.settings.language || 'tr'] && Object.keys(data.translations[data.settings.language || 'tr']).length > 0) ? data.translations[data.settings.language || 'tr'] : data.translations.tr;

  if (type === 'sentences') {
    area.innerHTML = `<div class="content-box"><h4>CÃ¼mle Ä°pucu DÃ¼zenle (${key})</h4>
      <label>${t.labels.hintText}</label><textarea id="hf_text_edit" class="input-field">${escapeHtml(hintText)}</textarea>
      <div class="button-group-row">
        <button class="btn btn-primary" onclick="saveEditedSentenceHint('${key}')">${t.buttons.update}</button>
        <button class="btn btn-danger" onclick="document.getElementById('hintFormsArea').innerHTML=''">${t.buttons.cancel}</button>
      </div></div>`;
  } else if (type === 'verbs') {
    area.innerHTML = `<div class="content-box"><h4>Fiil Ä°pucu DÃ¼zenle (${key})</h4>
      <label>${t.labels.hintText}</label><textarea id="vh_text_edit" class="input-field">${escapeHtml(hintText)}</textarea>
      <div class="button-group-row">
        <button class="btn btn-primary" onclick="saveEditedVerbHint('${key}')">${t.buttons.update}</button>
        <button class="btn btn-danger" onclick="document.getElementById('hintFormsArea').innerHTML=''">${t.buttons.cancel}</button>
      </div></div>`;
  }
}
function adminEditSectionHint(key) {
  const area = document.getElementById('hintFormsArea');
  const hintText = data.sectionsHints[key];
  const t = (data.translations[data.settings.language || 'tr'] && Object.keys(data.translations[data.settings.language || 'tr']).length > 0) ? data.translations[data.settings.language || 'tr'] : data.translations.tr;
  area.innerHTML = `<div class="content-box"><h4>BÃ¶lÃ¼m Ä°pucu DÃ¼zenle (${key})</h4>
    <label>${t.labels.sectionCode}</label><input id="sh_section_code" class="input-field" value="${escapeHtml(key)}" readonly>
    <label>${t.labels.hintText}</label><textarea id="sh_text" class="input-field">${escapeHtml(hintText)}</textarea>
    <div class="button-group-row">
      <button class="btn btn-primary" onclick="saveSectionHint()">${t.buttons.save}</button>
      <button class="btn btn-danger" onclick="document.getElementById('hintFormsArea').innerHTML=''">${t.buttons.cancel}</button>
    </div></div>`;
}

function saveEditedSentenceHint(key) {
  const txt = document.getElementById('hf_text_edit').value.trim();
  if (!txt) { alert('Ä°pucu boÅŸ olamaz'); return; }
  data.hints.sentences[key] = txt;
  alert('âœ… CÃ¼mle ipucu gÃ¼ncellendi');
  document.getElementById('hintFormsArea').innerHTML = ''; 
  showHintManager('hintManagerArea'); 
  saveDataOverride(); 
}
function saveEditedVerbHint(key) {
  const txt = document.getElementById('vh_text_edit').value.trim();
  if (!txt) { alert('Ä°pucu boÅŸ olamaz'); return; }
  data.hints.verbs[key] = txt;
  alert('âœ… Fiil ipucu gÃ¼ncellendi');
  document.getElementById('hintFormsArea').innerHTML = ''; 
  showHintManager('hintManagerArea'); 
  saveDataOverride(); 
}

function showHintManager(targetId = 'hintFormsArea'){ 
  const area = document.getElementById(targetId);
  if(!area) { console.error("Hint manager target area not found:", targetId); return; }
  
  const t = (data.translations[data.settings.language || 'tr'] && Object.keys(data.translations[data.settings.language || 'tr']).length > 0) ? data.translations[data.settings.language || 'tr'] : data.translations.tr;
  let html = '';
  
  html += '<h5>CÃ¼mle Ä°puÃ§larÄ±</h5>'; 
  if(!data.hints || !data.hints.sentences || Object.keys(data.hints.sentences).length===0) html += `<p class="small-muted">${t.messages.noHints}</p>`; 
  else Object.entries(data.hints.sentences).forEach(([k,v])=>{ 
    html += `<div class="hint-item"><strong>${k}</strong><div style="margin-top:6px">${escapeHtml(v)}</div>
             <div style="margin-top:8px" class="button-group-row">
               <button class="btn btn-info btn-small" onclick="adminEditHint('sentences','${k}')">âœï¸ ${t.buttons.edit}</button>
               <button class="btn btn-danger btn-small" onclick="deleteHint('sentences','${k}', '${targetId}')">ğŸ—‘ ${t.buttons.delete}</button>
             </div></div>`; 
  });
  
  html += '<h5 style="margin-top:12px">Fiil Ä°puÃ§larÄ±</h5>'; 
  if(!data.hints || !data.hints.verbs || Object.keys(data.hints.verbs).length===0) html += `<p class="small-muted">${t.messages.noHints}</p>`; 
  else Object.entries(data.hints.verbs).forEach(([k,v])=>{ 
    html += `<div class="hint-item"><strong>${k}</strong><div style="margin-top:6px">${escapeHtml(v)}</div>
             <div style="margin-top:8px" class="button-group-row">
               <button class="btn btn-info btn-small" onclick="adminEditHint('verbs','${k}')">âœï¸ ${t.buttons.edit}</button>
               <button class="btn btn-danger btn-small" onclick="deleteHint('verbs','${k}', '${targetId}')">ğŸ—‘ ${t.buttons.delete}</button>
             </div></div>`; 
  });
  
  html += '<h5 style="margin-top:12px">Genel BÃ¶lÃ¼m Ä°puÃ§larÄ± (B#)</h5>'; 
  if(!data.sectionsHints || Object.keys(data.sectionsHints).length===0) html += `<p class="small-muted">${t.messages.noHints}</p>`; 
  else Object.entries(data.sectionsHints).forEach(([k,v])=>{ 
    html += `<div class="hint-item"><strong>${k}</strong><div style="margin-top:6px">${escapeHtml(v)}</div>
             <div style="margin-top:8px" class="button-group-row">
               <button class="btn btn-info btn-small" onclick="adminEditSectionHint('${k}')">âœï¸ ${t.buttons.edit}</button>
               <button class="btn btn-danger btn-small" onclick="deleteSectionHint('${k}', '${targetId}')">ğŸ—‘ ${t.buttons.delete}</button>
             </div></div>`; 
  });
  
  if(targetId === 'hintFormsArea'){
    html += `<div style="margin-top:10px"><button class="btn btn-danger btn-small" onclick="document.getElementById('hintFormsArea').innerHTML=''">Kapat</button></div>`;
  }
  
  area.innerHTML = html; 
}

function deleteHint(type,key, targetId){ 
  if(!confirm('Silinsin mi?')) return; 
  if(data.hints && data.hints[type]) delete data.hints[type][key]; 
  if(targetId) showHintManager(targetId); 
  saveDataOverride(); 
  alert('Silindi'); 
}
function deleteSectionHint(key, targetId){ 
  if(!confirm('Genel bÃ¶lÃ¼m ipucunu silmek istediÄŸinize emin misiniz?')) return; 
  if(data.sectionsHints) delete data.sectionsHints[key]; 
  if(targetId) showHintManager(targetId); 
  saveDataOverride(); 
  alert('Silindi'); 
}

function toggleHintPanel(){ 
    state.hintPanelVisible = !state.hintPanelVisible; 
    const hintPanelEl = document.getElementById('hintPanel'); 
    
    if(state.hintPanelVisible) {
        let originalIndex;
        if (state.mode === 'study') {
            originalIndex = state.dueCards[state.dueCardPos];
        } else {
            originalIndex = state.dueCardPos;
        }
        
        const hintHtml = buildHintHtml(state.verb, state.section, originalIndex);
        if (hintHtml) {
            hintPanelEl.innerHTML = hintHtml;
            hintPanelEl.style.display = 'block';
        } else {
            hintPanelEl.innerHTML = '';
            hintPanelEl.style.display = 'none';
        }
    } else {
        hintPanelEl.style.display = 'none';
    }
}

/* ---------- Admin: Add/Edit content ---------- */
function showAdminAddGroup(){
  document.getElementById('adminTsvArea').style.display = 'none'; // TSV'yi gizle
  const area = document.getElementById('adminContentArea'); 
  const t = (data.translations[data.settings.language || 'tr'] && Object.keys(data.translations[data.settings.language || 'tr']).length > 0) ? data.translations[data.settings.language || 'tr'] : data.translations.tr;
  area.innerHTML = `<div class="content-box"><h4>${t.admin.addGroup}</h4>
    <label>${t.labels.groupID}</label><input id="adm_group_id" class="input-field">
    <label>${t.labels.groupNameTR}</label><input id="adm_group_name" class="input-field">
    <label>${t.labels.groupNameDE}</label><input id="adm_group_named" class="input-field">
    <div class="button-group-row"><button class="btn btn-primary" onclick="adminSaveGroup()">${t.buttons.save}</button><button class="btn btn-danger" onclick="document.getElementById('adminContentArea').innerHTML=''">${t.buttons.cancel}</button></div></div>`;
}
function adminSaveGroup(){
  const id = document.getElementById('adm_group_id').value.trim();
  const name = document.getElementById('adm_group_name').value.trim();
  const named = document.getElementById('adm_group_named').value.trim();
  if(!id||!name){ alert('ID ve isim girin'); return; }
  if(data.groups.find(g=>g.id===id)){ alert('Bu ID zaten var'); return; }
  data.groups.push({id:id,name:name,nameDE:named,story:null});
  if(!data.verbs[id]) data.verbs[id]=[];
  alert('Grup eklendi'); document.getElementById('adminContentArea').innerHTML='';
  saveDataOverride(); 
}
function showAdminAddVerb(){
  document.getElementById('adminTsvArea').style.display = 'none'; // TSV'yi gizle
  const area = document.getElementById('adminContentArea'); 
  const t = (data.translations[data.settings.language || 'tr'] && Object.keys(data.translations[data.settings.language || 'tr']).length > 0) ? data.translations[data.settings.language || 'tr'] : data.translations.tr;
  area.innerHTML = `<div class="content-box"><h4>${t.admin.addVerb}</h4>
    <label>${t.labels.group}</label><select id="adm_v_group" class="select-field"></select>
    <label>${t.labels.verbID}</label><input id="adm_v_id" class="input-field">
    <label>${t.labels.verbTR}</label><input id="adm_v_tr" class="input-field">
    <label>${t.labels.verbDE}</label><input id="adm_v_de" class="input-field">
    <div class="button-group-row"><button class="btn btn-primary" onclick="adminSaveVerb()">${t.buttons.save}</button><button class="btn btn-danger" onclick="document.getElementById('adminContentArea').innerHTML=''">${t.buttons.cancel}</button></div></div>`;
  fillSelect('adm_v_group', data.groups.map(g=>({v:g.id,t:g.name})), false);
}
function adminSaveVerb(){
  const gid = document.getElementById('adm_v_group').value;
  const vid = document.getElementById('adm_v_id').value.trim();
  const vtr = document.getElementById('adm_v_tr').value.trim();
  const vde = document.getElementById('adm_v_de').value.trim();
  if(!gid||!vid||(!vtr && !vde)){ alert('TÃ¼m gerekli alanlarÄ± doldurun'); return; }
  if(!data.verbs[gid]) data.verbs[gid]=[];
  if((data.verbs[gid]||[]).find(v=>v.id===vid)){ alert('Bu fiil ID zaten var bu grupta'); return; }
  data.verbs[gid].push({id:vid,verbTR:vtr,verbDE:vde});
  alert('Fiil eklendi'); document.getElementById('adminContentArea').innerHTML='';
  saveDataOverride(); 
}
function showAdminEditSentence(){
  document.getElementById('adminTsvArea').style.display = 'none'; // TSV'yi gizle
  const area = document.getElementById('adminContentArea'); 
  const t = (data.translations[data.settings.language || 'tr'] && Object.keys(data.translations[data.settings.language || 'tr']).length > 0) ? data.translations[data.settings.language || 'tr'] : data.translations.tr;
  area.innerHTML = `<div class="content-box"><h4>${t.admin.editSentence}</h4>
    <label>${t.labels.group}</label><select id="adm_es_group" class="select-field"></select>
    <label>${t.labels.verb}</label><select id="adm_es_verb" class="select-field"></select>
    <label>${t.labels.section}</label><select id="adm_es_section" class="select-field"></select>
    <label>${t.labels.sentence}</label><select id="adm_es_sentence" class="select-field"></select>
    <label>${t.labels.tr}</label><textarea id="adm_es_tr" class="input-field"></textarea>
    <label>${t.labels.de}</label><textarea id="adm_es_de" class="input-field"></textarea>
    <div class="button-group-row"><button class="btn btn-primary" onclick="adminSaveEditedSentence()">${t.buttons.update}</button><button class="btn btn-secondary" onclick="adminAddNewSentence()">â• ${t.buttons.add}</button><button class="btn btn-danger" onclick="document.getElementById('adminContentArea').innerHTML=''">${t.buttons.cancel}</button></div></div>`;
  fillSelect('adm_es_group', data.groups.map(g=>({v:g.id,t:g.name})), true); document.getElementById('adm_es_group').addEventListener('change', admin_es_loadVerbs);
}
function admin_es_loadVerbs(){
  const gid=document.getElementById('adm_es_group').value; const sel=document.getElementById('adm_es_verb'); sel.innerHTML=''; if(!gid) return; (data.verbs[gid]||[]).forEach(v=>{ const o=document.createElement('option'); o.value=v.id; o.textContent=(v.verbTR||v.verbDE); sel.appendChild(o); }); admin_es_loadSections();
}
function admin_es_loadSections(){
  const verbId=document.getElementById('adm_es_verb').value; const sel=document.getElementById('adm_es_section'); sel.innerHTML=''; if(!verbId) return; Object.entries(data.sections).forEach(([num,name])=>{ const key = `${verbId}_s${num}`; 
    const o=document.createElement('option'); o.value=num; 
    const count = (data.content[key] && data.content[key].length) || 0;
    o.textContent=`${num}. ${name} (${count} cÃ¼mle)`; 
    sel.appendChild(o); 
  }); admin_es_loadSentences();
}
function admin_es_loadSentences(){
  const verbId=document.getElementById('adm_es_verb').value; const section=document.getElementById('adm_es_section').value; const sel=document.getElementById('adm_es_sentence'); sel.innerHTML=''; if(!verbId||!section) return; const arr = data.content[`${verbId}_s${section}`]||[]; arr.forEach((s,i)=>{ const o=document.createElement('option'); o.value=i; o.textContent = (s.tr||s.de||'').substring(0,80); sel.appendChild(o); }); 
  document.getElementById('adm_es_sentence').addEventListener('change', admin_es_loadSentenceFields);
  admin_es_loadSentenceFields();
}
function admin_es_loadSentenceFields(){
  const verbId=document.getElementById('adm_es_verb').value; const section=document.getElementById('adm_es_section').value; const idx=document.getElementById('adm_es_sentence').value; if(!verbId||!section||idx==='') return; const s = (data.content[`${verbId}_s${section}`]||[])[idx]; if(s){ document.getElementById('adm_es_tr').value = s.tr || ''; document.getElementById('adm_es_de').value = s.de || ''; }
}
function adminSaveEditedSentence(){
  const verbId=document.getElementById('adm_es_verb').value; const section=document.getElementById('adm_es_section').value; const idx=document.getElementById('adm_es_sentence').value;
  const tr=document.getElementById('adm_es_tr').value.trim(); const de=document.getElementById('adm_es_de').value.trim();
  if(!verbId||!section||idx==='') { alert('SeÃ§im yapÄ±n'); return; }
  const arr = data.content[`${verbId}_s${section}`] || [];
  arr[idx] = {tr,de};
  data.content[`${verbId}_s${section}`] = arr;
  alert('CÃ¼mle gÃ¼ncellendi'); 
  admin_es_loadSentences(); 
  saveDataOverride(); 
}
function adminAddNewSentence(){
  const verbId=document.getElementById('adm_es_verb').value; const section=document.getElementById('adm_es_section').value;
  const tr=document.getElementById('adm_es_tr').value.trim(); const de=document.getElementById('adm_es_de').value.trim();
  if(!verbId||!section||(!tr&&!de)){ alert('Gerekli alanlarÄ± doldurun (Fiil, BÃ¶lÃ¼m, TR/DE)'); return; }
  if(!data.content[`${verbId}_s${section}`]) data.content[`${verbId}_s${section}`]=[];
  data.content[`${verbId}_s${section}`].push({tr,de});
  alert('Yeni cÃ¼mle eklendi'); 
  admin_es_loadSections(); 
  saveDataOverride(); 
}

/* ---------- Admin: Story management ---------- */
function showAdminAddStory(){
  const area = document.getElementById('adminStoryArea'); 
  const t = (data.translations[data.settings.language || 'tr'] && Object.keys(data.translations[data.settings.language || 'tr']).length > 0) ? data.translations[data.settings.language || 'tr'] : data.translations.tr;
  area.innerHTML = `<div class="content-box"><h4>${t.admin.addStory}</h4>
    <label>${t.labels.group}</label><select id="adm_story_group" class="select-field"></select>
    <label>${t.labels.title}</label><input id="adm_story_title" class="input-field">
    <label>${t.labels.deText}</label><textarea id="adm_story_de" class="input-field"></textarea>
    <label>${t.labels.trText}</label><textarea id="adm_story_tr" class="input-field"></textarea>
    <div class="button-group-row"><button class="btn btn-primary" onclick="adminSaveStory()">${t.buttons.save}</button><button class="btn btn-danger" onclick="document.getElementById('adminStoryArea').innerHTML=''">${t.buttons.cancel}</button></div></div>`;
  fillSelect('adm_story_group', data.groups.map(g=>({v:g.id,t:g.name})), false);
}
function adminSaveStory(){
  const gid=document.getElementById('adm_story_group').value; const title=document.getElementById('adm_story_title').value.trim();
  const de=document.getElementById('adm_story_de').value.trim(); const tr=document.getElementById('adm_story_tr').value.trim();
  if(!gid||!title||(!de&&!tr)){ alert('AlanlarÄ± doldurun'); return; }
  const g = data.groups.find(x=>x.id===gid);
  if(!g) { alert('Grup bulunamadÄ±'); return; }
  g.story = {title,de,tr,quiz:[]};
  alert('Hikaye kaydedildi'); document.getElementById('adminStoryArea').innerHTML='';
  saveDataOverride(); 
}
function showAdminEditStory(){
  const area = document.getElementById('adminStoryArea'); 
  const t = (data.translations[data.settings.language || 'tr'] && Object.keys(data.translations[data.settings.language || 'tr']).length > 0) ? data.translations[data.settings.language || 'tr'] : data.translations.tr;
  area.innerHTML = `<div class="content-box"><h4>${t.admin.editStory}</h4>
    <label>${t.labels.group}</label><select id="adm_esg_group" class="select-field"></select>
    <div class="button-group-row"><button class="btn btn-primary" onclick="adminLoadGroupStory()">Hikayeyi YÃ¼kle</button></div>
    <div id="adm_story_edit"></div></div>`;
  fillSelect('adm_esg_group', data.groups.map(g=>({v:g.id,t:g.name})), true);
}
function adminLoadGroupStory(){
  const gid=document.getElementById('adm_esg_group').value; if(!gid) return;
  const g = data.groups.find(x=>x.id===gid); if(!g || !g.story){ alert('Bu grupta hikaye yok'); return; }
  const s = g.story;
  const area = document.getElementById('adm_story_edit');
  const t = (data.translations[data.settings.language || 'tr'] && Object.keys(data.translations[data.settings.language || 'tr']).length > 0) ? data.translations[data.settings.language || 'tr'] : data.translations.tr;
  
  let html = `<div style="margin-top:8px"><label>${t.labels.title}</label><input id="ae_title" class="input-field" value="${escapeHtml(s.title||'')}">
    <label>${t.labels.deText}</label><textarea id="ae_de" class="input-field" rows="5">${escapeHtml(s.de||'')}</textarea>
    <label>${t.labels.trText}</label><textarea id="ae_tr" class="input-field" rows="5">${escapeHtml(s.tr||'')}</textarea>
    <div class="button-group-row"><button class="btn btn-primary" onclick="adminSaveEditedStory('${gid}')">${t.buttons.update}</button><button class="btn btn-danger" onclick="adminDeleteStory('${gid}')">ğŸ—‘ ${t.buttons.delete}</button></div></div>`;
  html += `<hr style="margin: 16px 0"><h4>Hikaye Testleri</h4><div id="ae_quiz_list"></div><div style="margin-top:8px"><button class="btn btn-info" onclick="adminAddQuiz('${gid}')">â• Test Ekle</button></div>`;
  area.innerHTML = html;
  renderAdminQuizList(gid);
}
function adminSaveEditedStory(gid){
  const g = data.groups.find(x=>x.id===gid); if(!g) return;
  g.story.title = document.getElementById('ae_title').value.trim();
  g.story.de = document.getElementById('ae_de').value.trim();
  g.story.tr = document.getElementById('ae_tr').value.trim();
  alert('Hikaye gÃ¼ncellendi');
  saveDataOverride(); 
}
function adminDeleteStory(gid){ if(!confirm('Hikayeyi silmek istediÄŸinize emin misiniz?')) return; const g = data.groups.find(x=>x.id===gid); if(g) { g.story = null; alert('Hikaye silindi'); document.getElementById('adm_story_edit').innerHTML=''; saveDataOverride(); } }

function renderAdminQuizList(gid){
  const g = data.groups.find(x=>x.id===gid); if(!g || !g.story) return;
  const list = document.getElementById('ae_quiz_list'); 
  const t = (data.translations[data.settings.language || 'tr'] && Object.keys(data.translations[data.settings.language || 'tr']).length > 0) ? data.translations[data.settings.language || 'tr'] : data.translations.tr;
  let html=''; 
  (g.story.quiz||[]).forEach((q,i)=>{ 
    html += `<div class="hint-item"><strong>${i+1}. ${escapeHtml(q.q)}</strong><div style="margin-top:6px">${q.options.map(o=>`<span class="muted">${escapeHtml(o)}</span>`).join(' , ')}</div>
             <div style="margin-top:8px" class="button-group-row">
               <button class="btn btn-info btn-small" onclick="adminEditQuiz('${gid}',${i})">âœï¸ ${t.buttons.edit}</button>
               <button class="btn btn-danger btn-small" onclick="adminDeleteQuiz('${gid}',${i})">ğŸ—‘ ${t.buttons.delete}</button>
             </div></div>`; 
  }); 
  list.innerHTML = html || `<p class="small-muted">${t.messages.noStoryQuestions}</p>`;
}
function adminAddQuiz(gid){
  const q = {q:'Yeni soru', options:['SeÃ§enek1','SeÃ§enek2'], a:'SeÃ§enek1'};
  const g = data.groups.find(x=>x.id===gid); if(!g.story) g.story={title:'',de:'',tr:'',quiz:[]};
  if(!g.story.quiz) g.story.quiz = [];
  g.story.quiz.push(q);
  renderAdminQuizList(gid);
  saveDataOverride(); 
}
function adminEditQuiz(gid, index){
  const g = data.groups.find(x=>x.id===gid); if(!g || !g.story) return;
  const q = g.story.quiz[index]; const container=document.getElementById('ae_quiz_list');
  const t = (data.translations[data.settings.language || 'tr'] && Object.keys(data.translations[data.settings.language || 'tr']).length > 0) ? data.translations[data.settings.language || 'tr'] : data.translations.tr;
  const html = `<div class="content-box">
    <h4>Testi DÃ¼zenle</h4>
    <label>${t.labels.question}</label><input id="aq_q" class="input-field" value="${escapeHtml(q.q)}">
    <label>${t.labels.options}</label><input id="aq_opts" class="input-field" value="${escapeHtml(q.options.join(','))}">
    <label>${t.labels.correctAnswer}</label><input id="aq_a" class="input-field" value="${escapeHtml(q.a)}">
    <div class="button-group-row">
      <button class="btn btn-primary" onclick="adminSaveQuiz('${gid}',${index})">${t.buttons.save}</button>
      <button class="btn btn-danger" onclick="renderAdminQuizList('${gid}')">${t.buttons.cancel}</button>
    </div></div>`;
  container.innerHTML = html;
}
function adminSaveQuiz(gid,index){
  const g = data.groups.find(x=>x.id===gid); if(!g || !g.story) return;
  const qtext = document.getElementById('aq_q').value.trim();
  const opts = document.getElementById('aq_opts').value.split(',').map(s=>s.trim()).filter(Boolean);
  const a = document.getElementById('aq_a').value.trim();
  if(!qtext || opts.length<2 || !a){ alert('Soru, en az 2 seÃ§enek ve doÄŸru cevap gerekli'); return; }
  g.story.quiz[index] = {q:qtext, options:opts, a};
  renderAdminQuizList(gid);
  saveDataOverride(); 
}

function adminDeleteQuiz(gid,index){ 
    if(!confirm('Testi sil?')) return; 
    const g = data.groups.find(x=>x.id===gid); 
    if(!g||!g.story) return; 
    g.story.quiz.splice(index,1); 
    renderAdminQuizList(gid); 
    saveDataOverride(); 
}

/* ---------- All sentences table ---------- */
function renderAllSentencesTable(){
  const container = document.getElementById('allSentencesTable'); 
  const t = (data.translations[data.settings.language || 'tr'] && Object.keys(data.translations[data.settings.language || 'tr']).length > 0) ? data.translations[data.settings.language || 'tr'] : data.translations.tr;
  let html = `<table><thead><tr><th>${t.labels.group}</th><th>${t.labels.verb}</th><th>${t.labels.section}</th><th>${t.labels.index}</th><th>${t.labels.tr}</th><th>${t.labels.de}</th></tr></thead><tbody>`;
  Object.entries(data.content||{}).forEach(([key,arr])=>{
    const m = key.match(/^(.+)_s(\d+)$/);
    if(!m) return;
    const vid = m[1]; const sec = m[2];
    let verbLabel = vid;
  
    let groupLabel = '';
    for(const g of Object.keys(data.verbs||{})){
      const vs = data.verbs[g]||[];
      const vv = vs.find(v=>v.id===vid);
      if(vv){
        groupLabel = (data.groups.find(x=>x.id===g)||{}).name || g;
        verbLabel = (vv.verbTR||vv.verbDE) || vid;
        break;
      }
    }
    (arr||[]).forEach((s,i)=>{
      html += `<tr><td>${escapeHtml(groupLabel)}</td><td>${escapeHtml(verbLabel)}</td><td>${escapeHtml(data.sections[sec]||sec)}</td><td>${i}</td><td>${escapeHtml(s.tr||'')}</td><td>${escapeHtml(s.de||'')}</td></tr>`;
    });
  });
  html += '</tbody></table>';
  container.innerHTML = html;
}

/* Export sentences CSV (simple) */
function exportSentencesCsv(){
  let rows = [['Grup','Fiil','BÃ¶lÃ¼m','Index','TR','DE']];
  Object.entries(data.content||{}).forEach(([key,arr])=>{
    const m = key.match(/^(.+)_s(\d+)$/);
    if(!m) return;
    const vid = m[1]; const sec = m[2];
    let verbLabel = vid; let groupLabel = '';
    for(const g of Object.keys(data.verbs||{})){
      const vs = data.verbs[g]||[];
        const vv = vs.find(v=>v.id===vid);
      if(vv){
        groupLabel = (data.groups.find(x=>x.id===g)||{}).name || g;
        verbLabel = (vv.verbTR||vv.verbDE) || vid;
        break;
      }
    }
    (arr||[]).forEach((s,i)=>{
      rows.push([groupLabel, verbLabel, data.sections[sec]||sec, i, s.tr||'', s.de||'']);
    });
  });
  const csv = rows.map(r=>r.map(c=>`"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'sentences.csv'; a.click(); URL.revokeObjectURL(url); alert('CSV indirildi');
}

/* ---------- JSON paste loader ---------- */
function loadJsonFromTextarea(){
  const txt = document.getElementById('jsonPaste').value.trim();
  const t = (data.translations[data.settings.language || 'tr'] && Object.keys(data.translations[data.settings.language || 'tr']).length > 0) ? data.translations[data.settings.language || 'tr'] : data.translations.tr;
  if(!txt){ alert('JSON yapÄ±ÅŸtÄ±rÄ±n'); return; }
  try{
    const imported = JSON.parse(txt);
    
    const defaultTranslations = JSON.parse(JSON.stringify(data.translations));

    data.groups = imported.groups;
    data.verbs = imported.verbs;
    data.content = imported.content;
    if(imported.sections) data.sections = imported.sections;
    if(imported.sectionsHints) data.sectionsHints = imported.sectionsHints;
    if(imported.hints) data.hints = imported.hints;
    if(imported.settings) data.settings = Object.assign(data.settings || {}, imported.settings);

    if (imported.translations) {
      data.translations = deepMerge(defaultTranslations, imported.translations);
    } else {
      data.translations = defaultTranslations;
    }
      
    saveDataOverride();

    alert('âœ“ YapÄ±ÅŸtÄ±rÄ±lan JSON yÃ¼klendi.'); 
    document.getElementById('jsonPaste').value='';
    loadSettings(); 
    showView('mainMenu');
  } catch(e){ alert(`${t.messages.loadError} ${e.message}`); }
}


/* ---------- YENÄ°: Admin Toplu YÃ¼kleme (TSV/Excel) AracÄ± ---------- */

function showTsvImporter() {
  document.getElementById('adminContentArea').innerHTML = '';
  document.getElementById('adminTsvArea').style.display = 'block';
  document.getElementById('tsvPasteArea').value = ''; 
}

function parseAndImportTsv() {
  const tsvData = document.getElementById('tsvPasteArea').value.trim();
  const t = (data.translations[data.settings.language || 'tr'] && Object.keys(data.translations[data.settings.language || 'tr']).length > 0) ? data.translations[data.settings.language || 'tr'] : data.translations.tr;

  if (!tsvData) {
    alert('LÃ¼tfen veriyi yapÄ±ÅŸtÄ±rÄ±n.');
    return;
  }

  const lines = tsvData.split('\n');
  
  let sentencesAdded = 0;
  let hintsAdded = 0;
  let errors = 0;

  if (!data.content) data.content = {};
  if (!data.hints) data.hints = { sentences: {}, verbs: {}, sections: {} };
  if (!data.hints.sentences) data.hints.sentences = {};

  lines.forEach((line, lineIndex) => {
    if (line.trim() === '') return; 

    const columns = line.split('\t');

    if (columns.length < 5) {
      console.error(`SatÄ±r ${lineIndex + 1}: Yetersiz sÃ¼tun. (En az 5 gerekli)`);
      errors++;
      return; 
    }

    const grupId = columns[0].trim();
    const fiilId = columns[1].trim();
    const bolumNum = columns[2].trim();
    const tr = columns[3].trim();
    const de = columns[4].trim();
    const cumleIpucu = (columns[5] || '').trim(); 

    if (!grupId || !fiilId || !bolumNum || !tr || !de) {
      console.error(`SatÄ±r ${lineIndex + 1}: Gerekli alanlar boÅŸ. (Grup, Fiil, BÃ¶lÃ¼m, TR, DE)`);
      errors++;
      return; 
    }

    try {
      const contentKey = `${fiilId}_s${bolumNum}`;
      if (!data.content[contentKey]) {
        data.content[contentKey] = [];
      }
      
      const newSentenceIndex = data.content[contentKey].length;
      data.content[contentKey].push({ tr: tr, de: de });
      sentencesAdded++;

      if (cumleIpucu) {
        const hintKey = `${fiilId}_s${bolumNum}_${newSentenceIndex}`;
        data.hints.sentences[hintKey] = cumleIpucu;
        hintsAdded++;
      }

    } catch (e) {
      console.error(`SatÄ±r ${lineIndex + 1} iÅŸlenirken hata: ${e.message}`);
      errors++;
    }
  });

  if (sentencesAdded > 0) {
    saveDataOverride(); 
  }

  alert(
    `Toplu YÃ¼kleme TamamlandÄ±!\n\n` +
    `âœ… Eklenen CÃ¼mle SayÄ±sÄ±: ${sentencesAdded}\n` +
    `ğŸ’¡ Eklenen Ä°pucu SayÄ±sÄ±: ${hintsAdded}\n` +
    `âŒ HatalÄ± SatÄ±r SayÄ±sÄ±: ${errors}`
  );

  document.getElementById('tsvPasteArea').value = '';
  document.getElementById('adminTsvArea').style.display = 'none';
}
/* ---------- Admin: Toplu YÃ¼kleme AracÄ± SONU ---------- */


/* ---------- Utils ---------- */
function escapeHtml(t){ if(t===undefined||t===null) return ''; return String(t).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

function isObject(item) {
  return (item && typeof item === 'object' && !Array.isArray(item));
}
function deepMerge(target, source) {
  let output = Object.assign({}, target);
  if (isObject(target) && isObject(source)) {
    Object.keys(source).forEach(key => {
      if (isObject(source[key])) {
        if (!(key in target))
          Object.assign(output, { [key]: source[key] });
        else
          output[key] = deepMerge(target[key], source[key]);
      } else {
        Object.assign(output, { [key]: source[key] });
      }
    });
  }
  return output;
}

/* ---------- Init ---------- */
function init(){
  loadDataOverride();
  
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('service-worker.js').then(function(registration) {
      console.log('ServiceWorker registration successful with scope: ', registration.scope);
    }, function(err) {
      console.log('ServiceWorker registration failed: ', err);
    }); 
  }

  // Event Listener'larÄ± ekle
  const modeToggleBtn = document.getElementById('modeToggleBtn');
  if(modeToggleBtn) modeToggleBtn.addEventListener('click', toggleNightMode);
  
  const nightModeToggle = document.getElementById('nightModeToggle');
  if(nightModeToggle) nightModeToggle.addEventListener('change', toggleNightMode);

  // --- MÃ¼zik Ã‡alarÄ± BaÅŸlat (Yerel MP3) ---
  const streamURL = './telifsiz-klasik.mp3'; 
  musicPlayer = new MusicPlayer(streamURL, 'musicVolumeSlider', 'musicToggleBtn');
  
  const musicBtn = document.getElementById('musicToggleBtn');
  const volumeSlider = document.getElementById('musicVolumeSlider');
  
  if (musicBtn) {
    musicBtn.addEventListener('click', () => {
      musicPlayer.toggleMusic();
    });
  }
  if (volumeSlider) {
    volumeSlider.addEventListener('input', (e) => {
      musicPlayer.setVolume(e.target.value);
    });
  }
  // --- MÃ¼zik Ã‡alar Kodu SONU ---

  loadSettings(); 
  loadProgress(); 
  loadSrsData();  
  
  updateConversionButtons();

  console.log('Verb Matrix v2.9.3 (TTS GÃ¼ncellemesi) hazÄ±r.');
}

window.addEventListener('DOMContentLoaded', init);

</script>
</body>
</html>
