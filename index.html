function updateUITexts(){
  const lang = data.settings.language || 'tr';
  
  const t = (data.translations[lang] && Object.keys(data.translations[lang]).length > 0) 
            ? data.translations[lang] 
            : data.translations.tr;

  document.querySelectorAll('[data-translate-key]').forEach(el => {
    const key = el.dataset.translateKey;
    const translation = getProperty(t, key);
    
    if (translation) {
      if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
        if (el.placeholder !== undefined) el.placeholder = translation;
      } else {
        el.textContent = translation;
      }
    } else {
      console.warn(`Translation key not found: ${key} for lang: ${lang}`);
    }
  });
  
  // YENÄ°: Otomatik Dinle ve YavaÅŸ Mod butonlarÄ±nÄ±n metinlerini de dil deÄŸiÅŸiminde gÃ¼ncelle
  const autoPlayBtn = document.getElementById('autoPlayBtn');
  if (autoPlayBtn) {
    if (state.autoPlayAudio) {
        autoPlayBtn.innerHTML = `<span class='led-indicator active' id='autoPlayLed'></span>Otomatik Aktif`; // Bu metin de Ã§evrilebilir
    } else {
        autoPlayBtn.innerHTML = `<span class='led-indicator' id='autoPlayLed'></span>Otomatik Dinle`; // Bu metin de Ã§evrilebilir
    }
  }
  updateSpeedButtonUI(); // YavaÅŸ mod butonunu gÃ¼ncelle
}


function changeLanguage(lang, btnEl){
  data.settings.language = lang;
  document.querySelectorAll('.lang-btn').forEach(b=>b.classList.remove('active'));
  if(btnEl) btnEl.classList.add('active');
  updateUITexts();
  saveSettings();
}

function toggleNightMode(){
  const body = document.body;
  const on = body.classList.toggle('night-mode');
  data.settings.nightMode = on;
  const toggleCheckbox = document.getElementById('nightModeToggle');
  if(toggleCheckbox) toggleCheckbox.checked = on;
  saveSettings();
}

function saveSettings(){ try{ localStorage.setItem('verbmatrix_settings', JSON.stringify(data.settings)); }catch(e){} }
function loadSettings(){
  try{
    const s = JSON.parse(localStorage.getItem('verbmatrix_settings')||'{}');
    if(s.language) data.settings.language = s.language;
    if(typeof s.nightMode === 'boolean') data.settings.nightMode = s.nightMode;
    if(s.conversionMode) data.settings.conversionMode = s.conversionMode; 
  }catch(e){}
  const toggleCheckbox = document.getElementById('nightModeToggle');
  if(toggleCheckbox) {
      toggleCheckbox.checked = !!data.settings.nightMode;
  }
  if(data.settings.nightMode) document.body.classList.add('night-mode'); else document.body.classList.remove('night-mode');
  document.querySelectorAll('.lang-btn').forEach(b=>b.classList.remove('active'));
  const map = {tr:'langTR', de:'langDE', en:'langEN'};
  const btn = document.getElementById(map[data.settings.language]||'langTR');
  if(btn) btn.classList.add('active');
  updateUITexts();
}

/* ---------- Quiz Ä°lerleme KalÄ±cÄ±lÄ±ÄŸÄ± FonksiyonlarÄ± ---------- */
function saveProgress(){
  try {
    localStorage.setItem('verbmatrix_progress_answers', JSON.stringify(state.answers));
  } catch (e) {
    console.error("Quiz ilerlemesi kaydedilemedi:", e);
  }
}

function loadProgress(){
  try {
    const savedAnswers = localStorage.getItem('verbmatrix_progress_answers');
    if (savedAnswers) {
      state.answers = JSON.parse(savedAnswers);
    }
  } catch (e) {
    console.error("Quiz ilerlemesi yÃ¼klenemedi:", e);
  }
}
/* ---------------------------------------------------- */

function loadAndShowGroupMenu(){
  const container = document.getElementById('groupButtons');
  container.innerHTML = '';
  const lang = data.settings.language || 'tr';
  const t = (data.translations[lang] && Object.keys(data.translations[lang]).length > 0) ? data.translations[lang] : data.translations.tr;

  if(!data.groups || data.groups.length===0){
    container.innerHTML = `<div class="content-box">${t.messages.noGroups}</div>`;
    showView('groupMenu'); 
    return;
  }
  
  const grid = document.createElement('div');
  grid.className = 'group-story-grid';
  
  data.groups.forEach(g=>{
    const groupBtn = document.createElement('button');
    groupBtn.className = 'btn btn-primary';
    groupBtn.innerHTML = `<strong>${g.name}</strong><span class="small-muted">${g.nameDE || ''}</span>`;
    groupBtn.onclick = ()=>selectGroup(g.id);
    grid.appendChild(groupBtn);

    const storyBtn = document.createElement('button');
    storyBtn.className = 'btn btn-warning';
    if (g.story && g.story.title) {
      storyBtn.textContent = g.story.title;
      storyBtn.onclick = ()=>showGroupStory(g.id); 
    } else {
      storyBtn.textContent = t.messages.noStoryAvailable;
      storyBtn.classList.add('disabled');
      storyBtn.disabled = true;
    }
    grid.appendChild(storyBtn);
  });
  container.appendChild(grid);
  showView('groupMenu');
}


function selectGroup(id){
  state.group = id; state.groupData = data.groups.find(x=>x.id===id) || null;
  const verbs = (data.verbs[id]||[]).filter(v=>v.id);
  const container = document.getElementById('verbButtons'); container.innerHTML='';
  if(verbs.length===0){ 
    const lang = data.settings.language || 'tr';
    const t = (data.translations[lang] && Object.keys(data.translations[lang]).length > 0) ? data.translations[lang] : data.translations.tr;
    container.innerHTML = `<div class="content-box">${t.messages.noVerbs}</div>`; 
    showView('verbMenu'); 
    return; 
  }
  verbs.forEach(v=>{
    const b = document.createElement('button'); b.className='btn btn-primary'; b.textContent = `${v.verbTR || v.verbDE}` + (v.verbDE? ' ('+v.verbDE+')':''); b.onclick = ()=>selectVerb(v.id); container.appendChild(b);
  });
  showView('verbMenu');
}

function selectVerb(verbId){
  state.verb = verbId;
  const container = document.getElementById('sectionButtons'); container.innerHTML='';
  
  Object.entries(data.sections).forEach(([num,name])=>{
    const b = document.createElement('button');
    const key = `${verbId}_s${num}`;
    const contentArray = data.content[key] || [];
    const sentenceCount = contentArray.length;
    
    b.textContent = `${num}. ${name} (${sentenceCount})`;
    
    if (sentenceCount > 0) {
      b.className='btn btn-primary';
      b.onclick = ()=>selectSection(parseInt(num));
    } else {
      b.className='btn btn-danger disabled';
      b.disabled = true;
    }
    container.appendChild(b);
  });
  
  showView('sectionMenu');
}

function selectSection(sectionNum){
  state.section = sectionNum;
  const container = document.getElementById('modeButtons'); container.innerHTML='';
  
  const modes = [
    {id:'study', name:'ðŸ“– Ã‡alÄ±ÅŸma (SRS)'},
    {id:'cloze', name:'ðŸ”² BoÅŸluk Doldurma'},
    {id:'wordorder', name:'ðŸ”¤ Kelimeleri SÄ±ralama'},
    {id:'quiz', name:'ðŸŽ¯ Quiz'}
  ];
  
  modes.forEach(m=>{
    const b = document.createElement('button'); b.className='btn btn-secondary'; b.textContent = m.name; b.onclick = ()=>startMode(m.id); container.appendChild(b);
  });
  showView('modeMenu');
}
/* ---------- Learning flow ---------- */
function startMode(modeId){
  state.mode = modeId; 
  state.showAnswer=false; 
  state.userAnswer=''; 
  state.correctAnswer=''; 
  state.showResult=false;

  const verbObj = (data.verbs[state.group]||[]).find(v=>v.id===state.verb);
  const title = `${(verbObj && (verbObj.verbTR||verbObj.verbDE)) || 'Fiil'} - ${data.sections[state.section]} - ${modeId}`;
  document.getElementById('learningTitle').textContent = title;

  // --- SRS / QUIZ AYRIMI ---
  if (modeId === 'study') {
    loadSrsData(); 
    const sentences = getSentences();
    const now = Date.now();
    state.dueCards = []; 

    for (let i = 0; i < sentences.length; i++) {
        const cardData = getCardSrsData(i); 
        if (cardData.nextReview <= now) {
            state.dueCards.push(i); 
        }
    }
    
    state.dueCards = shuffle(state.dueCards); 
    state.dueCardPos = 0; 
    
    if (state.dueCards.length === 0) {
        const t = (data.translations[data.settings.language || 'tr'] && Object.keys(data.translations[data.settings.language || 'tr']).length > 0) ? data.translations[data.settings.language || 'tr'] : data.translations.tr;
        document.getElementById('learningContent').innerHTML = `<div class="content-box"><h3 style="text-align:center">${t.messages.noDueCards}</h3></div>`;
        document.getElementById('progressText').textContent = "0 / 0";
        document.getElementById('progressFill').style.width = '100%';
        document.getElementById('progressFill').textContent = '100%';
        showView('learningView');
        return;
    }

  } else {
    state.answers = []; 
    state.dueCards = []; 
    state.dueCardPos = 0; 
  }

  showLearning();
}

function showLearning(){
  const sentences = getSentences();
  const lang = data.settings.language || 'tr';
  const t = (data.translations[lang] && Object.keys(data.translations[lang]).length > 0) ? data.translations[lang] : data.translations.tr;
  
  resetSpeechButtons(); 

  if (sentences.length === 0) {
    alert(t.messages.noSentences); 
    showView('sectionMenu'); 
    return;
  }
  
  if (state.mode === 'study') {
      if (state.dueCardPos >= state.dueCards.length) {
          showCompletion(state.dueCards.length);
          return;
      }
      updateProgress(state.dueCards.length);
  } else {
      if (state.dueCardPos >= sentences.length) {
          showCompletion(sentences.length);
          return;
      }
      updateProgress(sentences.length);
  }
  
  renderSentence(sentences); 
  showView('learningView');
}

function updateProgress(total){
  const currQuestionNum = Math.min(state.dueCardPos + 1, total); 
  const completedCount = state.dueCardPos; 
  
  const percent = total === 0 ? 0 : Math.round((completedCount / total) * 100); 
  
  document.getElementById('progressFill').style.width = percent + '%';
  document.getElementById('progressFill').textContent = percent + '%';
  document.getElementById('progressText').textContent = `${currQuestionNum} / ${total}`;
}

function getSentences(){ return data.content[`${state.verb}_s${state.section}`] || []; }
function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]] } return a; }

function buildHintHtml(verbId, sectionNum, sentenceIndex){
  let html = '';
  const sentKey = `${verbId}_s${sectionNum}_${sentenceIndex}`;
  const secKey = `${verbId}_s${sectionNum}`;
  const secCode = 'B' + sectionNum;

  if(data.hints && data.hints.sentences && data.hints.sentences[sentKey]){
    html += `<div class="hint-item"><strong>Ä°pucu (CÃ¼mle):</strong> ${escapeHtml(data.hints.sentences[sentKey])}</div>`;
  }
  if(data.hints && data.hints.sections && data.hints.sections[secKey]){
    html += `<div class="hint-item"><strong>Ä°pucu (BÃ¶lÃ¼m - Fiil):</strong> ${escapeHtml(data.hints.sections[secKey])}</div>`;
  }
  if(data.hints && data.hints.verbs && data.hints.verbs[verbId]){
    html += `<div class="hint-item"><strong>Ä°pucu (Fiil):</strong> ${escapeHtml(data.hints.verbs[verbId])}</div>`;
  }
  if(data.sectionsHints && data.sectionsHints[secCode]) {
      html += `<div class="hint-item"><strong>Ä°pucu (Genel BÃ¶lÃ¼m):</strong> ${escapeHtml(data.sectionsHints[secCode])}</div>`;
  }
  
  return html;
}

function renderSentence(sentences){
  const container = document.getElementById('learningContent');
  document.getElementById('resultArea').innerHTML=''; document.getElementById('answerArea').innerHTML=''; 
  const hintPanelEl = document.getElementById('hintPanel');
  const quickEditPanel = document.getElementById('quickEditPanel');
  
  quickEditPanel.style.display = 'none';
  hintPanelEl.style.display = state.hintPanelVisible ? 'block' : 'none';
  hintPanelEl.innerHTML = ''; 
  state.showResult = false;

  let originalIndex; 
  if (state.mode === 'study') {
      if(state.dueCardPos >= state.dueCards.length){ 
          showCompletion(state.dueCards.length); 
          return; 
      }
      originalIndex = state.dueCards[state.dueCardPos];
  } else {
      if(state.dueCardPos >= sentences.length){ 
          showCompletion(sentences.length); 
          return; 
      }
      originalIndex = state.dueCardPos; 
  }
  
  const sent = sentences[originalIndex];
  if (!sent) { 
      console.error("CÃ¼mle bulunamadÄ±, index:", originalIndex);
      return; 
  }
  
  container.innerHTML = '';
  const hintHtml = buildHintHtml(state.verb, state.section, originalIndex);

  const lang = data.settings.language || 'tr';
  const t = (data.translations[lang] && Object.keys(data.translations[lang]).length > 0) ? data.translations[lang] : data.translations.tr;

  const isTrDe = data.settings.conversionMode === 'tr-de';
  const questionText = isTrDe ? sent.tr : sent.de;
  const answerText = isTrDe ? sent.de : sent.tr;
  const questionLang = isTrDe ? 'TR' : 'DE';
  const answerLang = isTrDe ? 'DE' : 'TR';
  const placeholderKey = 'quiz'; 

  if(state.mode === 'study'){
    container.innerHTML = `<div class="sentence"><strong>${questionLang}:</strong> ${escapeHtml(questionText)}</div>
                             <div id="answerDisplay" class="sentence hidden"><strong>${answerLang}:</strong> ${escapeHtml(answerText)}</div>`;
  } else if(state.mode === 'cloze'){
    const words = sent.de.split(/\s+/).filter(Boolean);
    const idx = Math.floor(Math.random()*words.length);
    const correct = words[idx].replace(/[.,!?;:]$/,'');
    words[idx] = '_____';
    state.correctAnswer = correct;
    container.innerHTML = `<div class="sentence"><b>TR:</b> ${escapeHtml(sent.tr)}</div>
                             <div class="sentence"><b>DE:</b> ${escapeHtml(words.join(' '))}</div>
                             <input id="clozeInput" class="input-field" placeholder="${t.placeholders?.cloze || 'BoÅŸluÄŸu doldurun...'}">`;
  } else if(state.mode === 'wordorder'){
    const words = sent.de.split(/\s+/).filter(Boolean);
    
    // YENÄ° WORD ORDER MANTIÄžI: Kelimeleri havuzda karÄ±ÅŸtÄ±r
    if (state.wordPool.length === 0) {
      state.wordPool = shuffle([...words]);
    }
    state.wordSelected = []; 
    state.correctAnswer = words.join(' ');
    
    // YENÄ°: SatÄ±rlarÄ± DÄ°KEY sÄ±rada (TR -> KarÄ±ÅŸÄ±k -> SeÃ§ilen) gÃ¶ster
    container.innerHTML = `<div class="sentence"><b>TR:</b> ${escapeHtml(sent.tr)}</div>
                             <div class="word-order-area">
                               <div class="word-pool"><strong>KarÄ±ÅŸÄ±k Kelimeler:</strong><div id="wordPoolArea"></div></div>
                               <div class="word-selected"><strong>DÃ¼zenleme SatÄ±rÄ±:</strong><div id="wordSelectedArea"></div></div>
                             </div>`;
    renderWordOrder();
  } else if(state.mode === 'quiz'){
    state.correctAnswer = answerText; 
    container.innerHTML = `<div class="sentence"><b>${questionLang}:</b> ${escapeHtml(questionText)}</div>
                             <input id="quizInput" class="input-field" placeholder="${t.placeholders?.[placeholderKey] || 'Ã‡eviriyi yazÄ±n...'}">`;
  }
  
  if(hintHtml && state.hintPanelVisible){ 
    hintPanelEl.innerHTML = hintHtml; 
    hintPanelEl.style.display = 'block'; 
  } else {
    hintPanelEl.innerHTML = '';
    hintPanelEl.style.display = 'none';
  }

  const btnDE = document.getElementById('btnPlayDE');
  const btnTR = document.getElementById('btnPlayTR');
  
  if (state.mode !== 'study' && !state.showResult) {
      btnDE.disabled = true; btnDE.classList.add('disabled');
      btnTR.disabled = true; btnTR.classList.add('disabled');
  } else {
      btnDE.disabled = false; btnDE.classList.remove('disabled');
      btnTR.disabled = false; btnTR.classList.remove('disabled');
  }

  const actionBtn = document.getElementById('actionBtn');
  const srsControls = document.getElementById('srsControls');

  if (state.mode === 'study') {
      if (state.showAnswer) {
          actionBtn.style.display = 'none';
          srsControls.style.display = 'flex';
      } else {
          actionBtn.style.display = 'block';
          srsControls.style.display = 'none';
          actionBtn.textContent = t.buttons.show;
          actionBtn.onclick = handleAction;
      }
      document.querySelector('[onclick="previousQuestion()"]').style.display = 'none';
  } else {
      actionBtn.style.display = 'block';
      srsControls.style.display = 'none';
      actionBtn.textContent = t.buttons.check;
      actionBtn.onclick = handleAction;
      document.querySelector('[onclick="previousQuestion()"]').style.display = 'block';
  }
  
  if (state.mode === 'study') {
      updateProgress(state.dueCards.length);
  } else {
      updateProgress(sentences.length);
  }
}


function showQuickEditPanel(){
    if (!state.verb || !state.section) return;
    const sentences = getSentences();
    let originalIndex;

    if (state.mode === 'study') {
        if (state.dueCardPos >= state.dueCards.length) return;
        originalIndex = state.dueCards[state.dueCardPos];
    } else {
        if (state.dueCardPos >= sentences.length) return;
        originalIndex = state.dueCardPos;
    }

    const sent = sentences[originalIndex];
    const hintKey = getSrsKey(originalIndex);
    const currentHint = (data.hints && data.hints.sentences && data.hints.sentences[hintKey]) || '';

    document.getElementById('qe_tr').value = sent.tr || '';
    document.getElementById('qe_de').value = sent.de || '';
    document.getElementById('qe_hint').value = currentHint;
    document.getElementById('quickEditTitle').textContent = `HÄ±zlÄ± DÃ¼zenle (Soru ${originalIndex + 1})`;
    document.getElementById('quickEditPanel').style.display = 'block';
}

function saveQuickEdit(){
    if (!state.verb || !state.section) return;
    const sentences = getSentences();
    let originalIndex;

    if (state.mode === 'study') {
        originalIndex = state.dueCards[state.dueCardPos];
    } else {
        originalIndex = state.dueCardPos;
    }
    
    const hintKey = getSrsKey(originalIndex);

    const newTr = document.getElementById('qe_tr').value.trim();
    const newDe = document.getElementById('qe_de').value.trim();
    const newHint = document.getElementById('qe_hint').value.trim();

    sentences[originalIndex].tr = newTr;
    sentences[originalIndex].de = newDe;

    if(!data.hints) data.hints = {sentences:{}, verbs:{}, sections:{}};
    if(!data.hints.sentences) data.hints.sentences = {};
    
    if (newHint) { data.hints.sentences[hintKey] = newHint; } 
    else { delete data.hints.sentences[hintKey]; }
    
    saveDataOverride();
    document.getElementById('quickEditPanel').style.display = 'none';
    renderSentence(sentences);
    
    const t = (data.translations[data.settings.language || 'tr'] && Object.keys(data.translations[data.settings.language || 'tr']).length > 0) ? data.translations[data.settings.language || 'tr'] : data.translations.tr;
    alert(t.messages.quickEditSaved);
}


function renderWordOrder(){
  const pool = document.getElementById('wordPoolArea'); 
  const sel = document.getElementById('wordSelectedArea');
  pool.innerHTML=''; 
  sel.innerHTML='';
  
  // Ãœst satÄ±rdaki seÃ§ilen kelimeler (DÃ¼zenleme SatÄ±rÄ±)
  state.wordSelected.forEach((w,i)=>{
    const d = document.createElement('div'); 
    d.className='word-item top'; 
    d.textContent = w; 
    d.onclick = ()=> unselectWord(i, w); 
    sel.appendChild(d);
  });
  
  // Alt satÄ±rdaki kelime havuzu (KarÄ±ÅŸÄ±k Kelimeler)
  state.wordPool.forEach((w,i)=>{
    const d = document.createElement('div'); 
    d.className='word-item'; 
    d.textContent = w; 
    d.onclick = ()=> selectWordFromPool(i); 
    pool.appendChild(d);
  });
}
function selectWordFromPool(index){ 
    const word = state.wordPool[index];
    state.wordSelected.push(word); 
    state.wordPool.splice(index, 1); 
    renderWordOrder(); 
}
function unselectWord(index, word){ 
    const removedWord = state.wordSelected.splice(index, 1)[0]; 
    state.wordPool.push(removedWord); 
    renderWordOrder(); 
}

function rateCard(difficulty) {
    const sentences = getSentences();
    const originalIndex = state.dueCards[state.dueCardPos];

    updateCardSrsData(originalIndex, difficulty);

    state.dueCardPos++;
    state.showAnswer = false;
    
    renderSentence(sentences);
}


// GÃœNCELLENDÄ°: handleAction (Otomatik Dinle mantÄ±ÄŸÄ± eklendi)
function handleAction(){
  const sents = getSentences();
  const btn = document.getElementById('actionBtn');
  const resultArea = document.getElementById('resultArea'), answerArea = document.getElementById('answerArea');
  const lang = data.settings.language || 'tr';
  const t = (data.translations[lang] && Object.keys(data.translations[lang]).length > 0) ? data.translations[lang] : data.translations.tr;

  const btnDE = document.getElementById('btnPlayDE');
  const btnTR = document.getElementById('btnPlayTR');

  // YENÄ°: Otomatik Ã‡alma Tetikleyicisi
  // "GÃ¶ster" veya "Kontrol Et" butonuna basÄ±ldÄ±ÄŸÄ±nda, sonucu gÃ¶ster VE otomatik Ã§alma aÃ§Ä±ksa Almanca'yÄ± Ã§al.
  const triggerAutoPlay = () => {
      if (state.autoPlayAudio) {
          // Almanca'yÄ± (veya DE->TR modunda ise TÃ¼rkÃ§e'yi) Ã§al.
          // Almanca Ã¶ÄŸrenme odaklÄ± olduÄŸu iÃ§in 'de' tercih edilmiÅŸtir.
          playCurrentSentence('de');
      }
  };

  if(state.mode === 'study'){
    if(state.showAnswer){
      rateCard('medium'); 
    } else {
      const ad = document.getElementById('answerDisplay'); 
      if(ad) ad.classList.remove('hidden'); 
      state.showAnswer = true; 
      
      btn.style.display = 'none';
      document.getElementById('srsControls').style.display = 'flex';
      
      triggerAutoPlay(); // YENÄ°: Otomatik Ã§al
    }

  } else if(state.mode === 'cloze'){
    const input = document.getElementById('clozeInput'); const answer = (input && input.value.trim())||'';
    state.userAnswer = answer;
    const correct = state.correctAnswer || '';
    const ok = answer.toLowerCase() === correct.toLowerCase();
    resultArea.innerHTML = ok ? '<div class="result correct">âœ“ DoÄŸru!</div>' : '<div class="result incorrect">âœ— YanlÄ±ÅŸ!</div>';
    answerArea.innerHTML = `<div class="result"><strong>Sizin:</strong> ${escapeHtml(answer||'(boÅŸ)')}</div><div class="result"><strong>DoÄŸru:</strong> ${escapeHtml(correct)}</div>`;
    state.answers.push(!!ok);
    saveProgress(); 
    state.showResult=true; btn.textContent = t.buttons.next;
    btnDE.disabled = false; btnDE.classList.remove('disabled');
    btnTR.disabled = false; btnTR.classList.remove('disabled');
    btn.onclick = ()=>{ state.dueCardPos++; state.showAnswer=false; state.showResult=false; renderSentence(sents); };
    
    triggerAutoPlay(); // YENÄ°: Otomatik Ã§al
    
  } else if(state.mode === 'wordorder'){
    const user = state.wordSelected.join(' ').trim();
    const ok = user === state.correctAnswer;
    resultArea.innerHTML = ok ? '<div class="result correct">âœ“ DoÄŸru!</div>' : '<div class="result incorrect">âœ— YanlÄ±ÅŸ!</div>';
    answerArea.innerHTML = `<div class="result"><strong>Sizin:</strong> ${escapeHtml(user||'(boÅŸ)')}</div><div class="result"><strong>DoÄŸru:</strong> ${escapeHtml(state.correctAnswer)}</div>`;
    state.answers.push(!!ok);
    saveProgress(); 
    state.showResult=true; btn.textContent = t.buttons.next;
    btnDE.disabled = false; btnDE.classList.remove('disabled');
    btnTR.disabled = false; btnTR.classList.remove('disabled');
    btn.onclick = ()=>{ state.dueCardPos++; state.showAnswer=false; state.showResult=false; state.wordSelected=[]; state.wordPool=[]; renderSentence(sents); };
    
    triggerAutoPlay(); // YENÄ°: Otomatik Ã§al
    
  } else if(state.mode === 'quiz'){
    const input = document.getElementById('quizInput'); const answer = (input && input.value.trim())||'';
    const ok = answer.toLowerCase() === (state.correctAnswer||'').toLowerCase();
    resultArea.innerHTML = ok ? '<div class="result correct">âœ“ DoÄŸru! +3 Puan</div>' : '<div class="result incorrect">âœ— YanlÄ±ÅŸ!</div>';
    answerArea.innerHTML = `<div class="result"><strong>Sizin:</strong> ${escapeHtml(answer||'(boÅŸ)')}</div><div class="result"><strong>DoÄŸru:</strong> ${escapeHtml(state.correctAnswer)}</div>`;
    state.answers.push(ok?3:0);
    saveProgress(); 
    state.showResult=true; btn.textContent = t.buttons.next;
    btnDE.disabled = false; btnDE.classList.remove('disabled');
    btnTR.disabled = false; btnTR.classList.remove('disabled');
    btn.onclick = ()=>{ state.dueCardPos++; state.showAnswer=false; state.showResult=false; renderSentence(sents); };
    
    triggerAutoPlay(); // YENÄ°: Otomatik Ã§al
  }
}

function previousQuestion(){ 
  if (state.mode === 'study') return; 

  if(state.dueCardPos > 0){ 
      state.dueCardPos--; 
      state.showAnswer=false; 
      state.showResult=false; 
      renderSentence(getSentences()); 
  } 
}

function resetLearning(){ 
  const t = (data.translations[data.settings.language || 'tr'] && Object.keys(data.translations[data.settings.language || 'tr']).length > 0) ? data.translations[data.settings.language || 'tr'] : data.translations.tr;

  if (state.mode === 'study') {
      state.dueCardPos = 0;
      state.dueCards = shuffle(state.dueCards); 
  } else {
      state.dueCardPos = 0;
      state.answers = []; 
      saveProgress(); 
      alert(t.messages.progressReset); 
  }
  state.showAnswer=false; state.showResult=false; 
  renderSentence(getSentences()); 
}


function goToNextSection(sectionNum) {
    state.section = sectionNum;
    startMode(state.mode); 
}

function showCompletion(total){
  const t = (data.translations[data.settings.language || 'tr'] && Object.keys(data.translations[data.settings.language || 'tr']).length > 0) ? data.translations[data.settings.language || 'tr'] : data.translations.tr;
  let correctCount = 0;
  let scoreHtml = '';
  
  if (state.mode === 'study') {
      scoreHtml = `<p style="text-align:center">BugÃ¼n iÃ§in ${total} kartÄ± tekrar ettiniz!</p>`;
  } else {
      if(state.mode === 'quiz'){
        correctCount = state.answers.filter(a=>a>0).length;
      } else {
        correctCount = state.answers.filter(a=>a===true).length;
      }
      const percent = total===0?0:Math.round((correct/total)*100);
      scoreHtml = `<div class="score-display">${percent}%</div>
                   <p style="text-align:center">BaÅŸarÄ±: ${correctCount} / ${total}</p>`;
      saveProgress(); 
  }
  
  let nextButtonHtml = '';
  const sectionKeys = Object.keys(data.sections).map(Number).sort((a, b) => a - b);
  const currentSectionIndex = sectionKeys.indexOf(state.section);
  let nextSectionNum = null;
  if (currentSectionIndex > -1 && currentSectionIndex < sectionKeys.length - 1) {
      for (let i = currentSectionIndex + 1; i < sectionKeys.length; i++) {
          const potentialNextSec = sectionKeys[i];
          const contentKey = `${state.verb}_s${potentialNextSec}`;
          if (data.content[contentKey] && data.content[contentKey].length > 0) {
              nextSectionNum = potentialNextSec;
              break;
          }
      }
  }
  if (nextSectionNum) {
      nextButtonHtml = `<button class="btn btn-secondary" style="margin-top:10px;" onclick="goToNextSection(${nextSectionNum})">${t.buttons.nextSection} (${data.sections[nextSectionNum]})</button>`;
  }
  
  document.getElementById('learningContent').innerHTML = `<div class="content-box"><h3 style="text-align:center">ðŸŽ‰ TamamladÄ±nÄ±z!</h3>
    ${scoreHtml}
    ${nextButtonHtml} </div>`;
  
  document.getElementById('actionBtn').textContent='Tekrar BaÅŸla'; 
  document.getElementById('actionBtn').onclick = resetLearning;
  
  document.getElementById('actionBtn').style.display = 'block';
  document.getElementById('srsControls').style.display = 'none';

  document.getElementById('progressFill').style.width = '100%';
  document.getElementById('progressFill').textContent = '100%';
  document.getElementById('progressText').textContent = `${total} / ${total}`;
  
  document.getElementById('btnPlayDE').disabled = true; document.getElementById('btnPlayDE').classList.add('disabled');
  document.getElementById('btnPlayTR').disabled = true; document.getElementById('btnPlayTR').classList.add('disabled');
}

// GÃœNCELLENDÄ°: playCurrentSentence (iOS iÃ§in Anna/Markus'u zorlayan v2.9.3 mantÄ±ÄŸÄ±)
function playCurrentSentence(lang) {
    resetSpeechButtons(); 

    const sentences = getSentences();
    if (!sentences || sentences.length === 0) return;

    let originalIndex;
    if (state.mode === 'study') {
        if (state.dueCardPos >= state.dueCards.length) return;
        originalIndex = state.dueCards[state.dueCardPos];
    } else {
        if (state.dueCardPos >= sentences.length) return;
        originalIndex = state.dueCardPos;
    }
    
    const sent = sentences[originalIndex];
    if (!sent) return;

    const text = (lang === 'de') ? sent.de : sent.tr;
    const langCode = (lang === 'de') ? 'de-DE' : 'tr-TR';
    
    if (!text) return; 

    if (lang === 'de' && musicPlayer && musicPlayer.isPlaying) {
        musicPlayer.dim_music(true);
    }

    if('speechSynthesis' in window){
        const speakNow = () => {
            const voices = window.speechSynthesis.getVoices();
            const utter = new SpeechSynthesisUtterance(text);
            utter.lang = langCode;
            utter.rate = state.speechRate || 1;
            utter.pitch = 1; 
            utter.volume = 1; 
            
            // v2.9.3 Ses SeÃ§imi MantÄ±ÄŸÄ±: Anna/Markus'u zorla
            let voice = null;
            if (lang === 'de') {
                // 1. Anna veya Markus'u dene (yÃ¼ksek kaliteli sesler)
                voice = voices.find(v => v.lang.toLowerCase() === langCode.toLowerCase() && /anna|markus/i.test(v.name));
            }
            if (!voice) {
                // 2. Tam dil kodu eÅŸleÅŸmesini dene
                voice = voices.find(v => v.lang.toLowerCase() === langCode.toLowerCase());
            }
            if (!voice && lang === 'de') {
                 // 3. BÃ¶lge olmadan Almanca eÅŸleÅŸmesini dene
                 voice = voices.find(v => v.lang.toLowerCase().startsWith('de'));
            }

            if (voice) {
                utter.voice = voice;
            } else {
                console.warn("Uygun Almanca ses bulunamadÄ±, varsayÄ±lan kullanÄ±lacak.");
            }

            utter.onend = utter.onerror = () => {
                if (musicPlayer && musicPlayer.isPlaying) {
                    musicPlayer.dim_music(false);
                }
                resetSpeechButtons();
            };

            window.speechSynthesis.cancel();
            window.speechSynthesis.speak(utter);
        };

        // iOS/iPadOS iÃ§in kritik: Sesler yÃ¼klenmeden Ã¶nce boÅŸ dÃ¶nebilir
        if (window.speechSynthesis.getVoices().length === 0) {
            window.speechSynthesis.onvoiceschanged = function handler() {
                window.speechSynthesis.onvoiceschanged = null; 
                speakNow();
            };
        } else {
            speakNow();
        }

    } else {
        const t = (data.translations[data.settings.language || 'tr'] && Object.keys(data.translations[data.settings.language || 'tr']).length > 0) ? data.translations[data.settings.language || 'tr'] : data.translations.tr;
        alert(t.messages.ttsNotSupported);
        
        if (lang === 'de' && musicPlayer && musicPlayer.isPlaying) {
            musicPlayer.dim_music(false);
        }
    }
}

/* ---------- Story functions ---------- */
function showGroupStory(groupId){
  state.group = groupId; state.groupData = data.groups.find(g=>g.id===groupId) || null;
  const lang = data.settings.language || 'tr';
  const t = (data.translations[lang] && Object.keys(data.translations[lang]).length > 0) ? data.translations[lang] : data.translations.tr;
  if(!state.groupData || !state.groupData.story){ alert(t.messages.noStory); return; }
  
  document.getElementById('storyTitle').textContent = state.groupData.story.title || t.titles.story;
  renderStoryContent();
  showView('storyView');
}
function renderStoryContent(){
  const sc = document.getElementById('storyContent'); const s = state.groupData.story;
  sc.innerHTML = `<div class="story-section"><h3>Almanca</h3><div class="story-content">${escapeHtml(s.de||'').replace(/\n/g,'<br>')}</div></div>
                   <div class="story-section"><h3>TÃ¼rkÃ§e</h3><div class="story-content">${escapeHtml(s.tr||'').replace(/\n/g,'<br>')}</div></div>`;
}

// GÃœNCELLENDÄ°: playStoryAudio (iOS iÃ§in Anna/Markus'u zorlayan v2.9.3 mantÄ±ÄŸÄ±)
function playStoryAudio(lang) {
    resetSpeechButtons(); 

    const s = state.groupData && state.groupData.story;
    const t = (data.translations[data.settings.language || 'tr'] &&
               Object.keys(data.translations[data.settings.language || 'tr']).length > 0)
              ? data.translations[data.settings.language || 'tr']
              : data.translations.tr;

    if (!s) { alert(t.messages.noStoryFound); return; }

    const text = (lang === 'de') ? s.de : s.tr;
    const langCode = (lang === 'de') ? 'de-DE' : 'tr-TR';
    
    if (!text) return;

    if (lang === 'de' && musicPlayer && musicPlayer.isPlaying) {
        musicPlayer.dim_music(true);
    }

    if ('speechSynthesis' in window) {
        const speakNow = () => {
            const voices = window.speechSynthesis.getVoices();
            const utter = new SpeechSynthesisUtterance(text);
            utter.lang = langCode;
            utter.rate = state.speechRate || 1;
            utter.pitch = 1; // Ses tonunu normal tut
            utter.volume = 1; // Ses seviyesini tam tut

            // v2.9.3 Ses SeÃ§imi MantÄ±ÄŸÄ±: Anna/Markus'u zorla
            let voice = null;
            if (lang === 'de') {
                // 1. Anna veya Markus'u dene (yÃ¼ksek kaliteli sesler)
                voice = voices.find(v => v.lang.toLowerCase() === langCode.toLowerCase() && /anna|markus/i.test(v.name));
            }
            if (!voice) {
                // 2. Tam dil kodu eÅŸleÅŸmesini dene
                voice = voices.find(v => v.lang.toLowerCase() === langCode.toLowerCase());
            }
            if (!voice && lang === 'de') {
                 // 3. BÃ¶lge olmadan Almanca eÅŸleÅŸmesini dene
                 voice = voices.find(v => v.lang.toLowerCase().startsWith('de'));
            }

            if (voice) {
                utter.voice = voice;
            } else {
                console.warn("Uygun Almanca ses bulunamadÄ±, varsayÄ±lan kullanÄ±lacak.");
            }


            utter.onend = utter.onerror = () => {
                if (musicPlayer && musicPlayer.isPlaying) {
                    musicPlayer.dim_music(false);
                }
                resetSpeechButtons();
            };

            window.speechSynthesis.cancel();
            window.speechSynthesis.speak(utter);
        };

        // iOS/iPadOS iÃ§in kritik: Sesler yÃ¼klenmeden Ã¶nce boÅŸ dÃ¶nebilir
        if (window.speechSynthesis.getVoices().length === 0) {
            window.speechSynthesis.onvoiceschanged = function handler() {
                window.speechSynthesis.onvoiceschanged = null; // Sadece bir kere Ã§alÄ±ÅŸsÄ±n
                speakNow();
            };
        } else {
            speakNow();
        }

    } else {
        alert(t.messages.ttsNotSupported);
        if (lang === 'de' && musicPlayer && musicPlayer.isPlaying) {
            musicPlayer.dim_music(false);
        }
    }
}

function showStoryQuestions(){
  const story = state.groupData && state.groupData.story;
  const container = document.getElementById('storyQuestionsContent');
  const lang = data.settings.language || 'tr';
  const t = (data.translations[lang] && Object.keys(data.translations[lang]).length > 0) ? data.translations[lang] : data.translations.tr;

  container.innerHTML = '';
  if(!story || !story.quiz || !Array.isArray(story.quiz) || story.quiz.length===0){ 
    container.innerHTML = `<p>${t.messages.noStoryQuestions}</p>`; 
    showView('storyQuestionsView'); 
    return; 
  }
  
  const quiz = story.quiz;
  let html = '<form id="storyQuizForm">';
  quiz.forEach((q,i)=>{
    html += `<div style="margin:10px 0;padding:10px;border-radius:8px;background:#fff;color:#0f1724"><b>${i+1}. ${escapeHtml(q.q)}</b><div style="margin-top:8px">`;
    q.options.forEach((opt,j)=>{
      html += `<label style="display:block;margin:6px 0"><input type="radio" name="sq${i}" value="${escapeHtml(opt)}"> ${escapeHtml(opt)}</label>`;
    });
    html += `</div></div>`;
  });
  html += `<div class="button-group-row"><button type="button" class="btn btn-primary" onclick="checkStoryAnswers()">${t.buttons.show}</button></div></form>`;
  container.innerHTML = html;
  showView('storyQuestionsView');
}
function checkStoryAnswers(){
  const story = state.groupData.story; const quiz = story.quiz;
  let correct=0;
  quiz.forEach((q,i)=>{
    const sel = document.querySelector(`input[name="sq${i}"]:checked`);
    if(sel && sel.value === q.a) correct++;
  });
  alert(`ðŸŽ¯ ${correct} / ${quiz.length} doÄŸru`);
}

/* ---------- Data import/export/debug ---------- */
function importData(){
  const input = document.getElementById('fileInput');
  input.onchange = async (e)=>{ 
    const t = (data.translations[data.settings.language || 'tr'] && Object.keys(data.translations[data.settings.language || 'tr']).length > 0) ? data.translations[data.settings.language || 'tr'] : data.translations.tr;
    try{
      const file = e.target.files[0]; if(!file) return;
      const text = await file.text(); const imported = JSON.parse(text);
      
      const defaultTranslations = JSON.parse(JSON.stringify(data.translations));

      data.groups = imported.groups;
      data.verbs = imported.verbs;
      data.content = imported.content;
      if(imported.sections) data.sections = imported.sections;
      if(imported.sectionsHints) data.sectionsHints = imported.sectionsHints;
      if(imported.hints) data.hints = imported.hints;
      if(imported.settings) data.settings = Object.assign(data.settings || {}, imported.settings);

      if (imported.translations) {
        data.translations = deepMerge(defaultTranslations, imported.translations);
      } else {
        data.translations = defaultTranslations;
      }
      
      saveDataOverride();
      
      alert(`${t.messages.dataLoaded} ${data.groups.length}`);
      loadSettings(); 
      showView('mainMenu');
    }catch(err){ 
      alert(`${t.messages.loadError} ${err.message}`); 
    } 
    input.value=''; 
  };
  input.click();
}
function exportData(){
  const json = JSON.stringify(data,null,2);
  const blob = new Blob([json],{type:'application/json'}); const url = URL.createObjectURL(blob); const a = document.createElement('a');
  a.href = url; a.download = 'verbmatrix_data.json'; a.click(); URL.revokeObjectURL(url); 
  const t = (data.translations[data.settings.language || 'tr'] && Object.keys(data.translations[data.settings.language || 'tr']).length > 0) ? data.translations[data.settings.language || 'tr'] : data.translations.tr;
  alert(t.messages.dataExported);
}
function debugData(){
  const t = (data.translations[data.settings.language || 'tr'] && Object.keys(data.translations[data.settings.language || 'tr']).length > 0) ? data.translations[data.settings.language || 'tr'] : data.translations.tr;
  let msg = `${t.messages.jsonStatus}\n\n`;
  msg += `Gruplar: ${(data.groups||[]).length}\n`;
  msg += `Verbs grup count: ${Object.keys(data.verbs||{}).length}\n`;
  msg += `Content keys: ${Object.keys(data.content||{}).length}\n`;
  msg += `SectionsHints (B#): ${Object.keys((data.sectionsHints||{})).length}\n`;
  msg += `Hints sentences: ${Object.keys((data.hints&&data.hints.sentences)||{}).length}\n`;
  
  loadSrsData();
  const srsCount = Object.keys(srsData).length;
  msg += `\nSRS Veri KayÄ±tlarÄ±: ${srsCount}\n`;
  
  alert(msg);
}
function resetProgressStorage(){ 
  state.answers=[]; 
  saveProgress(); 
  const t = (data.translations[data.settings.language || 'tr'] && Object.keys(data.translations[data.settings.language || 'tr']).length > 0) ? data.translations[data.settings.language || 'tr'] : data.translations.tr;
  alert(t.messages.progressReset); 
}
function loadProgressView(){
  loadProgress(); 
  const total = state.answers.length; const correct = state.answers.filter(a=> a===true || a>0 ).length;
  const percent = total===0?0:Math.round((correct/total)*100);
  const t = (data.translations[data.settings.language || 'tr'] && Object.keys(data.translations[data.settings.language || 'tr']).length > 0) ? data.translations[data.settings.language || 'tr'] : data.translations.tr;
  
  if (total === 0) {
    document.getElementById('progressStats').innerHTML = `<p class="small-muted">${t.messages.noProgress}</p>`;
  } else {
    document.getElementById('progressStats').innerHTML = `<div style="text-align:center"><h3>Quiz Ä°lerlemesi</h3><div class="score-display">${percent}%</div><p>Toplam: ${total} | DoÄŸru: ${correct} | YanlÄ±ÅŸ: ${total-correct}</p></div>`;
  }
}

/* ---------- Hint forms & manager (Admin paneline taÅŸÄ±ndÄ±) ---------- */
function showHintForm(type){
  const area = document.getElementById('hintFormsArea'); area.innerHTML = '';
  const lang = data.settings.language || 'tr';
  const t = (data.translations[lang] && Object.keys(data.translations[lang]).length > 0) ? data.translations[lang] : data.translations.tr;

  if(type==='sentence'){
    area.innerHTML = `<div class="content-box"><h4>${t.admin.hintSentence}</h4>
      <label>${t.labels.group}</label><select id="hf_group" class="select-field"></select>
      <label>${t.labels.verb}</label><select id="hf_verb" class="select-field"></select>
      <label>${t.labels.section}</label><select id="hf_section" class="select-field"></select>
      <label>${t.labels.sentence}</label><select id="hf_sentence" class="select-field"></select>
      <label>${t.labels.hintText}</label><textarea id="hf_text" class="input-field"></textarea>
      <div class="button-group-row"><button class="btn btn-primary" onclick="saveSentenceHint()">${t.buttons.save}</button><button class="btn btn-danger" onclick="document.getElementById('hintFormsArea').innerHTML=''">${t.buttons.cancel}</button></div></div>`;
    fillSelect('hf_group', data.groups.map(g=>({v:g.id,t:g.name})), true); document.getElementById('hf_group').addEventListener('change', hf_loadVerbs);
  } else if(type==='verb'){
    area.innerHTML = `<div class="content-box"><h4>${t.admin.hintVerb}</h4>
      <label>${t.labels.group}</label><select id="vh_group" class="select-field"></select>
      <label>${t.labels.verb}</label><select id="vh_verb" class="select-field"></select>
      <label>${t.labels.hintText}</label><textarea id="vh_text" class="input-field"></textarea>
      <div class="button-group-row"><button class="btn btn-primary" onclick="saveVerbHint()">${t.buttons.save}</button><button class="btn btn-danger" onclick="document.getElementById('hintFormsArea').innerHTML=''">${t.buttons.cancel}</button></div></div>`;
    fillSelect('vh_group', data.groups.map(g=>({v:g.id,t:g.name})), true); document.getElementById('vh_group').addEventListener('change', vh_loadVerbs);
  } else if(type==='section'){
    area.innerHTML = `<div class="content-box"><h4>${t.admin.hintSection}</h4>
      <label>${t.labels.sectionCode}</label><input id="sh_section_code" class="input-field" placeholder="Ã¶rn: B1">
      <label>${t.labels.hintText}</label><textarea id="sh_text" class="input-field"></textarea>
      <div class="button-group-row"><button class="btn btn-primary" onclick="saveSectionHint()">${t.buttons.save}</button><button class="btn btn-danger" onclick="document.getElementById('hintFormsArea').innerHTML=''">${t.buttons.cancel}</button></div></div>`;
  }
}
function fillSelect(id, items, addEmpty){
  const s = document.getElementById(id); s.innerHTML=''; 
  if(addEmpty){ 
    const o=document.createElement('option'); o.value=''; o.textContent='SeÃ§in...'; s.appendChild(o); 
  }
  items.forEach(it=>{ const o=document.createElement('option'); o.value=it.v; o.textContent=it.t; s.appendChild(o); });
}
function hf_loadVerbs(){ const gid=document.getElementById('hf_group').value; const sel=document.getElementById('hf_verb'); sel.innerHTML=''; if(!gid) return; (data.verbs[gid]||[]).forEach(v=>{ const o=document.createElement('option'); o.value=v.id; o.textContent=(v.verbTR||v.verbDE); sel.appendChild(o); }); hf_loadSections(); }
function hf_loadSections(){ const verbId=document.getElementById('hf_verb').value; const sel=document.getElementById('hf_section'); sel.innerHTML=''; if(!verbId) return; Object.entries(data.sections).forEach(([num,name])=>{ const key = `${verbId}_s${num}`; if(data.content[key] && data.content[key].length>0){ const o=document.createElement('option'); o.value=num; o.textContent=`${num}. ${name}`; sel.appendChild(o); } }); hf_loadSentences(); }
function hf_loadSentences(){ const verbId=document.getElementById('hf_verb').value; const section=document.getElementById('hf_section').value; const sel=document.getElementById('hf_sentence'); sel.innerHTML=''; if(!verbId||!section) return; const arr = data.content[`${verbId}_s${section}`]||[]; arr.forEach((s,i)=>{ const o=document.createElement('option'); o.value=i; o.textContent = (s.tr||s.de||'').substring(0,80); sel.appendChild(o); }); }

function saveSentenceHint(){ 
    const verbId=document.getElementById('hf_verb').value; const section=document.getElementById('hf_section').value; const idx=document.getElementById('hf_sentence').value; const txt=document.getElementById('hf_text').value.trim(); 
    const t = (data.translations[data.settings.language || 'tr'] && Object.keys(data.translations[data.settings.language || 'tr']).length > 0) ? data.translations[data.settings.language || 'tr'] : data.translations.tr;
    if(!verbId||!section||idx===''||!txt){ alert(t.messages.allFieldsError); return; } 
    const key = `${verbId}_s${section}_${idx}`; 
    if(!data.hints) data.hints={sentences:{},verbs:{},sections:{}}; 
    data.hints.sentences[key] = txt; alert(t.messages.hintSaved); 
    document.getElementById('hintFormsArea').innerHTML=''; 
    if (state.currentView === 'adminHintView') { showHintManager('hintManagerArea'); }
    saveDataOverride(); 
}
function vh_loadVerbs(){ const gid=document.getElementById('vh_group').value; const sel=document.getElementById('vh_verb'); sel.innerHTML=''; if(!gid) return; (data.verbs[gid]||[]).forEach(v=>{ const o=document.createElement('option'); o.value=v.id; o.textContent=(v.verbTR||v.verbDE); sel.appendChild(o); }); }
function saveVerbHint(){ 
    const verbId = document.getElementById('vh_verb').value; const txt = document.getElementById('vh_text').value.trim(); 
    const t = (data.translations[data.settings.language || 'tr'] && Object.keys(data.translations[data.settings.language || 'tr']).length > 0) ? data.translations[data.settings.language || 'tr'] : data.translations.tr;
    if(!verbId||!txt){ alert(t.messages.allFieldsError); return; } 
    if(!data.hints) data.hints={sentences:{},verbs:{},sections:{}}; 
    data.hints.verbs[verbId] = txt; alert(t.messages.hintSaved); 
    document.getElementById('hintFormsArea').innerHTML=''; 
    if (state.currentView === 'adminHintView') { showHintManager('hintManagerArea'); }
    saveDataOverride(); 
}
function saveSectionHint(){ 
    const code=document.getElementById('sh_section_code').value.trim(); const txt=document.getElementById('sh_text').value.trim(); 
    const t = (data.translations[data.settings.language || 'tr'] && Object.keys(data.translations[data.settings.language || 'tr']).length > 0) ? data.translations[data.settings.language || 'tr'] : data.translations.tr;
    if(!code||!txt){ alert(t.messages.allFieldsError); return; } 
    if(!data.sectionsHints) data.sectionsHints={}; 
    data.sectionsHints[code] = txt; alert(t.messages.hintSaved + ': ' + code); 
    document.getElementById('hintFormsArea').innerHTML=''; 
    if (state.currentView === 'adminHintView') { showHintManager('hintManagerArea'); }
    saveDataOverride(); 
}

function adminEditHint(type, key) {
  const area = document.getElementById('hintFormsArea'); 
  area.innerHTML = ''; 
  const hintText = data.hints[type][key];
  const t = (data.translations[data.settings.language || 'tr'] && Object.keys(data.translations[data.settings.language || 'tr']).length > 0) ? data.translations[data.settings.language || 'tr'] : data.translations.tr;

  if (type === 'sentences') {
    area.innerHTML = `<div class="content-box"><h4>CÃ¼mle Ä°pucu DÃ¼zenle (${key})</h4>
      <label>${t.labels.hintText}</label><textarea id="hf_text_edit" class="input-field">${escapeHtml(hintText)}</textarea>
      <div class="button-group-row">
        <button class="btn btn-primary" onclick="saveEditedSentenceHint('${key}')">${t.buttons.update}</button>
        <button class="btn btn-danger" onclick="document.getElementById('hintFormsArea').innerHTML=''">${t.buttons.cancel}</button>
      </div></div>`;
  } else if (type === 'verbs') {
    area.innerHTML = `<div class="content-box"><h4>Fiil Ä°pucu DÃ¼zenle (${key})</h4>
      <label>${t.labels.hintText}</label><textarea id="vh_text_edit" class="input-field">${escapeHtml(hintText)}</textarea>
      <div class="button-group-row">
        <button class="btn btn-primary" onclick="saveEditedVerbHint('${key}')">${t.buttons.update}</button>
        <button class="btn btn-danger" onclick="document.getElementById('hintFormsArea').innerHTML=''">${t.buttons.cancel}</button>
      </div></div>`;
  }
}
function adminEditSectionHint(key) {
  const area = document.getElementById('hintFormsArea');
  const hintText = data.sectionsHints[key];
  const t = (data.translations[data.settings.language || 'tr'] && Object.keys(data.translations[data.settings.language || 'tr']).length > 0) ? data.translations[data.settings.language || 'tr'] : data.translations.tr;
  area.innerHTML = `<div class="content-box"><h4>BÃ¶lÃ¼m Ä°pucu DÃ¼zenle (${key})</h4>
    <label>${t.labels.sectionCode}</label><input id="sh_section_code" class="input-field" value="${escapeHtml(key)}" readonly>
    <label>${t.labels.hintText}</label><textarea id="sh_text" class="input-field">${escapeHtml(hintText)}</textarea>
    <div class="button-group-row">
      <button class="btn btn-primary" onclick="saveSectionHint()">${t.buttons.save}</button>
      <button class="btn btn-danger" onclick="document.getElementById('hintFormsArea').innerHTML=''">${t.buttons.cancel}</button>
    </div></div>`;
}

function saveEditedSentenceHint(key) {
  const txt = document.getElementById('hf_text_edit').value.trim();
  if (!txt) { alert('Ä°pucu boÅŸ olamaz'); return; }
  data.hints.sentences[key] = txt;
  alert('âœ… CÃ¼mle ipucu gÃ¼ncellendi');
  document.getElementById('hintFormsArea').innerHTML = ''; 
  showHintManager('hintManagerArea'); 
  saveDataOverride(); 
}
function saveEditedVerbHint(key) {
  const txt = document.getElementById('vh_text_edit').value.trim();
  if (!txt) { alert('Ä°pucu boÅŸ olamaz'); return; }
  data.hints.verbs[key] = txt;
  alert('âœ… Fiil ipucu gÃ¼ncellendi');
  document.getElementById('hintFormsArea').innerHTML = ''; 
  showHintManager('hintManagerArea'); 
  saveDataOverride(); 
}

function showHintManager(targetId = 'hintFormsArea'){ 
  const area = document.getElementById(targetId);
  if(!area) { console.error("Hint manager target area not found:", targetId); return; }
  
  const t = (data.translations[data.settings.language || 'tr'] && Object.keys(data.translations[data.settings.language || 'tr']).length > 0) ? data.translations[data.settings.language || 'tr'] : data.translations.tr;
  let html = '';
  
  html += '<h5>CÃ¼mle Ä°puÃ§larÄ±</h5>'; 
  if(!data.hints || !data.hints.sentences || Object.keys(data.hints.sentences).length===0) html += `<p class="small-muted">${t.messages.noHints}</p>`; 
  else Object.entries(data.hints.sentences).forEach(([k,v])=>{ 
    html += `<div class="hint-item"><strong>${k}</strong><div style="margin-top:6px">${escapeHtml(v)}</div>
             <div style="margin-top:8px" class="button-group-row">
               <button class="btn btn-info btn-small" onclick="adminEditHint('sentences','${k}')">âœï¸ ${t.buttons.edit}</button>
               <button class="btn btn-danger btn-small" onclick="deleteHint('sentences','${k}', '${targetId}')">ðŸ—‘ ${t.buttons.delete}</button>
             </div></div>`; 
  });
  
  html += '<h5 style="margin-top:12px">Fiil Ä°puÃ§larÄ±</h5>'; 
  if(!data.hints || !data.hints.verbs || Object.keys(data.hints.verbs).length===0) html += `<p class="small-muted">${t.messages.noHints}</p>`; 
  else Object.entries(data.hints.verbs).forEach(([k,v])=>{ 
    html += `<div class="hint-item"><strong>${k}</strong><div style="margin-top:6px">${escapeHtml(v)}</div>
             <div style="margin-top:8px" class="button-group-row">
               <button class="btn btn-info btn-small" onclick="adminEditHint('verbs','${k}')">âœï¸ ${t.buttons.edit}</button>
               <button class="btn btn-danger btn-small" onclick="deleteHint('verbs','${k}', '${targetId}')">ðŸ—‘ ${t.buttons.delete}</button>
             </div></div>`; 
  });
  
  html += '<h5 style="margin-top:12px">Genel BÃ¶lÃ¼m Ä°puÃ§larÄ± (B#)</h5>'; 
  if(!data.sectionsHints || Object.keys(data.sectionsHints).length===0) html += `<p class="small-muted">${t.messages.noHints}</p>`; 
  else Object.entries(data.sectionsHints).forEach(([k,v])=>{ 
    html += `<div class="hint-item"><strong>${k}</strong><div style="margin-top:6px">${escapeHtml(v)}</div>
             <div style="margin-top:8px" class="button-group-row">
               <button class="btn btn-info btn-small" onclick="adminEditSectionHint('${k}')">âœï¸ ${t.buttons.edit}</button>
               <button class="btn btn-danger btn-small" onclick="deleteSectionHint('${k}', '${targetId}')">ðŸ—‘ ${t.buttons.delete}</button>
             </div></div>`; 
  });
  
  if(targetId === 'hintFormsArea'){
    html += `<div style="margin-top:10px"><button class="btn btn-danger btn-small" onclick="document.getElementById('hintFormsArea').innerHTML=''">Kapat</button></div>`;
  }
  
  area.innerHTML = html; 
}

function deleteHint(type,key, targetId){ 
  if(!confirm('Silinsin mi?')) return; 
  if(data.hints && data.hints[type]) delete data.hints[type][key]; 
  if(targetId) showHintManager(targetId); 
  saveDataOverride(); 
  alert('Silindi'); 
}
function deleteSectionHint(key, targetId){ 
  if(!confirm('Genel bÃ¶lÃ¼m ipucunu silmek istediÄŸinize emin misiniz?')) return; 
  if(data.sectionsHints) delete data.sectionsHints[key]; 
  if(targetId) showHintManager(targetId); 
  saveDataOverride(); 
  alert('Silindi'); 
}

function toggleHintPanel(){ 
    state.hintPanelVisible = !state.hintPanelVisible; 
    const hintPanelEl = document.getElementById('hintPanel'); 
    
    if(state.hintPanelVisible) {
        let originalIndex;
        if (state.mode === 'study') {
            originalIndex = state.dueCards[state.dueCardPos];
        } else {
            originalIndex = state.dueCardPos;
        }
        
        const hintHtml = buildHintHtml(state.verb, state.section, originalIndex);
        if (hintHtml) {
            hintPanelEl.innerHTML = hintHtml;
            hintPanelEl.style.display = 'block';
        } else {
            hintPanelEl.innerHTML = '';
            hintPanelEl.style.display = 'none';
        }
    } else {
        hintPanelEl.style.display = 'none';
    }
}

/* ---------- Admin: Add/Edit content ---------- */
function showAdminAddGroup(){
  document.getElementById('adminTsvArea').style.display = 'none'; // TSV'yi gizle
  const area = document.getElementById('adminContentArea'); 
  const t = (data.translations[data.settings.language || 'tr'] && Object.keys(data.translations[data.settings.language || 'tr']).length > 0) ? data.translations[data.settings.language || 'tr'] : data.translations.tr;
  area.innerHTML = `<div class="content-box"><h4>${t.admin.addGroup}</h4>
    <label>${t.labels.groupID}</label><input id="adm_group_id" class="input-field">
    <label>${t.labels.groupNameTR}</label><input id="adm_group_name" class="input-field">
    <label>${t.labels.groupNameDE}</label><input id="adm_group_named" class="input-field">
    <div class="button-group-row"><button class="btn btn-primary" onclick="adminSaveGroup()">${t.buttons.save}</button><button class="btn btn-danger" onclick="document.getElementById('adminContentArea').innerHTML=''">${t.buttons.cancel}</button></div></div>`;
}
function adminSaveGroup(){
  const id = document.getElementById('adm_group_id').value.trim();
  const name = document.getElementById('adm_group_name').value.trim();
  const named = document.getElementById('adm_group_named').value.trim();
  if(!id||!name){ alert('ID ve isim girin'); return; }
  if(data.groups.find(g=>g.id===id)){ alert('Bu ID zaten var'); return; }
  data.groups.push({id:id,name:name,nameDE:named,story:null});
  if(!data.verbs[id]) data.verbs[id]=[];
  alert('Grup eklendi'); document.getElementById('adminContentArea').innerHTML='';
  saveDataOverride(); 
}
function showAdminAddVerb(){
  document.getElementById('adminTsvArea').style.display = 'none'; // TSV'yi gizle
  const area = document.getElementById('adminContentArea'); 
  const t = (data.translations[data.settings.language || 'tr'] && Object.keys(data.translations[data.settings.language || 'tr']).length > 0) ? data.translations[data.settings.language || 'tr'] : data.translations.tr;
  area.innerHTML = `<div class="content-box"><h4>${t.admin.addVerb}</h4>
    <label>${t.labels.group}</label><select id="adm_v_group" class="select-field"></select>
    <label>${t.labels.verbID}</label><input id="adm_v_id" class="input-field">
    <label>${t.labels.verbTR}</label><input id="adm_v_tr" class="input-field">
    <label>${t.labels.verbDE}</label><input id="adm_v_de" class="input-field">
    <div class="button-group-row"><button class="btn btn-primary" onclick="adminSaveVerb()">${t.buttons.save}</button><button class="btn btn-danger" onclick="document.getElementById('adminContentArea').innerHTML=''">${t.buttons.cancel}</button></div></div>`;
  fillSelect('adm_v_group', data.groups.map(g=>({v:g.id,t:g.name})), false);
}
function adminSaveVerb(){
  const gid = document.getElementById('adm_v_group').value;
  const vid = document.getElementById('adm_v_id').value.trim();
  const vtr = document.getElementById('adm_v_tr').value.trim();
  const vde = document.getElementById('adm_v_de').value.trim();
  if(!gid||!vid||(!vtr && !vde)){ alert('TÃ¼m gerekli alanlarÄ± doldurun'); return; }
  if(!data.verbs[gid]) data.verbs[gid]=[];
  if((data.verbs[gid]||[]).find(v=>v.id===vid)){ alert('Bu fiil ID zaten var bu grupta'); return; }
  data.verbs[gid].push({id:vid,verbTR:vtr,verbDE:vde});
  alert('Fiil eklendi'); document.getElementById('adminContentArea').innerHTML='';
  saveDataOverride(); 
}
function showAdminEditSentence(){
  document.getElementById('adminTsvArea').style.display = 'none'; // TSV'yi gizle
  const area = document.getElementById('adminContentArea'); 
  const t = (data.translations[data.settings.language || 'tr'] && Object.keys(data.translations[data.settings.language || 'tr']).length > 0) ? data.translations[data.settings.language || 'tr'] : data.translations.tr;
  area.innerHTML = `<div class="content-box"><h4>${t.admin.editSentence}</h4>
    <label>${t.labels.group}</label><select id="adm_es_group" class="select-field"></select>
    <label>${t.labels.verb}</label><select id="adm_es_verb" class="select-field"></select>
    <label>${t.labels.section}</label><select id="adm_es_section" class="select-field"></select>
    <label>${t.labels.sentence}</label><select id="adm_es_sentence" class="select-field"></select>
    <label>${t.labels.tr}</label><textarea id="adm_es_tr" class="input-field"></textarea>
    <label>${t.labels.de}</label><textarea id="adm_es_de" class="input-field"></textarea>
    <div class="button-group-row"><button class="btn btn-primary" onclick="adminSaveEditedSentence()">${t.buttons.update}</button><button class="btn btn-secondary" onclick="adminAddNewSentence()">âž• ${t.buttons.add}</button><button class="btn btn-danger" onclick="document.getElementById('adminContentArea').innerHTML=''">${t.buttons.cancel}</button></div></div>`;
  fillSelect('adm_es_group', data.groups.map(g=>({v:g.id,t:g.name})), true); document.getElementById('adm_es_group').addEventListener('change', admin_es_loadVerbs);
}
function admin_es_loadVerbs(){
  const gid=document.getElementById('adm_es_group').value; const sel=document.getElementById('adm_es_verb'); sel.innerHTML=''; if(!gid) return; (data.verbs[gid]||[]).forEach(v=>{ const o=document.createElement('option'); o.value=v.id; o.textContent=(v.verbTR||v.verbDE); sel.appendChild(o); }); admin_es_loadSections();
}
function admin_es_loadSections(){
  const verbId=document.getElementById('adm_es_verb').value; const sel=document.getElementById('adm_es_section'); sel.innerHTML=''; if(!verbId) return; Object.entries(data.sections).forEach(([num,name])=>{ const key = `${verbId}_s${num}`; 
    const o=document.createElement('option'); o.value=num; 
    const count = (data.content[key] && data.content[key].length) || 0;
    o.textContent=`${num}. ${name} (${count} cÃ¼mle)`; 
    sel.appendChild(o); 
  }); admin_es_loadSentences();
}
function admin_es_loadSentences(){
  const verbId=document.getElementById('adm_es_verb').value; const section=document.getElementById('adm_es_section').value; const sel=document.getElementById('adm_es_sentence'); sel.innerHTML=''; if(!verbId||!section) return; const arr = data.content[`${verbId}_s${section}`]||[]; arr.forEach((s,i)=>{ const o=document.createElement('option'); o.value=i; o.textContent = (s.tr||s.de||'').substring(0,80); sel.appendChild(o); }); 
  document.getElementById('adm_es_sentence').addEventListener('change', admin_es_loadSentenceFields);
  admin_es_loadSentenceFields();
}
function admin_es_loadSentenceFields(){
  const verbId=document.getElementById('adm_es_verb').value; const section=document.getElementById('adm_es_section').value; const idx=document.getElementById('adm_es_sentence').value; if(!verbId||!section||idx==='') return; const s = (data.content[`${verbId}_s${section}`]||[])[idx]; if(s){ document.getElementById('adm_es_tr').value = s.tr || ''; document.getElementById('adm_es_de').value = s.de || ''; }
}
function adminSaveEditedSentence(){
  const verbId=document.getElementById('adm_es_verb').value; const section=document.getElementById('adm_es_section').value; const idx=document.getElementById('adm_es_sentence').value;
  const tr=document.getElementById('adm_es_tr').value.trim(); const de=document.getElementById('adm_es_de').value.trim();
  if(!verbId||!section||idx==='') { alert('SeÃ§im yapÄ±n'); return; }
  const arr = data.content[`${verbId}_s${section}`] || [];
  arr[idx] = {tr,de};
  data.content[`${verbId}_s${section}`] = arr;
  alert('CÃ¼mle gÃ¼ncellendi'); 
  admin_es_loadSentences(); 
  saveDataOverride(); 
}
function adminAddNewSentence(){
  const verbId=document.getElementById('adm_es_verb').value; const section=document.getElementById('adm_es_section').value;
  const tr=document.getElementById('adm_es_tr').value.trim(); const de=document.getElementById('adm_es_de').value.trim();
  if(!verbId||!section||(!tr&&!de)){ alert('Gerekli alanlarÄ± doldurun (Fiil, BÃ¶lÃ¼m, TR/DE)'); return; }
  if(!data.content[`${verbId}_s${section}`]) data.content[`${verbId}_s${section}`]=[];
  data.content[`${verbId}_s${section}`].push({tr,de});
  alert('Yeni cÃ¼mle eklendi'); 
  admin_es_loadSections(); 
  saveDataOverride(); 
}

/* ---------- Admin: Story management ---------- */
function showAdminAddStory(){
  const area = document.getElementById('adminStoryArea'); 
  const t = (data.translations[data.settings.language || 'tr'] && Object.keys(data.translations[data.settings.language || 'tr']).length > 0) ? data.translations[data.settings.language || 'tr'] : data.translations.tr;
  area.innerHTML = `<div class="content-box"><h4>${t.admin.addStory}</h4>
    <label>${t.labels.group}</label><select id="adm_story_group" class="select-field"></select>
    <label>${t.labels.title}</label><input id="adm_story_title" class="input-field">
    <label>${t.labels.deText}</label><textarea id="adm_story_de" class="input-field"></textarea>
    <label>${t.labels.trText}</label><textarea id="adm_story_tr" class="input-field"></textarea>
    <div class="button-group-row"><button class="btn btn-primary" onclick="adminSaveStory()">${t.buttons.save}</button><button class="btn btn-danger" onclick="document.getElementById('adminStoryArea').innerHTML=''">${t.buttons.cancel}</button></div></div>`;
  fillSelect('adm_story_group', data.groups.map(g=>({v:g.id,t:g.name})), false);
}
function adminSaveStory(){
  const gid=document.getElementById('adm_story_group').value; const title=document.getElementById('adm_story_title').value.trim();
  const de=document.getElementById('adm_story_de').value.trim(); const tr=document.getElementById('adm_story_tr').value.trim();
  if(!gid||!title||(!de&&!tr)){ alert('AlanlarÄ± doldurun'); return; }
  const g = data.groups.find(x=>x.id===gid);
  if(!g) { alert('Grup bulunamadÄ±'); return; }
  g.story = {title,de,tr,quiz:[]};
  alert('Hikaye kaydedildi'); document.getElementById('adminStoryArea').innerHTML='';
  saveDataOverride(); 
}
function showAdminEditStory(){
  const area = document.getElementById('adminStoryArea'); 
  const t = (data.translations[data.settings.language || 'tr'] && Object.keys(data.translations[data.settings.language || 'tr']).length > 0) ? data.translations[data.settings.language || 'tr'] : data.translations.tr;
  area.innerHTML = `<div class="content-box"><h4>${t.admin.editStory}</h4>
    <label>${t.labels.group}</label><select id="adm_esg_group" class="select-field"></select>
    <div class="button-group-row"><button class="btn btn-primary" onclick="adminLoadGroupStory()">Hikayeyi YÃ¼kle</button></div>
    <div id="adm_story_edit"></div></div>`;
  fillSelect('adm_esg_group', data.groups.map(g=>({v:g.id,t:g.name})), true);
}
function adminLoadGroupStory(){
  const gid=document.getElementById('adm_esg_group').value; if(!gid) return;
  const g = data.groups.find(x=>x.id===gid); if(!g || !g.story){ alert('Bu grupta hikaye yok'); return; }
  const s = g.story;
  const area = document.getElementById('adm_story_edit');
  const t = (data.translations[data.settings.language || 'tr'] && Object.keys(data.translations[data.settings.language || 'tr']).length > 0) ? data.translations[data.settings.language || 'tr'] : data.translations.tr;
  
  let html = `<div style="margin-top:8px"><label>${t.labels.title}</label><input id="ae_title" class="input-field" value="${escapeHtml(s.title||'')}">
    <label>${t.labels.deText}</label><textarea id="ae_de" class="input-field" rows="5">${escapeHtml(s.de||'')}</textarea>
    <label>${t.labels.trText}</label><textarea id="ae_tr" class="input-field" rows="5">${escapeHtml(s.tr||'')}</textarea>
    <div class="button-group-row"><button class="btn btn-primary" onclick="adminSaveEditedStory('${gid}')">${t.buttons.update}</button><button class="btn btn-danger" onclick="adminDeleteStory('${gid}')">ðŸ—‘ ${t.buttons.delete}</button></div></div>`;
  html += `<hr style="margin: 16px 0"><h4>Hikaye Testleri</h4><div id="ae_quiz_list"></div><div style="margin-top:8px"><button class="btn btn-info" onclick="adminAddQuiz('${gid}')">âž• Test Ekle</button></div>`;
  area.innerHTML = html;
  renderAdminQuizList(gid);
}
function adminSaveEditedStory(gid){
  const g = data.groups.find(x=>x.id===gid); if(!g) return;
  g.story.title = document.getElementById('ae_title').value.trim();
  g.story.de = document.getElementById('ae_de').value.trim();
  g.story.tr = document.getElementById('ae_tr').value.trim();
  alert('Hikaye gÃ¼ncellendi');
  saveDataOverride(); 
}
function adminDeleteStory(gid){ if(!confirm('Hikayeyi silmek istediÄŸinize emin misiniz?')) return; const g = data.groups.find(x=>x.id===gid); if(g) { g.story = null; alert('Hikaye silindi'); document.getElementById('adm_story_edit').innerHTML=''; saveDataOverride(); } }

function renderAdminQuizList(gid){
  const g = data.groups.find(x=>x.id===gid); if(!g || !g.story) return;
  const list = document.getElementById('ae_quiz_list'); 
  const t = (data.translations[data.settings.language || 'tr'] && Object.keys(data.translations[data.settings.language || 'tr']).length > 0) ? data.translations[data.settings.language || 'tr'] : data.translations.tr;
  let html=''; 
  (g.story.quiz||[]).forEach((q,i)=>{ 
    html += `<div class="hint-item"><strong>${i+1}. ${escapeHtml(q.q)}</strong><div style="margin-top:6px">${q.options.map(o=>`<span class="muted">${escapeHtml(o)}</span>`).join(' , ')}</div>
             <div style="margin-top:8px" class="button-group-row">
               <button class="btn btn-info btn-small" onclick="adminEditQuiz('${gid}',${i})">âœï¸ ${t.buttons.edit}</button>
               <button class="btn btn-danger btn-small" onclick="adminDeleteQuiz('${gid}',${i})">ðŸ—‘ ${t.buttons.delete}</button>
             </div></div>`; 
  }); 
  list.innerHTML = html || `<p class="small-muted">${t.messages.noStoryQuestions}</p>`;
}
function adminAddQuiz(gid){
  const q = {q:'Yeni soru', options:['SeÃ§enek1','SeÃ§enek2'], a:'SeÃ§enek1'};
  const g = data.groups.find(x=>x.id===gid); if(!g.story) g.story={title:'',de:'',tr:'',quiz:[]};
  if(!g.story.quiz) g.story.quiz = [];
  g.story.quiz.push(q);
  renderAdminQuizList(gid);
  saveDataOverride(); 
}
function adminEditQuiz(gid, index){
  const g = data.groups.find(x=>x.id===gid); if(!g || !g.story) return;
  const q = g.story.quiz[index]; const container=document.getElementById('ae_quiz_list');
  const t = (data.translations[data.settings.language || 'tr'] && Object.keys(data.translations[data.settings.language || 'tr']).length > 0) ? data.translations[data.settings.language || 'tr'] : data.translations.tr;
  const html = `<div class="content-box">
    <h4>Testi DÃ¼zenle</h4>
    <label>${t.labels.question}</label><input id="aq_q" class="input-field" value="${escapeHtml(q.q)}">
    <label>${t.labels.options}</label><input id="aq_opts" class="input-field" value="${escapeHtml(q.options.join(','))}">
    <label>${t.labels.correctAnswer}</label><input id="aq_a" class="input-field" value="${escapeHtml(q.a)}">
    <div class="button-group-row">
      <button class="btn btn-primary" onclick="adminSaveQuiz('${gid}',${index})">${t.buttons.save}</button>
      <button class="btn btn-danger" onclick="renderAdminQuizList('${gid}')">${t.buttons.cancel}</button>
    </div></div>`;
  container.innerHTML = html;
}
function adminSaveQuiz(gid,index){
  const g = data.groups.find(x=>x.id===gid); if(!g || !g.story) return;
  const qtext = document.getElementById('aq_q').value.trim();
  const opts = document.getElementById('aq_opts').value.split(',').map(s=>s.trim()).filter(Boolean);
  const a = document.getElementById('aq_a').value.trim();
  if(!qtext || opts.length<2 || !a){ alert('Soru, en az 2 seÃ§enek ve doÄŸru cevap gerekli'); return; }
  g.story.quiz[index] = {q:qtext, options:opts, a};
  renderAdminQuizList(gid);
  saveDataOverride(); 
}

function adminDeleteQuiz(gid,index){ 
    if(!confirm('Testi sil?')) return; 
    const g = data.groups.find(x=>x.id===gid); 
    if(!g||!g.story) return; 
    g.story.quiz.splice(index,1); 
    renderAdminQuizList(gid); 
    saveDataOverride(); 
}

/* ---------- All sentences table ---------- */
function renderAllSentencesTable(){
  const container = document.getElementById('allSentencesTable'); 
  const t = (data.translations[data.settings.language || 'tr'] && Object.keys(data.translations[data.settings.language || 'tr']).length > 0) ? data.translations[data.settings.language || 'tr'] : data.translations.tr;
  let html = `<table><thead><tr><th>${t.labels.group}</th><th>${t.labels.verb}</th><th>${t.labels.section}</th><th>${t.labels.index}</th><th>${t.labels.tr}</th><th>${t.labels.de}</th></tr></thead><tbody>`;
  Object.entries(data.content||{}).forEach(([key,arr])=>{
    const m = key.match(/^(.+)_s(\d+)$/);
    if(!m) return;
    const vid = m[1]; const sec = m[2];
    let verbLabel = vid;
  
    let groupLabel = '';
    for(const g of Object.keys(data.verbs||{})){
      const vs = data.verbs[g]||[];
      const vv = vs.find(v=>v.id===vid);
      if(vv){
        groupLabel = (data.groups.find(x=>x.id===g)||{}).name || g;
        verbLabel = (vv.verbTR||vv.verbDE) || vid;
        break;
      }
    }
    (arr||[]).forEach((s,i)=>{
      html += `<tr><td>${escapeHtml(groupLabel)}</td><td>${escapeHtml(verbLabel)}</td><td>${escapeHtml(data.sections[sec]||sec)}</td><td>${i}</td><td>${escapeHtml(s.tr||'')}</td><td>${escapeHtml(s.de||'')}</td></tr>`;
    });
  });
  html += '</tbody></table>';
  container.innerHTML = html;
}

/* Export sentences CSV (simple) */
function exportSentencesCsv(){
  let rows = [['Grup','Fiil','BÃ¶lÃ¼m','Index','TR','DE']];
  Object.entries(data.content||{}).forEach(([key,arr])=>{
    const m = key.match(/^(.+)_s(\d+)$/);
    if(!m) return;
    const vid = m[1]; const sec = m[2];
    let verbLabel = vid; let groupLabel = '';
    for(const g of Object.keys(data.verbs||{})){
      const vs = data.verbs[g]||[];
        const vv = vs.find(v=>v.id===vid);
      if(vv){
        groupLabel = (data.groups.find(x=>x.id===g)||{}).name || g;
        verbLabel = (vv.verbTR||vv.verbDE) || vid;
        break;
      }
    }
    (arr||[]).forEach((s,i)=>{
      rows.push([groupLabel, verbLabel, data.sections[sec]||sec, i, s.tr||'', s.de||'']);
    });
  });
  const csv = rows.map(r=>r.map(c=>`"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob = new Blob([csv],{type:'text/csv;charset=utf-f;'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'sentences.csv'; a.click(); URL.revokeObjectURL(url); alert('CSV indirildi');
}

/* ---------- JSON paste loader ---------- */
function loadJsonFromTextarea(){
  const txt = document.getElementById('jsonPaste').value.trim();
  const t = (data.translations[data.settings.language || 'tr'] && Object.keys(data.translations[data.settings.language || 'tr']).length > 0) ? data.translations[data.settings.language || 'tr'] : data.translations.tr;
  if(!txt){ alert('JSON yapÄ±ÅŸtÄ±rÄ±n'); return; }
  try{
    const imported = JSON.parse(txt);
    
    const defaultTranslations = JSON.parse(JSON.stringify(data.translations));

    data.groups = imported.groups;
    data.verbs = imported.verbs;
    data.content = imported.content;
    if(imported.sections) data.sections = imported.sections;
    if(imported.sectionsHints) data.sectionsHints = imported.sectionsHints;
    if(imported.hints) data.hints = imported.hints;
    if(imported.settings) data.settings = Object.assign(data.settings || {}, imported.settings);

    if (imported.translations) {
      data.translations = deepMerge(defaultTranslations, imported.translations);
    } else {
      data.translations = defaultTranslations;
    }
      
    saveDataOverride();

    alert('âœ“ YapÄ±ÅŸtÄ±rÄ±lan JSON yÃ¼klendi.'); 
    document.getElementById('jsonPaste').value='';
    loadSettings(); 
    showView('mainMenu');
  } catch(e){ alert(`${t.messages.loadError} ${e.message}`); }
}


/* ---------- YENÄ°: Admin Toplu YÃ¼kleme (TSV/Excel) AracÄ± ---------- */

function showTsvImporter() {
  document.getElementById('adminContentArea').innerHTML = '';
  document.getElementById('adminTsvArea').style.display = 'block';
  document.getElementById('tsvPasteArea').value = ''; 
}

function parseAndImportTsv() {
  const tsvData = document.getElementById('tsvPasteArea').value.trim();
  const t = (data.translations[data.settings.language || 'tr'] && Object.keys(data.translations[data.settings.language || 'tr']).length > 0) ? data.translations[data.settings.language || 'tr'] : data.translations.tr;

  if (!tsvData) {
    alert('LÃ¼tfen veriyi yapÄ±ÅŸtÄ±rÄ±n.');
    return;
  }

  const lines = tsvData.split('\n');
  
  let sentencesAdded = 0;
  let hintsAdded = 0;
  let errors = 0;

  if (!data.content) data.content = {};
  if (!data.hints) data.hints = { sentences: {}, verbs: {}, sections: {} };
  if (!data.hints.sentences) data.hints.sentences = {};

  lines.forEach((line, lineIndex) => {
    if (line.trim() === '') return; 

    const columns = line.split('\t');

    if (columns.length < 5) {
      console.error(`SatÄ±r ${lineIndex + 1}: Yetersiz sÃ¼tun. (En az 5 gerekli)`);
      errors++;
      return; 
    }

    const grupId = columns[0].trim();
    const fiilId = columns[1].trim();
    const bolumNum = columns[2].trim();
    const tr = columns[3].trim();
    const de = columns[4].trim();
    const cumleIpucu = (columns[5] || '').trim(); 

    if (!grupId || !fiilId || !bolumNum || !tr || !de) {
      console.error(`SatÄ±r ${lineIndex + 1}: Gerekli alanlar boÅŸ. (Grup, Fiil, BÃ¶lÃ¼m, TR, DE)`);
      errors++;
      return; 
    }

    try {
      const contentKey = `${fiilId}_s${bolumNum}`;
      if (!data.content[contentKey]) {
        data.content[contentKey] = [];
      }
      
      const newSentenceIndex = data.content[contentKey].length;
      data.content[contentKey].push({ tr: tr, de: de });
      sentencesAdded++;

      if (cumleIpucu) {
        const hintKey = `${fiilId}_s${bolumNum}_${newSentenceIndex}`;
        data.hints.sentences[hintKey] = cumleIpucu;
        hintsAdded++;
      }

    } catch (e) {
      console.error(`SatÄ±r ${lineIndex + 1} iÅŸlenirken hata: ${e.message}`);
      errors++;
    }
  });

  if (sentencesAdded > 0) {
    saveDataOverride(); 
  }

  alert(
    `Toplu YÃ¼kleme TamamlandÄ±!\n\n` +
    `âœ… Eklenen CÃ¼mle SayÄ±sÄ±: ${sentencesAdded}\n` +
    `ðŸ’¡ Eklenen Ä°pucu SayÄ±sÄ±: ${hintsAdded}\n` +
    `âŒ HatalÄ± SatÄ±r SayÄ±sÄ±: ${errors}`
  );

  document.getElementById('tsvPasteArea').value = '';
  document.getElementById('adminTsvArea').style.display = 'none';
}
/* ---------- Admin: Toplu YÃ¼kleme AracÄ± SONU ---------- */


/* ---------- Utils ---------- */
function escapeHtml(t){ if(t===undefined||t===null) return ''; return String(t).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

function isObject(item) {
  return (item && typeof item === 'object' && !Array.isArray(item));
}
function deepMerge(target, source) {
  let output = Object.assign({}, target);
  if (isObject(target) && isObject(source)) {
    Object.keys(source).forEach(key => {
      if (isObject(source[key])) {
        if (!(key in target))
          Object.assign(output, { [key]: source[key] });
        else
          output[key] = deepMerge(target[key], source[key]);
      } else {
        Object.assign(output, { [key]: source[key] });
      }
    });
  }
  return output;
}

/* ---------- Init ---------- */
function init(){
  loadDataOverride();
  
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('service-worker.js').then(function(registration) {
      console.log('ServiceWorker registration successful with scope: ', registration.scope);
    }, function(err) {
      console.log('ServiceWorker registration failed: ', err);
    }); 
  }

  // Event Listener'larÄ± ekle
  const modeToggleBtn = document.getElementById('modeToggleBtn');
  if(modeToggleBtn) modeToggleBtn.addEventListener('click', toggleNightMode);
  
  const nightModeToggle = document.getElementById('nightModeToggle');
  if(nightModeToggle) nightModeToggle.addEventListener('change', toggleNightMode);

  // --- MÃ¼zik Ã‡alarÄ± BaÅŸlat (Yerel MP3) ---
  const streamURL = './telifsiz-klasik.mp3'; 
  musicPlayer = new MusicPlayer(streamURL, 'musicVolumeSlider', 'musicToggleBtn');
  
  const musicBtn = document.getElementById('musicToggleBtn');
  const volumeSlider = document.getElementById('musicVolumeSlider');
  
  if (musicBtn) {
    musicBtn.addEventListener('click', () => {
      musicPlayer.toggleMusic();
    });
  }
  if (volumeSlider) {
    volumeSlider.addEventListener('input', (e) => {
      musicPlayer.setVolume(e.target.value);
    });
  }
  // --- MÃ¼zik Ã‡alar Kodu SONU ---

  loadSettings(); 
  loadProgress(); 
  loadSrsData();  
  
  updateConversionButtons();

  console.log('Verb Matrix v2.9.5 (LED GÃ¼ncellemesi) hazÄ±r.');
}

window.addEventListener('DOMContentLoaded', init);

</script>
</body>
</html>
