<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Verb Matrix â€” v4.0 (Nihai SÃ¼rÃ¼m)</title>

<link rel="icon" href="favicon.ico" type="image/x-icon">

<link rel="manifest" href="manifest.json"> 

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#667eea">

<style>
  /* --- Genel --- */
  *{box-sizing:border-box;margin:0;padding:0}
  /* Mobil uyumluluÄŸu garantilemek iÃ§in min-width: 100% eklendi */
  body{font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); min-height:100vh;padding:18px; transition: background .25s,color .25s; min-width: 100%;}
  .container{max-width:1200px;margin:0 auto;background:#fff;border-radius:16px;padding:28px;box-shadow:0 18px 50px rgba(0,0,0,.18);transition:background .25s,color .25s}
  header{text-align:center;margin-bottom:18px}
  .subtitle{color:#6b7280;margin-top:6px}

  /* BÃ¶lÃ¼m BaÅŸlÄ±ÄŸÄ± */
  .section-title{font-size:1.25rem;color:#2d3748;margin:16px 0 10px;padding-bottom:8px;border-bottom:3px solid #667eea;font-weight:700}

  /* MODU SEÃ‡ iÃ§in bÃ¼yÃ¼k, ortalanmÄ±ÅŸ stil */
  .large-centered-title {
    text-align: center;
    font-size: 2.5rem;
    color: #2d3748;
    font-weight: 800;
    margin: 24px 0;
    text-transform: uppercase;
  }

  /* --- YENÄ°: STANDART BUTON GRÄ°DÄ° (v4.0) --- */
  /* TÃ¼m buton gridleri (Ana MenÃ¼, Mod seÃ§imi, Tekrar vb.) artÄ±k bunu kullanacak */
  .button-grid{
    display:grid;
    gap:12px;
    grid-template-columns:repeat(auto-fit,minmax(180px,1fr));
    margin:12px 0
  }
  /* Ana menÃ¼, Mod seÃ§imi, Ã‡eviri yÃ¶nÃ¼ butonlarÄ± iÃ§in standart gÃ¶rÃ¼nÃ¼m */
  .button-grid .btn {
    justify-content: center; 
    text-align: center;
    height: 70px;
    font-size: 1.1rem;
    padding: 16px 14px;
  }
  
  /* GRUP SEÃ‡Ä°M BAÅLIKLARI */
  .group-select-header { text-align: center; margin-bottom: 12px; padding-top: 18px; } /* Margin azaltÄ±ldÄ± */
  .group-select-header h2 { font-size: 2.5rem; color: #2d3748; font-weight: 800; letter-spacing: 2px; margin-bottom: 18px; }
  
  /* YENÄ°: BaÅŸlÄ±klar ve Butonlar iÃ§in EÅŸit Grid YapÄ±sÄ± */
  .group-select-columns { 
      display: grid; 
      gap: 12px; 
      grid-template-columns: 1fr 1fr; /* 2 EÅŸit sÃ¼tun */
      margin-bottom: 12px; 
      padding: 0 12px; 
  }
  .group-column-title { 
      font-size: 1.4rem; 
      color: #2d3748; 
      font-weight: 700; 
      display: inline-block; 
      padding: 0 10px 8px; 
      border-bottom: 3px solid #667eea; 
  }
  
  /* GRUP/HÄ°KAYE GRIDÄ° - Åimdi butonu ve hikaye butonunu yan yana getirmek iÃ§in 2 sÃ¼tunlu grid */
  .group-story-grid { 
      display: grid; 
      gap: 12px; 
      grid-template-columns: 1fr 1fr; /* 2 EÅŸit sÃ¼tun */
      margin: 12px; /* Kenar boÅŸluÄŸu eklenerek butonlarÄ±n daha iyi gÃ¶rÃ¼nmesi saÄŸlandÄ± */
      margin-top: 0;
  }
  /* GRUP/HÄ°KAYE GRIDÄ° - SADECE BUTTON STÄ°LÄ° DÃœZELTÄ°LDÄ° (v4.0.2) */
  .group-story-grid .btn { 
      flex-direction: column; 
      height: auto; /* YENÄ°: Otomatik yÃ¼kseklik (ALMANCA TAÅMASINI ENGELLER) */
      min-height: 60px; /* Minimum yÃ¼kseklik */
      font-size: 1rem;
      padding: 10px 14px;
      text-align: left; /* Metin sola hizalÄ± kalsÄ±n */
  }
  
  /* MOBÄ°L CÄ°HAZ GÃ–RÃœNÃœM DÃœZELTMESÄ° (En Alta Ekliyoruz) */
  @media(max-width:768px){
      /* ... (diÄŸer mobil stiller) */
      .group-select-columns,
      .group-story-grid { 
          grid-template-columns: 1fr !important; /* Tek sÃ¼tun ve tam geniÅŸlik */
          margin: 0 !important; /* Mobilde kenar boÅŸluÄŸunu kaldÄ±r */
          padding: 0 14px !important; /* Mobil paddingi */
      } 
      .group-story-grid {
          gap: 6px; /* Mobilde daha az boÅŸluk */
      }
      .group-select-columns {
          margin-bottom: 0 !important;
      }
      /* ... (diÄŸer mobil stiller) */
  }

  /* GRUP SEÃ‡Ä°M BAÅLIKLARI */
  .group-select-header { text-align: center; margin-bottom: 24px; padding-top: 18px; }
  .group-select-header h2 { font-size: 2.5rem; color: #2d3748; font-weight: 800; letter-spacing: 2px; margin-bottom: 18px; }
  .group-select-columns { display: flex; justify-content: space-between; margin-bottom: 12px; }
  .group-column-title { font-size: 1.4rem; color: #2d3748; font-weight: 700; display: inline-block; padding: 0 10px 8px; border-bottom: 3px solid #667eea; }

  /* --- GENEL BUTON STÄ°LLERÄ° (Metalik/Parlak v3.0) --- */
  .btn{
    padding:10px 14px;
    border-radius:10px;
    font-weight:700;
    cursor:pointer;
    color:#fff;
    text-align: left;
    display:flex;
    align-items:center;
    transition: all .15s ease;
    border-width: 1px;
    border-style: solid;
    box-shadow: 0 2px 4px rgba(0,0,0,0.15), inset 0 1px 1px rgba(255,255,255,0.3);
    text-shadow: 0 1px 1px rgba(0,0,0,0.2);
  }
  .btn:active {
    transform: translateY(1px);
    box-shadow: 0 1px 2px rgba(0,0,0,0.2), inset 0 1px 1px rgba(0,0,0,0.1);
  }

  .btn-small{padding:8px 10px;font-size:.9rem}

  /* RENKLER (Gradient ile gÃ¼ncellendi) */
  .btn-danger {
    background: linear-gradient(to bottom, #f87171 0%, #f56565 100%);
    border-color: #e53e3e;
  }
  .btn-danger:hover {
    background: linear-gradient(to bottom, #f56565 0%, #e53e3e 100%);
  }

  .btn-primary {
    background: linear-gradient(to bottom, #7a8efb 0%, #667eea 100%);
    border-color: #5a6ed0;
  }
  .btn-primary:hover {
    background: linear-gradient(to bottom, #667eea 0%, #5a6ed0 100%);
  }

  .btn-secondary {
    background: linear-gradient(to bottom, #cacedb 0%, #aeb4c5 100%);
    color: #1e293b;
    border-color: #949daf;
    text-shadow: 0 1px 0 rgba(255,255,255,0.3);
  }
  .btn-secondary:hover {
    background: linear-gradient(to bottom, #aeb4c5 0%, #949daf 100%);
  }

  .btn-info {
    background: linear-gradient(to bottom, #4fd1c5 0%, #38b2ac 100%);
    border-color: #319795;
  }
  .btn-info:hover {
    background: linear-gradient(to bottom, #38b2ac 0%, #319795 100%);
  }

  .btn-warning {
    background: linear-gradient(to bottom, #fbd38d 0%, #ecc94b 100%);
    color: #1e293b;
    border-color: #d69e2e;
    text-shadow: 0 1px 0 rgba(255,255,255,0.2);
  }
  .btn-warning:hover {
    background: linear-gradient(to bottom, #ecc94b 0%, #d69e2e 100%);
  }

  /* YENÄ°: SRS Tekrar ButonlarÄ± (Metalik/Parlak) */
  .btn-srs-zor {
    background: linear-gradient(to bottom, #f87171 0%, #f56565 100%);
    border-color: #e53e3e;
  }
  .btn-srs-zor:hover {
    background: linear-gradient(to bottom, #f56565 0%, #e53e3e 100%);
  }

  .btn-srs-normal {
    background: linear-gradient(to bottom, #fbd38d 0%, #ecc94b 100%);
    color: #1e293b;
    border-color: #d69e2e;
    text-shadow: 0 1px 0 rgba(255,255,255,0.2);
  }
  .btn-srs-normal:hover {
    background: linear-gradient(to bottom, #ecc94b 0%, #d69e2e 100%);
  }

  .btn-srs-ogrendim {
    background: linear-gradient(to bottom, #68d391 0%, #48bb78 100%);
    border-color: #38a169;
  }
  .btn-srs-ogrendim:hover {
    background: linear-gradient(to bottom, #48bb78 0%, #38a169 100%);
  }
  
  /* YENÄ°: AI Ä°pucu Buton Rengi */
  .btn-ai {
    background: linear-gradient(to bottom, #6366f1 0%, #4f46e5 100%); /* Ä°ndigo Mavisi */
    border-color: #4338ca;
  }
  .btn-ai:hover {
    background: linear-gradient(to bottom, #4f46e5 0%, #4338ca 100%);
  }
  body.night-mode .btn-ai { 
    background: #4f46e5;
    border-color: #6366f1;
  }
  body.night-mode .btn-ai:hover { 
    background: #6366f1;
  }

  /* Ã‡alÄ±ÅŸma SayfasÄ± Akordeon Ä°Ã§i Buton Gridi */
  .button-grid-learning {
      display: grid;
      gap: 8px;
      grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
      margin-top: 0; /* v4.0: Panel kendi paddingini saÄŸlÄ±yor */
  }
  .button-grid-learning .btn {
      min-width: 130px;
      padding: 10px 8px;
      font-size: 0.9rem;
      font-weight: 700;
      justify-content: center; /* Metni ve LED'i ortala */
      background: #aeb4c5; /* Pastel Gri/Mavi */
      color: #1e293b;
      height: auto; /* v4.0: YÃ¼ksekliÄŸi standart grid'den ayÄ±r */
  }
  .button-grid-learning .btn:hover { background: #949daf; }
  .button-grid-learning .btn-danger { background: #f56565; color: #fff; } 
  .button-grid-learning .btn-danger:hover { background: #e53e3e; }


  .btn.disabled, .btn:disabled{background:#cbd5e1;color:#718096;cursor:not-allowed;opacity:0.7}

  .hidden { display: none; }

  .view{display:none}
  .view.active{display:block;animation:slideIn .18s ease}
  @keyframes slideIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}

  /* YENÄ°: KÄ±rmÄ±zÄ± Geri/Ana MenÃ¼ butonlarÄ± kaldÄ±rÄ±ldÄ± (v4.0) */
  .button-group-row { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 12px; }
  /* ArtÄ±k kÄ±rmÄ±zÄ± butonlar olmadÄ±ÄŸÄ± iÃ§in .button-group-row stillerine gerek kalmadÄ± */
  
  /* YENÄ°: LED GÃ¶sterge Stilleri */
  .led-indicator {
    display: inline-block;
    width: 11px;
    height: 11px;
    border-radius: 50%;
    background-color: #555; /* VarsayÄ±lan: SÃ¶nÃ¼k */
    border: 1px solid #333;
    margin-right: 7px;
    vertical-align: middle;
    transition: background-color 0.2s, box-shadow 0.2s;
    flex-shrink: 0;
  }
  .led-indicator.active {
    background-color: #39e75f; /* Aktif: YeÅŸil */
    box-shadow: 0 0 6px #39e75f, 0 0 3px rgba(255,255,255,0.5) inset;
    border-color: #2b9e44;
  }
  body.night-mode .led-indicator { background-color: #333; border-color: #111; }
  body.night-mode .led-indicator.active { background-color: #39e75f; box-shadow: 0 0 8px #39e75f; border-color: #2b9e44; }
  /* --- LED BitiÅŸ --- */
  
  /* YENÄ°: Ã‡eviri ButonlarÄ± artÄ±k .button-grid kullanÄ±yor (v4.0) */
  /* .conversion-btn stilleri kaldÄ±rÄ±ldÄ± */

  /* YENÄ°: SRS Kontrol ButonlarÄ± (3'lÃ¼) */
  #srsControls {
      display: none;
      justify-content: space-around;
      margin-top: 15px;
      gap: 10px;
  }
  #srsControls .btn {
      flex: 1;
      margin: 0;
      justify-content: center; /* SRS butonlarÄ± ortalÄ± */
      font-size: 1rem;
      padding: 12px 8px;
      height: auto; /* v4.0 */
  }

  /* --- YENÄ°: SABÄ°T NAVÄ°GASYON BUTONLARI (v4.0) --- */
/* --- YENÄ°: SABÄ°T NAVÄ°GASYON BUTONLARI (v4.0) --- */
  .floating-nav-btn {
    position: fixed;
    border-radius: 50%;
    padding: 10px;
    border: 0;
    background: #fff;
    color: #333;
    cursor: pointer;
    box-shadow: 0 10px 28px rgba(0,0,0,.12);
    z-index: 2000; /* DÃœZELTME: KÄ±lavuz/Ä°pucu (1500) dahil her ÅŸeyin Ã¼stÃ¼nde olmasÄ± iÃ§in yÃ¼kseltildi */
    font-size: 1.4rem;
    line-height: 1;
    width: 48px;
    height: 48px;
    display: none; /* JS ile yÃ¶netilecek */
  }
  body.night-mode .floating-nav-btn {
    background: #1f2937;
    color: #e6eef8;
  }
  
  /* SaÄŸ Ãœst Grup (KÄ±lavuz ve Gece Modu) */
  #floatingNavTopRight {
    position: fixed;
    top: 18px;
    right: 18px;
    z-index: 2000; /* DÃ¼zeltme: Grubu da aynÄ± seviyede tutalÄ±m */
    display: flex;
    gap: 8px;
  }
  #floatingNavTopRight .floating-nav-btn {
    position: static; /* Grupta olduklarÄ± iÃ§in */
    display: block; /* Her zaman gÃ¶rÃ¼nÃ¼r */
  }
  
  /* Sol Alt (Geri) */
  #floatingBackBtn {
    left: 18px;
    bottom: 18px;
  }
  
  /* SaÄŸ Alt (Ana MenÃ¼) */
  #floatingHomeBtn {
    right: 18px;
    bottom: 18px;
  }
  
  /* SaÄŸ Alt (Admin) */
  #floatingAdminBtn {
    right: 18px;
    bottom: 80px; /* Ev butonunun Ã¼stÃ¼nde */
  }
  /* --- BÄ°TÄ°Å: SABÄ°T NAVÄ°GASYON --- */



  .lang-btn{padding:8px 12px;border-radius:8px;border:2px solid #667eea;background:#fff;color:#667eea;cursor:pointer}
  .lang-btn.active{background:#667eea;color:#fff}
  .score-display{font-size:1.6rem;font-weight:800;color:#667eea;text-align:center;margin:12px 0}
  .small-muted{color:#6b7280;font-size:.9rem}
  .toggle-hint-btn{padding:8px 10px;border-radius:8px;border:0;background:#34495e;color:#fff;cursor:pointer}
  .content-box{background:#f9fafb;padding:16px;border-radius:12px;margin:12px 0;border-left:5px solid #667eea}
  .input-field, .textarea-field {width:100%;padding:10px;border-radius:8px;border:2px solid #e5e7eb;margin-top:8px;font-size:1rem;background:#fff;color:#0f1724}
  .select-field{width:100%;padding:10px;border-radius:8px;border:2px solid #e5e7eb;background:#fff;color:#0f1724; margin-top: 8px;}
  .progress-container{margin:12px 0}
  .progress-bar{height:28px;background:#e6eefc;border-radius:14px;overflow:hidden}
  .progress-fill{height:100%;background:linear-gradient(90deg,#667eea,#764ba2);width:0;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:800; transition: width .2s;}

  /* Ã–ÄŸrenme iÃ§eriÄŸi ortalandÄ± ve bÃ¼yÃ¼tÃ¼ldÃ¼ */
  .sentence{padding:12px;border-radius:8px;background:#fff;border-left:4px solid #667eea;margin:10px 0;font-weight:700;color:#0f1724; text-align: center;}
  #learningContent .sentence { font-size: 1.6rem; line-height: 1.4; }
  #learningContent #answerDisplay.sentence { font-size: 1.3rem; line-height: 1.4; background: #f0f4f8; }

  /* Kelime SÄ±ralama (WordOrder) Modunda dikey sÄ±ralama */
  .word-order-area { display: flex; flex-direction: column; gap: 12px; flex-wrap: nowrap; justify-content: center; align-items: center; padding: 10px 0; }
  .word-pool, .word-selected { width: 95%; min-width: 95%; text-align: center; border: 1px solid #ddd; border-radius: 8px; padding: 8px; }
  .word-item{display:inline-block;padding:8px 12px;border-radius:8px;background:#667eea;color:#fff;margin:6px;cursor:pointer;user-select:none}
  .word-item.top{background:#10b981}
  .word-item.disabled{background:#cbd5e1;color:#2d3748;cursor:not-allowed}

  .hint-area{margin-top:10px}
  .hint-item{background:#e6f3ff;padding:10px;border-left:4px solid #4299e1;border-radius:8px;margin:8px 0;color:#0f1724}
  .result{padding:10px;border-radius:8px;margin:8px 0;font-weight:700}
  .result.correct{background:#c6f6d5;color:#22543d;border-left:4px solid #48bb78}
  .result.incorrect{background:#fed7d7;color:#742a2a;border-left:4px solid #f56565}

  /* YENÄ°: Ä°lerleme (Progress) EkranÄ± Stilleri */
  .progress-stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
    gap: 12px;
    text-align: center;
    margin: 20px 0;
  }
  .stat-card {
    background: #f9fafb;
    padding: 20px 15px;
    border-radius: 12px;
  }
  .stat-card h4 {
    font-size: 1.1rem;
    color: #4a5568;
    margin-bottom: 8px;
  }
  .stat-card .stat-value {
    font-size: 2.5rem;
    font-weight: 800;
  }
  .stat-card-zor .stat-value { color: #f56565; }
  .stat-card-normal .stat-value { color: #d69e2e; }
  .stat-card-ogrendim .stat-value { color: #48bb78; }

  /* GECE MODU */
  body.night-mode{background:linear-gradient(135deg,#0f1724 0%,#071226 100%);color:#e6eef8}
  body.night-mode .container{background:#071226;color:#e6eef8;box-shadow:none}
  body.night-mode .section-title{border-bottom-color:#3b82f6;color:#e6eef8}
  body.night-mode .large-centered-title{color: #e6eef8;}
  body.night-mode .group-column-title{color: #e6eef8;border-bottom-color: #3b82f6;}
  body.night-mode .content-box{background:#071831;border-left-color:#3b82f6}
  body.night-mode .input-field, .night-mode .textarea-field, .night-mode .select-field{background:#041226;color:#e6eef8;border-color:#082036}
  body.night-mode .sentence{background:#071226;color:#e6eef8;border-left-color:#3b82f6}
  body.night-mode #learningContent #answerDisplay.sentence { background: #0f2742; }
  body.night-mode .word-item{background:#3b82f6;color:#fff}
  body.night-mode .word-item.top{background:#10b981}
  body.night-mode .hint-item{background:#052033;color:#c8ecff;border-left-color:#3b82f6}
  body.night-mode .stat-card { background: #071831; }
  body.night-mode .stat-card h4 { color: #9ca3af; }

  /* GECE MODU RENKLER */
  body.night-mode .btn-primary { background: #3b82f6; }
  body.night-mode .btn-primary:hover { background: #2563eb; }
  body.night-mode .btn-secondary { background: #334155; color: #e2e8f0; }
  body.night-mode .btn-secondary:hover { background: #475569; }
  body.night-mode .btn-info { background: #0d9488; }
  body.night-mode .btn-info:hover { background: #0f766e; }
  body.night-mode .btn-warning { background: #d97706; color: #fff; }
  body.night-mode .btn-warning:hover { background: #b45309; }
  body.night-mode .btn-ai { background: #6366f1; border-color: #4f46e5; }
  body.night-mode .btn-ai:hover { background: #4f46e5; }

  body.night-mode .btn.disabled, body.night-mode .btn:disabled {background:#1f2937;color:#4b5563;}
  body.night-mode .toggle-hint-btn{ background:#1f2937 }
  body.night-mode .group-story-grid .btn .small-muted { color: #9ca3af; }

  body.night-mode .button-grid-learning .btn { background: #334155; color: #e2e8f0; }
  body.night-mode .button-grid-learning .btn:hover { background: #475569; }
  body.night-mode .button-grid-learning .btn-danger { background: #f56565; color: #fff; }

  /* --- YENÄ°: KILAVUZ & IPUCU DETAY GÃ–RÃœNÃœMÃœ (v4.0) --- */
  /* Bu stil artÄ±k hem AI Ä°pucu hem de KÄ±lavuz sayfasÄ± iÃ§in kullanÄ±lacak */
  #detailViewLayer {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(135deg,#667eea 0%,#764ba2 100%);
    z-index: 1500;
    overflow-y: auto;
    padding: 20px;
    display: none; /* VarsayÄ±lan olarak gizli */
  }
  #detailViewLayer.active { display: block; }
  #detailViewLayer .container {
    max-width: 800px;
    margin: 40px auto;
    background: #fff;
    padding: 30px;
    border-radius: 16px;
    box-shadow: 0 0 20px rgba(0,0,0,0.3);
  }
  #detailViewLayer h2 {
    text-align: center;
    color: #667eea;
    margin-bottom: 20px;
    border-bottom: 3px solid #667eea;
    padding-bottom: 10px;
  }
  #detailViewLayer .content-box {
    background: #f0f4f8;
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 15px;
    border-left: 5px solid #667eea;
    font-size: 1.1rem;
    line-height: 1.6;
    white-space: pre-wrap; /* KÄ±lavuz metni iÃ§in Ã¶nemli */
  }
  body.night-mode #detailViewLayer {
      background: linear-gradient(135deg,#0f1724 0%,#071226 100%);
  }
  body.night-mode #detailViewLayer .container {
      background: #071226;
      color: #e6eef8;
      box-shadow: none;
  }
  body.night-mode #detailViewLayer h2 {
      color: #3b82f6;
      border-bottom-color: #3b82f6;
  }
  body.night-mode #detailViewLayer .content-box {
      background: #0f2742;
      border-left-color: #3b82f6;
      color: #e6eef8;
  }
  /* BitiÅŸ: Detay GÃ¶rÃ¼nÃ¼mÃ¼ Stili */

  /* YENÄ°: Ã‡alÄ±ÅŸma EkranÄ± Akordeon ButonlarÄ± (v4.0) */
  .learning-controls-main {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 8px;
    margin-top: 15px;
  }
  .learning-controls-main .btn {
    justify-content: center;
    text-align: center;
    font-size: 1rem;
    padding: 12px 8px;
    height: auto; 
  }
  .learning-controls-panel {
    display: none; /* BaÅŸlangÄ±Ã§ta gizli */
    background: #f0f4f8;
    border-radius: 12px;
    padding: 12px;
    margin-top: 10px;
    border: 1px solid #e5e7eb;
    animation: slideIn .18s ease; 
  }
  body.night-mode .learning-controls-panel {
      background: #0f1724;
      border-color: #334155;
  }
  /* Panellerdeki gridleri 2 sÃ¼tunlu yapalÄ±m */
  #panelHint .button-grid-learning {
      grid-template-columns: 1fr 1fr;
  }
  #panelEdit .button-grid-learning {
      grid-template-columns: 1fr 1fr; /* KÄ±rmÄ±zÄ± butonu kaldÄ±rdÄ±k */
  }
  #panelListen .button-grid-learning {
      grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
  }


  /* --- MÃ¼zik Ã‡alar Stilleri --- */
  .music-player-container {
    position: fixed;
    left: 18px;
    top: 18px;
    z-index: 1200;
    background: rgba(255, 255, 255, 0.9);
    border-radius: 25px;
    padding: 5px;
    box-shadow: 0 5px 15px rgba(0, 0, 0, .1);
    display: flex;
    align-items: center;
    transition: background .25s;
  }
  .music-toggle-btn {
    border: 0;
    background: #667eea;
    color: #fff;
    border-radius: 50%;
    width: 38px;
    height: 38px;
    font-size: 1.2rem;
    cursor: pointer;
    z-index: 2;
  }
  .music-volume-slider {
    display: none;
    margin-left: 8px;
    margin-right: 10px;
    width: 80px;
    vertical-align: middle;
    z-index: 1;
    transition: opacity 0.3s;
  }
  .music-player-container:hover .music-volume-slider {
    display: inline-block;
  }
  body.night-mode .music-player-container {
    background: rgba(31, 41, 55, 0.9);
  }
  body.night-mode .music-toggle-btn {
    background: #3b82f6;
  }

  /* GÃ¶ster butonunu ortalamak iÃ§in */
  .primary-action-container {
    display: flex;
    justify-content: center;
    margin-top: 15px;
    margin-bottom: 8px;
  }
  .primary-action-container .btn { /* ID'den class'a geÃ§iÅŸ */
    padding: 12px 24px;
    font-size: 1.1rem;
    min-width: 200px;
    justify-content: center;
    text-align: center;
    height: auto; 
  }
  /* #actionBtn iÃ§in Ã¶zel renkler */
  #actionBtn {
    background: #aeb4c5; 
    color: #1e293b;
  }
  #actionBtn:hover {
    background: #949daf;
  }
  body.night-mode #actionBtn {
    background: #334155;
    color: #e2eef0;
  }
  body.night-mode #actionBtn:hover {
    background: #475569;
  }
  
  
  /* MOBÄ°L CÄ°HAZ GÃ–RÃœNÃœM DÃœZELTMESÄ° (v4.0) */
  @media(max-width:768px){
    .container{padding:14px}
    /* TÃœM BUTTON-GRID'LERÄ° MOBÄ°LDE TEK SÃœTUNA Ã‡EVÄ°R VE GENÄ°ÅLET */
    .button-grid, 
    .group-story-grid { 
        grid-template-columns: 1fr !important; /* Tek sÃ¼tun ve tam geniÅŸlik */
    } 
    /* Standart grid buton yÃ¼ksekliÄŸi mobilde otomatik */
    .button-grid .btn { 
        height: auto; 
        padding: 16px; 
        font-size: 1.2rem;
    }
    /* Tekrar menÃ¼sÃ¼ butonlarÄ± (zaten auto idi) */
    #tekrarMenu .button-grid .btn {
      height: auto;
      padding: 16px;
      font-size: 1.2rem;
    }
    /* Grup menÃ¼sÃ¼ (zaten ayarlÄ±ydÄ±, kalsÄ±n) */
    .group-story-grid .btn {
      height: 60px;
      font-size: 1rem;
      padding: 10px 14px;
    }
    
    /* Akordeon Ana ButonlarÄ± (Mobilde 3'lÃ¼ kalsÄ±n) */
    .learning-controls-main {
        grid-template-columns: 1fr 1fr 1fr !important;
    }
    .learning-controls-main .btn {
        font-size: 0.9rem; /* Mobilde biraz kÃ¼Ã§Ã¼ltelim sÄ±ÄŸmasÄ± iÃ§in */
        padding: 10px 6px;
    }
    /* Akordeon Ä°Ã§ ButonlarÄ± (Mobilde tek sÃ¼tun) */
    .learning-controls-panel .button-grid-learning {
        grid-template-columns: 1fr !important;
    }

  }

</style>
</head>
<body>
<div id="musicPlayerContainer" class="music-player-container">
    <button id="musicToggleBtn" class="music-toggle-btn" title="MÃ¼zik Ã‡al/Durdur">ğŸ”Š</button>
    <input type="range" id="musicVolumeSlider" min="0" max="100" value="70" class="music-volume-slider" style="display: none;">
</div>

<div id="floatingNavTopRight">
    <button id="floatingGuideBtn" class="floating-nav-btn" title="KullanÄ±m KÄ±lavuzu" onclick="showGuide()">â­</button>
    <button id="modeToggleBtn" class="floating-nav-btn" title="Gece/GÃ¼ndÃ¼z toggle">ğŸŒ™</button>
</div>

<button id="floatingBackBtn" class="floating-nav-btn" title="Geri" onclick="goBackInHistory()">ğŸ”™</button>
<button id="floatingHomeBtn" class="floating-nav-btn" title="Ana MenÃ¼" onclick="showView('mainMenu')">ğŸ </button>
<button id="floatingAdminBtn" class="floating-nav-btn" title="YÃ¶netici" onclick="showView('adminView')">ğŸ”§</button>
<div class="container">
  <header>
    <img src="logo.png" alt="Verb Matrix Logo" style="max-width: 280px; height: auto; margin: 10px auto 0; display: block;">
    <div class="subtitle" id="appSubtitle" data-translate-key="app.subtitle">Fiiller Ä°le Almanca Ã–ÄŸrenme Platformu</div>
  </header>

  <div id="mainMenu" class="view active">
    <div class="button-grid">
      <button class="btn btn-primary" id="btnCalis" data-translate-key="menu.calis" onclick="loadAndShowGroupMenu()">ğŸ“š Ã‡alÄ±ÅŸ</button>
      <button class="btn btn-info" id="btnTekrar" data-translate-key="menu.tekrar" onclick="showView('tekrarMenu')">ğŸ”„ Tekrar</button>
      <button class="btn btn-warning" id="btnProgress" data-translate-key="menu.progress" onclick="showView('progress')">ğŸ“Š Ä°lerleme</button>
      <button class="btn btn-secondary" id="btnSettings" data-translate-key="menu.settings" onclick="showView('settings')">âš™ï¸ Ayarlar</button>
    </div>
  </div>

  <div id="tekrarMenu" class="view">
    <h2 class="large-centered-title" data-translate-key="titles.tekrar">ğŸ”„ TEKRAR</h2>
    <div class="button-grid">
      <button class="btn btn-srs-zor" onclick="startTekrar('zor')">
        <span data-translate-key="srs.zorlandiklarim">ZORLANDIKLARIM</span> (<span id="tekrarCountZor">0</span>)
      </button>
      <button class="btn btn-srs-normal" onclick="startTekrar('normal')">
        <span data-translate-key="srs.normal">NORMAL</span> (<span id="tekrarCountNormal">0</span>)
      </button>
      <button class="btn btn-srs-ogrendim" onclick="startTekrar('ogrendim')">
        <span data-translate-key="srs.ogrendiklerim">Ã–ÄRENDÄ°KLERÄ°M</span> (<span id="tekrarCountOgrenildi">0</span>)
      </button>
    </div>
    </div>

  <div id="tekrarModeMenu" class="view">
    <h2 class="large-centered-title" id="tekrarModeTitle">TEKRAR MODU</h2>

    <div class="content-box" style="margin-bottom: 20px;">
      <h4 data-translate-key="titles.conversionSelect">Ã‡eviri YÃ¶nÃ¼nÃ¼ SeÃ§in:</h4>
      <div class="button-grid" style="grid-template-columns: 1fr 1fr;">
        <button class="btn btn-primary" id="tekrarModeTRDE" onclick="setConversionMode('tr-de'); startTekrarModePrompt()">
            <span class="led-indicator" style="margin-right: 12px;"></span> ğŸ‡¹ğŸ‡· TR â†’ DE ğŸ‡©ğŸ‡ª
        </button>
        <button class="btn btn-info" id="tekrarModeDETR" onclick="setConversionMode('de-tr'); startTekrarModePrompt()">
            <span class="led-indicator" style="margin-right: 12px;"></span> ğŸ‡©ğŸ‡ª DE â†’ TR ğŸ‡¹ğŸ‡·
        </button>
      </div>
    </div>

    <div class="button-grid">
      <button class="btn btn-secondary" onclick="startTekrarMode('cloze')">ğŸ”² <span data-translate-key="modes.cloze">BoÅŸluk Doldurma</span></button>
      <button class="btn btn-secondary" onclick="startTekrarMode('wordorder')">ğŸ”¤ <span data-translate-key="modes.wordorder">Kelimeleri SÄ±ralama</span></button>
      <button class="btn btn-primary" onclick="startTekrarMode('quiz')">ğŸ¯ <span data-translate-key="modes.quiz">Quiz (Test)</span></button>
    </div>
    </div>

  <div id="groupMenu" class="view">
    <div class="group-select-header">
      <h2 data-translate-key="titles.start">BAÅLA</h2>
    </div>
    <div class="group-select-columns">
      <div class="group-column-title-container">
        <div class="group-column-title" data-translate-key="titles.groupSelect">Fiil SeÃ§</div>
      </div>
      <div class="group-column-title-container">
        <div class="group-column-title" data-translate-key="titles.storySelect">Hikaye SeÃ§</div>
      </div>
    </div>
    <div id="groupButtons"></div>
    </div>

  <div id="verbMenu" class="view">
    <h2 class="section-title" data-translate-key="titles.verbSelect">FÄ°Ä°L SEÃ‡</h2>
    <div id="verbButtons" class="button-grid"></div>
    </div>

  <div id="sectionMenu" class="view">
    <h2 class="section-title" data-translate-key="titles.sectionSelect">BÃ–LÃœM SEÃ‡</h2>
    <div id="sectionButtons" class="button-grid"></div>
    </div>

  <div id="modeMenu" class="view">
    <h2 class="large-centered-title" data-translate-key="titles.conversionSelect">Ã‡EVÄ°RÄ° YÃ–NÃœ</h2>

    <div class="content-box" style="margin-bottom: 20px;">
      <h4 data-translate-key="titles.conversionSelect">Ã‡eviri YÃ¶nÃ¼nÃ¼ SeÃ§in:</h4>
      <div class="button-grid" style="grid-template-columns: 1fr 1fr;">
        <button class="btn btn-primary" id="modeTRDE" onclick="setConversionMode('tr-de'); startMode('study')">ğŸ‡¹ğŸ‡· TR â†’ DE ğŸ‡©ğŸ‡ª</button>
        <button class="btn btn-info" id="modeDETR" onclick="setConversionMode('de-tr'); startMode('study')">ğŸ‡©ğŸ‡ª DE â†’ TR ğŸ‡¹ğŸ‡·</button>
      </div>
    </div>
    </div>

  <div id="learningView" class="view">
    <h2 class="section-title" id="learningTitle">ğŸ“š Ã‡alÄ±ÅŸma</h2>
    <h3 id="learningSubtitle" style="text-align:center; color: #4a5568; font-weight: 600; margin-top: -10px; margin-bottom: 10px;"></h3>
    
    <div class="progress-container">
      <div class="progress-bar"><div id="progressFill" class="progress-fill">0%</div></div>
      <div style="text-align:center;margin-top:8px;font-weight:700;"><span id="progressText">0 / 0</span></div>
    </div>
    <div class="content-box">
      <div id="learningContent"></div>
      <div id="hintPanel" class="hint-area" style="display:none"></div>
      <div id="resultArea"></div>
      <div id="answerArea"></div>
    </div>
    
    <div id="completionControls" class="primary-action-container" style="display: none; margin-top: 15px;">
        <button class="btn btn-primary" id="nextStepBtn" style="min-width: 250px; justify-content: center;"></button>
    </div>

    <div id="srsControls" class="button-group-row">
        <button class="btn btn-srs-zor" onclick="rateCard('zor')">ğŸ¥µ <span data-translate-key="srs.zor">ZOR</span></button>
        <button class="btn btn-srs-normal" onclick="rateCard('normal')">ğŸ¤” <span data-translate-key="srs.normal">NORMAL</span></button>
        <button class="btn btn-srs-ogrendim" onclick="rateCard('ogrendim')">âœ… <span data-translate-key="srs.ogrendim">Ã–ÄRENDÄ°M</span></button>
    </div>
    <div id="quickEditPanel" class="content-box" style="display:none; margin-top: 15px;">
        <h4 id="quickEditTitle" style="margin-bottom: 10px;">Sayfa Ä°Ã§eriÄŸi HÄ±zlÄ± DÃ¼zenleme</h4>
        <label style="display:block;margin-top:12px;" data-translate-key="labels.tr">TR CÃ¼mle:</label>
        <textarea id="qe_tr" class="textarea-field" rows="3"></textarea>
        <label style="display:block;margin-top:12px;" data-translate-key="labels.de">DE CÃ¼mle:</label>
        <textarea id="qe_de" class="textarea-field" rows="3"></textarea>
        <label style="display:block;margin-top:12px;" data-translate-key="labels.hintText">CÃ¼mle Ä°pucu:</label>
        <textarea id="qe_hint" class="textarea-field" rows="3" placeholder="Bu cÃ¼mleye Ã¶zel ipucu ekleyin/dÃ¼zenleyin."></textarea>
        <div class="button-group-row">
            <button class="btn btn-secondary" onclick="saveQuickEdit()">âœ… <span data-translate-key="buttons.save">Kaydet</span> & Kapat</button>
            <button class="btn btn-danger" onclick="document.getElementById('quickEditPanel').style.display='none'" data-translate-key="buttons.cancel">Ä°ptal</button>
        </div>
    </div>
    <div class="primary-action-container">
      <button class="btn" id="actionBtn" data-translate-key="buttons.show" onclick="handleAction()">Kontrol Et / GÃ¶ster</button>
    </div>

    <div id="learningControlsAccordion">
        <div class="learning-controls-main">
            <button class="btn btn-info" onclick="toggleLearningPanel('panelHint')">ğŸ’¡ Ä°pucu</button>
            <button class="btn btn-primary" onclick="toggleLearningPanel('panelListen')">ğŸ”Š Dinle</button>
            <button class="btn btn-secondary" onclick="toggleLearningPanel('panelEdit')">âœï¸ DÃ¼zenle</button>
        </div>

        <div id="panelHint" class="learning-controls-panel">
            <div class="button-grid-learning">
                <button class="btn btn-ai" onclick="getAIHint()">ğŸ§  AI Ä°pucu Al</button>
                <button class="btn btn-info" onclick="showHintDetail('section')">BÃ¶lÃ¼m Ä°pucu</button>
                <button class="btn btn-info" onclick="showHintDetail('verb')">Fiil Ä°pucu</button>
                <button class="btn" id="toggleHintBtn" data-translate-key="buttons.hintToggle" onclick="toggleHintPanel()">CÃ¼mle Ä°pucu</button>
            </div>
        </div>
        <div id="panelListen" class="learning-controls-panel">
             <div class="button-grid-learning">
                <button class="btn" id="autoPlayBtn" onclick="toggleAutoPlay()">
                    <span class="led-indicator" id="autoPlayLed"></span>Otomatik Dinle
                </button>
                <button class="btn" id="slowModeToggleBtn" onclick="toggleSpeechSpeed()">
                    <span class="led-indicator" id="slowModeLedL"></span>ğŸ”Š YavaÅŸ Mod
                </button>
                <button class="btn" id="pauseBtn" onclick="toggleSpeechPause()">â¸ï¸ Durdur</button>
                <button class="btn" id="btnPlayDE" data-translate-key="buttons.playDE" onclick="playCurrentSentence('de')">ğŸ”Š Almanca Dinle</button>
                <button class="btn" id="btnPlayTR" data-translate-key="buttons.playTR" onclick="playCurrentSentence('tr')">ğŸ”Š TÃ¼rkÃ§e Dinle</button>
             </div>
        </div>
        <div id="panelEdit" class="learning-controls-panel">
             <div class="button-grid-learning">
                <button class="btn" id="btnQuickEdit" onclick="showQuickEditPanel()">âœï¸ DÃ¼zelt/Ekle</button>
                <button class="btn" onclick="previousQuestion()" data-translate-key="buttons.previous">â† Ã–nceki</button>
                </div>
        </div>
    </div>
    </div>

  <div id="detailViewLayer" class="view">
    <div class="container">
        <h2 id="detailViewTitle"></h2>
        <div id="detailViewContent" class="content-box" style="white-space: pre-wrap;"></div>
        </div>
  </div>

  <div id="storyView" class="view">
    <h2 class="section-title" id="storyTitle" data-translate-key="titles.story">Hikaye</h2>
    <div class="content-box" id="storyContent"></div>
    <div class="button-grid-learning">
      <button class="btn btn-warning" onclick="showStoryQuestions()" data-translate-key="buttons.questions">ğŸ“ Sorular</button>
      <button class="btn" id="storySlowModeToggleBtn" onclick="toggleSpeechSpeed()">
        <span class="led-indicator" id="slowModeLedS"></span>ğŸ”Š YavaÅŸ Mod
      </button>
      <button class="btn" id="storyPauseBtn" onclick="toggleSpeechPause()">â¸ï¸ Durdur</button>
      <button class="btn" id="btnPlayDE" data-translate-key="buttons.playDE" onclick="playStoryAudio('de')">ğŸ”Š Almanca Dinle</button>
      <button class="btn" onclick="playStoryAudio('tr')" data-translate-key="buttons.playTR">ğŸ”Š TÃ¼rkÃ§e Dinle</button>
      </div>
  </div>

  <div id="storyQuestionsView" class="view">
    <h2 class="section-title" data-translate-key="titles.storyQuestions">Hikaye SorularÄ±</h2>
    <div class="content-box" id="storyQuestionsContent"></div>
    </div>

  <div id="settings" class="view">
    <h2 class="section-title" data-translate-key="titles.settings">âš™ï¸ Ayarlar</h2>
    <div class="content-box">
      <h3 data-translate-key="settings.dataManagement">ğŸ’¾ Veri YÃ¶netimi</h3>
      <div class="button-grid" style="grid-template-columns: 1fr 1fr; margin-top: 10px;">
        <button class="btn btn-primary" style="width:100%;" onclick="importDataFromFile()" data-translate-key="buttons.importJSON">ğŸ“¥ Ä°Ã§erik YÃ¼kle (JSON)</button>
        <button class="btn btn-secondary" style="width:100%;" onclick="exportData()" data-translate-key="buttons.exportJSON">ğŸ“¤ Ä°Ã§erik Ä°ndir (JSON)</button>
      </div>
    </div>
    <div class="content-box">
      <h3 data-translate-key="settings.appearance">ğŸ¨ GÃ¶rÃ¼nÃ¼m ve DiÄŸer</h3>
      <div style="margin-top: 12px;">
          <label style="display:block;font-weight:700;margin-bottom:6px" data-translate-key="settings.language">Dil:</label>
          <div style="display:flex;gap:8px">
            <button class="lang-btn active" id="langTR" onclick="changeLanguage('tr', this)">TÃ¼rkÃ§e</button>
            <button class="lang-btn" id="langDE" onclick="changeLanguage('de', this)">Deutsch</button>
          </div>
      </div
      ><label style="display:flex;align-items:center;gap:8px;margin-top:15px;">
          <input type="checkbox" id="nightModeToggle" style="width: 20px; height: 20px;"> <span data-translate-key="settings.nightMode">Gece Modu</span>
      </label>
      <div style="margin-top: 15px;">
        <label style="display:block;font-weight:700;margin-bottom:6px" data-translate-key="settings.music">MÃ¼zik:</label>
        <div style="display:flex; align-items: center; gap: 10px;">
          <button id="settingsMusicToggle" class="btn btn-primary btn-small" onclick="musicPlayer.toggleMusic()">ğŸ”Š Ã‡al/Durdur</button>
          <input type="range" id="settingsMusicVolume" min="0" max="100" value="70" style="flex: 1;">
        </div>
      </div>
    </div>
    <div class="content-box">
        <h3 data-translate-key="settings.appUpdate">ğŸ”„ Uygulama</h3>
        <button class="btn btn-warning" style="width:100%; margin-top: 10px;" onclick="forceUpdateApp()" data-translate-key="buttons.forceUpdate">ğŸ”„ UygulamayÄ± GÃ¼ncelle</button>
    </div>
    <div class="content-box" style="margin-top:12px">
      <h3 data-translate-key="settings.pasteJSONTitle">ğŸ“ JSON YapÄ±ÅŸtÄ±r (Mobil)</h3>
      <textarea id="jsonPaste" class="textarea-field" data-translate-key="placeholders.jsonPaste" placeholder="JSON iÃ§eriÄŸinizi buraya yapÄ±ÅŸtÄ±rÄ±n..." rows="5"></textarea>
      <div class="button-group-row" style="margin-top:8px">
        <button class="btn btn-primary" onclick="loadJsonFromTextarea()" data-translate-key="buttons.pasteAndLoad">ğŸ“¥ YapÄ±ÅŸtÄ±r & YÃ¼kle</button>
        <button class="btn btn-danger" onclick="document.getElementById('jsonPaste').value=''" data-translate-key="buttons.clear">Temizle</button>
      </div>
    </div>
    </div>

  <div id="progress" class="view">
    <h2 class="section-title" data-translate-key="titles.progress">ğŸ“Š Ä°lerleme</h2>
    <div class="content-box">
      <h3 data-translate-key="titles.srsStats">Tekrar Durumu</h3>
      <div class="progress-stats-grid">
        <div class="stat-card stat-card-zor">
          <h4 data-translate-key="srs.zorlandiklarim">ZORLANDIKLARIM</h4>
          <div class="stat-value" id="progressStatZor">0</div>
        </div>
        <div class="stat-card stat-card-normal">
          <h4 data-translate-key="srs.normal">NORMAL</h4>
          <div class="stat-value" id="progressStatNormal">0</div>
        </div>
        <div class="stat-card stat-card-ogrendim">
          <h4 data-translate-key="srs.ogrendiklerim">Ã–ÄRENDÄ°KLERÄ°M</h4>
          <div class="stat-value" id="progressStatOgrenildi">0</div>
        </div>
      </div>
    </div>
    <div class="content-box">
      <h3 data-translate-key="titles.totalProgress">Toplam Ã‡alÄ±ÅŸma Ä°lerlemesi</h3>
      <p class="small-muted" data-translate-key="messages.totalProgressDesc">TÃ¼m iÃ§erikteki (cÃ¼mlelerdeki) ilerleme durumunuz.</p>
      <div class="progress-container" style="margin-top: 15px;">
        <div class="progress-bar"><div id="totalProgressFill" class="progress-fill">0%</div></div>
        <div style="text-align:center;margin-top:8px;font-weight:700;"><span id="totalProgressText">0 / 0</span></div>
      </div>
    </div>
    <div class="content-box">
        <h3 data-translate-key="settings.progressManagement">ğŸ’¾ Ä°lerleme Veri YÃ¶netimi</h3>
        <div class="button-grid" style="grid-template-columns: 1fr 1fr; margin-top: 10px;">
           <button class="btn btn-primary" style="width:100%;" onclick="importSrsData()" data-translate-key="buttons.importProgress">ğŸ“¥ Ä°lerleme YÃ¼kle</button>
           <button class="btn btn-secondary" style="width:100%;" onclick="exportSrsData()" data-translate-key="buttons.exportProgress">ğŸ“¤ Ä°lerleme Ä°ndir</button>
        </div>
        <button class="btn btn-danger" style="width:100%; margin-top: 10px;" onclick="resetSrsData()" data-translate-key="buttons.resetSrs">âš ï¸ TÃ¼m Ä°lerlemeyi SÄ±fÄ±rla</button>
    </div>
    </div>

  <div id="adminView" class="view">
    <h2 class="section-title" data-translate-key="titles.adminPanel">ğŸ”§ YÃ¶netici Paneli</h2>
    <div class="button-grid">
      <button class="btn btn-primary" onclick="showView('adminContentView')" data-translate-key="admin.contentManagement">ğŸ“š Ä°Ã§erik YÃ¶netimi</button>
      <button class="btn btn-warning" onclick="showGroupVerbImporter()">ğŸ—ï¸ Grup & Fiil YÃ¼kle</button>
      <button class="btn btn-info" onclick="showTsvImporter()">ğŸ“Š Toplu CÃ¼mle YÃ¼kle</button>
      <button class="btn btn-secondary" onclick="showView('adminSentenceListView')" data-translate-key="admin.listAllSentences">ğŸ“‹ TÃ¼m CÃ¼mleleri Listele</button>
    </div>

    <div id="adminGroupVerbArea" class="content-box" style="display:none; margin-top: 15px; border-color: #fbd38d;">
        <h4 data-translate-key="admin.groupVerbTitle">ğŸ—ï¸ Toplu Grup & Fiil YÃ¼kleme</h4>
        <p class="small-muted" data-translate-key="admin.groupVerbDesc">
          Excel'den kopyaladÄ±ÄŸÄ±nÄ±z YENÄ° GRUP ve FÄ°Ä°L listenizi buraya yapÄ±ÅŸtÄ±rÄ±n.<br>
          KullanmanÄ±z gereken sÃ¼tun sÄ±rasÄ± (Sekme/Tab ile ayrÄ±lmÄ±ÅŸ):<br>
          <b>GrupID | GrupAdÄ± | FiilID | FiilAdÄ± (TR) | FiilAdÄ± (DE)</b>
        </p>
        <textarea id="groupVerbPasteArea" class="textarea-field" rows="10" placeholder="g21 (Tab) PAKET TESLÄ°M SÃœRECÄ° (Tab) v61 (Tab) almak, toplamak (Tab) abholen..."></textarea>
        <div class="button-group-row">
            <button class="btn btn-warning" onclick="parseAndImportGroupsAndVerbs()">âœ… <span data-translate-key="buttons.pasteAndLoadTsv">YÃ¼kle ve Ä°ÅŸle</span></button>
            <button class="btn btn-danger" onclick="document.getElementById('adminGroupVerbArea').style.display='none'" data-translate-key="buttons.cancel">Ä°ptal</button>
        </div>
    </div>

    <div id="adminTsvArea" class="content-box" style="display:none; margin-top: 15px; border-color: #10b981;">
        <h4 data-translate-key="admin.tsvTitle">ğŸ“Š Toplu CÃ¼mle YÃ¼kleme (Excel'den Kopyala-YapÄ±ÅŸtÄ±r)</h4>
        <p class="small-muted" data-translate-key="admin.tsvDesc">
          Excel veya Google E-Tablolar'da hazÄ±rladÄ±ÄŸÄ±nÄ±z veriyi buraya yapÄ±ÅŸtÄ±rÄ±n.<br>
          KullanmanÄ±z gereken sÃ¼tun sÄ±rasÄ± (BAÅLIK SATIRI OLMADAN):<br>
          <b>GrupID | FiilID | BÃ¶lÃ¼mNumarasÄ± | TR_CÃ¼mle | DE_CÃ¼mle | CÃ¼mleIpucu (Ä°steÄŸe baÄŸlÄ±)</b>
        </p>
        <textarea id="tsvPasteArea" class="textarea-field" rows="10" placeholder="GrupID (Tab/VirgÃ¼l) FiilID (Tab/VirgÃ¼l) BÃ¶lÃ¼mNo (Tab/VirgÃ¼l) TR CÃ¼mle..."></textarea>
        <div class="button-group-row">
            <button class="btn btn-info" onclick="parseAndImportTsv()">âœ… <span data-translate-key="buttons.pasteAndLoadTsv">YÃ¼kle ve Ä°ÅŸle</span></button>
            <button class="btn btn-danger" onclick="document.getElementById('adminTsvArea').style.display='none'" data-translate-key="buttons.cancel">Ä°ptal</button>
        </div>
    </div>
    </div>

  <div id="adminContentView" class="view">
     <h2 class="section-title" data-translate-key="admin.contentManagement">ğŸ“š Ä°Ã§erik YÃ¶netimi</h2>
     <div class="button-grid" style="grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));">
        <button class="btn btn-warning" onclick="showAdminForm('groupOrder')">â†•ï¸ SÄ±ralamayÄ± DÃ¼zenle (Gruplar)</button>  <button class="btn btn-primary" onclick="showAdminForm('addGroup')">â• <span data-translate-key="admin.addGroup">Grup Ekle/DÃ¼zenle</span></button>
        <button class="btn btn-primary" onclick="showAdminForm('addVerb')">â• <span data-translate-key="admin.addVerb">Fiil Ekle/DÃ¼zenle</span></button>
        <button class="btn btn-primary" onclick="showAdminForm('addSection')">â• <span data-translate-key="admin.addSection">BÃ¶lÃ¼m Ekle/DÃ¼zenle</span></button>
        <button class="btn btn-info" onclick="showAdminForm('addStory')">â• <span data-translate-key="admin.addStory">Hikaye Ekle/DÃ¼zenle</span></button>
        <button class="btn btn-info" onclick="showAdminForm('addHint')">ğŸ’¡ <span data-translate-key="admin.hintManagement">Ä°pucu Ekle/DÃ¼zenle</span></button>
        <button class="btn btn-secondary" onclick="showAdminForm('editSentence')">âœï¸ <span data-translate-key="admin.editSentence">CÃ¼mle Ekle/DÃ¼zenle</span></button>
        <button class="btn btn-primary" onclick="showAdminForm('editGuide')">â­ <span data-translate-key="admin.editGuide">KÄ±lavuz Metnini DÃ¼zenle</span></button>
     </div>
     <div id="adminContentArea" class="content-box" style="margin-top: 15px; display: none;">
     </div>
     </div>

  <div id="adminSentenceListView" class="view">
    <h2 class="section-title" data-translate-key="admin.listAllSentences">ğŸ“‹ TÃ¼m CÃ¼mleleri Listele</h2>
    <div class="content-box">
      <div class="button-group-row" style="margin-bottom:8px;">
        <button class="btn btn-secondary" onclick="renderAllSentencesTable()" data-translate-key="buttons.refreshList">ğŸ”„ Yenile Liste</button>
        <button class="btn btn-warning" onclick="exportSentencesCsv()" data-translate-key="buttons.exportCSV">ğŸ“¤ TSV Ä°ndir (Tablo)</button>
      </div>
      <div id="allSentencesTable" style="max-height:60vh;overflow:auto"></div>
    </div>
    </div>
</div>

<input type="file" id="fileInput" accept=".json" style="display:none">
<input type="file" id="progressFileInput" accept=".json" style="display:none">
<script>
/* ===============================
    Verb Matrix â€” v4.0 (Nihai SÃ¼rÃ¼m)
    =============================== */

/* ---------------- VarsayÄ±lan Veri --------------- */
let data = {
  groups: [ { id: "g1", name: "VarsayÄ±lan Grup", nameDE: "Standardgruppe" } ],
  verbs: { g1: [ { id:'v1', verbTR:'YÃ¼kleniyor...', verbDE:'Laden...' } ] },
  content: {},
  sections: { 1: "BÃ¶lÃ¼m 1" },
  hints: { sentences: {}, verbs: {}, sections: {} },
  // YENÄ°: Dinamik KÄ±lavuz Metni (v4.0)
  guideText: {
      title: "KullanÄ±m KÄ±lavuzu",
      content: "KÄ±lavuz metni buraya gelecek.\n\nBu alanÄ± Admin panelinden dÃ¼zenleyebilirsiniz."
  },
  translations: {
    tr: {
      app: { subtitle: 'Fiiller Ä°le Almanca Ã–ÄŸrenme Platformu' },
      menu: {
        calis: 'ğŸ“š Ã‡alÄ±ÅŸ',
        tekrar: 'ğŸ”„ Tekrar',
        settings: 'âš™ï¸ Ayarlar',
        progress: 'ğŸ“Š Ä°lerleme',
        admin: 'ğŸ”§ YÃ¶netici'
      },
      titles: {
        start: 'BAÅLA',
        tekrar: 'ğŸ”„ TEKRAR',
        guide: 'â­ KullanÄ±m KÄ±lavuzu', // YENÄ°
        groupSelect: 'Fiil SeÃ§',
        storySelect: 'Hikaye SeÃ§',
        verbSelect: 'FÄ°Ä°L SEÃ‡',
        sectionSelect: 'BÃ–LÃœM SEÃ‡',
        modeSelect: 'MODU SEÃ‡',
        conversionSelect: 'Ã‡EVÄ°RÄ° YÃ–NÃœ',
        learning: 'ğŸ“š Ã‡alÄ±ÅŸma', // v4.0 (Dinamik alt baÅŸlÄ±k)
        story: 'Hikaye',
        storyQuestions: 'Hikaye SorularÄ±',
        settings: 'âš™ï¸ Ayarlar',
        progress: 'ğŸ“Š Ä°lerleme',
        adminPanel: 'ğŸ”§ YÃ¶netici Paneli',
        srsStats: 'Tekrar Durumu',
        totalProgress: 'Toplam Ã‡alÄ±ÅŸma Ä°lerlemesi'
      },
      buttons: {
        // KÄ±rmÄ±zÄ± butonlar kaldÄ±rÄ±ldÄ±
        show: 'GÃ¶ster', next: 'â†’ Sonraki', check: 'Kontrol Et', start: 'BaÅŸla',
        previous: 'â† Ã–nceki', hintToggle: 'CÃ¼mle Ä°pucu', 
        questions: 'ğŸ“ Sorular', playDE: 'ğŸ”Š Almanca Dinle', playTR: 'ğŸ”Š TÃ¼rkÃ§e Dinle',
        importJSON: 'ğŸ“¥ Ä°Ã§erik YÃ¼kle (JSON)', exportJSON: 'ğŸ“¤ Ä°Ã§erik Ä°ndir (JSON)',
        importProgress: 'ğŸ“¥ Ä°lerleme YÃ¼kle', exportProgress: 'ğŸ“¤ Ä°lerleme Ä°ndir',
        resetSrs: 'âš ï¸ TÃ¼m Ä°ilerlemeyi SÄ±fÄ±rla',
        pasteAndLoad: 'ğŸ“¥ YapÄ±ÅŸtÄ±r & YÃ¼kle', clear: 'Temizle',
        refreshList: 'ğŸ”„ Yenile Liste', exportCSV: 'ğŸ“¤ TSV Ä°ndir (Tablo)',
        save: 'Kaydet', cancel: 'Ä°ptal', update: 'GÃ¼ncelle', add: 'Ekle', delete: 'Sil', edit: 'DÃ¼zenle',
        nextSection: 'â†’ Sonraki BÃ¶lÃ¼m',
        nextVerb: 'â†’ Sonraki Fiil',
        goToStory: 'â†’ Hikayeye Git',
        startStudy: 'ğŸ“– Ã‡alÄ±ÅŸmaya BaÅŸla',
        forceUpdate: 'ğŸ”„ UygulamayÄ± GÃ¼ncelle',
        pasteAndLoadTsv: 'YÃ¼kle ve Ä°ÅŸle'
      },
      settings: {
        appearance: 'ğŸ¨ GÃ¶rÃ¼nÃ¼m ve DiÄŸer', nightMode: 'Gece Modu', language: 'Dil:', music: 'MÃ¼zik:',
        dataManagement: 'ğŸ’¾ Ä°Ã§erik Veri YÃ¶netimi',
        progressManagement: 'ğŸ’¾ Ä°lerleme Veri YÃ¶netimi',
        appUpdate: 'ğŸ”„ Uygulama',
        pasteJSONTitle: 'ğŸ“ JSON YapÄ±ÅŸtÄ±r (Mobil)',
        pasteJSONDesc: 'Ä°Ã§erik JSON dosyanÄ±zÄ± buraya yapÄ±ÅŸtÄ±rÄ±n...'
      },
      admin: {
        contentManagement: 'ğŸ“š Ä°Ã§erik YÃ¶netimi',
        listAllSentences: 'ğŸ“‹ TÃ¼m CÃ¼mleleri Listele',
        addGroup: 'Grup Ekle/DÃ¼zenle', addVerb: 'Fiil Ekle/DÃ¼zenle', addSection: 'BÃ¶lÃ¼m Ekle/DÃ¼zenle',
        editSentence: 'CÃ¼mle Ekle/DÃ¼zenle', addStory: 'Hikaye Ekle/DÃ¼zenle',
        hintManagement: 'Ä°pucu Ekle/DÃ¼zenle',
        editGuide: 'â­ KÄ±lavuz Metnini DÃ¼zenle', // YENÄ°
        groupVerbTitle: 'ğŸ—ï¸ Toplu Grup & Fiil YÃ¼kleme',
        groupVerbDesc: 'Excel\'den kopyaladÄ±ÄŸÄ±nÄ±z YENÄ° GRUP ve FÄ°Ä°L listenizi buraya yapÄ±ÅŸtÄ±rÄ±n.<br>KullanmanÄ±z gereken sÃ¼tun sÄ±rasÄ± (Sekme/Tab ile ayrÄ±lmÄ±ÅŸ):<br><b>GrupID | GrupAdÄ± | FiilID | FiilAdÄ± (TR) | FiilAdÄ± (DE)</b>',
        tsvTitle: 'ğŸ“Š Toplu CÃ¼mle YÃ¼kleme (Excel\'den Kopyala-YapÄ±ÅŸtÄ±r)',
        tsvDesc: 'Excel veya Google E-Tablolar\'da hazÄ±rladÄ±ÄŸÄ±nÄ±z veriyi buraya yapÄ±ÅŸtÄ±rÄ±n.<br>KullanmanÄ±z gereken sÃ¼tun sÄ±rasÄ± (BAÅLIK SATIRI OLMADAN):<br><b>GrupID | FiilID | BÃ¶lÃ¼mNumarasÄ± | TR_CÃ¼mle | DE_CÃ¼mle | CÃ¼mleIpucu (Ä°steÄŸe baÄŸlÄ±)</b>'
      },
      labels: {
        group: 'Grup:', verb: 'Fiil:', section: 'BÃ¶lÃ¼m:', sentence: 'CÃ¼mle:', index: 'Index:',
        hintText: 'Ä°pucu metni:', tr: 'TR:', de: 'DE:', title: 'BaÅŸlÄ±k:', deText: 'DE metin:', trText: 'TR metin:',
        groupID: 'Grup ID (Ã¶r: g5):', groupNameTR: 'Ad (TR):', groupNameDE: 'Ad (DE):',
        verbID: 'Fiil ID (Ã¶rn v10):', verbTR: 'Fiil TR:', verbDE: 'Fiil DE:',
        sectionCode: 'BÃ¶lÃ¼m Kodu (Ã¶rn: B1):',
        sectionNum: 'BÃ¶lÃ¼m NumarasÄ± (Ã¶rn: 1):', sectionName: 'BÃ¶lÃ¼m AdÄ± (Ã¶rn: KiÅŸi Zamiri):',
        question: 'Soru:', options: 'SeÃ§enekler (virgÃ¼lle ayÄ±r):',
        correctAnswer: 'DoÄŸru cevap (tam metin):',
        guideTitle: 'KÄ±lavuz BaÅŸlÄ±ÄŸÄ±:', // YENÄ°
        guideContent: 'KÄ±lavuz Ä°Ã§eriÄŸi (Metin):' // YENÄ°
      },
      placeholders: {
        jsonPaste: 'JSON iÃ§eriÄŸinizi buraya yapÄ±ÅŸtÄ±rÄ±n...',
        cloze: 'BoÅŸluÄŸu doldurun...',
        quiz: 'Ã‡eviriyi yazÄ±n...'
      },
      messages: {
        noGroups: 'HenÃ¼z grup yok. JSON yÃ¼kleyin.',
        noVerbs: 'Bu grupta fiil bulunamadÄ±.',
        noSentences: 'Bu fiil ve bÃ¶lÃ¼m iÃ§in cÃ¼mle bulunamadÄ±!',
        noDueCards: 'Bu kategoride tekrar edilecek kart kalmadÄ±! ğŸ‰',
        noNewCards: 'Bu bÃ¶lÃ¼mdeki tÃ¼m kartlarÄ± Ã§alÄ±ÅŸtÄ±nÄ±z! ğŸ‰',
        noStory: 'Bu grup iÃ§in hikaye bulunamadÄ±!',
        noStoryAvailable: 'Hikaye Yok',
        noStoryQuestions: 'Bu hikaye iÃ§in henÃ¼z soru yok.',
        noProgress: 'HenÃ¼z ilerleme yok.',
        noHints: 'Yok',
        noStoryFound: 'Hikaye bulunamadÄ±',
        ttsNotSupported: 'TarayÄ±cÄ± TTS desteklemiyor.',
        dataLoaded: 'âœ“ Ä°Ã§erik verisi yÃ¼klendi. Grup sayÄ±sÄ±:',
        progressLoaded: 'âœ“ Ä°lerleme verisi yÃ¼klendi.',
        invalidJSON: 'âœ— GeÃ§ersiz JSON formatÄ±.',
        loadError: 'âœ— Hata:',
        dataExported: 'âœ“ Ä°Ã§erik verisi (verbmatrix_data.json) indirildi!',
        progressExported: 'âœ“ Ä°lerleme verisi (verbmatrix_ilerleme_data.json) indirildi!',
        srsReset: 'âœ“ TÃ¼m Ã§alÄ±ÅŸma (SRS) verisi sÄ±fÄ±rlandÄ±.',
        jsonStatus: 'ğŸ“Š JSON DURUMU',
        allFieldsError: 'TÃ¼m alanlarÄ± doldurun',
        hintSaved: 'âœ… Ä°pucu kaydedildi',
        guideSaved: 'âœ… KÄ±lavuz metni kaydedildi', // YENÄ°
        quickEditSaved: 'âœ… CÃ¼mle ve ipucu gÃ¼ncellendi (Yerel olarak kaydedildi)!',
        overrideReset: 'âœ… Ä°Ã§erik dÃ¼zeltmeleri silindi. Sayfa yenilendikten sonra varsayÄ±lan iÃ§eriÄŸe dÃ¶nÃ¼lecektir.',
        srsResetConfirm: 'TÃ¼m Ã§alÄ±ÅŸma (AralÄ±klÄ± Tekrar) verilerinizi sÄ±fÄ±rlamak istediÄŸinizden emin misiniz? TÃ¼m kartlarÄ±n ilerlemesi (Zor, Normal, Ã–ÄŸrendim) silinecektir.',
        totalProgressDesc: 'TÃ¼m iÃ§erikteki (cÃ¼mlelerdeki) ilerleme durumunuz.',
        srsPromotion: 'ğŸ‰ Tebrikler! Kart "%s" listesine taÅŸÄ±ndÄ±.',
        srsDemotion: 'ğŸ¤” Dikkat! Kart "%s" listesine taÅŸÄ±ndÄ±.'
      },
      srs: {
        zor: 'ğŸ¥µ ZOR',
        normal: 'ğŸ¤” NORMAL',
        ogrendim: 'âœ… Ã–ÄRENDÄ°M',
        zorlandiklarim: 'ZORLANDIKLARIM',
        ogrendiklerim: 'Ã–ÄRENDÄ°KLERÄ°M'
      },
      modes: {
          cloze: 'BoÅŸluk Doldurma',
          wordorder: 'Kelimeleri SÄ±ralama',
          quiz: 'Quiz (Test)',
          study: 'Ã‡alÄ±ÅŸma (Yeni Kartlar)'
      }
    },
    de: { // Almanca Ã§eviriler (kÄ±saltÄ±ldÄ±)
      app: { subtitle: 'Deutsch-Lernplattform mit Verben' },
      menu: { calis: 'ğŸ“š Lernen', tekrar: 'ğŸ”„ Wiederholen', settings: 'âš™ï¸ Einstellungen', progress: 'ğŸ“Š Fortschritt', admin: 'ğŸ”§ Admin' },
      titles: {
        guide: 'â­ Anleitung',
        start: 'START',
        tekrar: 'ğŸ”„ WIEDERHOLEN',
        settings: 'âš™ï¸ Einstellungen',
        progress: 'ğŸ“Š Fortschritt',
        adminPanel: 'ğŸ”§ Admin-Panel',
        srsStats: 'Lernstatus',
        totalProgress: 'Gesamtfortschritt',
        conversionSelect: 'ÃœBERSETZUNG',
        learning: 'ğŸ“š Lernen' 
      },
      buttons: {
        show: 'Zeigen', next: 'â†’ NÃ¤chste', check: 'PrÃ¼fen',
        playDE: 'ğŸ”Š Deutsch hÃ¶ren', playTR: 'ğŸ”Š TÃ¼rkisch hÃ¶ren',
        resetSrs: 'âš ï¸ Lernfortschritt zurÃ¼cksetzen',
        startStudy: 'ğŸ“– Lernen starten',
        nextSection: 'â†’ NÃ¤chste Lektion',
        nextVerb: 'â†’ NÃ¤chstes Verb',
        goToStory: 'â†’ Zur Geschichte'
      },
      settings: {
        appearance: 'ğŸ¨ Ansicht & Sonstiges', nightMode: 'Nachtmodus', language: 'Sprache:', music: 'Musik:',
        dataManagement: 'ğŸ’¾ Inhaltsdaten',
        progressManagement: 'ğŸ’¾ Fortschrittsdaten',
        appUpdate: 'ğŸ”„ App'
      },
      admin: {
        editGuide: 'â­ Anleitung bearbeiten'
      },
      labels: {
        guideTitle: 'Anleitung Titel:',
        guideContent: 'Anleitung Inhalt:'
      },
      srs: {
        zor: 'ğŸ¥µ SCHWER',
        normal: 'ğŸ¤” NORMAL',
        ogrendim: 'âœ… GEKONNT',
        zorlandiklarim: 'SCHWIERIG',
        ogrendiklerim: 'GEKONNT'
      },
      messages: {
          srsPromotion: 'ğŸ‰ Super! Karte nach "%s" verschoben.',
          srsDemotion: 'ğŸ¤” Achtung! Karte nach "%s" verschoben.',
          guideSaved: 'âœ… Anleitungstext gespeichert.'
      }
    }
  },
  settings:{ language:'tr', nightMode:false, conversionMode: 'tr-de' }
};

// Ä°Ã§erik ve Ä°lerleme Verisi AyrÄ± Tutuluyor
let srsData = {};
let contentOverride = {};

/* ---------------- State ---------------- */
let state = {
  currentView:'mainMenu',
  viewHistory: ['mainMenu'], // YENÄ°: Geri butonu iÃ§in (v4.0)
  group:null, groupData:null,
  verb:null, verbData:null, 
  section:null,
  mode:null,
  tekrarStatus: null,
  deck: [],
  deckPos: 0,
  currentCardKey: null,
  currentCardData: null,
  showAnswer:false,
  wordPool:[], wordSelected:[], userAnswer:'', correctAnswer:'', showResult:false,
  hintPanelVisible: false,
  speechRate: 1.0,
  isSpeaking: false,
  autoPlayAudio: true,
  activeLearningPanel: null // Akordeon durumu
};

/* ---------- MÃ¼zik Ã‡alar ---------- */
class MusicPlayer {
  constructor(streamUrl, volumeSliderId, toggleBtnId, settingsSliderId, settingsToggleId) {
    this.audio = new Audio(streamUrl);
    this.audio.crossOrigin = "anonymous";
    this.audio.loop = true;
    this.isPlaying = false;
    this.currentVolume = 0.7;
    this.dimmedVolume = 0.2;
    this.isDimmed = false;
    this.slider = document.getElementById(volumeSliderId);
    this.toggleBtn = document.getElementById(toggleBtnId);
    this.settingsSlider = document.getElementById(settingsSliderId);
    this.settingsToggleBtn = document.getElementById(settingsToggleId);
    const savedVolume = parseFloat(localStorage.getItem('verbmatrix_music_volume')) || 0.7;
    this.setVolume(savedVolume * 100, true);
    if (this.toggleBtn) this.toggleBtn.addEventListener('click', () => this.toggleMusic());
    if (this.slider) this.slider.addEventListener('input', (e) => this.setVolume(e.target.value));
    if (this.settingsToggleBtn) this.settingsToggleBtn.addEventListener('click', () => this.toggleMusic());
    if (this.settingsSlider) this.settingsSlider.addEventListener('input', (e) => this.setVolume(e.target.value));
  }
  updateUI() {
      const t = getMergedTranslations(data.settings.language || 'tr');
      const isPlaying = this.isPlaying;
      if (this.toggleBtn) this.toggleBtn.textContent = isPlaying ? 'â¸ï¸' : 'ğŸ”Š';
      if (this.settingsToggleBtn) {
          this.settingsToggleBtn.textContent = isPlaying ? 'â¸ï¸ ' + (t.buttons.pause || 'Durdur') : 'ğŸ”Š ' + (t.buttons.play || 'Ã‡al');
      }
      const volumeValue = this.currentVolume * 100;
      if (this.slider) this.slider.value = volumeValue;
      if (this.settingsSlider) this.settingsSlider.value = volumeValue;
  }
  toggleMusic() {
    if (this.isPlaying) {
      this.audio.pause();
      this.isPlaying = false;
      console.log("MÃ¼zik duraklatÄ±ldÄ±.");
    } else {
      this.audio.load();
      this.audio.play().then(() => {
        this.isPlaying = true;
        console.log("MÃ¼zik Ã§alÄ±nÄ±yor.");
      }).catch(error => {
        console.error("MÃ¼zik Ã§alÄ±namadÄ±:", error);
      });
    }
    this.updateUI();
  }
  setVolume(volumeValue, isInit = false) {
    const newVolume = parseFloat(volumeValue) / 100;
    this.currentVolume = newVolume;
    if (!this.isDimmed) {
      this.audio.volume = this.currentVolume;
    }
    if (!isInit) {
        try { localStorage.setItem('verbmatrix_music_volume', this.currentVolume.toString()); } catch (e) {}
    }
    if (this.slider) this.slider.value = volumeValue;
    if (this.settingsSlider) this.settingsSlider.value = volumeValue;
  }
  dim_music(dim) {
    if (!this.isPlaying) return;
    if (dim) {
      this.isDimmed = true;
      this.audio.volume = this.dimmedVolume;
    } else {
      this.isDimmed = false;
      this.audio.volume = this.currentVolume;
    }
  }
}
let musicPlayer = null;

/* ---------- KonuÅŸma Sentezi ---------- */
let speechUtterance = null;
function toggleAutoPlay() {
  state.autoPlayAudio = !state.autoPlayAudio;
  const btn = document.getElementById('autoPlayBtn');
  const led = document.getElementById('autoPlayLed');
  if (btn) {
    if (state.autoPlayAudio) {
      btn.innerHTML = `<span class="led-indicator active" id="autoPlayLed"></span>Otomatik Aktif`;
      if(led) led.classList.add('active'); 
    } else {
      btn.innerHTML = `<span class="led-indicator" id="autoPlayLed"></span>Otomatik Dinle`;
      if(led) led.classList.remove('active');
    }
  }
}
function updateSpeedButtonUI() {
    const ledL = document.getElementById('slowModeLedL');
    const ledS = document.getElementById('slowModeLedS');
    if (state.speechRate === 0.5) {
        if(ledL) ledL.classList.add('active');
        if(ledS) ledS.classList.add('active');
    } else {
        if(ledL) ledL.classList.remove('active');
        if(ledS) ledS.classList.remove('active');
    }
}
function toggleSpeechSpeed() {
    state.speechRate = (state.speechRate === 1.0) ? 0.5 : 1.0;
    updateSpeedButtonUI();
    if (speechUtterance && !speechSynthesis.paused) {
        speechSynthesis.cancel();
        speechSynthesis.speak(speechUtterance);
    }
}
function toggleSpeechPause() {
    if ('speechSynthesis' in window) {
        const btnL = document.getElementById('pauseBtn');
        const btnS = document.getElementById('storyPauseBtn');
        const btn = btnL && btnL.offsetParent !== null ? btnL : btnS;
        if (!btn) return;
        if (speechSynthesis.paused) {
            speechSynthesis.resume();
            btn.textContent = 'â¸ï¸ Durdur';
        } else {
            speechSynthesis.pause();
            btn.textContent = 'â–¶ï¸ Oynat';
        }
    }
}
function resetSpeechButtons() {
    if ('speechSynthesis' in window) {
        window.speechSynthesis.cancel();
    }
    const pauseBtnL = document.getElementById('pauseBtn');
    const pauseBtnS = document.getElementById('storyPauseBtn');
    if (pauseBtnL) { pauseBtnL.textContent = 'â¸ï¸ Durdur'; }
    if (pauseBtnS) { pauseBtnS.textContent = 'â¸ï¸ Durdur'; }
}

/* ---------- SRS (Ä°lerleme) Veri YÃ¶netimi ---------- */
function getSrsKey(verbId, sectionNum, sentenceIndex) {
    return `${verbId}_s${sectionNum}_${sentenceIndex}`;
}
function loadSrsData() {
    try {
        const data = localStorage.getItem('verbmatrix_srs_data_v3');
        srsData = data ? JSON.parse(data) : {};
    } catch (e) {
        console.error("SRS verisi yÃ¼klenemedi", e);
        srsData = {};
    }
    updateProgressView();
}
function saveSrsData() {
    try {
        localStorage.setItem('verbmatrix_srs_data_v3', JSON.stringify(srsData));
    } catch (e) {
        console.error("SRS verisi kaydedilemedi", e);
    }
    updateProgressView();
}
function getCardSrsData(key) {
    if (!srsData[key]) {
        srsData[key] = {
            status: 'new',
            quizHistory: []
        };
    }
    return srsData[key];
}
function exportSrsData() {
    const t = getMergedTranslations(data.settings.language || 'tr');
    const json = JSON.stringify(srsData, null, 2);
    const blob = new Blob([json], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'verbmatrix_ilerleme_data.json';
    a.click();
    URL.revokeObjectURL(url);
    alert(t.messages.progressExported);
}
function importSrsData() {
    const input = document.getElementById('progressFileInput');
    input.onchange = async (e) => {
        const t = getMergedTranslations(data.settings.language || 'tr');
        try {
            const file = e.target.files[0]; if (!file) return;
            const text = await file.text();
            const imported = JSON.parse(text);
            if (Object.keys(imported).length > 0 && typeof Object.values(imported)[0].status !== 'string') {
                 throw new Error("Bu geÃ§erli bir ilerleme dosyasÄ± deÄŸil.");
            }
            srsData = imported;
            saveSrsData();
            alert(t.messages.progressLoaded);
            updateProgressView();
        } catch (err) {
            alert(`${t.messages.loadError} ${err.message}`);
        }
        input.value = '';
    };
    input.click();
}
function rateCard(newStatus) {
    const cardData = getCardSrsData(state.currentCardKey);
    cardData.status = newStatus;
    cardData.quizHistory = [];
    console.log(`Kart ${state.currentCardKey} -> ${newStatus} olarak ayarlandÄ±.`);
    saveSrsData();
    state.deckPos++;
    state.showAnswer = false;
    showLearning();
}

// YENÄ°: DÃ¼zeltilmiÅŸ Quiz MantÄ±ÄŸÄ± (v4.0)
function updateSrsStatusAfterQuiz(key, isCorrect) {
    const t = getMergedTranslations(data.settings.language || 'tr');
    const cardData = getCardSrsData(key);
    const history = cardData.quizHistory || [];
    history.push(isCorrect ? 1 : 0);
    while (history.length > 5) {
        history.shift();
    }
    cardData.quizHistory = history;
    const currentStatus = cardData.status;
    let newStatus = null;

    if (currentStatus === 'zor' && history.length >= 2 && history.slice(-2).every(v => v === 1)) {
        newStatus = 'normal';
    }
    else if (currentStatus === 'normal' && history.length >= 3 && history.slice(-3).every(v => v === 1)) {
        newStatus = 'ogrendim';
    }
    else if (currentStatus === 'normal' && history.length >= 3 && history.slice(-3).every(v => v === 0)) {
        newStatus = 'zor';
    }
    else if (currentStatus === 'ogrendim' && history.length >= 2 && history.slice(-2).every(v => v === 0)) {
        newStatus = 'normal';
    }

    if (newStatus) {
        cardData.status = newStatus;
        cardData.quizHistory = []; // GeÃ§miÅŸi sÄ±fÄ±rla
        saveSrsData();
        console.log(`STATÃœ DEÄÄ°ÅTÄ°: ${key} -> ${newStatus}`);
        
        const statusMap = {
            zor: t.srs.zorlandiklarim,
            normal: t.srs.normal,
            ogrendim: t.srs.ogrendiklerim
        };
        const messageKey = (newStatus === 'zor') ? 'srsDemotion' : 'srsPromotion';
        const message = (t.messages[messageKey] || '').replace('%s', statusMap[newStatus] || newStatus);
        
        // Desteden bu kartÄ± Ã§Ä±kar
        state.deck = state.deck.filter(deckKey => deckKey !== key);
        
        // Sonucu gÃ¶ster (ama "Sonraki" butonu artÄ±k bir sonraki karta atlayacak)
        showResult(isCorrect, userAnswer, message); 
        
        return true; // StatÃ¼ deÄŸiÅŸtiÄŸini belirt
    } else {
        saveSrsData(); // Sadece history'yi kaydet
        return false; // StatÃ¼ deÄŸiÅŸmedi
    }
}
function resetSrsData() {
    const t = getMergedTranslations(data.settings.language || 'tr');
    if (confirm(t.messages.srsResetConfirm)) {
        srsData = {};
        saveSrsData();
        alert(t.messages.srsReset);
    }
}

/* ---------- Ä°Ã§erik (Content) Veri YÃ¶netimi ---------- */
async function loadDataFromServer() {
    try {
        const response = await fetch('verbmatrix_data.json');
        if (!response.ok) {
            throw new Error(`HTTP hatasÄ±! Durum: ${response.status}`);
        }
        const serverData = await response.json();
        data = deepMerge(data, serverData);
        console.log('âœ… Sunucudan iÃ§erik verisi yÃ¼klendi.');
        loadContentOverride();
    } catch (e) {
        console.error("Sunucudan 'verbmatrix_data.json' yÃ¼klenemedi. VarsayÄ±lan veri kullanÄ±lacak.", e);
        loadContentOverride();
    }
}
function loadContentOverride() {
    try {
        const override = localStorage.getItem('verbmatrix_content_override');
        if (override) {
            contentOverride = JSON.parse(override);
            data = deepMerge(data, contentOverride);
            console.log('âœ… Yerel iÃ§erik dÃ¼zenlemeleri (Override) yÃ¼klendi.');
        } else {
            contentOverride = {};
        }
    } catch (e) {
        console.error("Yerel iÃ§erik dÃ¼zenlemeleri yÃ¼klenirken hata:", e);
        localStorage.removeItem('verbmatrix_content_override');
        contentOverride = {};
    }
}
function saveContentOverride() {
    const contentToSave = {
        groups: data.groups,
        verbs: data.verbs,
        content: data.content,
        sections: data.sections,
        hints: data.hints,
        guideText: data.guideText // YENÄ°
    };
    contentOverride = deepMerge(contentOverride, contentToSave);
    try {
        localStorage.setItem('verbmatrix_content_override', JSON.stringify(contentOverride));
        console.log('âœ… Ä°Ã§erik gÃ¼ncellendi ve yerel olarak kaydedildi (Override).');
    } catch (e) {
        console.error("Ä°Ã§erik depolanamadÄ±:", e);
    }
}
function exportData(){
  const t = getMergedTranslations(data.settings.language || 'tr');
  const json = JSON.stringify(data,null,2);
  const blob = new Blob([json],{type:'application/json'}); const url = URL.createObjectURL(blob); const a = document.createElement('a');
  a.href = url; a.download = 'verbmatrix_data.json'; a.click(); URL.revokeObjectURL(url);
  alert(t.messages.dataExported);
}
function importData(imported){
    const t = getMergedTranslations(data.settings.language || 'tr');
    try {
        const defaultTranslations = JSON.parse(JSON.stringify(data.translations || {}));
        if (imported.groups && Array.isArray(imported.groups)) {
            imported.groups.forEach(newGroup => {
                const index = data.groups.findIndex(g => g.id === newGroup.id);
                if (index > -1) { data.groups[index] = deepMerge(data.groups[index], newGroup); } 
                else { data.groups.push(newGroup); }
            });
            console.log("Gruplar birleÅŸtirildi.");
        }
        if (imported.verbs && typeof imported.verbs === 'object') {
            Object.keys(imported.verbs).forEach(gid => {
                if (!data.verbs[gid]) data.verbs[gid] = [];
                const newVerbs = imported.verbs[gid] || [];
                newVerbs.forEach(newVerb => {
                    const index = data.verbs[gid].findIndex(v => v.id === newVerb.id);
                    if (index > -1) { data.verbs[gid][index] = deepMerge(data.verbs[gid][index], newVerb); } 
                    else { data.verbs[gid].push(newVerb); }
                });
            });
            console.log("Fiiller birleÅŸtirildi.");
        }
        if (imported.content && typeof imported.content === 'object') {
            data.content = Object.assign(data.content || {}, imported.content);
            console.log("CÃ¼mle iÃ§erikleri birleÅŸtirildi.");
        }
        if(imported.sections) data.sections = Object.assign(data.sections || {}, imported.sections);
        if(imported.hints) data.hints = deepMerge(data.hints || {}, imported.hints);
        if(imported.settings) data.settings = Object.assign(data.settings || {}, imported.settings);
        if(imported.guideText) data.guideText = deepMerge(data.guideText || {}, imported.guideText); // YENÄ°
        if (imported.translations) {
            data.translations = deepMerge(defaultTranslations, imported.translations);
        }
        saveContentOverride();
        alert(`${t.messages.dataLoaded} (Veriler BirleÅŸtirildi)\nYeni Toplam Grup SayÄ±sÄ±: ${data.groups.length}`);
        loadSettings();
        showView('mainMenu');
    } catch(err){
        alert(`${t.messages.loadError} ${err.message}`);
    }
}
function importDataFromFile(){
  const input = document.getElementById('fileInput');
  input.onchange = async (e)=>{
    try{
      const file = e.target.files[0]; if(!file) return;
      const text = await file.text();
      const importedJson = JSON.parse(text);
      importData(importedJson);
    } catch(err) {
      const t = getMergedTranslations(data.settings.language || 'tr');
      alert(`${t.messages.loadError} ${err.message}`);
    }
    input.value='';
  };
  input.click();
}
function loadJsonFromTextarea(){
  const txt = document.getElementById('jsonPaste').value.trim();
  const t = getMergedTranslations(data.settings.language || 'tr');
  if(!txt){ alert('JSON yapÄ±ÅŸtÄ±rÄ±n'); return; }
  try{
    const importedJson = JSON.parse(txt);
    importData(importedJson);
    document.getElementById('jsonPaste').value='';
  } catch(e){ alert(`${t.messages.loadError} ${e.message}`); }
}

/* ---------- Ayarlar ve ArayÃ¼z FonksiyonlarÄ± (v4.0) ---------- */

// YENÄ°: showView (v4.0) - Geri Butonu GeÃ§miÅŸi YÃ¶netimi
function showView(id, isBack = false){
  if (id === state.currentView) return; // Zaten bu ekranda
  
  document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
  const el = document.getElementById(id);
  if(el) el.classList.add('active');
  state.currentView = id;

  if (!isBack) {
      if (id === 'mainMenu') { state.viewHistory = ['mainMenu']; } // Ana menÃ¼ tarihi sÄ±fÄ±rlar
      else if (id === 'detailViewLayer') { state.viewHistory.push(id); } // Detay katmanÄ± da tarihe eklenir
      else {
          // EÄŸer bir alt menÃ¼ye gidiyorsak (Ã¶rn: gruptan fiile)
          // ve fiil menÃ¼sÃ¼ zaten tarihteyse (Ã¶rn: geri gittik, tekrar ileri bastÄ±k)
          // tarihi temizle
          const lastView = state.viewHistory[state.viewHistory.length - 1];
          if ( (lastView === 'groupMenu' && id === 'verbMenu') ||
               (lastView === 'verbMenu' && id === 'sectionMenu') ||
               (lastView === 'sectionMenu' && id === 'modeMenu') ||
               (lastView === 'tekrarMenu' && id === 'tekrarModeMenu') ) 
          {
               // Ä°leri gidiyor, tarihi koru
          }
          else if (id !== 'mainMenu' && !id.includes('Menu') && id !== 'detailViewLayer') {
               // EÄŸer 'Menu' deÄŸilse (Ã¶rn: learningView, storyView) tarihi temizle
               const menuViews = ['mainMenu', 'groupMenu', 'verbMenu', 'sectionMenu', 'modeMenu', 'tekrarMenu', 'tekrarModeMenu'];
               let baseHistory = state.viewHistory.filter(v => menuViews.includes(v));
               state.viewHistory = baseHistory;
          }
          state.viewHistory.push(id);
      }
  }
  // Tarihi temizle (Ã§ok derine inmemek iÃ§in)
  if (state.viewHistory.length > 10) {
      state.viewHistory = state.viewHistory.slice(-10);
      state.viewHistory[0] = 'mainMenu'; // Her zaman bir kÃ¶k olmalÄ±
  }
  console.log("View History:", state.viewHistory.join(' -> '));

  const headerEl = document.querySelector('.container > header');
  const hideLogo = ['learningView', 'storyView', 'storyQuestionsView', 'detailViewLayer'].includes(id);
  if (headerEl) {
      headerEl.style.display = hideLogo ? 'none' : 'block';
  }
  resetSpeechButtons();
  
  if (id === 'learningView') { 
      updateSpeedButtonUI();
      toggleLearningPanel(null); // Akordeonu kapat
      document.getElementById('learningControlsAccordion').style.display = 'block';
      document.getElementById('completionControls').style.display = 'none';
      document.getElementById('actionBtn').style.display = 'flex';
  }
  if(id === 'storyView') { 
      updateSpeedButtonUI();
  }

  // --- YÃ¼zen ButonlarÄ± YÃ¶net (v4.0) ---
  const homeBtn = document.getElementById('floatingHomeBtn');
  const backBtn = document.getElementById('floatingBackBtn');
  const adminBtn = document.getElementById('floatingAdminBtn');
  
  if (id === 'mainMenu') {
      homeBtn.style.display = 'none';
      backBtn.style.display = 'none';
      adminBtn.style.display = 'block';
  } else {
      homeBtn.style.display = 'block';
      backBtn.style.display = 'block';
      adminBtn.style.display = 'none';
  }

  if(id === 'modeMenu' || id === 'tekrarModeMenu') {
      updateConversionButtons();
  }
  if(id === 'adminView'){
    document.getElementById('adminTsvArea').style.display = 'none';
    document.getElementById('adminGroupVerbArea').style.display = 'none';
  }
  if(id === 'adminContentView'){
    document.getElementById('adminContentArea').style.display = 'none';
    document.getElementById('adminContentArea').innerHTML = '';
  }
  if(id === 'adminSentenceListView'){
    renderAllSentencesTable();
  }
  if(id === 'progress') {
    updateProgressView();
  }
  if(id === 'tekrarMenu') {
    updateProgressView();
  }
}

// YENÄ°: Geri Butonu Fonksiyonu (v4.0)
function goBackInHistory() {
    if (state.viewHistory.length <= 1) {
        showView('mainMenu'); // GÃ¼venlik
        return; 
    }
    state.viewHistory.pop(); // Mevcut view'Ä± tarihten Ã§Ä±kar
    const prevView = state.viewHistory[state.viewHistory.length - 1]; // Son kalanÄ± al
    showView(prevView, true); // 'isBack' bayraÄŸÄ±yla (tarihe tekrar eklememesi iÃ§in) gÃ¶ster
}

// YENÄ°: Ortak Detay GÃ¶sterim Fonksiyonu (v4.0)
// AI Ä°pucu, BÃ¶lÃ¼m Ä°pucu ve KÄ±lavuz tarafÄ±ndan kullanÄ±lÄ±r
function showDetailView(title, content) {
    document.getElementById('detailViewTitle').textContent = title;
    document.getElementById('detailViewContent').innerHTML = content.replace(/\n/g, '<br>');
    showView('detailViewLayer');
}

// YENÄ°: KÄ±lavuz GÃ¶sterim Fonksiyonu (v4.0)
function showGuide() {
    const t = getMergedTranslations(data.settings.language || 'tr');
    const guide = data.guideText || { title: t.titles.guide, content: "KÄ±lavuz yÃ¼klenemedi." };
    showDetailView(guide.title, guide.content);
}

function getProperty(obj, keyString) {
  if (!keyString) return null;
  return keyString.split('.').reduce((acc, key) => (acc && acc[key] !== undefined) ? acc[key] : null, obj);
}
function getMergedTranslations(lang = 'tr') {
    const defaultLang = 'tr';
    const defaultTranslations = data.translations[defaultLang] || {};
    if (lang === defaultLang || !data.translations[lang] || Object.keys(data.translations[lang]).length === 0) {
        return defaultTranslations;
    }
    return deepMerge(defaultTranslations, data.translations[lang]);
}
function updateUITexts(){
  const lang = data.settings.language || 'tr';
  const t = getMergedTranslations(lang);
  document.querySelectorAll('[data-translate-key]').forEach(el => {
    const key = el.dataset.translateKey;
    const translation = getProperty(t, key);
    if (translation) {
      if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
        if (el.placeholder !== undefined) el.placeholder = translation;
      } else {
        const firstChild = el.firstChild;
        if (firstChild && (firstChild.tagName === 'SPAN' || firstChild.tagName === 'I' || firstChild.nodeName === '#text')) {
            let textNode = firstChild.nextSibling;
            if (textNode && textNode.nodeType === Node.TEXT_NODE) {
                textNode.textContent = ' ' + translation;
            } else if (!textNode && firstChild.nodeType === Node.TEXT_NODE) {
                firstChild.textContent = translation;
            } else if (textNode) {
                 el.appendChild(document.createTextNode(' ' + translation));
            } else {
                el.textContent = translation;
            }
        } else {
            el.textContent = translation;
        }
      }
    } else {
      console.warn(`Translation key not found: ${key} for lang: ${lang}`);
    }
  });
  if(musicPlayer) musicPlayer.updateUI();
  updateAutoPlayButtonText();
  // BaÅŸlÄ±klarÄ± manuel gÃ¼ncelleyelim
  const learningTitleEl = document.getElementById('learningTitle');
  if (learningTitleEl) {
      learningTitleEl.textContent = t.titles.learning;
  }
}
function updateAutoPlayButtonText() {
    const autoPlayBtn = document.getElementById('autoPlayBtn');
    if (autoPlayBtn) {
        if (state.autoPlayAudio) {
            autoPlayBtn.innerHTML = `<span class="led-indicator active" id="autoPlayLed"></span>Otomatik Aktif`;
        } else {
            autoPlayBtn.innerHTML = `<span class.led-indicator" id="autoPlayLed"></span>Otomatik Dinle`;
        }
    }
}
function changeLanguage(lang, btnEl){
  data.settings.language = lang;
  document.querySelectorAll('.lang-btn').forEach(b=>b.classList.remove('active'));
  if(btnEl) btnEl.classList.add('active');
  updateUITexts();
  saveSettings();
}
function toggleNightMode(){
  const body = document.body;
  const on = body.classList.toggle('night-mode');
  data.settings.nightMode = on;
  const toggleCheckbox = document.getElementById('nightModeToggle');
  if(toggleCheckbox) toggleCheckbox.checked = on;
  saveSettings();
}
function saveSettings(){ try{ localStorage.setItem('verbmatrix_settings', JSON.stringify(data.settings)); }catch(e){} }
function loadSettings(){
  try{
    const s = JSON.parse(localStorage.getItem('verbmatrix_settings')||'{}');
    if(s.language) data.settings.language = s.language;
    if(typeof s.nightMode === 'boolean') data.settings.nightMode = s.nightMode;
    if(s.conversionMode) data.settings.conversionMode = s.conversionMode;
  }catch(e){}
  const toggleCheckbox = document.getElementById('nightModeToggle');
  if(toggleCheckbox) toggleCheckbox.checked = !!data.settings.nightMode;
  if(data.settings.nightMode) document.body.classList.add('night-mode');
  document.querySelectorAll('.lang-btn').forEach(b=>b.classList.remove('active'));
  const map = {tr:'langTR', de:'langDE'};
  const btn = document.getElementById(map[data.settings.language]||'langTR');
  if(btn) btn.classList.add('active');
  updateUITexts();
}

/* ---------- Ã‡eviri YÃ¶nÃ¼ (Conversion Mode) ---------- */
function setConversionMode(mode) {
    data.settings.conversionMode = mode;
    saveSettings();
    updateConversionButtons();
}
function updateConversionButtons() {
    const modes = ['mode', 'tekrarMode'];
    const activeMode = data.settings.conversionMode; // tr-de veya de-tr
    modes.forEach(prefix => {
        const trdeBtn = document.getElementById(prefix + 'TRDE');
        const detrBtn = document.getElementById(prefix + 'DETR');
        if (!trdeBtn || !detrBtn) return;
        if (activeMode === 'tr-de') {
            trdeBtn.classList.add('btn-primary');
            trdeBtn.classList.remove('btn-info');
            detrBtn.classList.add('btn-info');
            detrBtn.classList.remove('btn-primary');
        } else {
            trdeBtn.classList.add('btn-info');
            trdeBtn.classList.remove('btn-primary');
            detrBtn.classList.add('btn-primary');
            detrBtn.classList.remove('btn-info');
        }
        if (prefix === 'tekrarMode') {
            const trdeLed = trdeBtn.querySelector('.led-indicator');
            const detrLed = detrBtn.querySelector('.led-indicator');
            if (trdeLed && detrLed) {
                if (activeMode === 'tr-de') {
                    trdeLed.classList.add('active');
                    detrLed.classList.remove('active');
                } else {
                    trdeLed.classList.remove('active');
                    detrLed.classList.add('active');
                }
            }
        }
    });
}
/* ---------- AI Ä°pucu Entegrasyonu (v4.0 GÃ¼ncellemesi) ---------- */
async function getAIHint() {
    const t = getMergedTranslations(data.settings.language || 'tr');
    const currentCard = state.currentCardData;
    const verbData = (data.verbs[state.group] || []).find(v => v.id === state.verb) || { verbTR: 'Bilinmiyor', verbDE: 'Unknown' };

    if (!currentCard) {
        alert("LÃ¼tfen Ã¶nce bir cÃ¼mle kartÄ± yÃ¼kleyin.");
        return;
    }

    // Ortak detay gÃ¶rÃ¼nÃ¼mÃ¼nÃ¼ kullanÄ±yoruz
    showDetailView("ğŸ§  Yapay Zeka Ä°pucu OluÅŸturuluyor...", 
        "<div style='text-align:center; padding: 20px;'>YÃ¼kleniyor... Bu iÅŸlem birkaÃ§ saniye sÃ¼rebilir.</div>"
    );

    const isTrDe = data.settings.conversionMode === 'tr-de';
    const trText = currentCard.tr;
    const deText = currentCard.de;

    const prompt = `
        Sen bir Almanca Ã¶ÄŸretmenisin ve kullanÄ±cÄ±nÄ±n Ã¶ÄŸrenme baÄŸlamÄ±na uygun detaylÄ± bir dil bilgisi veya kullanÄ±m ipucu veriyorsun.
        CevabÄ±n sadece ipucu metninden oluÅŸmalÄ±, baÅŸlÄ±k veya ek konuÅŸma iÃ§ermemelidir.
        
        BaÄŸlam:
        - Ã‡alÄ±ÅŸÄ±lan Fiil: ${verbData.verbDE || state.verb} (${verbData.verbTR})
        - TÃ¼rkÃ§e CÃ¼mle: "${trText}"
        - Almanca CÃ¼mle: "${deText}"
        - Ã‡eviri YÃ¶nÃ¼: ${isTrDe ? 'TÃ¼rkÃ§eden Almancaya Ã§eviri yapÄ±lÄ±yor.' : 'Almancadan TÃ¼rkÃ§eye Ã§eviri yapÄ±lÄ±yor.'}
        
        GÃ¶revin: Almanca cÃ¼mledeki **dil bilgisi kuralÄ±nÄ± (Ã¶rneÄŸin zamir, edat, kelime sÄ±rasÄ±)**, fiilin Ã¶zel kullanÄ±mÄ±nÄ± veya Almanca'ya Ã¶zel bir nÃ¼ansÄ± aÃ§Ä±klayan, 2-3 paragraf uzunluÄŸunda, derinlemesine ve net bir ipucu metni oluÅŸtur. Markdown formatÄ±nÄ± kullan.
    `;

    try {
        const response = await fetch('http://localhost:3000/api/ai-hint', { 
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ prompt: prompt })
        });

        if (!response.ok) {
            throw new Error(`HTTP Hata: ${response.status} - Sunucu hatasÄ± veya Yapay Zeka servisi baÄŸlantÄ± sorunu.`);
        }

        const responseData = await response.json();
        const generatedHint = responseData.text || "Yapay zekadan ipucu alÄ±namadÄ±.";

        showDetailView(
            "ğŸ§  Yapay Zeka Ä°pucu (DetaylÄ± Analiz)", 
            generatedHint.replace(/\n/g, '<br>')
        ); 
        
    } catch (error) {
        console.error("AI Ä°pucu HatasÄ±:", error);
        showDetailView(
            "âŒ Yapay Zeka HatasÄ±",
            `<div style="color: #991b1b; padding: 15px; border: 1px solid #991b1b; background: #fee2e2; border-radius: 8px;">
            **Yapay Zeka Ä°pucu AlÄ±namadÄ±!**
            <br><br>
            **Hata Nedeni:** **${error.message}**<br>
            <br>
            **Ã‡Ã–ZÃœM Ä°Ã‡Ä°N NOT:** Bu Ã¶zelliÄŸin Ã§alÄ±ÅŸmasÄ± iÃ§in, Yapay Zeka (Gemini, OpenAI vb.) API anahtarÄ±nÄ±zÄ± gÃ¼venli bir ÅŸekilde yÃ¶neten, arka planda Ã§alÄ±ÅŸan bir **sunucu (proxy)** veya **sunucusuz iÅŸlev (serverless function)** kurmuÅŸ olmanÄ±z gerekir. TarayÄ±cÄ±nÄ±z, \`http://localhost:3000/api/ai-hint\` adresine baÄŸlanmayÄ± denedi.
            </div>`
        );
    }
}


/* ---------- ANA AKIÅ FONKSÄ°YONLARI (v4.0) ---------- */

/* --- Ã‡alÄ±ÅŸma EkranÄ± AkÄ±ÅŸlarÄ± (Tekrar / Ã‡alÄ±ÅŸ) --- */
function loadAndShowGroupMenu(){
  const container = document.getElementById('groupButtons');
  container.innerHTML = '';
  const t = getMergedTranslations(data.settings.language || 'tr');
  if(!data.groups || data.groups.length===0){
    container.innerHTML = `<div class="content-box">${t.messages.noGroups}</div>`;
    showView('groupMenu');
    return;
  }
  const grid = document.createElement('div');
  grid.className = 'group-story-grid';
  data.groups.forEach(g=>{
    const groupBtn = document.createElement('button');
    groupBtn.className = 'btn btn-primary';
    groupBtn.innerHTML = `<strong>${g.name}</strong><span class="small-muted">${g.nameDE || ''}</span>`;
    groupBtn.onclick = ()=>selectGroup(g.id);
    grid.appendChild(groupBtn);
    const storyBtn = document.createElement('button');
    storyBtn.className = 'btn btn-warning';
    if (g.story && g.story.title) {
      storyBtn.textContent = g.story.title;
      storyBtn.onclick = ()=>showGroupStory(g.id);
    } else {
      storyBtn.textContent = t.messages.noStoryAvailable;
      storyBtn.classList.add('disabled');
      storyBtn.disabled = true;
    }
    grid.appendChild(storyBtn);
  });
  container.appendChild(grid);
  showView('groupMenu');
}
function selectGroup(id){
  state.group = id; state.groupData = data.groups.find(x=>x.id===id) || null;
  const verbs = (data.verbs[id]||[]).filter(v=>v.id);
  const container = document.getElementById('verbButtons'); container.innerHTML='';
  const t = getMergedTranslations(data.settings.language || 'tr');
  if(verbs.length===0){
    container.innerHTML = `<div class="content-box">${t.messages.noVerbs}</div>`;
    showView('verbMenu');
    return;
  }
  verbs.forEach(v=>{
    const b = document.createElement('button'); b.className='btn btn-primary'; b.textContent = `${v.verbTR || v.verbDE}` + (v.verbDE? ' ('+v.verbDE+')':''); b.onclick = ()=>selectVerb(v.id); container.appendChild(b);
  });
  showView('verbMenu');
}
function selectVerb(verbId){
  state.verb = verbId;
  state.verbData = (data.verbs[state.group] || []).find(v => v.id === verbId); 
  const container = document.getElementById('sectionButtons'); container.innerHTML='';
  Object.entries(data.sections).forEach(([num,name])=>{
    const b = document.createElement('button');
    const key = `${verbId}_s${num}`;
    const contentArray = data.content[key] || [];
    const sentenceCount = contentArray.length;
    let newCount = 0;
    if (sentenceCount > 0) {
        for(let i=0; i < sentenceCount; i++) {
            const srsKey = getSrsKey(verbId, num, i);
            const cardData = getCardSrsData(srsKey);
            if (cardData.status === 'new') {
                newCount++;
            }
        }
    }
    b.textContent = `${num}. ${name} (${newCount}/${sentenceCount})`;
    if (sentenceCount > 0) {
      b.className = (newCount > 0) ? 'btn btn-primary' : 'btn btn-secondary';
      b.onclick = ()=>selectSection(parseInt(num));
    } else {
      b.className='btn btn-danger disabled';
      b.disabled = true;
    }
    container.appendChild(b);
  });
  showView('sectionMenu');
}
function selectSection(sectionNum){
  state.section = sectionNum;
  showView('modeMenu');
}
function startTekrar(status) {
    state.tekrarStatus = status;
    state.mode = null;
    const t = getMergedTranslations(data.settings.language || 'tr');
    const statusMap = {
        zor: t.srs.zorlandiklarim,
        normal: t.srs.normal,
        ogrendim: t.srs.ogrendiklerim
    };
    document.getElementById('tekrarModeTitle').textContent = statusMap[status] || 'Tekrar Modu';
    showView('tekrarModeMenu');
}
function startTekrarModePrompt() {
    // Ã‡eviri modu zaten setConversionMode ile ayarlandÄ±.
}
function startTekrarMode(modeId) {
    state.mode = modeId;
    const allCardsOfStatus = [];
    Object.keys(srsData).forEach(key => {
        if (srsData[key].status === state.tekrarStatus) {
            allCardsOfStatus.push(key);
        }
    });
    state.deck = shuffle(allCardsOfStatus);
    state.deckPos = 0;
    console.log(`Tekrar modu: ${state.tekrarStatus} (${state.mode}). ${state.deck.length} kart bulundu.`);
    showLearning();
}
function startMode(modeId){
  state.mode = modeId;
  state.tekrarStatus = null;
  const sentences = getSentences();
  const newCards = [];
  for (let i = 0; i < sentences.length; i++) {
      const key = getSrsKey(state.verb, state.section, i);
      const cardData = getCardSrsData(key);
      if (cardData.status === 'new') {
          newCards.push(key);
      }
  }
  state.deck = shuffle(newCards);
  state.deckPos = 0;
  console.log(`Ã‡alÄ±ÅŸma modu: ${state.verb}_s${state.section}. ${state.deck.length} YENÄ° kart bulundu.`);
  showLearning();
}
function getSentences(){
    if (!state.verb || !state.section) return [];
    return data.content[`${state.verb}_s${state.section}`] || [];
}
function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[i],a[j]] } return a; }

function showLearning(){
  const t = getMergedTranslations(data.settings.language || 'tr');
  resetSpeechButtons();
  
  // v4.0: Akordeon ve TamamlandÄ± Kontrollerini yÃ¶net
  toggleLearningPanel(null); // Akordeonu kapat
  document.getElementById('learningControlsAccordion').style.display = 'block';
  document.getElementById('completionControls').style.display = 'none';
  document.getElementById('actionBtn').style.display = 'flex'; // Tekrar gÃ¶ster

  // Tekrar modunda "Ã–nceki" butonu gÃ¶rÃ¼nÃ¼r, Ã§alÄ±ÅŸma modunda gizli
  const prevBtn = document.querySelector('#panelEdit button[onclick="previousQuestion()"]');
  if (prevBtn) {
      prevBtn.style.display = (state.mode === 'study') ? 'none' : 'flex';
  }

  if (state.deck.length === 0) {
      const message = (state.mode === 'study') ? t.messages.noNewCards : t.messages.noDueCards;
      document.getElementById('learningContent').innerHTML = `<div class="content-box"><h3 style="text-align:center">${message}</h3></div>`;
      updateProgress(0, 0);
      showCompletion(); // v4.0 AkÄ±ÅŸÄ± gÃ¶stermek iÃ§in
      return;
  }
  if (state.deckPos >= state.deck.length) {
      showCompletion();
      return;
  }
  state.currentCardKey = state.deck[state.deckPos];
  const parts = state.currentCardKey.match(/^(.*?)_s(\d+)_(\d+)$/);
  if (!parts) {
      console.error("GeÃ§ersiz kart anahtarÄ±:", state.currentCardKey);
      state.deckPos++;
      showLearning();
      return;
  }
  const verbId = parts[1];
  const sectionNum = parts[2];
  const sentenceIndex = parseInt(parts[3]);
  const sentenceArray = data.content[`${verbId}_s${sectionNum}`] || [];
  state.currentCardData = sentenceArray[sentenceIndex];
  
  // Tekrar modu iÃ§in state.verb ve state.section'Ä± ayarla
  if (state.mode !== 'study') {
      state.verb = verbId;
      state.verbData = (data.verbs[state.group] || []).find(v => v.id === verbId);
      state.section = sectionNum;
  }
  
  if (!state.currentCardData) {
      console.error(`CÃ¼mle verisi bulunamadÄ±: ${state.currentCardKey}`);
      state.deckPos++;
      showLearning();
      return;
  }
  renderSentence();
  showView('learningView');
}
function updateProgress(current, total){
  const currQuestionNum = Math.min(current + 1, total);
  const percent = total === 0 ? 100 : Math.round((current / total) * 100);
  document.getElementById('progressFill').style.width = percent + '%';
  document.getElementById('progressFill').textContent = percent + '%';
  document.getElementById('progressText').textContent = `${currQuestionNum} / ${total}`;
}
function buildSentenceHintHtml(){
  if(!state.currentCardKey || !data.hints || !data.hints.sentences || !data.hints.sentences[state.currentCardKey]) {
      return ''; 
  }
  const hintText = data.hints.sentences[state.currentCardKey];
  return `<div class="hint-item"><strong>CÃ¼mle Ä°pucu:</strong> ${escapeHtml(hintText)}</div>`;
}
function showHintDetail(type) {
    const t = getMergedTranslations(data.settings.language || 'tr');
    let title = '';
    let content = '';

    if (!state.currentCardKey) {
        content = 'LÃ¼tfen Ã¶nce bir Ã§alÄ±ÅŸma kartÄ± yÃ¼kleyin.';
        title = 'Hata';
    } else {
        const parts = state.currentCardKey.match(/^(.*?)_s(\d+)_(\d+)$/);
        const verbId = parts[1];
        const sectionNum = parts[2];
        const secCode = 'B' + sectionNum;
        const verbData = state.verbData || (data.verbs[state.group] || []).find(v => v.id === verbId);

        if (type === 'section') {
            title = 'BÃ¶lÃ¼m Ä°pucu: ' + (data.sections[sectionNum] || secCode);
            content = data.hints && data.hints.sections && data.hints.sections[secCode] ? data.hints.sections[secCode] : 'Bu bÃ¶lÃ¼me ait genel bir ipucu eklenmemiÅŸtir.';
        } else if (type === 'verb') {
            title = 'Fiil Ä°pucu: ' + (verbData ? (verbData.verbTR || verbData.verbDE) : verbId);
            content = data.hints && data.hints.verbs && data.hints.verbs[verbId] ? data.hints.verbs[verbId] : 'Bu fiile ait genel bir ipucu eklenmemiÅŸtir.';
        }
    }
    // Ortak detay gÃ¶rÃ¼nÃ¼mÃ¼nÃ¼ kullan
    showDetailView(title, content);
}

// YENÄ°: Ã–ÄŸrenme EkranÄ± Akordeon KontrolÃ¼ (v4.0)
function toggleLearningPanel(panelId) {
    const panels = ['panelHint', 'panelListen', 'panelEdit'];
    
    if (panelId === state.activeLearningPanel || panelId === null) {
        if (state.activeLearningPanel) {
            document.getElementById(state.activeLearningPanel).style.display = 'none';
        }
        state.activeLearningPanel = null;
        return;
    }

    panels.forEach(id => {
        if (id !== panelId) {
            const el = document.getElementById(id);
            if(el) el.style.display = 'none';
        }
    });

    const targetPanel = document.getElementById(panelId);
    if (targetPanel) {
        targetPanel.style.display = 'block';
        state.activeLearningPanel = panelId;
    }
}


function renderSentence(){
  const container = document.getElementById('learningContent');
  document.getElementById('resultArea').innerHTML='';
  document.getElementById('answerArea').innerHTML='';
  const hintPanelEl = document.getElementById('hintPanel');
  const quickEditPanel = document.getElementById('quickEditPanel');
  quickEditPanel.style.display = 'none';
  
  hintPanelEl.style.display = state.hintPanelVisible ? 'block' : 'none';
  hintPanelEl.innerHTML = '';
  
  state.showResult = false;
  state.wordPool = [];
  state.wordSelected = [];
  
  if (state.deckPos >= state.deck.length) {
      showCompletion();
      return;
  }
  const sent = state.currentCardData;
  if (!sent) {
      console.error("Render edilecek cÃ¼mle bulunamadÄ±", state.currentCardKey);
      return;
  }
  container.innerHTML = '';
  
  // CÃ¼mle ipucunu oluÅŸtur
  if(state.hintPanelVisible){
    const hintHtml = buildSentenceHintHtml();
    hintPanelEl.innerHTML = hintHtml || '<div class="hint-item">Bu kart iÃ§in ipucu yok.</div>';
    hintPanelEl.style.display = 'block';
  } else {
    hintPanelEl.innerHTML = '';
    hintPanelEl.style.display = 'none';
  }
  
  const t = getMergedTranslations(data.settings.language || 'tr');
  const isTrDe = data.settings.conversionMode === 'tr-de';
  const questionText = isTrDe ? sent.tr : sent.de;
  const answerText = isTrDe ? sent.de : sent.tr;
  const questionLang = isTrDe ? 'TR' : 'DE';
  const answerLang = isTrDe ? 'DE' : 'TR';

  let title = '';
  if (state.mode === 'study') title = t.modes.study;
  else if (state.mode === 'quiz') title = t.modes.quiz;
  else if (state.mode === 'cloze') title = t.modes.cloze;
  else if (state.mode === 'wordorder') title = t.modes.wordorder;
  
  const verbName = (state.verbData && (state.verbData.verbTR || state.verbData.verbDE)) || state.verb;
  const sectionName = data.sections[state.section] || `BÃ¶lÃ¼m ${state.section}`;
  document.getElementById('learningTitle').textContent = `${verbName}`;
  document.getElementById('learningSubtitle').textContent = `${sectionName} - ${title}`;


  if(state.mode === 'study'){
    container.innerHTML = `<div class="sentence"><strong>${questionLang}:</strong> ${escapeHtml(questionText)}</div>
                             <div id="answerDisplay" class="sentence hidden"><strong>${answerLang}:</strong> ${escapeHtml(answerText)}</div>`;
  } else if(state.mode === 'cloze'){
    const words = answerText.split(/\s+/).filter(Boolean);
    const idx = Math.floor(Math.random()*words.length);
    const correct = words[idx].replace(/[.,!?;:]$/,'');
    words[idx] = '_____';
    state.correctAnswer = correct;
    container.innerHTML = `<div class="sentence"><b>${questionLang}:</b> ${escapeHtml(questionText)}</div>
                             <div class="sentence"><b>${answerLang}:</b> ${escapeHtml(words.join(' '))}</div>
                             <input id="clozeInput" class="input-field" placeholder="${t.placeholders?.cloze || 'BoÅŸluÄŸu doldurun...'}">`;
  } else if(state.mode === 'wordorder'){
    const words = answerText.split(/\s+/).filter(Boolean);
    state.wordPool = shuffle([...words]);
    state.wordSelected = [];
    state.correctAnswer = words.join(' ');
    container.innerHTML = `<div class="sentence"><b>${questionLang}:</b> ${escapeHtml(questionText)}</div>
                             <div class="word-order-area">
                               <div class="word-pool"><strong>KarÄ±ÅŸÄ±k Kelimeler:</strong><div id="wordPoolArea"></div></div>
                               <div class="word-selected"><strong>DÃ¼zenleme SatÄ±rÄ±:</strong><div id="wordSelectedArea"></div></div>
                             </div>`;
    renderWordOrder();
  } else if(state.mode === 'quiz'){
    state.correctAnswer = answerText;
    container.innerHTML = `<div class="sentence"><b>${questionLang}:</b> ${escapeHtml(questionText)}</div>
                             <input id="quizInput" class="input-field" placeholder="${t.placeholders?.quiz || 'Ã‡eviriyi yazÄ±n...'}">`;
  }

  const btnDE = document.getElementById('btnPlayDE');
  const btnTR = document.getElementById('btnPlayTR');
  const canPlayDE = (state.mode === 'study' && state.showAnswer) || state.showResult || !isTrDe;
  const canPlayTR = (state.mode === 'study' && state.showAnswer) || state.showResult || isTrDe;
  btnDE.disabled = !canPlayDE; btnDE.classList.toggle('disabled', !canPlayDE);
  btnTR.disabled = !canPlayTR; btnTR.classList.toggle('disabled', !canPlayTR);
  
  const actionBtn = document.getElementById('actionBtn');
  const srsControls = document.getElementById('srsControls');
  
  if (state.mode === 'study') {
      if (state.showAnswer) {
          actionBtn.style.display = 'none';
          srsControls.style.display = 'flex';
      } else {
          actionBtn.style.display = 'flex'; 
          srsControls.style.display = 'none';
          actionBtn.textContent = t.buttons.show;
          actionBtn.onclick = handleAction;
      }
      document.querySelector('#panelEdit button[onclick="previousQuestion()"]').style.display = 'none';
  } else {
      actionBtn.style.display = 'flex'; 
      srsControls.style.display = 'none';
      actionBtn.textContent = t.buttons.check;
      actionBtn.onclick = handleAction;
      document.querySelector('#panelEdit button[onclick="previousQuestion()"]').style.display = 'flex';
  }
  updateProgress(state.deckPos, state.deck.length);
}
function showQuickEditPanel(){
    if (!state.currentCardData) return;
    toggleLearningPanel(null); // DiÄŸer panelleri kapat
    const sent = state.currentCardData;
    const currentHint = (data.hints && data.hints.sentences && data.hints.sentences[state.currentCardKey]) || '';
    document.getElementById('qe_tr').value = sent.tr || '';
    document.getElementById('qe_de').value = sent.de || '';
    document.getElementById('qe_hint').value = currentHint;
    document.getElementById('quickEditTitle').textContent = `HÄ±zlÄ± DÃ¼zenle (${state.currentCardKey})`;
    document.getElementById('quickEditPanel').style.display = 'block';
}
function saveQuickEdit(){
    if (!state.currentCardKey) return;
    const parts = state.currentCardKey.match(/^(.*?)_s(\d+)_(\d+)$/);
    const verbId = parts[1];
    const sectionNum = parts[2];
    const sentenceIndex = parseInt(parts[3]);
    const newTr = document.getElementById('qe_tr').value.trim();
    const newDe = document.getElementById('qe_de').value.trim();
    const newHint = document.getElementById('qe_hint').value.trim();
    const contentKey = `${verbId}_s${sectionNum}`;
    if (!data.content[contentKey]) data.content[contentKey] = [];
    data.content[contentKey][sentenceIndex] = { tr: newTr, de: newDe };
    if(!data.hints) data.hints = {sentences:{}, verbs:{}, sections:{}};
    if(!data.hints.sentences) data.hints.sentences = {};
    if (newHint) { data.hints.sentences[state.currentCardKey] = newHint; }
    else { delete data.hints.sentences[state.currentCardKey]; }
    state.currentCardData = { tr: newTr, de: newDe };
    saveContentOverride();
    document.getElementById('quickEditPanel').style.display = 'none';
    renderSentence();
    const t = getMergedTranslations(data.settings.language || 'tr');
    alert(t.messages.quickEditSaved);
}
function renderWordOrder(){
  const pool = document.getElementById('wordPoolArea');
  const sel = document.getElementById('wordSelectedArea');
  pool.innerHTML='';
  sel.innerHTML='';
  state.wordSelected.forEach((w,i)=>{
    const d = document.createElement('div'); d.className='word-item top'; d.textContent = w; d.onclick = ()=> unselectWord(i, w); sel.appendChild(d);
  });
  state.wordPool.forEach((w,i)=>{
    const d = document.createElement('div'); d.className='word-item'; d.textContent = w; d.onclick = ()=> selectWordFromPool(i); pool.appendChild(d);
  });
}
function selectWordFromPool(index){ const word = state.wordPool[index]; state.wordSelected.push(word); state.wordPool.splice(index, 1); renderWordOrder(); }
function unselectWord(index, word){ const removedWord = state.wordSelected.splice(index, 1)[0]; state.wordPool.push(removedWord); renderWordOrder(); }

function showResult(isCorrect, userAnswer, specialMessage = null) {
    const resultArea = document.getElementById('resultArea'), answerArea = document.getElementById('answerArea');
    const t = getMergedTranslations(data.settings.language || 'tr');
    
    let resultHtml = isCorrect ? '<div class="result correct">âœ“ DoÄŸru!</div>' : '<div class="result incorrect">âœ— YanlÄ±ÅŸ!</div>';
    if (specialMessage) {
        resultHtml += `<div class="result" style="background-color: #e6f3ff; color: #0f172a; border-left-color: #4299e1;">${escapeHtml(specialMessage)}</div>`;
    }
    resultArea.innerHTML = resultHtml;
    
    answerArea.innerHTML = `<div class="result"><strong>Sizin:</strong> ${escapeHtml(userAnswer||'(boÅŸ)')}</div><div class="result"><strong>DoÄŸru:</strong> ${escapeHtml(state.correctAnswer)}</div>`;

    state.showResult = true;
    document.getElementById('actionBtn').textContent = t.buttons.next;
    document.getElementById('btnPlayDE').disabled = false; document.getElementById('btnPlayDE').classList.remove('disabled');
    document.getElementById('btnPlayTR').disabled = false; document.getElementById('btnPlayTR').classList.remove('disabled');

    if (state.autoPlayAudio) {
        playCurrentSentence('de');
    }
}

function handleAction(){
  const btn = document.getElementById('actionBtn');
  const resultArea = document.getElementById('resultArea'), answerArea = document.getElementById('answerArea');
  const t = getMergedTranslations(data.settings.language || 'tr');
  
  const triggerAutoPlay = () => {
      if (state.autoPlayAudio) {
          playCurrentSentence('de');
      }
  };

  if(state.mode === 'study'){
    if(!state.showAnswer){
      const ad = document.getElementById('answerDisplay');
      if(ad) ad.classList.remove('hidden');
      state.showAnswer = true;
      btn.style.display = 'none';
      document.getElementById('srsControls').style.display = 'flex';
      document.getElementById('btnPlayDE').disabled = false; document.getElementById('btnPlayDE').classList.remove('disabled');
      document.getElementById('btnPlayTR').disabled = false; document.getElementById('btnPlayTR').classList.remove('disabled');
      triggerAutoPlay();
    }
  } else {
    if(state.showResult){
        // EÄŸer statÃ¼ deÄŸiÅŸtiyse (updateSrsStatusAfterQuiz), kart zaten desteden Ã§Ä±karÄ±ldÄ±.
        // StatÃ¼ deÄŸiÅŸmediyse, kartÄ±n pozisyonunu ilerlet.
        if (!resultArea.innerHTML.includes('listesine taÅŸÄ±ndÄ±')) {
            state.deckPos++;
        }
        state.showAnswer=false;
        state.showResult=false;
        showLearning(); // Bir sonraki karta geÃ§
        return;
    }
    
    let userAnswer = '';
    let isCorrect = false;
    if (state.mode === 'cloze') {
        const input = document.getElementById('clozeInput');
        userAnswer = (input && input.value.trim())||'';
        isCorrect = userAnswer.toLowerCase() === state.correctAnswer.toLowerCase();
    } else if (state.mode === 'wordorder') {
        userAnswer = state.wordSelected.join(' ').trim();
        isCorrect = userAnswer === state.correctAnswer;
    } else if (state.mode === 'quiz') {
        const input = document.getElementById('quizInput');
        userAnswer = (input && input.value.trim())||'';
        isCorrect = userAnswer.toLowerCase() === (state.correctAnswer||'').toLowerCase();
    }
    
    const statusChanged = updateSrsStatusAfterQuiz(state.currentCardKey, isCorrect);
    
    if (!statusChanged) {
        // StatÃ¼ deÄŸiÅŸmediyse, normal sonucu gÃ¶ster
        showResult(isCorrect, userAnswer);
    }
  }
}
function previousQuestion(){
  if (state.mode === 'study') return;
  if(state.deckPos > 0){
      state.deckPos--;
      state.showAnswer=false;
      state.showResult=false;
      state.currentCardKey = state.deck[state.deckPos];
      const parts = state.currentCardKey.match(/^(.*?)_s(\d+)_(\d+)$/);
      const verbId = parts[1], sectionNum = parts[2], sentenceIndex = parseInt(parts[3]);
      state.currentCardData = (data.content[`${verbId}_s${sectionNum}`] || [])[sentenceIndex];
      // Tekrar modu iÃ§in state.verb ve state.section'Ä± ayarla
      state.verb = verbId;
      state.verbData = (data.verbs[state.group] || []).find(v => v.id === verbId);
      state.section = sectionNum;

      renderSentence();
  }
}

// YENÄ°: Bir sonraki adÄ±mÄ± (bÃ¶lÃ¼m/fiil/hikaye) bulan fonksiyon (v4.0)
function findNextStudyStep() {
    const t = getMergedTranslations(data.settings.language || 'tr');
    
    // Mevcut gruptaki tÃ¼m fiilleri sÄ±rayla al
    const currentGroupVerbs = data.verbs[state.group] || [];
    
    // 1. Mevcut fiilde yeni kartÄ± olan sonraki bÃ¶lÃ¼mÃ¼ ara
    const currentSectionNum = parseInt(state.section);
    const sectionKeys = Object.keys(data.sections).map(Number).sort((a, b) => a - b);
    
    for (const secNum of sectionKeys) {
        if (secNum > currentSectionNum) {
            const contentKey = `${state.verb}_s${secNum}`;
            const sentences = data.content[contentKey] || [];
            
            if (sentences.length > 0) {
                // Sadece yeni kart var mÄ± diye kontrol et (basitÃ§e ilk kart)
                const key = getSrsKey(state.verb, secNum, 0); 
                if (getCardSrsData(key).status === 'new' || sentences.some((_, i) => getCardSrsData(getSrsKey(state.verb, secNum, i)).status === 'new')) {
                    return {
                        type: 'section',
                        section: secNum,
                        text: `${t.buttons.nextSection}: ${data.sections[secNum]}`,
                        action: () => {
                            selectSection(secNum);
                            startMode('study');
                        }
                    };
                }
            }
        }
    }

    // 2. Mevcut grupta yeni kartÄ± olan sonraki fiili ara
    const currentVerbIndex = currentGroupVerbs.findIndex(v => v.id === state.verb);
    
    for (let i = currentVerbIndex + 1; i < currentGroupVerbs.length; i++) {
        const nextVerb = currentGroupVerbs[i];
        
        // Bu yeni fiilin tÃ¼m bÃ¶lÃ¼mlerini kontrol et
        for (const secNum of sectionKeys) {
             const contentKey = `${nextVerb.id}_s${secNum}`;
             const sentences = data.content[contentKey] || [];
             if (sentences.length > 0) {
                 // Sadece yeni kart var mÄ± diye kontrol et
                 if (sentences.some((_, j) => getCardSrsData(getSrsKey(nextVerb.id, secNum, j)).status === 'new')) {
                     return {
                        type: 'verb',
                        verb: nextVerb.id,
                        text: `${t.buttons.nextVerb}: ${nextVerb.verbTR || nextVerb.verbDE}`,
                        action: () => {
                            selectVerb(nextVerb.id); // Bu, sectionMenu'yu aÃ§ar
                            // Otomatik olarak ilk yeni bÃ¶lÃ¼me yÃ¶nlendirelim
                            selectSection(secNum);
                            startMode('study');
                        }
                    };
                 }
             }
        }
    }

    // 3. Grubun hikayesini ara (Sadece Ã§alÄ±ÅŸma bittiyse gÃ¶ster)
    if (state.groupData && state.groupData.story && state.groupData.story.title) {
        return {
            type: 'story',
            text: t.buttons.goToStory,
            action: () => showGroupStory(state.group)
        };
    }

    // 4. HiÃ§bir ÅŸey bulunamadÄ±
    return null;
}

function showCompletion(){
  const t = getMergedTranslations(data.settings.language || 'tr');
  let scoreHtml = '';
  
  // v4.0: Akordeon ve SRS'yi gizle
  document.getElementById('actionBtn').style.display = 'none';
  document.getElementById('srsControls').style.display = 'none';
  document.getElementById('learningControlsAccordion').style.display = 'none'; // Akordeon yapÄ±sÄ±nÄ± gizle

  const completionControls = document.getElementById('completionControls');
  const nextStepBtn = document.getElementById('nextStepBtn');

  if (state.mode === 'study') {
      scoreHtml = `<p style="text-align:center">Bu bÃ¶lÃ¼mdeki ${state.deck.length} yeni kartÄ± Ã§alÄ±ÅŸtÄ±nÄ±z!</p>`;
      
      const nextStep = findNextStudyStep();

      if (nextStep) {
          nextStepBtn.textContent = nextStep.text;
          nextStepBtn.onclick = nextStep.action;
          completionControls.style.display = 'flex';
      } else {
          // Sonraki adÄ±m yoksa, butonu gizle. Sabit Home/Back butonlarÄ± kullanÄ±lacak.
          completionControls.style.display = 'none';
      }

  } else {
      scoreHtml = `<p style="text-align:center">"${state.tekrarStatus}" kategorisindeki ${state.deck.length} kartÄ± tekrar ettiniz!</p>`;
      // Tekrar modu bittiÄŸinde sadece mesaj gÃ¶ster, ekstra buton yok.
      completionControls.style.display = 'none';
  }

  document.getElementById('learningContent').innerHTML = `<div class="content-box"><h3 style="text-align:center">ğŸ‰ TamamladÄ±nÄ±z!</h3>
    ${scoreHtml}
  </div>`;
  
  updateProgress(state.deckPos, state.deck.length); 
  document.getElementById('btnPlayDE').disabled = true; document.getElementById('btnPlayDE').classList.add('disabled');
  document.getElementById('btnPlayTR').disabled = true; document.getElementById('btnPlayTR').classList.add('disabled');
}
function playCurrentSentence(lang, retryCount = 0) {
    if (retryCount === 0) resetSpeechButtons();
    if (!state.currentCardData) return;
    const sent = state.currentCardData;
    const text = (lang === 'de') ? sent.de : sent.tr;
    const langCode = (lang === 'de') ? 'de-DE' : 'tr-TR';
    if (!text) return;
    if (lang === 'de' && musicPlayer && musicPlayer.isPlaying && retryCount === 0) {
        musicPlayer.dim_music(true);
    }
    if('speechSynthesis' in window){
        const speakNow = () => {
            const voices = window.speechSynthesis.getVoices();
            if (voices.length === 0 && retryCount < 3) {
                setTimeout(() => playCurrentSentence(lang, retryCount + 1), 500);
                return;
            }
            const utter = new SpeechSynthesisUtterance(text);
            utter.lang = langCode;
            utter.rate = state.speechRate || 1;
            let voice = null;
            if (lang === 'de') {
                voice = voices.find(v => v.lang.toLowerCase() === langCode.toLowerCase() && /anna|markus/i.test(v.name));
            }
            if (!voice) {
                voice = voices.find(v => v.lang.toLowerCase() === langCode.toLowerCase());
            }
            if (!voice && lang === 'de') {
                 voice = voices.find(v => v.lang.toLowerCase().startsWith('de'));
            }
            if (voice) utter.voice = voice;
            utter.onend = utter.onerror = () => {
                if (musicPlayer && musicPlayer.isPlaying) musicPlayer.dim_music(false);
                resetSpeechButtons();
            };
            window.speechSynthesis.cancel();
            window.speechSynthesis.speak(utter);
        };
        if (window.speechSynthesis.getVoices().length === 0 && retryCount === 0 && (navigator.userAgent.match(/iPad|iPhone|iPod/i) || navigator.userAgent.match(/Safari/i) && !navigator.userAgent.match(/Chrome/i))) {
             window.speechSynthesis.onvoiceschanged = function handler() {
                window.speechSynthesis.onvoiceschanged = null; 
                speakNow();
            };
            setTimeout(speakNow, 250);
        } else {
            speakNow();
        }
    } else {
        const t = getMergedTranslations(data.settings.language || 'tr');
        alert(t.messages.ttsNotSupported);
        if (lang === 'de' && musicPlayer && musicPlayer.isPlaying) musicPlayer.dim_music(false);
    }
}

/* ---------- Hikaye FonksiyonlarÄ± ---------- */
function showGroupStory(groupId){
  state.group = groupId; state.groupData = data.groups.find(g=>g.id===groupId) || null;
  const t = getMergedTranslations(data.settings.language || 'tr');
  if(!state.groupData || !state.groupData.story){ alert(t.messages.noStory); return; }
  document.getElementById('storyTitle').textContent = state.groupData.story.title || t.titles.story;
  renderStoryContent();
  showView('storyView');
}
function renderStoryContent(){
  const sc = document.getElementById('storyContent'); const s = state.groupData.story;
  sc.innerHTML = `<div class="story-section"><h3>Almanca</h3><div class="story-content" style="white-space: pre-wrap;">${escapeHtml(s.de||'')}</div></div>
                   <div class="story-section"><h3>TÃ¼rkÃ§e</h3><div class="story-content" style="white-space: pre-wrap;">${escapeHtml(s.tr||'')}</div></div>`;
}
function playStoryAudio(lang, retryCount = 0) {
    if (retryCount === 0) resetSpeechButtons();
    const s = state.groupData && state.groupData.story;
    const t = getMergedTranslations(data.settings.language || 'tr');
    if (!s) { alert(t.messages.noStoryFound); return; }
    const text = (lang === 'de') ? s.de : s.tr;
    const langCode = (lang === 'de') ? 'de-DE' : 'tr-TR';
    if (!text) return;
    if (lang === 'de' && musicPlayer && musicPlayer.isPlaying && retryCount === 0) musicPlayer.dim_music(true);
    if ('speechSynthesis' in window) {
        const speakNow = () => {
            const voices = window.speechSynthesis.getVoices();
            if (voices.length === 0 && retryCount < 3) {
                setTimeout(() => playStoryAudio(lang, retryCount + 1), 500);
                return;
            }
            const utter = new SpeechSynthesisUtterance(text);
            utter.lang = langCode;
            utter.rate = state.speechRate || 1;
            let voice = null;
            if (lang === 'de') voice = voices.find(v => v.lang.toLowerCase() === langCode.toLowerCase() && /anna|markus/i.test(v.name));
            if (!voice) voice = voices.find(v => v.lang.toLowerCase() === langCode.toLowerCase());
            if (!voice && lang === 'de') voice = voices.find(v => v.lang.toLowerCase().startsWith('de'));
            if (voice) utter.voice = voice;
            utter.onend = utter.onerror = () => {
                if (musicPlayer && musicPlayer.isPlaying) musicPlayer.dim_music(false);
                resetSpeechButtons();
            };
            window.speechSynthesis.cancel();
            window.speechSynthesis.speak(utter);
        };
        if (window.speechSynthesis.getVoices().length === 0 && retryCount === 0 && (navigator.userAgent.match(/iPad|iPhone|iPod/i) || navigator.userAgent.match(/Safari/i) && !navigator.userAgent.match(/Chrome/i))) {
             window.speechSynthesis.onvoiceschanged = function handler() {
                window.speechSynthesis.onvoiceschanged = null;
                speakNow();
            };
            setTimeout(speakNow, 250);
        } else {
            speakNow();
        }
    } else {
        alert(t.messages.ttsNotSupported);
        if (lang === 'de' && musicPlayer && musicPlayer.isPlaying) musicPlayer.dim_music(false);
    }
}
function showStoryQuestions(){
  const story = state.groupData && state.groupData.story;
  const container = document.getElementById('storyQuestionsContent');
  const t = getMergedTranslations(data.settings.language || 'tr');
  container.innerHTML = '';
  if(!story || !story.quiz || !Array.isArray(story.quiz) || story.quiz.length===0){
    container.innerHTML = `<p>${t.messages.noStoryQuestions}</p>`;
    showView('storyQuestionsView');
    return;
  }
  const quiz = story.quiz;
  let html = '<form id="storyQuizForm">';
  quiz.forEach((q,i)=>{
    html += `<div style="margin:10px 0;padding:10px;border-radius:8px;background:#fff;color:#0f1724"><b>${i+1}. ${escapeHtml(q.q)}</b><div style="margin-top:8px">`;
    (q.options || []).forEach((opt,j)=>{
      html += `<label style="display:block;margin:6px 0"><input type="radio" name="sq${i}" value="${escapeHtml(opt)}"> ${escapeHtml(opt)}</label>`;
    });
    html += `</div></div>`;
  });
  html += `<div class="button-group-row"><button type="button" class="btn btn-primary" onclick="checkStoryAnswers()">${t.buttons.show}</button></div></form>`;
  container.innerHTML = html;
  showView('storyQuestionsView');
}
function checkStoryAnswers(){
  const story = state.groupData.story; const quiz = story.quiz;
  let correct=0;
  quiz.forEach((q,i)=>{
    const sel = document.querySelector(`input[name="sq${i}"]:checked`);
    if(sel && sel.value === q.a) correct++;
  });
  alert(`ğŸ¯ ${correct} / ${quiz.length} doÄŸru`);
}

/* ---------- Debug & Ä°lerleme EkranÄ± ---------- */
function debugData(){
  const t = getMergedTranslations(data.settings.language || 'tr');
  let msg = `${t.messages.jsonStatus}\n\n`;
  msg += `Gruplar: ${(data.groups||[]).length}\n`;
  msg += `Fiil GruplarÄ±: ${Object.keys(data.verbs||{}).length}\n`;
  msg += `Ä°Ã§erik AnahtarlarÄ±: ${Object.keys(data.content||{}).length}\n`;
  msg += `BÃ¶lÃ¼m Ä°puÃ§larÄ±: ${Object.keys((data.hints && data.hints.sections)||{}).length}\n`;
  msg += `Ä°pucu (CÃ¼mle): ${Object.keys((data.hints&&data.hints.sentences)||{}).length}\n`;
  const srsCount = Object.keys(srsData).length;
  msg += `\nSRS Veri KayÄ±tlarÄ±: ${srsCount}\n`;
  alert(msg);
}
function updateProgressView(){
  const t = getMergedTranslations(data.settings.language || 'tr');
  let totalCards = 0;
  let learnedCards = 0;
  let stats = { zor: 0, normal: 0, ogrendim: 0, new: 0 };
  Object.keys(data.content).forEach(key => {
      totalCards += (data.content[key] || []).length;
  });
  Object.keys(srsData).forEach(key => {
      const status = srsData[key].status;
      if (stats.hasOwnProperty(status)) {
          stats[status]++;
      }
  });
  learnedCards = stats.zor + stats.normal + stats.ogrendim;
  stats.new = totalCards - learnedCards;
  if (stats.new < 0) stats.new = 0;
  const progressView = document.getElementById('progress');
  if (progressView && progressView.classList.contains('active')) {
      document.getElementById('progressStatZor').textContent = stats.zor;
      document.getElementById('progressStatNormal').textContent = stats.normal;
      document.getElementById('progressStatOgrenildi').textContent = stats.ogrendim;
      const percent = totalCards === 0 ? 0 : Math.round((learnedCards / totalCards) * 100);
      document.getElementById('totalProgressFill').style.width = percent + '%';
      document.getElementById('totalProgressFill').textContent = percent + '%';
      document.getElementById('totalProgressText').textContent = `${learnedCards} / ${totalCards}`;
  }
  const tekrarView = document.getElementById('tekrarMenu');
  if (tekrarView && tekrarView.classList.contains('active')) {
      document.getElementById('tekrarCountZor').textContent = stats.zor;
      document.getElementById('tekrarCountNormal').textContent = stats.normal;
      document.getElementById('tekrarCountOgrenildi').textContent = stats.ogrendim;
  }
}
function toggleHintPanel(){
    state.hintPanelVisible = !state.hintPanelVisible;
    const hintPanelEl = document.getElementById('hintPanel');
    if(state.hintPanelVisible) {
        const hintHtml = buildSentenceHintHtml();
        hintPanelEl.innerHTML = hintHtml || '<div class="hint-item">Bu kart iÃ§in ipucu yok.</div>';
        hintPanelEl.style.display = 'block';
    } else {
        hintPanelEl.style.display = 'none';
    }
}


/* -------------------------------------------------------- */
/* -------------------- ADMIN PANeli (v4.0) -------------------- */
/* -------------------------------------------------------- */

// YENÄ°: KÄ±lavuz Metni DÃ¼zenleme Formu (v4.0)
function showAdminGuideForm(area) {
    const t = getMergedTranslations(data.settings.language || 'tr');
    const guide = data.guideText || {};
    area.innerHTML = `
        <div class="content-box">
            <h4>â­ KÄ±lavuz Metnini DÃ¼zenle</h4>
            <p class="small-muted">Bu metin, Ã¼st saÄŸdaki â­ butonuna basÄ±ldÄ±ÄŸÄ±nda gÃ¶rÃ¼nÃ¼r.</p>
            <label>${t.labels.guideTitle}</label><input id="adm_g_title" class="input-field" value="${escapeHtml(guide.title || t.titles.guide)}">
            <label>${t.labels.guideContent}</label><textarea id="adm_g_content" class="textarea-field" rows="15">${escapeHtml(guide.content || '')}</textarea>
            <div class="button-group-row" style="margin-top:15px;">
                <button class="btn btn-primary" onclick="adminSaveGuide()">âœ… ${t.buttons.save}</button>
            </div>
        </div>`;
}
function adminSaveGuide() {
    const t = getMergedTranslations(data.settings.language || 'tr');
    const title = document.getElementById('adm_g_title').value.trim();
    const content = document.getElementById('adm_g_content').value.trim();
    if (!title || !content) { alert('BaÅŸlÄ±k ve iÃ§erik boÅŸ olamaz.'); return; }

    data.guideText = { title: title, content: content };
    saveContentOverride();
    alert(t.messages.guideSaved);
    showAdminForm('editGuide');
}


function showAdminGroupOrderForm(area) {
    const t = getMergedTranslations(data.settings.language || 'tr');
    area.innerHTML = `
        <div class="content-box">
            <h4>â†•ï¸ Grup SÄ±ralamasÄ±nÄ± DÃ¼zenle</h4>
            <p class="small-muted">OklarÄ± kullanarak gruplarÄ±n menÃ¼deki sÄ±rasÄ±nÄ± ayarlayÄ±n. Kaydetmek iÃ§in butona basÄ±n.</p>
            <ul id="groupOrderList" style="list-style: none; padding: 0;"></ul>
            <div class="button-group-row" style="margin-top:15px;">
                <button class="btn btn-primary" onclick="adminSaveGroupOrder()">âœ… SÄ±ralamayÄ± Kaydet</button>
            </div>
        </div>`;
    renderGroupOrderList();
}
function renderGroupOrderList() {
    const listContainer = document.getElementById('groupOrderList');
    if (!listContainer) return;
    listContainer.innerHTML = '';
    data.groups.forEach((group, index) => {
        const li = document.createElement('li');
        li.style.cssText = 'display: flex; justify-content: space-between; align-items: center; padding: 8px; border: 1px solid #ccc; margin-bottom: 4px; border-radius: 4px; background: #f9f9f9; color: #0f172a;';
        li.dataset.groupId = group.id;
        const upDisabled = index === 0 ? 'disabled' : '';
        const downDisabled = index === data.groups.length - 1 ? 'disabled' : '';
        const upBtn = `<button class="btn btn-small btn-secondary" style="width:30px; margin:2px;" ${upDisabled} onclick="moveGroup(${index}, 'up')">â–²</button>`;
        const downBtn = `<button class="btn btn-small btn-secondary" style="width:30px; margin:2px;" ${downDisabled} onclick="moveGroup(${index}, 'down')">â–¼</button>`;
        li.innerHTML = `
            <div style="font-weight: bold; width: 40px;">${group.id}</div>
            <div style="flex-grow: 1;">${group.name}</div>
            <div style="display:flex; flex-direction:column;">${upBtn} ${downBtn}</div>
        `;
        listContainer.appendChild(li);
    });
}
function moveGroup(index, direction) {
    const groups = data.groups;
    const newIndex = direction === 'up' ? index - 1 : index + 1;
    if (newIndex >= 0 && newIndex < groups.length) {
        [groups[index], groups[newIndex]] = [groups[newIndex], groups[index]];
        renderGroupOrderList(); 
    }
}
function adminSaveGroupOrder() {
    saveContentOverride();
    alert('âœ… Yeni Grup SÄ±ralamasÄ± BaÅŸarÄ±yla Kaydedildi!');
    showAdminForm('groupOrder'); 
}
function showGroupVerbImporter() {
  document.getElementById('adminTsvArea').style.display = 'none'; 
  document.getElementById('adminGroupVerbArea').style.display = 'block';
  document.getElementById('groupVerbPasteArea').value = '';
}
function parseAndImportGroupsAndVerbs() {
    const textData = document.getElementById('groupVerbPasteArea').value.trim();
    const t = getMergedTranslations(data.settings.language || 'tr');
    if (!textData) { alert('LÃ¼tfen veriyi yapÄ±ÅŸtÄ±rÄ±n.'); return; }
    const lines = textData.split('\n');
    let groupsAdded = 0, verbsAdded = 0, errors = 0;
    if (!data.groups) data.groups = [];
    if (!data.verbs) data.verbs = {};
    lines.forEach((line, lineIndex) => {
        line = line.trim();
        if (!line) return;
        const columns = line.split('\t');
        if (columns.length < 5) {
            console.warn(`Grup/Fiil YÃ¼kleyici: SatÄ±r ${lineIndex} atlandÄ± (yetersiz sÃ¼tun).`);
            errors++;
            return;
        }
        const [gid, gName, vid, vTR, vDE] = columns.map(c => c.trim());
        if (!gid || !gName || !vid || !vTR || !vDE) {
            console.warn(`Grup/Fiil YÃ¼kleyici: SatÄ±r ${lineIndex} atlandÄ± (boÅŸ alanlar).`);
            errors++;
            return;
        }
        try {
            let groupExists = data.groups.find(g => g.id === gid);
            if (!groupExists) {
                data.groups.push({ id: gid, name: gName, nameDE: gName, story: null });
                groupsAdded++;
            }
            if (!data.verbs[gid]) {
                data.verbs[gid] = [];
            }
            let verbExists = data.verbs[gid].find(v => v.id === vid);
            if (!verbExists) {
                data.verbs[gid].push({ id: vid, verbTR: vTR, verbDE: vDE });
                verbsAdded++;
            }
        } catch (e) {
             console.error(`Grup/Fiil YÃ¼kleyici: SatÄ±r ${lineIndex} iÅŸlenirken hata: ${e.message}`);
             errors++;
        }
    });
    if (groupsAdded > 0 || verbsAdded > 0) {
        saveContentOverride();
        alert(`Ä°ÅŸlem tamam!\nâœ… Eklenen Yeni Grup: ${groupsAdded}\nâœ… Eklenen Yeni Fiil: ${verbsAdded}\nâŒ HatalÄ± SatÄ±r: ${errors}\n\nDeÄŸiÅŸikliklerin gÃ¶rÃ¼nmesi iÃ§in sayfayÄ± yenileyin.`);
        document.getElementById('adminGroupVerbArea').style.display = 'none';
        showView('adminView');
    } else {
         alert(`Ä°ÅŸlem tamamlandÄ±!\n(Veriler zaten mevcut olabilir)\nâœ… Eklenen Yeni Grup: ${groupsAdded}\nâœ… Eklenen Yeni Fiil: ${verbsAdded}\nâŒ HatalÄ± SatÄ±r: ${errors}`);
    }
}
function showTsvImporter() {
  document.getElementById('adminGroupVerbArea').style.display = 'none'; 
  document.getElementById('adminTsvArea').style.display = 'block';
  document.getElementById('tsvPasteArea').value = '';
}
function parseAndImportTsv() {
  const tsvData = document.getElementById('tsvPasteArea').value.trim();
  const t = getMergedTranslations(data.settings.language || 'tr');
  if (!tsvData) { alert('LÃ¼tfen veriyi yapÄ±ÅŸtÄ±rÄ±n.'); return; }
  const lines = tsvData.split('\n');
  let sentencesAdded = 0, hintsAdded = 0, errors = 0;
  if (!data.content) data.content = {};
  if (!data.hints) data.hints = { sentences: {}, verbs: {}, sections: {} };
  if (!data.hints.sentences) data.hints.sentences = {};
  const firstDataLine = lines[0] || '';
  const delimiter = firstDataLine.includes('\t') ? '\t' : ',';
  if (delimiter === ',') { console.log('CSV (VirgÃ¼l) formatÄ± algÄ±landÄ±.'); } 
  else { console.log('TSV (Sekme/Tab) formatÄ± algÄ±landÄ±.'); }
  lines.forEach((line, lineIndex) => {
    line = line.trim();
    if (line === '') return;
    const columns = line.split(delimiter);
    if (columns.length < 5) {
        console.warn(`CÃ¼mle YÃ¼kleyici: SatÄ±r ${lineIndex} atlandÄ± (yetersiz sÃ¼tun: ${columns.length})`);
        errors++;
        return;
    }
    const [grupId, fiilId, bolumNum, tr, de, cumleIpucu] = columns.map(c => (c || '').trim().replace(/^"|"$/g, ''));
    if (!grupId || !fiilId || !bolumNum || !tr || !de) {
        console.warn(`CÃ¼mle YÃ¼kleyici: SatÄ±r ${lineIndex} atlandÄ± (gerekli alanlar boÅŸ).`);
        errors++;
        return;
    }
    if (bolumNum.toLowerCase().includes('bÃ¶lÃ¼m') || isNaN(parseInt(bolumNum))) {
        if (lineIndex === 0) {
             console.log("CÃ¼mle YÃ¼kleyici: BaÅŸlÄ±k satÄ±rÄ± algÄ±landÄ± ve atlandÄ±.");
        } else {
             console.warn(`CÃ¼mle YÃ¼kleyici: SatÄ±r ${lineIndex} atlandÄ± (geÃ§ersiz bÃ¶lÃ¼m no: ${bolumNum}).`);
        }
        return;
    }
    try {
      const contentKey = `${fiilId}_s${bolumNum}`;
      if (!data.content[contentKey]) data.content[contentKey] = [];
      const newSentenceIndex = data.content[contentKey].length;
      data.content[contentKey].push({ tr: tr, de: de });
      sentencesAdded++;
      if (cumleIpucu && cumleIpucu.trim() !== '') {
        const hintKey = getSrsKey(fiilId, bolumNum, newSentenceIndex);
        data.hints.sentences[hintKey] = cumleIpucu;
        hintsAdded++;
      }
    } catch (e) {
        console.error(`CÃ¼mle YÃ¼kleyici: SatÄ±r ${lineIndex} iÅŸlenirken hata: ${e.message}`);
        errors++;
    }
  });
  if (sentencesAdded > 0) {
    saveContentOverride();
  }
  alert(`CÃ¼mle YÃ¼kleme TamamlandÄ±!\nâœ… Eklenen CÃ¼mle: ${sentencesAdded}\nğŸ’¡ Eklenen Ä°pucu: ${hintsAdded}\nâŒ HatalÄ±/Atlanan SatÄ±r: ${errors}`);
  document.getElementById('tsvPasteArea').value = '';
  document.getElementById('adminTsvArea').style.display = 'none';
}
function showAdminForm(formType) {
    const area = document.getElementById('adminContentArea');
    area.style.display = 'block';
    area.innerHTML = 'YÃ¼kleniyor...';
    if (formType === 'addGroup') showAdminGroupForm(area);
    else if (formType === 'addVerb') showAdminVerbForm(area);
    else if (formType === 'addSection') showAdminSectionForm(area);
    else if (formType === 'addStory') showAdminStoryForm(area);
    else if (formType === 'addHint') showAdminHintForm(area);
    else if (formType === 'editSentence') showAdminSentenceForm(area);
    else if (formType === 'groupOrder') showAdminGroupOrderForm(area); 
    else if (formType === 'editGuide') showAdminGuideForm(area); // YENÄ°: KÄ±lavuz
    else area.innerHTML = 'Form bulunamadÄ±.';
}
function showAdminGroupForm(area) {
    const t = getMergedTranslations(data.settings.language || 'tr');
    let options = data.groups.map(g => `<option value="${g.id}">${g.name} (${g.id})</option>`).join('');
    area.innerHTML = `<div class="content-box"><h4>${t.admin.addGroup}</h4>
      <label>${t.labels.group} (DÃ¼zenlemek iÃ§in seÃ§in)</label>
      <select id="adm_g_select" class="select-field"><option value="">-- YENÄ° GRUP --</option>${options}</select>
      <label>${t.labels.groupID}</label><input id="adm_g_id" class="input-field">
      <label>${t.labels.groupNameTR}</label><input id="adm_g_name_tr" class="input-field">
      <label>${t.labels.groupNameDE}</label><input id="adm_g_name_de" class="input-field">
      <div class="button-group-row">
        <button class="btn btn-primary" onclick="adminSaveGroup()">âœ… ${t.buttons.save}</button>
        <button class="btn btn-danger" onclick="adminDeleteGroup()">ğŸ—‘ ${t.buttons.delete}</button>
      </div></div>`;
    document.getElementById('adm_g_select').onchange = (e) => {
        const gid = e.target.value;
        const g = data.groups.find(x => x.id === gid);
        if (g) {
            document.getElementById('adm_g_id').value = g.id;
            document.getElementById('adm_g_id').readOnly = true;
            document.getElementById('adm_g_name_tr').value = g.name;
            document.getElementById('adm_g_name_de').value = g.nameDE || '';
        } else {
            document.getElementById('adm_g_id').value = '';
            document.getElementById('adm_g_id').readOnly = false;
            document.getElementById('adm_g_name_tr').value = '';
            document.getElementById('adm_g_name_de').value = '';
        }
    };
}
function adminSaveGroup() {
    const selId = document.getElementById('adm_g_select').value;
    const id = document.getElementById('adm_g_id').value.trim();
    const name = document.getElementById('adm_g_name_tr').value.trim();
    const named = document.getElementById('adm_g_name_de').value.trim();
    if (!id || !name) { alert('ID ve TR Ä°sim gerekli'); return; }
    let g = data.groups.find(x => x.id === (selId || id));
    if (g) {
        g.name = name;
        g.nameDE = named;
        alert('Grup gÃ¼ncellendi');
    } else {
        if (data.groups.find(x => x.id === id)) { alert('Bu ID zaten var'); return; }
        data.groups.push({ id: id, name: name, nameDE: named, story: null });
        if (!data.verbs[id]) data.verbs[id] = [];
        alert('Grup eklendi');
    }
    saveContentOverride();
    showAdminForm('addGroup');
}
function adminDeleteGroup() {
    const selId = document.getElementById('adm_g_select').value;
    if (!selId) { alert('Silmek iÃ§in bir grup seÃ§in'); return; }
    if (!confirm(`'${selId}' grubunu silmek istediÄŸinizden emin misiniz? (Ä°Ã§indeki fiiller ve iÃ§erikler de silinebilir!)`)) return;
    data.groups = data.groups.filter(g => g.id !== selId);
    delete data.verbs[selId];
    alert('Grup silindi');
    saveContentOverride();
    showAdminForm('addGroup');
}
function showAdminVerbForm(area) {
    const t = getMergedTranslations(data.settings.language || 'tr');
    let groupOptions = data.groups.map(g => `<option value="${g.id}">${g.name}</option>`).join('');
    area.innerHTML = `<div class="content-box"><h4>${t.admin.addVerb}</h4>
      <label>${t.labels.group}</label>
      <select id="adm_v_group" class="select-field">${groupOptions}</select>
      <label>${t.labels.verb} (DÃ¼zenlemek iÃ§in seÃ§in)</label>
      <select id="adm_v_select" class="select-field"><option value="">-- YENÄ° FÄ°Ä°L --</option></select>
      <label>${t.labels.verbID}</label><input id="adm_v_id" class="input-field">
      <label>${t.labels.verbTR}</label><input id="adm_v_tr" class="input-field">
      <label>${t.labels.verbDE}</label><input id="adm_v_de" class="input-field">
      <div class="button-group-row">
        <button class="btn btn-primary" onclick="adminSaveVerb()">âœ… ${t.buttons.save}</button>
        <button class="btn btn-danger" onclick="adminDeleteVerb()">ğŸ—‘ ${t.buttons.delete}</button>
      </div></div>`;
    const groupSelect = document.getElementById('adm_v_group');
    const verbSelect = document.getElementById('adm_v_select');
    const loadVerbs = () => {
        const gid = groupSelect.value;
        verbSelect.innerHTML = '<option value="">-- YENÄ° FÄ°Ä°L --</option>';
        if (!gid || !data.verbs[gid]) { adminLoadVerbFields(); return; }
        const verbOptions = (data.verbs[gid] || []).map(v => `<option value="${v.id}">${v.verbTR || v.verbDE} (${v.id})</option>`).join('');
        verbSelect.innerHTML += verbOptions;
        adminLoadVerbFields();
    };
    groupSelect.onchange = loadVerbs;
    verbSelect.onchange = adminLoadVerbFields;
    if(groupSelect.options.length > 0) groupSelect.selectedIndex = 0;
    loadVerbs();
}
function adminLoadVerbFields() {
    const gid = document.getElementById('adm_v_group').value;
    const vid = document.getElementById('adm_v_select').value;
    const v = (data.verbs[gid] || []).find(x => x.id === vid);
    if (v) {
        document.getElementById('adm_v_id').value = v.id;
        document.getElementById('adm_v_id').readOnly = true;
        document.getElementById('adm_v_tr').value = v.verbTR || '';
        document.getElementById('adm_v_de').value = v.verbDE || '';
    } else {
        document.getElementById('adm_v_id').value = '';
        document.getElementById('adm_v_id').readOnly = false;
        document.getElementById('adm_v_tr').value = '';
        document.getElementById('adm_v_de').value = '';
    }
}
function adminSaveVerb() {
    const gid = document.getElementById('adm_v_group').value;
    const selId = document.getElementById('adm_v_select').value;
    const id = document.getElementById('adm_v_id').value.trim();
    const vtr = document.getElementById('adm_v_tr').value.trim();
    const vde = document.getElementById('adm_v_de').value.trim();
    if (!gid || !id || (!vtr && !vde)) { alert('Grup, Fiil ID ve TR/DE adÄ± gerekli'); return; }
    if (!data.verbs[gid]) data.verbs[gid] = [];
    let v = data.verbs[gid].find(x => x.id === (selId || id));
    if (v) {
        v.verbTR = vtr;
        v.verbDE = vde;
        alert('Fiil gÃ¼ncellendi');
    } else {
        if (data.verbs[gid].find(x => x.id === id)) { alert('Bu ID bu grupta zaten var'); return; }
        data.verbs[gid].push({ id: id, verbTR: vtr, verbDE: vde });
        alert('Fiil eklendi');
    }
    saveContentOverride();
    showAdminForm('addVerb');
}
function adminDeleteVerb() {
    const gid = document.getElementById('adm_v_group').value;
    const selId = document.getElementById('adm_v_select').value;
    if (!selId || !gid) { alert('Silmek iÃ§in bir grup ve fiil seÃ§in'); return; }
    if (!confirm(`'${selId}' fiilini silmek istediÄŸinizden emin misiniz?`)) return;
    data.verbs[gid] = (data.verbs[gid] || []).filter(v => v.id !== selId);
    alert('Fiil silindi');
    saveContentOverride();
    showAdminForm('addVerb');
}
function showAdminSectionForm(area) {
    const t = getMergedTranslations(data.settings.language || 'tr');
    let options = Object.entries(data.sections).map(([num, name]) => `<option value="${num}">${num}. ${name}</option>`).join('');
    area.innerHTML = `<div class="content-box"><h4>${t.admin.addSection}</h4>
      <label>BÃ¶lÃ¼m (DÃ¼zenlemek iÃ§in seÃ§in)</label>
      <select id="adm_s_select" class="select-field"><option value="">-- YENÄ° BÃ–LÃœM --</option>${options}</select>
      <label>${t.labels.sectionNum}</label><input id="adm_s_num" class="input-field" type="number">
      <label>${t.labels.sectionName}</label><input id="adm_s_name" class="input-field">
      <div class="button-group-row">
        <button class="btn btn-primary" onclick="adminSaveSection()">âœ… ${t.buttons.save}</button>
        <button class="btn btn-danger" onclick="adminDeleteSection()">ğŸ—‘ ${t.buttons.delete}</button>
      </div></div>`;
    document.getElementById('adm_s_select').onchange = (e) => {
        const num = e.target.value;
        const name = data.sections[num];
        if (name) {
            document.getElementById('adm_s_num').value = num;
            document.getElementById('adm_s_num').readOnly = true;
            document.getElementById('adm_s_name').value = name;
        } else {
            document.getElementById('adm_s_num').value = '';
            document.getElementById('adm_s_num').readOnly = false;
            document.getElementById('adm_s_name').value = '';
        }
    };
}
function adminSaveSection() {
    const selNum = document.getElementById('adm_s_select').value;
    const num = document.getElementById('adm_s_num').value.trim();
    const name = document.getElementById('adm_s_name').value.trim();
    if (!num || !name) { alert('Numara ve Ä°sim gerekli'); return; }
    if (data.sections[num] && !selNum) {
        alert('Bu bÃ¶lÃ¼m numarasÄ± zaten var'); return;
    }
    data.sections[num] = name;
    if (selNum && selNum !== num) {
        delete data.sections[selNum];
    }
    alert(selNum ? 'BÃ¶lÃ¼m gÃ¼ncellendi' : 'BÃ¶lÃ¼m eklendi');
    saveContentOverride();
    showAdminForm('addSection');
}
function adminDeleteSection() {
    const selNum = document.getElementById('adm_s_select').value;
    if (!selNum) { alert('Silmek iÃ§in bir bÃ¶lÃ¼m seÃ§in'); return; }
    if (!confirm(`'${selNum}' numaralÄ± bÃ¶lÃ¼mÃ¼ silmek istediÄŸinizden emin misiniz?`)) return;
    delete data.sections[selNum];
    alert('BÃ¶lÃ¼m silindi');
    saveContentOverride();
    showAdminForm('addSection');
}
function showAdminStoryForm(area) {
    const t = getMergedTranslations(data.settings.language || 'tr');
    let groupOptions = data.groups.map(g => `<option value="${g.id}">${g.name}</option>`).join('');
    area.innerHTML = `<div class="content-box"><h4>${t.admin.addStory}</h4>
      <label>${t.labels.group}</label>
      <select id="adm_st_group" class="select-field">${groupOptions}</select>
      <label>${t.labels.title}</label><input id="adm_st_title" class="input-field">
      <label>${t.labels.deText}</label><textarea id="adm_st_de" class="textarea-field" rows="5"></textarea>
      <label>${t.labels.trText}</label><textarea id="adm_st_tr" class="textarea-field" rows="5"></textarea>
      <h5 style="margin-top:10px;">Hikaye SorularÄ± (Quiz)</h5>
      <div id="adm_st_quiz_area"></div>
      <button class="btn btn-secondary btn-small" onclick="adminStoryAddQuestion()">+ Soru Ekle</button>
      <div class="button-group-row">
        <button class="btn btn-primary" onclick="adminSaveStory()">âœ… ${t.buttons.save}</button>
      </div></div>`;
    document.getElementById('adm_st_group').onchange = adminStoryLoadFields;
    if(data.groups.length > 0) {
        document.getElementById('adm_st_group').selectedIndex = 0;
        adminStoryLoadFields(); 
    }
}
function adminStoryLoadFields() {
    const gid = document.getElementById('adm_st_group').value;
    const g = data.groups.find(x => x.id === gid);
    const story = g ? g.story : null;
    document.getElementById('adm_st_title').value = story ? story.title || '' : '';
    document.getElementById('adm_st_de').value = story ? story.de || '' : '';
    document.getElementById('adm_st_tr').value = story ? story.tr || '' : '';
    const quizArea = document.getElementById('adm_st_quiz_area');
    quizArea.innerHTML = '';
    if (story && story.quiz) {
        story.quiz.forEach((q, i) => adminStoryAddQuestion(q));
    }
}
function adminStoryAddQuestion(q = null) {
    const t = getMergedTranslations(data.settings.language || 'tr');
    const quizArea = document.getElementById('adm_st_quiz_area');
    const index = quizArea.children.length;
    const qDiv = document.createElement('div');
    qDiv.className = 'content-box';
    qDiv.style.borderColor = '#ccc';
    qDiv.innerHTML = `
        <label>${t.labels.question} ${index + 1}</label>
        <input type="text" class="input-field adm_st_q_q" value="${q ? escapeHtml(q.q) : ''}">
        <label>${t.labels.options}</label>
        <input type="text" class="input-field adm_st_q_opts" value="${q ? escapeHtml(q.options.join(',')) : ''}">
        <label>${t.labels.correctAnswer}</label>
        <input type="text" class="input-field adm_st_q_a" value="${q ? escapeHtml(q.a) : ''}">
        <button class="btn btn-danger btn-small" style="margin-top:5px;" onclick="this.parentElement.remove()">- Sil</button>
    `;
    quizArea.appendChild(qDiv);
}
function adminSaveStory() {
    const gid = document.getElementById('adm_st_group').value;
    const g = data.groups.find(x => x.id === gid);
    if (!g) { alert('Grup bulunamadÄ±'); return; }
    const title = document.getElementById('adm_st_title').value;
    const de = document.getElementById('adm_st_de').value;
    const tr = document.getElementById('adm_st_tr').value;
    const quiz = [];
    document.getElementById('adm_st_quiz_area').querySelectorAll('.content-box').forEach(qDiv => {
        const q = qDiv.querySelector('.adm_st_q_q').value;
        const opts = qDiv.querySelector('.adm_st_q_opts').value.split(',').map(s => s.trim());
        const a = qDiv.querySelector('.adm_st_q_a').value;
        if (q && opts.length > 0 && a) {
            quiz.push({ q, options: opts, a });
        }
    });
    g.story = { title, de, tr, quiz };
    saveContentOverride();
    alert('Hikaye kaydedildi!');
}
function showAdminHintForm(area) {
    const t = getMergedTranslations(data.settings.language || 'tr');
    area.innerHTML = `<div class="content-box"><h4>${t.admin.hintManagement}</h4>
      <label>Ä°pucu Tipi SeÃ§</label>
      <select id="adm_h_type" class="select-field">
        <option value="">SeÃ§in...</option>
        <option value="section">BÃ¶lÃ¼m (Genel Ä°pucu, Ã¶rn: B1, B2)</option>
        <option value="verb">Fiil (Genel Ä°pucu, Ã¶rn: v1, v2)</option>
        <option value="sentence">CÃ¼mle (Ã–zel Ä°pucu, Ã¶rn: v1_s1_0)</option>
      </select>
      <div id="adm_h_target_area" style="margin-top:10px;"></div>
      <label>${t.labels.hintText}</label>
      <textarea id="adm_h_text" class="textarea-field" rows="4"></textarea>
      <div class="button-group-row">
        <button class="btn btn-primary" onclick="adminSaveHint()">âœ… ${t.buttons.save}</button>
      </div></div>`;
    document.getElementById('adm_h_type').onchange = adminHintLoadTargetSelectors;
}
function adminHintLoadTargetSelectors() {
    const type = document.getElementById('adm_h_type').value;
    const targetArea = document.getElementById('adm_h_target_area');
    targetArea.innerHTML = ''; 
    document.getElementById('adm_h_text').value = ''; 
    if (type === 'section') {
        let options = Object.entries(data.sections).map(([num, name]) => `<option value="B${num}">${num}. ${name} (B${num})</option>`).join('');
        targetArea.innerHTML = `<label>BÃ¶lÃ¼m SeÃ§</label><select id="adm_h_target" class="select-field">${options}</select>`;
        document.getElementById('adm_h_target').onchange = adminHintLoadText;
    }
    else if (type === 'verb') {
        let options = data.groups.map(g => {
            return (data.verbs[g.id] || []).map(v => `<option value="${v.id}">${g.name} -> ${v.verbTR || v.verbDE} (${v.id})</option>`).join('');
        }).join('');
        targetArea.innerHTML = `<label>Fiil SeÃ§</label><select id="adm_h_target" class="select-field">${options}</select>`;
        document.getElementById('adm_h_target').onchange = adminHintLoadText;
    }
    else if (type === 'sentence') {
        let groupOptions = data.groups.map(g => `<option value="${g.id}">${g.name}</option>`).join('');
        targetArea.innerHTML = `
            <label>Grup</label><select id="adm_h_g" class="select-field">${groupOptions}</select>
            <label>Fiil</label><select id="adm_h_v" class="select-field"></select>
            <label>BÃ¶lÃ¼m</label><select id="adm_h_s" class="select-field"></select>
            <label>CÃ¼mle</label><select id="adm_h_target" class="select-field"></select>`;
        document.getElementById('adm_h_g').onchange = () => {
            const gid = document.getElementById('adm_h_g').value;
            fillSelect('adm_h_v', (data.verbs[gid] || []).map(v => ({ v: v.id, t: (v.verbTR || v.verbDE) })), false);
            adminHintLoadTargetSelectors_LoadSections();
        };
        document.getElementById('adm_h_v').onchange = adminHintLoadTargetSelectors_LoadSections;
        document.getElementById('adm_h_s').onchange = adminHintLoadTargetSelectors_LoadSentences;
        document.getElementById('adm_h_target').onchange = adminHintLoadText;
        if(data.groups.length > 0) {
             document.getElementById('adm_h_g').selectedIndex = 0;
             document.getElementById('adm_h_g').onchange();
        }
    }
}
function adminHintLoadTargetSelectors_LoadSections() {
    const vid = document.getElementById('adm_h_v').value;
    if (!vid) { fillSelect('adm_h_s', [], false); adminHintLoadTargetSelectors_LoadSentences(); return; }
    const items = Object.entries(data.sections).map(([num, name]) => {
        const count = (data.content[`${vid}_s${num}`] || []).length;
        return { v: num, t: `${num}. ${name} (${count}c)` };
    });
    fillSelect('adm_h_s', items, false);
    adminHintLoadTargetSelectors_LoadSentences();
}
function adminHintLoadTargetSelectors_LoadSentences() {
    const vid = document.getElementById('adm_h_v').value;
    const sec = document.getElementById('adm_h_s').value;
    if (!vid || !sec) { fillSelect('adm_h_target', [], false); adminHintLoadText(); return; }
    const arr = data.content[`${vid}_s${sec}`] || [];
    const items = arr.map((s, i) => ({ v: getSrsKey(vid, sec, i), t: `${i}: ${(s.tr || s.de || '').substring(0, 50)}...` }));
    fillSelect('adm_h_target', items, false);
    adminHintLoadText();
}
function adminHintLoadText() {
    const type = document.getElementById('adm_h_type').value;
    const targetEl = document.getElementById('adm_h_target');
    if (!targetEl) { document.getElementById('adm_h_text').value = ''; return; }
    const key = targetEl.value;
    if (!key) { document.getElementById('adm_h_text').value = ''; return; }
    let hint = '';
    if (type === 'section' && data.hints && data.hints.sections) { 
        hint = data.hints.sections[key] || '';
    } else if (type === 'verb' && data.hints && data.hints.verbs) {
        hint = data.hints.verbs[key] || '';
    } else if (type === 'sentence' && data.hints && data.hints.sentences) {
        hint = data.hints.sentences[key] || '';
    }
    document.getElementById('adm_h_text').value = hint;
}
function adminSaveHint() {
    const type = document.getElementById('adm_h_type').value;
    const targetEl = document.getElementById('adm_h_target');
    if (!targetEl) { alert('Hedef seÃ§in'); return; }
    const key = targetEl.value;
    const text = document.getElementById('adm_h_text').value.trim();
    if (!type || !key) { alert('LÃ¼tfen tip ve hedef seÃ§in'); return; }
    if (!data.hints) data.hints = {sentences:{}, verbs:{}, sections:{}}; 
    if (type === 'section') {
        if (!data.hints.sections) data.hints.sections = {};
        if (text) data.hints.sections[key] = text;
        else delete data.hints.sections[key];
    } else if (type === 'verb') {
        if (!data.hints.verbs) data.hints.verbs = {};
        if (text) data.hints.verbs[key] = text;
        else delete data.hints.verbs[key];
    } else if (type === 'sentence') {
        if (!data.hints.sentences) data.hints.sentences = {};
        if (text) data.hints.sentences[key] = text;
        else delete data.hints.sentences[key];
    }
    if (!text) { alert('Ä°pucu metni boÅŸ olduÄŸu iÃ§in silindi.'); }
    else { alert('Ä°pucu kaydedildi.'); }
    saveContentOverride();
}
function showAdminSentenceForm(area) {
    const t = getMergedTranslations(data.settings.language || 'tr');
    area.innerHTML = `<div class="content-box"><h4>${t.admin.editSentence}</h4>
      <label>${t.labels.group}</label><select id="adm_es_group" class="select-field"></select>
      <label>${t.labels.verb}</label><select id="adm_es_verb" class="select-field"></select>
      <label>${t.labels.section}</label><select id="adm_es_section" class="select-field"></select>
      <label>${t.labels.sentence}</label><select id="adm_es_sentence" class="select-field"></select>
      <label>${t.labels.tr}</label><textarea id="adm_es_tr" class="textarea-field" rows="3"></textarea>
      <label>${t.labels.de}</label><textarea id="adm_es_de" class="textarea-field" rows="3"></textarea>
      <div class="button-group-row">
        <button class="btn btn-primary" onclick="adminSaveEditedSentence()">âœ… ${t.buttons.update}</button>
        <button class="btn btn-info" onclick="adminAddNewSentence()">â• ${t.buttons.add}</button>
        <button class="btn btn-danger" onclick="adminDeleteSentence()">ğŸ—‘ ${t.buttons.delete}</button>
      </div></div>`;
    fillSelect('adm_es_group', data.groups.map(g => ({ v: g.id, t: g.name })), true);
    document.getElementById('adm_es_group').onchange = admin_es_loadVerbs;
    document.getElementById('adm_es_verb').onchange = admin_es_loadSections;
    document.getElementById('adm_es_section').onchange = admin_es_loadSentences;
    document.getElementById('adm_es_sentence').onchange = admin_es_loadSentenceFields;
    if (data.groups.length > 0) {
        document.getElementById('adm_es_group').selectedIndex = 1;
        admin_es_loadVerbs();
    }
}
function fillSelect(id, items, addEmpty) {
    const s = document.getElementById(id); s.innerHTML = '';
    if (addEmpty) { const o = document.createElement('option'); o.value = ''; o.textContent = 'SeÃ§in...'; s.appendChild(o); }
    items.forEach(it => { const o = document.createElement('option'); o.value = it.v; o.textContent = it.t; s.appendChild(o); });
}
function admin_es_loadVerbs() {
    const gid = document.getElementById('adm_es_group').value;
    fillSelect('adm_es_verb', (data.verbs[gid] || []).map(v => ({ v: v.id, t: (v.verbTR || v.verbDE) })), true);
    admin_es_loadSections();
}
function admin_es_loadSections() {
    const verbId = document.getElementById('adm_es_verb').value;
    const items = Object.entries(data.sections).map(([num, name]) => {
        const count = (data.content[`${verbId}_s${num}`] || []).length;
        return { v: num, t: `${num}. ${name} (${count} cÃ¼mle)` };
    });
    fillSelect('adm_es_section', items, true);
    admin_es_loadSentences();
}
function admin_es_loadSentences() {
    const verbId = document.getElementById('adm_es_verb').value;
    const section = document.getElementById('adm_es_section').value;
    const arr = data.content[`${verbId}_s${section}`] || [];
    fillSelect('adm_es_sentence', arr.map((s, i) => ({ v: i, t: (s.tr || s.de || '').substring(0, 80) })), true);
    admin_es_loadSentenceFields();
}
function admin_es_loadSentenceFields() {
    const verbId = document.getElementById('adm_es_verb').value;
    const section = document.getElementById('adm_es_section').value;
    const idx = document.getElementById('adm_es_sentence').value;
    const trEl = document.getElementById('adm_es_tr');
    const deEl = document.getElementById('adm_es_de');
    if (!verbId || !section || idx === '') {
        trEl.value = ''; deEl.value = ''; return;
    }
    const s = (data.content[`${verbId}_s${section}`] || [])[idx];
    if (s) { trEl.value = s.tr || ''; deEl.value = s.de || ''; }
}
function adminSaveEditedSentence() {
    const verbId = document.getElementById('adm_es_verb').value;
    const section = document.getElementById('adm_es_section').value;
    const idx = document.getElementById('adm_es_sentence').value;
    const tr = document.getElementById('adm_es_tr').value.trim();
    const de = document.getElementById('adm_es_de').value.trim();
    if (!verbId || !section || idx === '') { alert('SeÃ§im yapÄ±n'); return; }
    const arr = data.content[`${verbId}_s${section}`] || [];
    arr[idx] = { tr, de };
    data.content[`${verbId}_s${section}`] = arr;
    alert('CÃ¼mle gÃ¼ncellendi');
    saveContentOverride();
    admin_es_loadSentences();
}
function adminAddNewSentence() {
    const verbId = document.getElementById('adm_es_verb').value;
    const section = document.getElementById('adm_es_section').value;
    const tr = document.getElementById('adm_es_tr').value.trim();
    const de = document.getElementById('adm_es_de').value.trim();
    if (!verbId || !section || (!tr && !de)) { alert('Fiil, BÃ¶lÃ¼m ve TR/DE gerekli'); return; }
    const key = `${verbId}_s${section}`;
    if (!data.content[key]) data.content[key] = [];
    data.content[key].push({ tr, de });
    alert('Yeni cÃ¼mle eklendi');
    saveContentOverride();
    admin_es_loadSections();
}
function adminDeleteSentence() {
    const verbId = document.getElementById('adm_es_verb').value;
    const section = document.getElementById('adm_es_section').value;
    const idx = parseInt(document.getElementById('adm_es_sentence').value);
    if (!verbId || !section || isNaN(idx)) { alert('Silmek iÃ§in cÃ¼mle seÃ§in'); return; }
    if (!confirm(`${idx + 1}. cÃ¼mleyi silmek istediÄŸinizden emin misiniz?`)) return;
    const key = `${verbId}_s${section}`;
    if (data.content[key] && data.content[key][idx]) {
        data.content[key].splice(idx, 1);
        alert('CÃ¼mle silindi');
        saveContentOverride();
        admin_es_loadSections();
    }
}
function renderAllSentencesTable(){
  const container = document.getElementById('allSentencesTable');
  const t = getMergedTranslations(data.settings.language || 'tr');
  let html = `<table style="width:100%; border-collapse: collapse;"><thead><tr style="text-align:left; background: #eee;">
    <th style="padding: 6px;">${t.labels.group}</th><th>${t.labels.verb}</th><th>${t.labels.section}</th>
    <th>${t.labels.index}</th><th>${t.labels.tr}</th><th>${t.labels.de}</th></tr></thead><tbody>`;
  let groupMap = {};
  (data.groups || []).forEach(g => {
      (data.verbs[g.id] || []).forEach(v => {
          groupMap[v.id] = { groupName: g.name, verbName: (v.verbTR || v.verbDE) };
      });
  });
  Object.entries(data.content||{}).forEach(([key,arr])=>{
    const m = key.match(/^(.+)_s(\d+)$/);
    if(!m) return;
    const vid = m[1]; const sec = m[2];
    const info = groupMap[vid] || { groupName: '?', verbName: vid };
    (arr||[]).forEach((s,i)=>{
      html += `<tr style="border-bottom: 1px solid #eee;"><td style="padding: 4px;">${escapeHtml(info.groupName)}</td><td>${escapeHtml(info.verbName)}</td><td>${escapeHtml(data.sections[sec]||sec)}</td>
        <td>${i}</td><td>${escapeHtml(s.tr||'')}</td><td>${escapeHtml(s.de||'')}</td></tr>`;
    });
  });
  html += '</tbody></table>';
  container.innerHTML = html;
}
function exportSentencesCsv(){
  console.log("TSV DÄ±ÅŸa Aktarma BaÅŸlatÄ±lÄ±yor...");
  const t = getMergedTranslations(data.settings.language || 'tr');
  let rows = [['GrupID','FiilID','BÃ¶lÃ¼mNumarasÄ±','TR','DE','CÃ¼mleIpucu']];
  const verbToGroupMap = new Map();
  Object.entries(data.verbs).forEach(([gid, verbList]) => {
      (verbList || []).forEach(v => {
          verbToGroupMap.set(v.id, gid);
      });
  });
  Object.entries(data.content||{}).forEach(([key,arr])=>{
    const m = key.match(/^(.+)_s(\d+)$/);
    if(!m) return;
    const vid = m[1];
    const sec = m[2];
    const gid = verbToGroupMap.get(vid) || '?';
    (arr||[]).forEach((s,i)=>{
      const hintKey = getSrsKey(vid, sec, i); 
      const hint = (data.hints && data.hints.sentences && data.hints.sentences[hintKey]) || '';
      rows.push([gid, vid, sec, s.tr||'', s.de||'', hint]);
    });
  });
  console.log(`${rows.length - 1} cÃ¼mle bulundu. TSV oluÅŸturuluyor...`);
  const tsv = rows.map(r => r.join('\t')).join('\n');
  const blob = new Blob([tsv],{type:'text/tab-separated-values;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'sentences_backup.tsv';
  a.click();
  URL.revokeObjectURL(url);
  alert('TSV (Excel) formatÄ±nda yedek indirildi. Bu dosyayÄ± kopyalayÄ±p Toplu YÃ¼klemeye yapÄ±ÅŸtÄ±rabilirsiniz.');
}

/* ---------- Uygulama GÃ¼ncelleme ---------- */
function forceUpdateApp() {
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.getRegistrations().then(registrations => {
            const unregisterPromises = registrations.map(reg => reg.unregister());
            const deleteCachePromises = window.caches ? caches.keys().then(keys => {
                return Promise.all(keys.map(key => caches.delete(key)));
            }) : Promise.resolve();
            Promise.all([].concat(unregisterPromises, [deleteCachePromises]))
                .then(() => {
                    alert('âœ… GÃ¼ncelleme tamamlandÄ±. Uygulama yeniden yÃ¼klenecek.');
                    window.location.reload(true);
                });
        }).catch(err => {
            alert('GÃ¼ncelleme hatasÄ±: ' + err.message);
            window.location.reload(true);
        });
    } else {
        window.location.reload(true);
    }
}

/* ---------- Utils ---------- */
function escapeHtml(t){ if(t===undefined||t===null) return ''; return String(t).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
function isObject(item) { return (item && typeof item === 'object' && !Array.isArray(item)); }
function deepMerge(target, source) {
  let output = Object.assign({}, target);
  if (isObject(target) && isObject(source)) {
    Object.keys(source).forEach(key => {
      if (isObject(source[key])) {
        if (!(key in target)) Object.assign(output, { [key]: source[key] });
        else output[key] = deepMerge(target[key], source[key]);
      } else {
        Object.assign(output, { [key]: source[key] });
      }
    });
  }
  return output;
}
/* --- YENÄ°: Basit Markdown Ä°ÅŸleyici Fonksiyonu (KÄ±lavuz Ä°Ã§in) --- */
function processGuideMarkdown(text) {
    if (!text) return '';
    let processedText = text;
    
    // 1. **Bold** -> <b>bold</b>
    processedText = processedText.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>');

    // 2. Basit Liste Ä°ÅŸleyici (* veya - ile baÅŸlayan satÄ±rlar)
    let listRegex = /^\s*(\*|-)\s+(.*)/gm;
    let listOpen = false;
    processedText = processedText.split('\n').map(line => {
        if (listRegex.test(line)) {
            let item = line.replace(listRegex, '<li>$2</li>');
            if (!listOpen) {
                listOpen = true;
                return '<ul>' + item;
            }
            return item;
        } else {
            if (listOpen) {
                listOpen = false;
                return '</ul>' + line;
            }
            return line;
        }
    }).join('\n');
    
    if (listOpen) {
        processedText += '</ul>';
    }

    // 3. Ä°ki boÅŸ satÄ±rÄ± paragraflara (<p>) Ã§evir
    processedText = processedText.replace(/\n\n/g, '</p><p>');
    // Geri kalan tek satÄ±r atlamalarÄ±nÄ± <br> yap
    processedText = processedText.replace(/\n/g, '<br>');
    
    // Sonucu <p> etiketine sar
    if (processedText.trim().length > 0) {
        processedText = '<p>' + processedText + '</p>';
    }
    
    return processedText;
}
/* --- YENÄ°: Basit Markdown Ä°ÅŸleyici Fonksiyonu (KÄ±lavuz Ä°Ã§in) --- */
function processGuideMarkdown(text) {
    if (!text) return '';
    let processedText = text;
    
    // 1. HTML kodunu temizle (gÃ¼venlik)
    processedText = escapeHtml(processedText);

    // 2. **Bold** -> <b>bold</b>
    processedText = processedText.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>');

    // 3. Basit Liste Ä°ÅŸleyici (* veya - ile baÅŸlayan satÄ±rlar)
    let listRegex = /^\s*(\*|-)\s+(.*)/gm;
    let listOpen = false;
    processedText = processedText.split('\n').map(line => {
        if (listRegex.test(line)) {
            let item = line.replace(listRegex, '<li>$2</li>');
            if (!listOpen) {
                listOpen = true;
                return '<ul>' + item;
            }
            return item;
        } else {
            if (listOpen) {
                listOpen = false;
                return '</ul>' + line;
            }
            return line;
        }
    }).join('\n');
    
    if (listOpen) {
        processedText += '</ul>';
    }

    // 4. Ä°ki boÅŸ satÄ±rÄ± paragraflara (<p>) Ã§evir
    processedText = processedText.replace(/\n\n/g, '</p><p>');
    // Geri kalan tek satÄ±r atlamalarÄ±nÄ± <br> yap
    processedText = processedText.replace(/\n/g, '<br>');
    
    // 5. Sonucu <p> etiketine sar
    if (processedText.trim().length > 0) {
        processedText = '<p>' + processedText + '</p>';
    }
    
    return processedText;
}
/* ---------- BaÅŸlatma (Init v4.0) ---------- */
async function init(){
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('service-worker.js').then(reg => {
      console.log('SW kaydÄ± baÅŸarÄ±lÄ±: ', reg.scope);
    }, err => {
      console.log('SW kaydÄ± baÅŸarÄ±sÄ±z: ', err);
    });
  }
  if ('speechSynthesis' in window) {
    if (navigator.userAgent.match(/iPad|iPhone|iPod/i) || (navigator.userAgent.match(/Safari/i) && !navigator.userAgent.match(/Chrome/i))) {
        window.speechSynthesis.onvoiceschanged = () => console.log("TTS Sesleri yÃ¼klendi (init).");
    }
    window.speechSynthesis.getVoices(); 
  }
  document.getElementById('modeToggleBtn').addEventListener('click', toggleNightMode);
  document.getElementById('nightModeToggle').addEventListener('change', toggleNightMode);
  document.getElementById('fileInput').onchange = importDataFromFile;
  document.getElementById('progressFileInput').onchange = importSrsData;

  musicPlayer = new MusicPlayer(
      './telifsiz-klasik.mp3',
      'musicVolumeSlider',
      'musicToggleBtn',
      'settingsMusicVolume',
      'settingsMusicToggle'
  );
  loadSettings();
  await loadDataFromServer();
  loadSrsData();
  updateConversionButtons();
  updateUITexts();
  updateProgressView();
  console.log('Verb Matrix v4.0 (Nihai SÃ¼rÃ¼m) hazÄ±r.');
  showView('mainMenu');
}

window.addEventListener('DOMContentLoaded', init);

</script>
</body>
</html>
