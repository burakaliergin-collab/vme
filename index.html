<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Verb Matrix ‚Äî v4.0 (Geli≈ümi≈ü Kƒ±lavuz ve Navigasyon)</title>

<link rel="icon" href="favicon.ico" type="image/x-icon">

<link rel="manifest" href="manifest.json"> 

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#667eea">

<style>
/* ###########################################
#       B√ñL√úM 1: CSS STƒ∞LLERƒ∞ BURAYA      #
###########################################
*/
/* --- BURAYA B√ñL√úM 2'deki CSS KODU GELECEK --- */
/* --- Genel --- */
  *{box-sizing:border-box;margin:0;padding:0}
  /* Mobil uyumluluƒüu garantilemek i√ßin min-width: 100% eklendi */
  body{font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); min-height:100vh;padding:18px; transition: background .25s,color .25s; min-width: 100%;}
  .container{max-width:1200px;margin:0 auto;background:#fff;border-radius:16px;padding:28px;box-shadow:0 18px 50px rgba(0,0,0,.18);transition:background .25s,color .25s}
  header{text-align:center;margin-bottom:18px}
  .subtitle{color:#6b7280;margin-top:6px}

  /* B√∂l√ºm Ba≈ülƒ±ƒüƒ± */
  .section-title{font-size:1.25rem;color:#2d3748;margin:16px 0 10px;padding-bottom:8px;border-bottom:3px solid #667eea;font-weight:700}

  /* MODU SE√á i√ßin b√ºy√ºk, ortalanmƒ±≈ü stil */
  .large-centered-title {
    text-align: center;
    font-size: 2.5rem;
    color: #2d3748;
    font-weight: 800;
    margin: 24px 0;
    text-transform: uppercase;
  }

  .button-grid{display:grid;gap:12px;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));margin:12px 0}

  /* YENƒ∞: Ana Men√º Grid (2x2 veya mobil i√ßin 1x4) */
  #mainMenu .button-grid {
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 12px;
  }
  #mainMenu .btn {
    font-size: 1.1rem;
    padding: 16px 14px;
    height: 70px;
    justify-content: center;
  }

  /* GRUP SE√áƒ∞M BA≈ûLIKLARI */
  .group-select-header { text-align: center; margin-bottom: 24px; padding-top: 18px; }
  .group-select-header h2 { font-size: 2.5rem; color: #2d3748; font-weight: 800; letter-spacing: 2px; margin-bottom: 18px; }
  .group-select-columns { display: flex; justify-content: space-between; margin-bottom: 12px; }
  .group-column-title { font-size: 1.4rem; color: #2d3748; font-weight: 700; display: inline-block; padding: 0 10px 8px; border-bottom: 3px solid #667eea; }

  /* --- GRUP/Hƒ∞KAYE BUTONU (V4.0 D√úZELTMESƒ∞) --- */
  .group-story-grid { 
      display: grid; 
      gap: 12px; 
      grid-template-columns: 1fr 1fr; 
  }
  .group-story-grid .btn { 
      justify-content: center; 
      text-align: center; 
      flex-direction: column; 
      min-height: 85px; /* Butonlara dikeyde daha fazla alan */
      height: auto; 
  }
  .group-story-grid .btn strong {
      margin-bottom: 2px;
      font-size: 1.1rem;
  }
  .group-story-grid .btn .small-muted {
      line-height: 1.1; 
  }
  /* --- GENEL BUTON STƒ∞LLERƒ∞ (Metalik/Parlak v3.0) --- */
  .btn{
    padding:10px 14px;
    border-radius:10px;
    font-weight:700;
    cursor:pointer;
    color:#fff;
    text-align: left;
    display:flex;
    align-items:center;
    transition: all .15s ease; 
    border-width: 1px;
    border-style: solid;
    box-shadow: 0 2px 4px rgba(0,0,0,0.15), inset 0 1px 1px rgba(255,255,255,0.3);
    text-shadow: 0 1px 1px rgba(0,0,0,0.2);
  }
  .btn:active {
    transform: translateY(1px);
    box-shadow: 0 1px 2px rgba(0,0,0,0.2), inset 0 1px 1px rgba(0,0,0,0.1);
  }

  .btn-small{padding:8px 10px;font-size:.9rem}

  /* RENKLER (Gradient ile g√ºncellendi) */
  .btn-danger {
    background: linear-gradient(to bottom, #f87171 0%, #f56565 100%);
    border-color: #e53e3e;
  }
  .btn-danger:hover {
    background: linear-gradient(to bottom, #f56565 0%, #e53e3e 100%);
  }

  .btn-primary {
    background: linear-gradient(to bottom, #7a8efb 0%, #667eea 100%);
    border-color: #5a6ed0;
  }
  .btn-primary:hover {
    background: linear-gradient(to bottom, #667eea 0%, #5a6ed0 100%);
  }

  .btn-secondary {
    background: linear-gradient(to bottom, #cacedb 0%, #aeb4c5 100%);
    color: #1e293b;
    border-color: #949daf;
    text-shadow: 0 1px 0 rgba(255,255,255,0.3);
  }
  .btn-secondary:hover {
    background: linear-gradient(to bottom, #aeb4c5 0%, #949daf 100%);
  }

  .btn-info {
    background: linear-gradient(to bottom, #4fd1c5 0%, #38b2ac 100%);
    border-color: #319795;
  }
  .btn-info:hover {
    background: linear-gradient(to bottom, #38b2ac 0%, #319795 100%);
  }

  .btn-warning {
    background: linear-gradient(to bottom, #fbd38d 0%, #ecc94b 100%);
    color: #1e293b;
    border-color: #d69e2e;
    text-shadow: 0 1px 0 rgba(255,255,255,0.2);
  }
  .btn-warning:hover {
    background: linear-gradient(to bottom, #ecc94b 0%, #d69e2e 100%);
  }

  /* YENƒ∞: SRS Tekrar Butonlarƒ± (Metalik/Parlak) */
  .btn-srs-zor {
    background: linear-gradient(to bottom, #f87171 0%, #f56565 100%);
    border-color: #e53e3e;
  }
  .btn-srs-zor:hover {
    background: linear-gradient(to bottom, #f56565 0%, #e53e3e 100%);
  }

  .btn-srs-normal {
    background: linear-gradient(to bottom, #fbd38d 0%, #ecc94b 100%);
    color: #1e293b;
    border-color: #d69e2e;
    text-shadow: 0 1px 0 rgba(255,255,255,0.2);
  }
  .btn-srs-normal:hover {
    background: linear-gradient(to bottom, #ecc94b 0%, #d69e2e 100%);
  }

  .btn-srs-ogrendim {
    background: linear-gradient(to bottom, #68d391 0%, #48bb78 100%);
    border-color: #38a169;
  }
  .btn-srs-ogrendim:hover {
    background: linear-gradient(to bottom, #48bb78 0%, #38a169 100%);
  }
  
  /* YENƒ∞: AI ƒ∞pucu Buton Rengi */
  .btn-ai {
    background: linear-gradient(to bottom, #6366f1 0%, #4f46e5 100%); /* ƒ∞ndigo Mavisi */
    border-color: #4338ca;
  }
  .btn-ai:hover {
    background: linear-gradient(to bottom, #4f46e5 0%, #4338ca 100%);
  }
  body.night-mode .btn-ai { 
    background: #4f46e5;
    border-color: #6366f1;
  }
  body.night-mode .btn-ai:hover { 
    background: #6366f1;
  }


  /* √áalƒ±≈üma Sayfasƒ± Buton Gridi */
  .button-grid-learning {
      display: grid;
      gap: 8px;
      grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
      margin-top: 15px;
  }
  /* Buton metninin ortalanmasƒ± i√ßin ayar (LED eklendiƒüi i√ßin) */
  .button-grid-learning .btn {
      min-width: 130px;
      padding: 10px 8px;
      font-size: 0.9rem;
      font-weight: 700;
      justify-content: center; /* Metni ve LED'i ortala */
      background: #aeb4c5; /* Pastel Gri/Mavi */
      color: #1e293b;
  }
  .button-grid-learning .btn:hover { background: #949daf; }
  .button-grid-learning .btn-danger { background: #f56565; color: #fff; } /* Kƒ±rmƒ±zƒ± kalacak */
  .button-grid-learning .btn-danger:hover { background: #e53e3e; }


  .btn.disabled, .btn:disabled{background:#cbd5e1;color:#718096;cursor:not-allowed;opacity:0.7}

  .hidden { display: none; }

  .view{display:none}
  .view.active{display:block;animation:slideIn .18s ease}
  @keyframes slideIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}

  .button-group-row { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 12px; }
  .button-group-row .btn { justify-content: center; } /* Geri/Ana Men√º butonlarƒ± */
  
  /* YENƒ∞: √áeviri Butonu Grubu Ortalama */
  #modeMenu .button-group-row, 
  #tekrarModeMenu .button-group-row {
      justify-content: center; 
  }

  .button-grid .btn { justify-content: center; }


  /* YENƒ∞: LED G√∂sterge Stilleri */
  .led-indicator {
    display: inline-block;
    width: 11px;
    height: 11px;
    border-radius: 50%;
    background-color: #555; /* Varsayƒ±lan: S√∂n√ºk */
    border: 1px solid #333;
    margin-right: 7px;
    vertical-align: middle;
    transition: background-color 0.2s, box-shadow 0.2s;
    flex-shrink: 0;
  }
  .led-indicator.active {
    background-color: #39e75f; /* Aktif: Ye≈üil */
    box-shadow: 0 0 6px #39e75f, 0 0 3px rgba(255,255,255,0.5) inset;
    border-color: #2b9e44;
  }
  /* Gece Modu LED */
  body.night-mode .led-indicator { background-color: #333; border-color: #111; }
  body.night-mode .led-indicator.active { background-color: #39e75f; box-shadow: 0 0 8px #39e75f; border-color: #2b9e44; }
  /* --- LED Biti≈ü --- */
  
  /* YENƒ∞: √áeviri Butonlarƒ±nƒ± B√ºy√ºtme */
  .conversion-btn {
      font-size: 1.3rem !important; 
      padding: 16px 20px !important; 
      min-width: 250px; 
      height: 70px;
      display: flex;
      align-items: center;
      justify-content: center; 
      text-align: center;
  }

  /* YENƒ∞: SRS Kontrol Butonlarƒ± (3'l√º) */
  #srsControls {
      display: none;
      justify-content: space-around;
      margin-top: 15px;
      gap: 10px;
  }
  #srsControls .btn {
      flex: 1;
      margin: 0;
      justify-content: center; /* SRS butonlarƒ± ortalƒ± */
      font-size: 1rem;
      padding: 12px 8px;
  }

  /* --- YENƒ∞: SABƒ∞T NAVƒ∞GASYON BUTONLARI (v4.0) --- */
  .floating-nav-btn {
    position: fixed;
    border-radius: 50%;
    padding: 10px;
    border: 0;
    background: #fff;
    color: #333;
    cursor: pointer;
    box-shadow: 0 10px 28px rgba(0,0,0,.12);
    z-index: 2000; /* KRƒ∞Tƒ∞K D√úZELTME: Her zaman en √ºstte g√∂r√ºn√ºr */
    font-size: 1.4rem;
    line-height: 1;
    width: 48px;
    height: 48px;
    display: none; /* JS ile y√∂netilecek */
  }
  body.night-mode .floating-nav-btn {
    background: #1f2937;
    color: #e6eef8;
  }
  
  /* Sol Alt (Geri) */
  #floatingBackBtn {
    left: 18px;
    bottom: 18px;
  }
  
  /* Saƒü Alt (Ana Men√º) */
  #floatingHomeBtn {
    right: 18px;
    bottom: 18px;
  }
  
  /* Saƒü Alt (Admin) */
  .admin-float-btn {
    right: 18px;
    bottom: 80px; /* Ev butonunun √ºst√ºnde */
  }
  /* Top Right Container, Gece Modu butonu ve Kƒ±lavuz butonu i√ßin konum saƒülar */
  #floatingNavTopRight {
    display: flex; /* ƒ∞√ßindeki butonlarƒ± yan yana hizalar */
    gap: 8px;
  }
  .mode-toggle{
    position: static; /* Fixed konumunu iptal et */
    box-shadow: 0 10px 28px rgba(0,0,0,.12);
  }
  /* --- SABƒ∞T BUTONLAR Bƒ∞Tƒ∞≈û --- */

  .lang-btn{padding:8px 12px;border-radius:8px;border:2px solid #667eea;background:#fff;color:#667eea;cursor:pointer}
  .lang-btn.active{background:#667eea;color:#fff}
  .score-display{font-size:1.6rem;font-weight:800;color:#667eea;text-align:center;margin:12px 0}
  .small-muted{color:#6b7280;font-size:.9rem}
  .toggle-hint-btn{padding:8px 10px;border-radius:8px;border:0;background:#34495e;color:#fff;cursor:pointer}
  .content-box{background:#f9fafb;padding:16px;border-radius:12px;margin:12px 0;border-left:5px solid #667eea}
  .input-field, .textarea-field {width:100%;padding:10px;border-radius:8px;border:2px solid #e5e7eb;margin-top:8px;font-size:1rem;background:#fff;color:#0f1724}
  .select-field{width:100%;padding:10px;border-radius:8px;border:2px solid #e5e7eb;background:#fff;color:#0f1724; margin-top: 8px;}
  .progress-container{margin:12px 0}
  .progress-bar{height:28px;background:#e6eefc;border-radius:14px;overflow:hidden}
  .progress-fill{height:100%;background:linear-gradient(90deg,#667eea,#764ba2);width:0;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:800; transition: width .2s;}

  /* √ñƒürenme i√ßeriƒüi ortalandƒ± ve b√ºy√ºt√ºld√º */
  .sentence{padding:12px;border-radius:8px;background:#fff;border-left:4px solid #667eea;margin:10px 0;font-weight:700;color:#0f1724; text-align: center;}
  #learningContent .sentence { font-size: 1.6rem; line-height: 1.4; }
  #learningContent #answerDisplay.sentence { font-size: 1.3rem; line-height: 1.4; background: #f0f4f8; }

  /* Kelime Sƒ±ralama (WordOrder) Modunda dikey sƒ±ralama */
  .word-order-area { display: flex; flex-direction: column; gap: 12px; flex-wrap: nowrap; justify-content: center; align-items: center; padding: 10px 0; }
  .word-pool, .word-selected { width: 95%; min-width: 95%; text-align: center; border: 1px solid #ddd; border-radius: 8px; padding: 8px; }
  .word-item{display:inline-block;padding:8px 12px;border-radius:8px;background:#667eea;color:#fff;margin:6px;cursor:pointer;user-select:none}
  .word-item.top{background:#10b981}
  .word-item.disabled{background:#cbd5e1;color:#2d3748;cursor:not-allowed}

  .hint-area{margin-top:10px}
  .hint-item{background:#e6f3ff;padding:10px;border-left:4px solid #4299e1;border-radius:8px;margin:8px 0;color:#0f1724}
  .result{padding:10px;border-radius:8px;margin:8px 0;font-weight:700}
  .result.correct{background:#c6f6d5;color:#22543d;border-left:4px solid #48bb78}
  .result.incorrect{background:#fed7d7;color:#742a2a;border-left:4px solid #f56565}

  /* YENƒ∞: ƒ∞lerleme (Progress) Ekranƒ± Stilleri */
  .progress-stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
    gap: 12px;
    text-align: center;
    margin: 20px 0;
  }
  .stat-card {
    background: #f9fafb;
    padding: 20px 15px;
    border-radius: 12px;
  }
  .stat-card h4 {
    font-size: 1.1rem;
    color: #4a5568;
    margin-bottom: 8px;
  }
  .stat-card .stat-value {
    font-size: 2.5rem;
    font-weight: 800;
  }
  .stat-card-zor .stat-value { color: #f56565; }
  .stat-card-normal .stat-value { color: #d69e2e; }
  .stat-card-ogrendim .stat-value { color: #48bb78; }
  
  /* YENƒ∞: KILAVUZ/ƒ∞PUCU DETAY G√ñR√úN√úM√ú STƒ∞Lƒ∞ */
  #detailViewLayer .container {
    max-width: 800px;
    margin: 40px auto;
    background: #fff;
    padding: 30px;
    border-radius: 16px;
    box-shadow: 0 0 20px rgba(0,0,0,0.3);
  }
  #detailViewLayer h2 {
    text-align: center;
    color: #667eea;
    margin-bottom: 20px;
    border-bottom: 3px solid #667eea;
    padding-bottom: 10px;
  }
  #detailViewContent {
    background: #f0f4f8;
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 15px;
    border-left: 5px solid #667eea;
    font-size: 1.1rem;
    line-height: 1.6;
    /* Metninizi bi√ßimlendirmek i√ßin tabloya, listeye ve HTML'e izin verir */
    white-space: normal;
  }
  #detailViewContent table {
      width: 100%;
      margin: 15px 0;
      border-collapse: collapse;
      background: #fff;
  }
  #detailViewContent th, #detailViewContent td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: left;
      font-size: 0.95rem;
  }
  #detailViewContent th {
      background: #e6f3ff;
      font-weight: bold;
  }
  /* Biti≈ü: KILAVUZ/ƒ∞PUCU DETAY G√ñR√úN√úM√ú STƒ∞Lƒ∞ */


  /* --- M√ºzik √áalar Stilleri --- */
  .music-player-container {
    position: fixed;
    left: 18px;
    top: 18px;
    z-index: 1200;
    background: rgba(255, 255, 255, 0.9);
    border-radius: 25px;
    padding: 5px;
    box-shadow: 0 5px 15px rgba(0, 0, 0, .1);
    display: flex;
    align-items: center;
    transition: background .25s;
  }
  .music-toggle-btn {
    border: 0;
    background: #667eea;
    color: #fff;
    border-radius: 50%;
    width: 38px;
    height: 38px;
    font-size: 1.2rem;
    cursor: pointer;
    z-index: 2;
  }
  .music-volume-slider {
    display: none;
    margin-left: 8px;
    margin-right: 10px;
    width: 80px;
    vertical-align: middle;
    z-index: 1;
    transition: opacity 0.3s;
  }
  .music-player-container:hover .music-volume-slider {
    display: inline-block;
  }
  body.night-mode .music-player-container {
    background: rgba(31, 41, 55, 0.9);
  }
  body.night-mode .music-toggle-btn {
    background: #3b82f6;
  }

  /* G√∂ster butonunu ortalamak i√ßin */
  .primary-action-container {
    display: flex;
    justify-content: center;
    margin-top: 15px;
    margin-bottom: 8px;
  }
  .primary-action-container #actionBtn {
    padding: 12px 24px;
    font-size: 1.1rem;
    min-width: 200px;
    justify-content: center;
    text-align: center;
    background: #aeb4c5; /* Pastel Gri/Mavi */
    color: #1e293b;
  }
  .primary-action-container #actionBtn:hover {
    background: #949daf;
  }
  body.night-mode .primary-action-container #actionBtn {
    background: #334155;
    color: #e2eef0;
  }
  body.night-mode .primary-action-container #actionBtn:hover {
    background: #475569;
  }
  
  /* GECE MODU */
  body.night-mode{background:linear-gradient(135deg,#0f1724 0%,#071226 100%);color:#e6eef8}
  body.night-mode .container{background:#071226;color:#e6eef8;box-shadow:none}
  body.night-mode .section-title{border-bottom-color:#3b82f6;color:#e6eef8}
  body.night-mode .large-centered-title{color: #e6eef8;}
  body.night-mode .group-column-title{color: #e6eef8;border-bottom-color: #3b82f6;}
  body.night-mode .content-box{background:#071831;border-left-color:#3b82f6}
  body.night-mode .input-field, .night-mode .textarea-field, .night-mode .select-field{background:#041226;color:#e6eef8;border-color:#082036}
  body.night-mode .sentence{background:#071226;color:#e6eef8;border-left-color:#3b82f6}
  body.night-mode #learningContent #answerDisplay.sentence { background: #0f2742; }
  body.night-mode .word-item{background:#3b82f6;color:#fff}
  body.night-mode .word-item.top{background:#10b981}
  body.night-mode .hint-item{background:#052033;color:#c8ecff;border-left-color:#3b82f6}
  body.night-mode .stat-card { background: #071831; }
  body.night-mode .stat-card h4 { color: #9ca3af; }

  /* GECE MODU RENKLER */
  body.night-mode .btn-primary { background: #3b82f6; }
  body.night-mode .btn-primary:hover { background: #2563eb; }
  body.night-mode .btn-secondary { background: #334155; color: #e2e8f0; }
  body.night-mode .btn-secondary:hover { background: #475569; }
  body.night-mode .btn-info { background: #0d9488; }
  body.night-mode .btn-info:hover { background: #0f766e; }
  body.night-mode .btn-warning { background: #d97706; color: #fff; }
  body.night-mode .btn-warning:hover { background: #b45309; }
  body.night-mode .btn-ai { background: #6366f1; border-color: #4f46e5; }
  body.night-mode .btn-ai:hover { background: #4f46e5; }

  body.night-mode .btn.disabled, body.night-mode .btn:disabled {background:#1f2937;color:#4b5563;}
  body.night-mode .toggle-hint-btn{ background:#1f2937 }
  body.night-mode .group-story-grid .btn .small-muted { color: #9ca3af; }

  body.night-mode .button-grid-learning .btn { background: #334155; color: #e2e8f0; }
  body.night-mode .button-grid-learning .btn:hover { background: #475569; }
  body.night-mode .button-grid-learning .btn-danger { background: #f56565; color: #fff; }
  
  body.night-mode #detailViewLayer .container {
      background: #071226;
      color: #e6eef8;
      box-shadow: none;
  }
  body.night-mode #detailViewLayer h2 {
      color: #3b82f6;
      border-bottom-color: #3b82f6;
  }
  body.night-mode #detailViewContent {
      background: #0f2742;
      border-left-color: #3b82f6;
      color: #e6eef8;
  }
  body.night-mode #detailViewContent th {
      background: #071831;
      color: #e6eef8;
      border-color: #334155;
  }
  body.night-mode #detailViewContent td {
      border-color: #334155;
  }

  /* MOBƒ∞L Cƒ∞HAZ G√ñR√úN√úM D√úZELTMESƒ∞ (Kesin √á√∂z√ºm) */
  @media(max-width:768px){
    .container{padding:14px}
    /* T√úM BUTTON-GRID'LERƒ∞ MOBƒ∞LDE TEK S√úTUNA √áEVƒ∞R VE GENƒ∞≈ûLET */
    .button-grid, 
    #mainMenu .button-grid, 
    .button-grid-learning,
    .group-story-grid { /* Grup/Hikaye butonlarƒ± da alt alta gelsin */
        grid-template-columns: 1fr !important; /* Tek s√ºtun ve tam geni≈ülik */
    } 
    #mainMenu .btn { 
        height: auto; 
        padding: 16px; 
        font-size: 1.2rem; /* Butonlarƒ± biraz b√ºy√ºtelim */
    }
    .conversion-btn {
        min-width: 100% !important; /* √áeviri butonlarƒ±nƒ±n mobil ekranƒ± doldurmasƒ± */
        padding: 18px 10px !important; 
    }
    #floatingNavTopRight, #floatingBackBtn, #floatingHomeBtn, #floatingAdminBtn {
        transform: scale(0.85); /* Mobil ekranda y√ºzen butonlarƒ± biraz k√º√ß√ºlt */
    }
  }
/* --- Genel --- */
  *{box-sizing:border-box;margin:0;padding:0}
  body{font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); min-height:100vh;padding:18px; transition: background .25s,color .25s; min-width: 100%;}
  .container{max-width:1200px;margin:0 auto;background:#fff;border-radius:16px;padding:28px;box-shadow:0 18px 50px rgba(0,0,0,.18);transition:background .25s,color .25s}
  header{text-align:center;margin-bottom:18px}
  .subtitle{color:#6b7280;margin-top:6px}
  .section-title{font-size:1.25rem;color:#2d3748;margin:16px 0 10px;padding-bottom:8px;border-bottom:3px solid #667eea;font-weight:700}
  .large-centered-title { text-align: center; font-size: 2.5rem; color: #2d3748; font-weight: 800; margin: 24px 0; text-transform: uppercase; }
  .button-grid{display:grid;gap:12px;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));margin:12px 0}
  #mainMenu .button-grid { grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 12px; }
  #mainMenu .btn { font-size: 1.1rem; padding: 16px 14px; height: 70px; justify-content: center; }
  .group-select-header { text-align: center; margin-bottom: 24px; padding-top: 18px; }
  .group-select-header h2 { font-size: 2.5rem; color: #2d3748; font-weight: 800; letter-spacing: 2px; margin-bottom: 18px; }
  .group-select-columns { display: flex; justify-content: space-between; margin-bottom: 12px; }
  .group-column-title { font-size: 1.4rem; color: #2d3748; font-weight: 700; display: inline-block; padding: 0 10px 8px; border-bottom: 3px solid #667eea; }
  .group-story-grid { display: grid; gap: 12px; grid-template-columns: 1fr 1fr; }
  .group-story-grid .btn { justify-content: center; text-align: center; flex-direction: column; min-height: 85px; height: auto; }
  .group-story-grid .btn strong { margin-bottom: 2px; font-size: 1.1rem; }
  .group-story-grid .btn .small-muted { line-height: 1.1; }
  .btn{ padding:10px 14px; border-radius:10px; font-weight:700; cursor:pointer; color:#fff; text-align: left; display:flex; align-items:center; transition: all .15s ease; border-width: 1px; border-style: solid; box-shadow: 0 2px 4px rgba(0,0,0,0.15), inset 0 1px 1px rgba(255,255,255,0.3); text-shadow: 0 1px 1px rgba(0,0,0,0.2); }
  .btn:active { transform: translateY(1px); box-shadow: 0 1px 2px rgba(0,0,0,0.2), inset 0 1px 1px rgba(0,0,0,0.1); }
  .btn-small{padding:8px 10px;font-size:.9rem}
  .btn-danger { background: linear-gradient(to bottom, #f87171 0%, #f56565 100%); border-color: #e53e3e; }
  .btn-danger:hover { background: linear-gradient(to bottom, #f56565 0%, #e53e3e 100%); }
  .btn-primary { background: linear-gradient(to bottom, #7a8efb 0%, #667eea 100%); border-color: #5a6ed0; }
  .btn-primary:hover { background: linear-gradient(to bottom, #667eea 0%, #5a6ed0 100%); }
  .btn-secondary { background: linear-gradient(to bottom, #cacedb 0%, #aeb4c5 100%); color: #1e293b; border-color: #949daf; text-shadow: 0 1px 0 rgba(255,255,255,0.3); }
  .btn-secondary:hover { background: linear-gradient(to bottom, #aeb4c5 0%, #949daf 100%); }
  .btn-info { background: linear-gradient(to bottom, #4fd1c5 0%, #38b2ac 100%); border-color: #319795; }
  .btn-info:hover { background: linear-gradient(to bottom, #38b2ac 0%, #319795 100%); }
  .btn-warning { background: linear-gradient(to bottom, #fbd38d 0%, #ecc94b 100%); color: #1e293b; border-color: #d69e2e; text-shadow: 0 1px 0 rgba(255,255,255,0.2); }
  .btn-warning:hover { background: linear-gradient(to bottom, #ecc94b 0%, #d69e2e 100%); }
  .btn-srs-zor { background: linear-gradient(to bottom, #f87171 0%, #f56565 100%); border-color: #e53e3e; }
  .btn-srs-zor:hover { background: linear-gradient(to bottom, #f56565 0%, #e53e3e 100%); }
  .btn-srs-normal { background: linear-gradient(to bottom, #fbd38d 0%, #ecc94b 100%); color: #1e293b; border-color: #d69e2e; text-shadow: 0 1px 0 rgba(255,255,255,0.2); }
  .btn-srs-normal:hover { background: linear-gradient(to bottom, #ecc94b 0%, #d69e2e 100%); }
  .btn-srs-ogrendim { background: linear-gradient(to bottom, #68d391 0%, #48bb78 100%); border-color: #38a169; }
  .btn-srs-ogrendim:hover { background: linear-gradient(to bottom, #48bb78 0%, #38a169 100%); }
  .btn-ai { background: linear-gradient(to bottom, #6366f1 0%, #4f46e5 100%); border-color: #4338ca; }
  .btn-ai:hover { background: linear-gradient(to bottom, #4f46e5 0%, #4338ca 100%); }
  body.night-mode .btn-ai { background: #4f46e5; border-color: #6366f1; }
  body.night-mode .btn-ai:hover { background: #6366f1; }
  .button-grid-learning { display: grid; gap: 8px; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); margin-top: 15px; }
  .button-grid-learning .btn { min-width: 130px; padding: 10px 8px; font-size: 0.9rem; font-weight: 700; justify-content: center; background: #aeb4c5; color: #1e293b; }
  .button-grid-learning .btn:hover { background: #949daf; }
  .button-grid-learning .btn-danger { background: #f56565; color: #fff; }
  .button-grid-learning .btn-danger:hover { background: #e53e3e; }
  .btn.disabled, .btn:disabled{background:#cbd5e1;color:#718096;cursor:not-allowed;opacity:0.7}
  .hidden { display: none; }
  .view{display:none}
  .view.active{display:block;animation:slideIn .18s ease}
  @keyframes slideIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
  .button-group-row { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 12px; }
  .button-group-row .btn { justify-content: center; }
  #modeMenu .button-group-row, #tekrarModeMenu .button-group-row { justify-content: center; }
  .button-grid .btn { justify-content: center; }
  .led-indicator { display: inline-block; width: 11px; height: 11px; border-radius: 50%; background-color: #555; border: 1px solid #333; margin-right: 7px; vertical-align: middle; transition: background-color 0.2s, box-shadow 0.2s; flex-shrink: 0; }
  .led-indicator.active { background-color: #39e75f; box-shadow: 0 0 6px #39e75f, 0 0 3px rgba(255,255,255,0.5) inset; border-color: #2b9e44; }
  body.night-mode .led-indicator { background-color: #333; border-color: #111; }
  body.night-mode .led-indicator.active { background-color: #39e75f; box-shadow: 0 0 8px #39e75f; border-color: #2b9e44; }
  .conversion-btn { font-size: 1.3rem !important; padding: 16px 20px !important; min-width: 250px; height: 70px; display: flex; align-items: center; justify-content: center; text-align: center; }
  #srsControls { display: none; justify-content: space-around; margin-top: 15px; gap: 10px; }
  #srsControls .btn { flex: 1; margin: 0; justify-content: center; font-size: 1rem; padding: 12px 8px; }
  .floating-nav-btn { position: fixed; border-radius: 50%; padding: 10px; border: 0; background: #fff; color: #333; cursor: pointer; box-shadow: 0 10px 28px rgba(0,0,0,.12); z-index: 2000; font-size: 1.4rem; line-height: 1; width: 48px; height: 48px; display: none; }
  body.night-mode .floating-nav-btn { background: #1f2937; color: #e6eef8; }
  #floatingBackBtn { left: 18px; bottom: 18px; }
  #floatingHomeBtn { right: 18px; bottom: 18px; }
  .admin-float-btn { right: 18px; bottom: 80px; }
  #floatingNavTopRight { display: flex; gap: 8px; }
  .mode-toggle{ position: static; box-shadow: 0 10px 28px rgba(0,0,0,.12); }
  .lang-btn{padding:8px 12px;border-radius:8px;border:2px solid #667eea;background:#fff;color:#667eea;cursor:pointer}
  .lang-btn.active{background:#667eea;color:#fff}
  .score-display{font-size:1.6rem;font-weight:800;color:#667eea;text-align:center;margin:12px 0}
  .small-muted{color:#6b7280;font-size:.9rem}
  .toggle-hint-btn{padding:8px 10px;border-radius:8px;border:0;background:#34495e;color:#fff;cursor:pointer}
  .content-box{background:#f9fafb;padding:16px;border-radius:12px;margin:12px 0;border-left:5px solid #667eea}
  .input-field, .textarea-field {width:100%;padding:10px;border-radius:8px;border:2px solid #e5e7eb;margin-top:8px;font-size:1rem;background:#fff;color:#0f1724}
  .select-field{width:100%;padding:10px;border-radius:8px;border:2px solid #e5e7eb;background:#fff;color:#0f1724; margin-top: 8px;}
  .progress-container{margin:12px 0}
  .progress-bar{height:28px;background:#e6eefc;border-radius:14px;overflow:hidden}
  .progress-fill{height:100%;background:linear-gradient(90deg,#667eea,#764ba2);width:0;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:800; transition: width .2s;}
  .sentence{padding:12px;border-radius:8px;background:#fff;border-left:4px solid #667eea;margin:10px 0;font-weight:700;color:#0f1724; text-align: center;}
  #learningContent .sentence { font-size: 1.6rem; line-height: 1.4; }
  #learningContent #answerDisplay.sentence { font-size: 1.3rem; line-height: 1.4; background: #f0f4f8; }
  .word-order-area { display: flex; flex-direction: column; gap: 12px; flex-wrap: nowrap; justify-content: center; align-items: center; padding: 10px 0; }
  .word-pool, .word-selected { width: 95%; min-width: 95%; text-align: center; border: 1px solid #ddd; border-radius: 8px; padding: 8px; }
  .word-item{display:inline-block;padding:8px 12px;border-radius:8px;background:#667eea;color:#fff;margin:6px;cursor:pointer;user-select:none}
  .word-item.top{background:#10b981}
  .word-item.disabled{background:#cbd5e1;color:#2d3748;cursor:not-allowed}
  .hint-area{margin-top:10px}
  .hint-item{background:#e6f3ff;padding:10px;border-left:4px solid #4299e1;border-radius:8px;margin:8px 0;color:#0f1724}
  .result{padding:10px;border-radius:8px;margin:8px 0;font-weight:700}
  .result.correct{background:#c6f6d5;color:#22543d;border-left:4px solid #48bb78}
  .result.incorrect{background:#fed7d7;color:#742a2a;border-left:4px solid #f56565}
  .progress-stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 12px; text-align: center; margin: 20px 0; }
  .stat-card { background: #f9fafb; padding: 20px 15px; border-radius: 12px; }
  .stat-card h4 { font-size: 1.1rem; color: #4a5568; margin-bottom: 8px; }
  .stat-card .stat-value { font-size: 2.5rem; font-weight: 800; }
  .stat-card-zor .stat-value { color: #f56565; }
  .stat-card-normal .stat-value { color: #d69e2e; }
  .stat-card-ogrendim .stat-value { color: #48bb78; }
  #detailViewLayer .container { max-width: 800px; margin: 40px auto; background: #fff; padding: 30px; border-radius: 16px; box-shadow: 0 0 20px rgba(0,0,0,0.3); }
  #detailViewLayer h2 { text-align: center; color: #667eea; margin-bottom: 20px; border-bottom: 3px solid #667eea; padding-bottom: 10px; }
  #detailViewContent { background: #f0f4f8; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 5px solid #667eea; font-size: 1.1rem; line-height: 1.6; white-space: normal; }
  #detailViewContent table { width: 100%; margin: 15px 0; border-collapse: collapse; background: #fff; }
  #detailViewContent th, #detailViewContent td { border: 1px solid #ccc; padding: 8px; text-align: left; font-size: 0.95rem; }
  #detailViewContent th { background: #e6f3ff; font-weight: bold; }
  .music-player-container { position: fixed; left: 18px; top: 18px; z-index: 1200; background: rgba(255, 255, 255, 0.9); border-radius: 25px; padding: 5px; box-shadow: 0 5px 15px rgba(0, 0, 0, .1); display: flex; align-items: center; transition: background .25s; }
  .music-toggle-btn { border: 0; background: #667eea; color: #fff; border-radius: 50%; width: 38px; height: 38px; font-size: 1.2rem; cursor: pointer; z-index: 2; }
  .music-volume-slider { display: none; margin-left: 8px; margin-right: 10px; width: 80px; vertical-align: middle; z-index: 1; transition: opacity 0.3s; }
  .music-player-container:hover .music-volume-slider { display: inline-block; }
  body.night-mode .music-player-container { background: rgba(31, 41, 55, 0.9); }
  body.night-mode .music-toggle-btn { background: #3b82f6; }
  .primary-action-container { display: flex; justify-content: center; margin-top: 15px; margin-bottom: 8px; }
  .primary-action-container #actionBtn { padding: 12px 24px; font-size: 1.1rem; min-width: 200px; justify-content: center; text-align: center; background: #aeb4c5; color: #1e293b; }
  .primary-action-container #actionBtn:hover { background: #949daf; }
  body.night-mode .primary-action-container #actionBtn { background: #334155; color: #e2eef0; }
  body.night-mode .primary-action-container #actionBtn:hover { background: #475569; }
  body.night-mode{background:linear-gradient(135deg,#0f1724 0%,#071226 100%);color:#e6eef8}
  body.night-mode .container{background:#071226;color:#e6eef8;box-shadow:none}
  body.night-mode .section-title{border-bottom-color:#3b82f6;color:#e6eef8}
  body.night-mode .large-centered-title{color: #e6eef8;}
  body.night-mode .group-column-title{color: #e6eef8;border-bottom-color: #3b82f6;}
  body.night-mode .content-box{background:#071831;border-left-color:#3b82f6}
  body.night-mode .input-field, .night-mode .textarea-field, .night-mode .select-field{background:#041226;color:#e6eef8;border-color:#082036}
  body.night-mode .sentence{background:#071226;color:#e6eef8;border-left-color:#3b82f6}
  body.night-mode #learningContent #answerDisplay.sentence { background: #0f2742; }
  body.night-mode .word-item{background:#3b82f6;color:#fff}
  body.night-mode .word-item.top{background:#10b981}
  body.night-mode .hint-item{background:#052033;color:#c8ecff;border-left-color:#3b82f6}
  body.night-mode .stat-card { background: #071831; }
  body.night-mode .stat-card h4 { color: #9ca3af; }
  body.night-mode .btn-primary { background: #3b82f6; }
  body.night-mode .btn-primary:hover { background: #2563eb; }
  body.night-mode .btn-secondary { background: #334155; color: #e2e8f0; }
  body.night-mode .btn-secondary:hover { background: #475569; }
  body.night-mode .btn-info { background: #0d9488; }
  body.night-mode .btn-info:hover { background: #0f766e; }
  body.night-mode .btn-warning { background: #d97706; color: #fff; }
  body.night-mode .btn-warning:hover { background: #b45309; }
  body.night-mode .btn-ai { background: #6366f1; border-color: #4f46e5; }
  body.night-mode .btn-ai:hover { background: #4f46e5; }
  body.night-mode .btn.disabled, body.night-mode .btn:disabled {background:#1f2937;color:#4b5563;}
  body.night-mode .toggle-hint-btn{ background:#1f2937 }
  body.night-mode .group-story-grid .btn .small-muted { color: #9ca3af; }
  body.night-mode .button-grid-learning .btn { background: #334155; color: #e2e8f0; }
  body.night-mode .button-grid-learning .btn:hover { background: #475569; }
  body.night-mode .button-grid-learning .btn-danger { background: #f56565; color: #fff; }
  body.night-mode #detailViewLayer .container { background: #071226; color: #e6eef8; box-shadow: none; }
  body.night-mode #detailViewLayer h2 { color: #3b82f6; border-bottom-color: #3b82f6; }
  body.night-mode #detailViewContent { background: #0f2742; border-left-color: #3b82f6; color: #e6eef8; }
  body.night-mode #detailViewContent th { background: #071831; color: #e6eef8; border-color: #334155; }
  body.night-mode #detailViewContent td { border-color: #334155; }
  @media(max-width:768px){
    .container{padding:14px}
    .button-grid, #mainMenu .button-grid, .button-grid-learning, .group-story-grid { grid-template-columns: 1fr !important; } 
    #mainMenu .btn { height: auto; padding: 16px; font-size: 1.2rem; }
    .conversion-btn { min-width: 100% !important; padding: 18px 10px !important; }
    #floatingNavTopRight, #floatingBackBtn, #floatingHomeBtn, #floatingAdminBtn { transform: scale(0.85); }
  }
</style>
</head>
<body>
<div id="floatingNavTopRight" style="position:fixed; right:18px; top:18px; z-index:10000; display:flex; gap:12px; pointer-events:none;">
    
    <button id="floatingGuideBtn" onclick="showGuide()" style="display:block; width:48px; height:48px; font-size:1.5rem; border-radius:50%; border:none; background:#fff; cursor:pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.15); pointer-events:auto;" title="Kƒ±lavuz">‚≠ê</button>
    
    <button id="modeToggleBtn" onclick="toggleNightMode()" style="width:48px; height:48px; font-size:1.5rem; border-radius:50%; border:none; background:#fff; cursor:pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.15); pointer-events:auto;" title="Gece/G√ºnd√ºz toggle">üåô</button>

</div>
<button id="floatingBackBtn" class="floating-nav-btn" title="Geri" onclick="goBackInHistory()">üîô</button>

<button id="floatingHomeBtn" class="floating-nav-btn" title="Ana Men√º" onclick="showView('mainMenu')">üè†</button>
<button id="floatingAdminBtn" class="admin-float-btn floating-nav-btn" title="Y√∂netici" onclick="showView('adminView')">üîß</button>

<div id="musicPlayerContainer" class="music-player-container">
    <button id="musicToggleBtn" class="music-toggle-btn" title="M√ºzik √áal/Durdur">üîä</button>
    <input type="range" id="musicVolumeSlider" min="0" max="100" value="70" class="music-volume-slider" style="display: none;">
</div>
<div class="container">
  <header>
    <img src="logo.png" alt="Verb Matrix Logo" style="max-width: 280px; height: auto; margin: 10px auto 0; display: block;">
    <div class="subtitle" id="appSubtitle" data-translate-key="app.subtitle">Fiiller ƒ∞le Almanca √ñƒürenme Platformu</div>
  </header>

  <div id="mainMenu" class="view active">
    <div class="button-grid">
      <button class="btn btn-primary" id="btnCalis" data-translate-key="menu.calis" onclick="loadAndShowGroupMenu()">üìö √áalƒ±≈ü</button>
      <button class="btn btn-info" id="btnTekrar" data-translate-key="menu.tekrar" onclick="showView('tekrarMenu')">üîÑ Tekrar</button>
      <button class="btn btn-warning" id="btnProgress" data-translate-key="menu.progress" onclick="showView('progress')">üìä ƒ∞lerleme</button>
      <button class="btn btn-secondary" id="btnSettings" data-translate-key="menu.settings" onclick="showView('settings')">‚öôÔ∏è Ayarlar</button>
    </div>
  </div>

  <div id="tekrarMenu" class="view">
    <h2 class="large-centered-title" data-translate-key="titles.tekrar">üîÑ TEKRAR</h2>
    <div class="button-grid">
      <button class="btn btn-srs-zor" onclick="startTekrar('zor')">
        <span data-translate-key="srs.zorlandiklarim">ZORLANDIKLARIM</span> (<span id="tekrarCountZor">0</span>)
      </button>
      <button class="btn btn-srs-normal" onclick="startTekrar('normal')">
        <span data-translate-key="srs.normal">NORMAL</span> (<span id="tekrarCountNormal">0</span>)
      </button>
      <button class="btn btn-srs-ogrendim" onclick="startTekrar('ogrendim')">
        <span data-translate-key="srs.ogrendiklerim">√ñƒûRENDƒ∞KLERƒ∞M</span> (<span id="tekrarCountOgrenildi">0</span>)
      </button>
    </div>
    <div class="button-group-row">
      <button class="btn btn-danger btn-small" onclick="showView('mainMenu')" data-translate-key="buttons.mainMenu">‚Üê Ana Men√º</button>
    </div>
  </div>

  <div id="tekrarModeMenu" class="view">
    <h2 class="large-centered-title" id="tekrarModeTitle">TEKRAR MODU</h2>

    <div class="content-box" style="margin-bottom: 20px;">
      <h4 data-translate-key="titles.conversionSelect">√áeviri Y√∂n√ºn√º Se√ßin:</h4>
      <div class="button-group-row">
        <button class="btn conversion-btn btn-primary" id="tekrarModeTRDE" onclick="setConversionMode('tr-de'); startTekrarModePrompt()">
            <span class="led-indicator" style="margin-right: 12px;"></span> üáπüá∑ TR ‚Üí DE üá©üá™
        </button>
        <button class="btn conversion-btn btn-info" id="tekrarModeDETR" onclick="setConversionMode('de-tr'); startTekrarModePrompt()">
            <span class="led-indicator" style="margin-right: 12px;"></span> üá©üá™ DE ‚Üí TR üáπüá∑
        </button>
      </div>
    </div>

    <div class="button-grid">
      <button class="btn btn-secondary" onclick="startTekrarMode('cloze')">üî≤ <span data-translate-key="modes.cloze">Bo≈üluk Doldurma</span></button>
      <button class="btn btn-secondary" onclick="startTekrarMode('wordorder')">üî§ <span data-translate-key="modes.wordorder">Kelimeleri Sƒ±ralama</span></button>
      <button class="btn btn-primary" onclick="startTekrarMode('quiz')">üéØ <span data-translate-key="modes.quiz">Quiz (Test)</span></button>
    </div>
    <div class="button-group-row">
      <button class="btn btn-danger btn-small" onclick="showView('tekrarMenu')" data-translate-key="buttons.goBack">‚Üê Geri</button>
    </div>
  </div>

  <div id="groupMenu" class="view">
    <div class="group-select-header">
      <h2 data-translate-key="titles.start">BA≈ûLA</h2>
    </div>
    <div class="group-select-columns">
      <div class="group-column-title-container">
        <div class="group-column-title" data-translate-key="titles.groupSelect">Fiil Se√ß</div>
      </div>
      <div class="group-column-title-container">
        <div class="group-column-title" data-translate-key="titles.storySelect">Hikaye Se√ß</div>
      </div>
    </div>
    <div id="groupButtons"></div>
    <div class="button-group-row">
      <button class="btn btn-danger btn-small" onclick="showView('mainMenu')" data-translate-key="buttons.mainMenu">‚Üê Ana Men√º</button>
    </div>
  </div>

  <div id="verbMenu" class="view">
    <h2 class="section-title" data-translate-key="titles.verbSelect">Fƒ∞ƒ∞L SE√á</h2>
    <div id="verbButtons" class="button-grid"></div>
    <div class="button-group-row">
      <button class="btn btn-danger btn-small" onclick="goBackInHistory()" data-translate-key="buttons.goBack">‚Üê Geri</button>
    </div>
  </div>

  <div id="sectionMenu" class="view">
    <h2 class="section-title" data-translate-key="titles.sectionSelect">B√ñL√úM SE√á</h2>
    <div id="sectionButtons" class="button-grid"></div>
    <div class="button-group-row">
      <button class="btn btn-danger btn-small" onclick="goBackInHistory()" data-translate-key="buttons.goBack">‚Üê Geri</button>
    </div>
  </div>

  <div id="modeMenu" class="view">
    <h2 class="large-centered-title" data-translate-key="titles.conversionSelect">√áEVƒ∞Rƒ∞ Y√ñN√ú</h2>

    <div class="content-box" style="margin-bottom: 20px;">
      <h4 data-translate-key="titles.conversionSelect">√áeviri Y√∂n√ºn√º Se√ßin:</h4>
      <div class="button-group-row">
        <button class="btn conversion-btn btn-primary" id="modeTRDE" onclick="setConversionMode('tr-de'); startMode('study')">üáπüá∑ TR ‚Üí DE üá©üá™</button>
        <button class="btn conversion-btn btn-info" id="modeDETR" onclick="setConversionMode('de-tr'); startMode('study')">üá©üá™ DE ‚Üí TR üáπüá∑</button>
      </div>
    </div>

    <div class="button-group-row">
      <button class="btn btn-danger btn-small" onclick="goBackInHistory()" data-translate-key="buttons.goBack">‚Üê Geri</button>
    </div>
  </div>

  <div id="learningView" class="view">
    <h2 class="section-title" id="learningTitle"></h2> <div class="progress-container">
      <div class="progress-bar"><div id="progressFill" class="progress-fill">0%</div></div>
      <div style="text-align:center;margin-top:8px;font-weight:700;"><span id="progressText">0 / 0</span></div>
    </div>
    
    <div id="learningControlsAccordion" style="margin-top: 15px;">
      <div class="button-grid-learning">
          <button class="btn btn-warning btn-small" onclick="toggleLearningPanel('panelHint')">üí° ƒ∞pucu Paneli</button>
          <button class="btn btn-info btn-small" onclick="toggleLearningPanel('panelListen')">üîä Dinleme/Hƒ±z</button>
          <button class="btn btn-secondary btn-small" onclick="toggleLearningPanel('panelEdit')">üîß Kart Ayarlarƒ±</button>
      </div>
      
      <div id="panelHint" class="content-box" style="display:none; margin-top: 10px;">
          <h4 style="margin-bottom: 10px;">ƒ∞pucu Y√∂netimi</h4>
          <div class="button-group-row" style="margin-bottom: 10px;">
              <button class="btn btn-ai" onclick="getAIHint()">üß† AI ƒ∞pucu Al</button>
              <button class="btn btn-info btn-small" onclick="showHintDetail('section')">B√∂l√ºm ƒ∞pucu</button>
              <button class="btn btn-info btn-small" onclick="showHintDetail('verb')">Fiil ƒ∞pucu</button>
          </div>
          <button class="btn btn-secondary" id="toggleHintBtn" data-translate-key="buttons.hintToggle" onclick="toggleHintPanel()" style="width:100%;">C√ºmle ƒ∞pucu A√ß / Kapat</button>
          <div id="hintPanel" class="hint-area" style="display:none"></div>
      </div>

      <div id="panelListen" class="content-box" style="display:none; margin-top: 10px;">
          <h4 style="margin-bottom: 10px;">Dinleme Kontrolleri</h4>
          <div class="button-grid-learning" style="grid-template-columns: 1fr 1fr;">
              <button class="btn" id="autoPlayBtn" onclick="toggleAutoPlay()">
                  <span class="led-indicator" id="autoPlayLed"></span>Otomatik Dinle
              </button>
              <button class="btn" id="slowModeToggleBtn" onclick="toggleSpeechSpeed()">
                  <span class="led-indicator" id="slowModeLedL"></span>üîä Yava≈ü Mod
              </button>
              <button class="btn" id="pauseBtn" onclick="toggleSpeechPause()">‚è∏Ô∏è Durdur</button>
              <button class="btn" id="btnPlayDE" data-translate-key="buttons.playDE" onclick="playCurrentSentence('de')">üîä Almanca Dinle</button>
              <button class="btn" id="btnPlayTR" data-translate-key="buttons.playTR" onclick="playCurrentSentence('tr')">üîä T√ºrk√ße Dinle</button>
          </div>
      </div>

      <div id="panelEdit" class="content-box" style="display:none; margin-top: 10px;">
          <h4 style="margin-bottom: 10px;">Kart D√ºzeltme & Navigasyon</h4>
          <div class="button-group-row">
              <button class="btn" id="btnQuickEdit" onclick="showQuickEditPanel()">‚úèÔ∏è Kartƒ± D√ºzelt/Ekle</button>
              <button class="btn" onclick="previousQuestion()" data-translate-key="buttons.previous">‚Üê √ñnceki</button>
          </div>
      </div>
    </div>
    <div class="content-box">
      <div id="learningContent"></div>
      <div id="resultArea"></div>
      <div id="answerArea"></div>
    </div>
    
    <div id="srsControls" class="button-group-row">
        <button class="btn btn-srs-zor" onclick="rateCard('zor')">ü•µ <span data-translate-key="srs.zor">ZOR</span></button>
        <button class="btn btn-srs-normal" onclick="rateCard('normal')">ü§î <span data-translate-key="srs.normal">NORMAL</span></button>
        <button class="btn btn-srs-ogrendim" onclick="rateCard('ogrendim')">‚úÖ <span data-translate-key="srs.ogrendim">√ñƒûRENDƒ∞M</span></button>
    </div>
    
    <div id="quickEditPanel" class="content-box" style="display:none; margin-top: 15px;">
        <h4 id="quickEditTitle" style="margin-bottom: 10px;">Sayfa ƒ∞√ßeriƒüi Hƒ±zlƒ± D√ºzenleme</h4>
        <label style="display:block;margin-top:12px;" data-translate-key="labels.tr">TR C√ºmle:</label>
        <textarea id="qe_tr" class="textarea-field" rows="3"></textarea>
        <label style="display:block;margin-top:12px;" data-translate-key="labels.de">DE C√ºmle:</label>
        <textarea id="qe_de" class="textarea-field" rows="3"></textarea>
        <label style="display:block;margin-top:12px;" data-translate-key="labels.hintText">C√ºmle ƒ∞pucu:</label>
        <textarea id="qe_hint" class="textarea-field" rows="3" placeholder="Bu c√ºmleye √∂zel ipucu ekleyin/d√ºzenleyin."></textarea>
        <div class="button-group-row">
            <button class="btn btn-secondary" onclick="saveQuickEdit()">‚úÖ <span data-translate-key="buttons.save">Kaydet</span> & Kapat</button>
            <button class="btn btn-danger" onclick="document.getElementById('quickEditPanel').style.display='none'" data-translate-key="buttons.cancel">ƒ∞ptal</button>
        </div>
    </div>

    <div id="completionControls" style="display:none; justify-content:center; margin-top: 15px;">
        <button class="btn btn-primary conversion-btn" id="nextStepBtn" style="min-width: 300px;">‚Üí Sonraki Adƒ±m</button>
    </div>

    <div class="primary-action-container">
      <button class="btn" id="actionBtn" data-translate-key="buttons.show" onclick="handleAction()">Kontrol Et / G√∂ster</button>
    </div>
  </div>

  <div id="detailViewLayer" class="view">
    <div class="container">
        <h2 id="detailViewTitle"></h2>
        <div id="detailViewContent" class="content-box" style="white-space: pre-wrap;"></div>
        <div class="button-group-row" style="justify-content:center;">
            <button class="btn btn-danger" onclick="goBackInHistory()" data-translate-key="buttons.goBack">‚Üê Geri</button>
        </div>
    </div>
  </div>

  <div id="storyView" class="view">
    <h2 class="section-title" data-translate-key="titles.story">Hikaye</h2>
    <div class="content-box" id="storyContent"></div>
    <div class="button-grid-learning">
      <button class="btn btn-warning" onclick="showStoryQuestions()" data-translate-key="buttons.questions">üìù Sorular</button>
      <button class="btn" id="storySlowModeToggleBtn" onclick="toggleSpeechSpeed()">
        <span class="led-indicator" id="slowModeLedS"></span>üîä Yava≈ü Mod
      </button>
      <button class="btn" id="storyPauseBtn" onclick="toggleSpeechPause()">‚è∏Ô∏è Durdur</button>
      <button class="btn" id="btnPlayDE" data-translate-key="buttons.playDE" onclick="playStoryAudio('de')">üîä Almanca Dinle</button>
      <button class="btn" onclick="playStoryAudio('tr')" data-translate-key="buttons.playTR" onclick="playStoryAudio('tr')">üîä T√ºrk√ße Dinle</button>
      <button class="btn btn-danger" onclick="goBackInHistory()" data-translate-key="buttons.groupMenuReturn">‚Üê Grup Men√ºs√ºne D√∂n</button>
    </div>
  </div>

  <div id="storyQuestionsView" class="view">
    <h2 class="section-title" data-translate-key="titles.storyQuestions">Hikaye Sorularƒ±</h2>
    <div class="content-box" id="storyQuestionsContent"></div>
    <div class="button-group-row">
      <button class="btn btn-danger btn-small" onclick="goBackInHistory()" data-translate-key="buttons.storyReturn">‚Üê Hikayeye D√∂n</button>
    </div>
  </div>

  <div id="settings" class="view">
    <h2 class="section-title" data-translate-key="titles.settings">‚öôÔ∏è Ayarlar</h2>
    <div class="content-box">
      <h3 data-translate-key="settings.dataManagement">üíæ Veri Y√∂netimi</h3>
      <div class="button-grid" style="grid-template-columns: 1fr 1fr; margin-top: 10px;">
        <button class="btn btn-primary" style="width:100%;" onclick="importDataFromFile()" data-translate-key="buttons.importJSON">üì• ƒ∞√ßerik Y√ºkle (JSON)</button>
        <button class="btn btn-secondary" style="width:100%;" onclick="exportData()" data-translate-key="buttons.exportJSON">üì§ ƒ∞√ßerik ƒ∞ndir (JSON)</button>
      </div>
    </div>
    <div class="content-box">
      <h3 data-translate-key="settings.appearance">üé® G√∂r√ºn√ºm ve Diƒüer</h3>
      <div style="margin-top: 12px;">
          <label style="display:block;font-weight:700;margin-bottom:6px" data-translate-key="settings.language">Dil:</label>
          <div style="display:flex;gap:8px">
            <button class="lang-btn active" id="langTR" onclick="changeLanguage('tr', this)">T√ºrk√ße</button>
            <button class="lang-btn" id="langDE" onclick="changeLanguage('de', this)">Deutsch</button>
          </div>
      </div
      ><label style="display:flex;align-items:center;gap:8px;margin-top:15px;">
          <input type="checkbox" id="nightModeToggle" style="width: 20px; height: 20px;"> <span data-translate-key="settings.nightMode">Gece Modu</span>
      </label>
      <div style="margin-top: 15px;">
        <label style="display:block;font-weight:700;margin-bottom:6px" data-translate-key="settings.music">M√ºzik:</label>
        <div style="display:flex; align-items: center; gap: 10px;">
          <button id="settingsMusicToggle" class="btn btn-primary btn-small" onclick="musicPlayer.toggleMusic()">üîä √áal/Durdur</button>
          <input type="range" id="settingsMusicVolume" min="0" max="100" value="70" style="flex: 1;">
        </div>
      </div>
    </div>
    <div class="content-box">
        <h3 data-translate-key="settings.appUpdate">üîÑ Uygulama</h3>
        <button class="btn btn-warning" style="width:100%; margin-top: 10px;" onclick="forceUpdateApp()" data-translate-key="buttons.forceUpdate">üîÑ Uygulamayƒ± G√ºncelle</button>
    </div>
    <div class="content-box" style="margin-top:12px">
      <h3 data-translate-key="settings.pasteJSONTitle">üìù JSON Yapƒ±≈ütƒ±r (Mobil)</h3>
      <textarea id="jsonPaste" class="textarea-field" data-translate-key="placeholders.jsonPaste" placeholder="JSON i√ßeriƒüinizi buraya yapƒ±≈ütƒ±rƒ±n..." rows="5"></textarea>
      <div class="button-group-row" style="margin-top:8px">
        <button class="btn btn-primary" onclick="loadJsonFromTextarea()" data-translate-key="buttons.pasteAndLoad">üì• Yapƒ±≈ütƒ±r & Y√ºkle</button>
        <button class="btn btn-danger" onclick="document.getElementById('jsonPaste').value=''" data-translate-key="buttons.clear">Temizle</button>
      </div>
    </div>
    <div class="button-group-row" style="margin-top:12px">
      <button class="btn btn-danger btn-small" onclick="goBackInHistory()" data-translate-key="buttons.mainMenu">‚Üê Ana Men√º</button>
    </div>
  </div>

  <div id="progress" class="view">
    <h2 class="section-title" data-translate-key="titles.progress">üìä ƒ∞lerleme</h2>
    <div class="content-box">
      <h3 data-translate-key="titles.srsStats">Tekrar Durumu</h3>
      <div class="progress-stats-grid">
        <div class="stat-card stat-card-zor">
          <h4 data-translate-key="srs.zorlandiklarim">ZORLANDIKLARIM</h4>
          <div class="stat-value" id="progressStatZor">0</div>
        </div>
        <div class="stat-card stat-card-normal">
          <h4 data-translate-key="srs.normal">NORMAL</h4>
          <div class="stat-value" id="progressStatNormal">0</div>
        </div>
        <div class="stat-card stat-card-ogrendim">
          <h4 data-translate-key="srs.ogrendiklerim">√ñƒûRENDƒ∞KLERƒ∞M</h4>
          <div class="stat-value" id="progressStatOgrenildi">0</div>
        </div>
      </div>
    </div>
    <div class="content-box">
      <h3 data-translate-key="titles.totalProgress">Toplam √áalƒ±≈üma ƒ∞lerlemesi</h3>
      <p class="small-muted" data-translate-key="messages.totalProgressDesc">T√ºm i√ßerikteki (c√ºmlelerdeki) ilerleme durumunuz.</p>
      <div class="progress-container" style="margin-top: 15px;">
        <div class="progress-bar"><div id="totalProgressFill" class="progress-fill">0%</div></div>
        <div style="text-align:center;margin-top:8px;font-weight:700;"><span id="totalProgressText">0 / 0</span></div>
      </div>
    </div>
    <div class="content-box">
        <h3 data-translate-key="settings.progressManagement">üíæ ƒ∞lerleme Veri Y√∂netimi</h3>
        <div class="button-grid" style="grid-template-columns: 1fr 1fr; margin-top: 10px;">
           <button class="btn btn-primary" style="width:100%;" onclick="importSrsData()" data-translate-key="buttons.importProgress">üì• ƒ∞lerleme Y√ºkle</button>
           <button class="btn btn-secondary" style="width:100%;" onclick="exportSrsData()" data-translate-key="buttons.exportProgress">üì§ ƒ∞lerleme ƒ∞ndir</button>
        </div>
        <button class="btn btn-danger" style="width:100%; margin-top: 10px;" onclick="resetSrsData()" data-translate-key="buttons.resetSrs">‚ö†Ô∏è T√ºm ƒ∞lerlemeyi Sƒ±fƒ±rla</button>
    </div>
    <div class="button-group-row">
      <button class="btn btn-danger btn-small" onclick="goBackInHistory()" data-translate-key="buttons.mainMenu">‚Üê Ana Men√º</button>
    </div>
  </div>

  <div id="adminView" class="view">
    <h2 class="section-title" data-translate-key="titles.adminPanel">üîß Y√∂netici Paneli</h2>
    <div class="button-grid">
      <button class="btn btn-primary" onclick="showView('adminContentView')" data-translate-key="admin.contentManagement">üìö ƒ∞√ßerik Y√∂netimi</button>
      <button class="btn btn-warning" onclick="showGroupVerbImporter()">üèóÔ∏è Grup & Fiil Y√ºkle</button>
      <button class="btn btn-info" onclick="showTsvImporter()">üìä Toplu C√ºmle Y√ºkle</button>
      <button class="btn btn-secondary" onclick="showView('adminSentenceListView')" data-translate-key="admin.listAllSentences">üìã T√ºm C√ºmleleri Listele</button>
    </div>

    <div id="adminGroupVerbArea" class="content-box" style="display:none; margin-top: 15px; border-color: #fbd38d;">
        <h4 data-translate-key="admin.groupVerbTitle">üèóÔ∏è Toplu Grup & Fiil Y√ºkleme</h4>
        <p class="small-muted" data-translate-key="admin.groupVerbDesc">
          Excel'den kopyaladƒ±ƒüƒ±nƒ±z YENƒ∞ GRUP ve Fƒ∞ƒ∞L listenizi buraya yapƒ±≈ütƒ±rƒ±n.<br>
          Kullanmanƒ±z gereken s√ºtun sƒ±rasƒ± (Sekme/Tab ile ayrƒ±lmƒ±≈ü):<br>
          <b>GrupID | GrupAdƒ± | FiilID | FiilAdƒ± (TR) | FiilAdƒ± (DE)</b>
        </p>
        <textarea id="groupVerbPasteArea" class="textarea-field" rows="10" placeholder="g21 (Tab) PAKET TESLƒ∞M S√úRECƒ∞ (Tab) v61 (Tab) almak, toplamak (Tab) abholen..."></textarea>
        <div class="button-group-row">
            <button class="btn btn-warning" onclick="parseAndImportGroupsAndVerbs()">‚úÖ <span data-translate-key="buttons.pasteAndLoadTsv">Y√ºkle ve ƒ∞≈üle</span></button>
            <button class="btn btn-danger" onclick="document.getElementById('adminGroupVerbArea').style.display='none'" data-translate-key="buttons.cancel">ƒ∞ptal</button>
        </div>
    </div>

    <div id="adminTsvArea" class="content-box" style="display:none; margin-top: 15px; border-color: #10b981;">
        <h4 data-translate-key="admin.tsvTitle">üìä Toplu C√ºmle Y√ºkleme (Excel'den Kopyala-Yapƒ±≈ütƒ±r)</h4>
        <p class="small-muted" data-translate-key="admin.tsvDesc">
          Excel veya Google E-Tablolar'da hazƒ±rladƒ±ƒüƒ±nƒ±z veriyi buraya yapƒ±≈ütƒ±rƒ±n.<br>
          Kullanmanƒ±z gereken s√ºtun sƒ±rasƒ± (BA≈ûLIK SATIRI OLMADAN):<br>
          <b>GrupID | FiilID | B√∂l√ºmNumarasƒ± | TR_C√ºmle | DE_C√ºmle | C√ºmleIpucu (ƒ∞steƒüe baƒülƒ±)</b>
        </p>
        <textarea id="tsvPasteArea" class="textarea-field" rows="10" placeholder="GrupID (Tab/Virg√ºl) FiilID (Tab/Virg√ºl) B√∂l√ºmNo (Tab/Virg√ºl) TR C√ºmle..."></textarea>
        <div class="button-group-row">
            <button class="btn btn-info" onclick="parseAndImportTsv()">‚úÖ <span data-translate-key="buttons.pasteAndLoadTsv">Y√ºkle ve ƒ∞≈üle</span></button>
            <button class="btn btn-danger" onclick="document.getElementById('adminTsvArea').style.display='none'" data-translate-key="buttons.cancel">ƒ∞ptal</button>
        </div>
    </div>

    <div class="button-group-row" style="margin-top:12px">
      <button class="btn btn-danger btn-small" onclick="goBackInHistory()" data-translate-key="buttons.mainMenu">‚Üê Ana Men√º</button>
    </div>
  </div>

  <div id="adminContentView" class="view">
     <h2 class="section-title" data-translate-key="admin.contentManagement">üìö ƒ∞√ßerik Y√∂netimi</h2>
     <div class="button-grid" style="grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));">
        <button class="btn btn-warning" onclick="showAdminForm('groupOrder')">‚ÜïÔ∏è Sƒ±ralamayƒ± D√ºzenle (Gruplar)</button>  
        <button class="btn btn-warning" onclick="showAdminForm('editGuide')">‚≠ê Kƒ±lavuz Metni D√ºzenle</button>  
        <button class="btn btn-primary" onclick="showAdminForm('addGroup')">‚ûï <span data-translate-key="admin.addGroup">Grup Ekle/D√ºzenle</span></button>
        <button class="btn btn-primary" onclick="showAdminForm('addVerb')">‚ûï <span data-translate-key="admin.addVerb">Fiil Ekle/D√ºzenle</span></button>
        <button class="btn btn-primary" onclick="showAdminForm('addSection')">‚ûï <span data-translate-key="admin.addSection">B√∂l√ºm Ekle/D√ºzenle</span></button>
        <button class="btn btn-info" onclick="showAdminForm('addStory')">‚ûï <span data-translate-key="admin.addStory">Hikaye Ekle/D√ºzenle</span></button>
        <button class="btn btn-info" onclick="showAdminForm('addHint')">üí° <span data-translate-key="admin.hintManagement">ƒ∞pucu Ekle/D√ºzenle</span></button>
        <button class="btn btn-secondary" onclick="showAdminForm('editSentence')">‚úèÔ∏è <span data-translate-key="admin.editSentence">C√ºmle Ekle/D√ºzenle</span></button>
     </div>
     <div id="adminContentArea" class="content-box" style="margin-top: 15px; display: none;">
     </div>
     <div class="button-group-row" style="margin-top:12px">
      <button class="btn btn-danger btn-small" onclick="goBackInHistory()" data-translate-key="buttons.adminReturn">‚Üê Y√∂netici Paneline D√∂n</button>
    </div>
  </div>

  <div id="adminSentenceListView" class="view">
    <h2 class="section-title" data-translate-key="admin.listAllSentences">üìã T√ºm C√ºmleleri Listele</h2>
    <div class="content-box">
      <div class="button-group-row" style="margin-bottom:8px;">
        <button class="btn btn-secondary" onclick="renderAllSentencesTable()" data-translate-key="buttons.refreshList">üîÑ Yenile Liste</button>
        <button class="btn btn-warning" onclick="exportSentencesCsv()" data-translate-key="buttons.exportCSV">üì§ TSV ƒ∞ndir (Tablo)</button>
      </div>
      <div id="allSentencesTable" style="max-height:60vh;overflow:auto"></div>
    </div>
    <div class="button-group-row" style="margin-top:12px">
      <button class="btn btn-danger btn-small" onclick="goBackInHistory()" data-translate-key="buttons.adminReturn">‚Üê Y√∂netici Paneline D√∂n</button>
    </div>
  </div>
</div>

<input type="file" id="fileInput" accept=".json" style="display:none">
<input type="file" id="progressFileInput" accept=".json" style="display:none">

<script>/* ======================================================
   VERB MATRIX v4.0 - Nƒ∞HAƒ∞ S√úR√úM
   (T√ºm Admin, TSV ve Geli≈ümi≈ü iOS/Safari TTS D√ºzeltmeleri Dahil)
   ====================================================== */

/* ---------------- Varsayƒ±lan Veri ve Durum --------------- */
let data = {
  groups: [ 
      { id: "g1", name: "Ba≈ülangƒ±√ß Seviyesi (√ñrnek)", nameDE: "Anf√§nger", story: { title: "Ho≈ü Geldin Hikayesi", tr: "Merhaba, Almanca √∂ƒürenme yolculuƒüuna ho≈ü geldin.", de: "Hallo, herzlich willkommen auf deiner Reise zum Deutschlernen.", quiz: [{q:'Almanca √∂ƒüreniyor musun?', options:['Evet', 'Hayƒ±r'], a:'Evet'}] } },
      { id: "g2", name: "Orta Seviye", nameDE: "Mittelstufe", story: null } 
  ],
  verbs: { 
      g1: [ { id:'v1', verbTR:'Gitmek', verbDE:'Gehen' }, { id:'v2', verbTR:'G√∂rmek', verbDE:'Sehen' } ] 
  },
  content: {
      "v1_s1": [
          { tr: "Ben okula gidiyorum.", de: "Ich gehe zur Schule." },
          { tr: "Oraya gidiyor musun?", de: "Gehst du dorthin?" }
      ],
      "v2_s1": [
          { tr: "Ben seni g√∂r√ºyorum.", de: "Ich sehe dich." }
      ]
  },
  sections: { 1: "≈ûimdiki Zaman", 2: "Ge√ßmi≈ü Zaman" },
  hints: { sentences: {}, verbs: {}, sections: { "B1": "≈ûimdiki zaman (Pr√§sens) kuralƒ±: Fiil k√∂k√º + ≈üahƒ±s eki." } },
  guideText: { title: "Kullanƒ±m Kƒ±lavuzu", content: "**Ho≈ügeldiniz!**\nBu uygulama ile fiil √ßekimlerini √∂ƒürenirken, Almanca gramer kurallarƒ±nƒ± da peki≈ütirebilirsiniz.\n\n### Temel √ñzellikler\n* **√áalƒ±≈üma:** Yeni kartlarƒ± √∂ƒürenin.\n* **Tekrar (SRS):** √ñƒürendiklerinizi aralƒ±klƒ± tekrar sistemiyle peki≈ütirin.\n* **Hikayeler:** Okuma ve anlama becerinizi geli≈ütirin." },
  translations: {
    tr: {
      app: { subtitle: 'Fiiller ƒ∞le Almanca √ñƒürenme Platformu' },
      menu: { calis: 'üìö √áalƒ±≈ü', tekrar: 'üîÑ Tekrar', settings: '‚öôÔ∏è Ayarlar', progress: 'üìä ƒ∞lerleme' },
      titles: { start: 'BA≈ûLA', tekrar: 'üîÑ TEKRAR', guide: '‚≠ê Kullanƒ±m Kƒ±lavuzu', groupSelect: 'Fiil Se√ß', storySelect: 'Hikaye Se√ß', verbSelect: 'Fƒ∞ƒ∞L SE√á', sectionSelect: 'B√ñL√úM SE√á', modeSelect: 'MODU SE√á', conversionSelect: '√áEVƒ∞Rƒ∞ Y√ñN√ú', learning: 'üìö √áalƒ±≈üma', story: 'Hikaye', storyQuestions: 'Hikaye Sorularƒ±', settings: '‚öôÔ∏è Ayarlar', progress: 'üìä ƒ∞lerleme', adminPanel: 'üîß Y√∂netici Paneli', srsStats: 'Tekrar Durumu', totalProgress: 'Toplam √áalƒ±≈üma ƒ∞lerlemesi' },
      buttons: { show: 'G√∂ster', next: '‚Üí Sonraki', check: 'Kontrol Et', start: 'Ba≈üla', previous: '‚Üê √ñnceki', hintToggle: 'C√ºmle ƒ∞pucu', questions: 'üìù Sorular', playDE: 'üîä Almanca Dinle', playTR: 'üîä T√ºrk√ße Dinle', importJSON: 'üì• ƒ∞√ßerik Y√ºkle (JSON)', exportJSON: 'üì§ ƒ∞√ßerik ƒ∞ndir (JSON)', importProgress: 'üì• ƒ∞lerleme Y√ºkle', exportProgress: 'üì§ ƒ∞lerleme ƒ∞ndir', resetSrs: '‚ö†Ô∏è T√ºm ƒ∞lerlemeyi Sƒ±fƒ±rla', pasteAndLoad: 'üì• Yapƒ±≈ütƒ±r & Y√ºkle', clear: 'Temizle', refreshList: 'üîÑ Yenile Liste', exportCSV: 'üì§ TSV ƒ∞ndir (Tablo)', save: 'Kaydet', cancel: 'ƒ∞ptal', update: 'G√ºncelle', add: 'Ekle', delete: 'Sil', edit: 'D√ºzenle', nextSection: '‚Üí Sonraki B√∂l√ºm', nextVerb: '‚Üí Sonraki Fiil', goToStory: '‚Üí Hikayeye Git', startStudy: 'üìñ √áalƒ±≈ümaya Ba≈üla', forceUpdate: 'üîÑ Uygulamayƒ± G√ºncelle', pasteAndLoadTsv: 'Y√ºkle ve ƒ∞≈üle', menuReturn: 'Ana Men√ºye D√∂n', goBack: '‚Üê Geri', storyReturn: '‚Üê Hikayeye D√∂n', groupMenuReturn: '‚Üê Grup Men√ºs√ºne D√∂n', adminReturn: '‚Üê Y√∂netici Paneline D√∂n' },
      settings: { appearance: 'üé® G√∂r√ºn√ºm ve Diƒüer', nightMode: 'Gece Modu', language: 'Dil:', music: 'M√ºzik:', dataManagement: 'üíæ ƒ∞√ßerik Veri Y√∂netimi', progressManagement: 'üíæ ƒ∞lerleme Veri Y√∂netimi', appUpdate: 'üîÑ Uygulama', pasteJSONTitle: 'üìù JSON Yapƒ±≈ütƒ±r (Mobil)', pasteJSONDesc: 'ƒ∞√ßerik JSON dosyanƒ±zƒ± buraya yapƒ±≈ütƒ±rƒ±n...' },
      admin: { contentManagement: 'üìö ƒ∞√ßerik Y√∂netimi', listAllSentences: 'üìã T√ºm C√ºmleleri Listele', addGroup: 'Grup Ekle/D√ºzenle', addVerb: 'Fiil Ekle/D√ºzenle', addSection: 'B√∂l√ºm Ekle/D√ºzenle', editSentence: 'C√ºmle Ekle/D√ºzenle', addStory: 'Hikaye Ekle/D√ºzenle', hintManagement: 'üí° ƒ∞pucu Ekle/D√ºzenle', editGuide: '‚≠ê Kƒ±lavuz Metni D√ºzenle', groupVerbTitle: 'üèóÔ∏è Toplu Grup & Fiil Y√ºkleme', groupVerbDesc: 'Excel\'den kopyaladƒ±ƒüƒ±nƒ±z YENƒ∞ GRUP ve Fƒ∞ƒ∞L listenizi buraya yapƒ±≈ütƒ±rƒ±n.<br>Kullanmanƒ±z gereken s√ºtun sƒ±rasƒ± (Sekme/Tab ile ayrƒ±lmƒ±≈ü):<br><b>GrupID | GrupAdƒ± | FiilID | FiilAdƒ± (TR) | FiilAdƒ± (DE)</b>', tsvTitle: 'üìä Toplu C√ºmle Y√ºkleme (Excel\'den Kopyala-Yapƒ±≈ütƒ±r)', tsvDesc: 'Excel veya Google E-Tablolar\'da hazƒ±rladƒ±ƒüƒ±nƒ±z veriyi buraya yapƒ±≈ütƒ±rƒ±n.<br>Kullanmanƒ±z gereken s√ºtun sƒ±rasƒ± (BA≈ûLIK SATIRI OLMADAN):<br><b>GrupID | FiilID | B√∂l√ºmNumarasƒ± | TR_C√ºmle | DE_C√ºmle | C√ºmleIpucu (ƒ∞steƒüe baƒülƒ±)</b>' },
      labels: { group: 'Grup:', verb: 'Fiil:', section: 'B√∂l√ºm:', sentence: 'C√ºmle:', index: 'Index:', hintText: 'ƒ∞pucu metni:', tr: 'TR:', de: 'DE:', title: 'Ba≈ülƒ±k:', deText: 'DE metin:', trText: 'TR metin:', groupID: 'Grup ID (√∂r: g5):', groupNameTR: 'Ad (TR):', groupNameDE: 'Ad (DE):', verbID: 'Fiil ID (√∂rn v10):', verbTR: 'Fiil TR:', verbDE: 'Fiil DE:', sectionCode: 'B√∂l√ºm Kodu (√∂rn: B1):', sectionNum: 'B√∂l√ºm Numarasƒ± (√∂rn: 1):', sectionName: 'B√∂l√ºm Adƒ± (√∂rn: Ki≈üi Zamiri):', question: 'Soru:', options: 'Se√ßenekler (virg√ºlle ayƒ±r):', correctAnswer: 'Doƒüru cevap (tam metin):', guideTitle: 'Kƒ±lavuz Ba≈ülƒ±ƒüƒ±:', guideContent: 'Kƒ±lavuz ƒ∞√ßeriƒüi (Metin):' },
      placeholders: { jsonPaste: 'JSON i√ßeriƒüinizi buraya yapƒ±≈ütƒ±rƒ±n...', cloze: 'Bo≈üluƒüu doldurun...', quiz: '√áeviriyi yazƒ±n...' },
      messages: { noGroups: 'Hen√ºz grup yok. JSON y√ºkleyin.', noVerbs: 'Bu grupta fiil bulunamadƒ±.', noSentences: 'Bu fiil ve b√∂l√ºm i√ßin c√ºmle bulunamadƒ±!', noDueCards: 'Bu kategoride tekrar edilecek kart kalmadƒ±! üéâ', noNewCards: 'Bu b√∂l√ºmdeki t√ºm kartlarƒ± √ßalƒ±≈ütƒ±nƒ±z! üéâ', noStory: 'Bu grup i√ßin hikaye bulunamadƒ±!', noStoryAvailable: 'Hikaye Yok', noStoryQuestions: 'Bu hikaye i√ßin hen√ºz soru yok.', noProgress: 'Hen√ºz ilerleme yok.', noHints: 'Yok', noStoryFound: 'Hikaye bulunamadƒ±', ttsNotSupported: 'Tarayƒ±cƒ± TTS desteklemiyor.', dataLoaded: '‚úì ƒ∞√ßerik verisi y√ºklendi. Grup sayƒ±sƒ±:', progressLoaded: '‚úì ƒ∞lerleme verisi y√ºklendi.', invalidJSON: '‚úó Ge√ßersiz JSON formatƒ±.', loadError: '‚úó Hata:', dataExported: '‚úì ƒ∞√ßerik verisi (verbmatrix_data.json) indirildi!', progressExported: '‚úì ƒ∞lerleme verisi (verbmatrix_ilerleme_data.json) indirildi!', srsReset: '‚úì T√ºm √ßalƒ±≈üma (SRS) verisi sƒ±fƒ±rlandƒ±.', jsonStatus: 'üìä JSON DURUMU', allFieldsError: 'T√ºm alanlarƒ± doldurun', hintSaved: '‚úÖ ƒ∞pucu kaydedildi', guideSaved: '‚úÖ Kƒ±lavuz metni kaydedildi', quickEditSaved: '‚úÖ C√ºmle ve ipucu g√ºncellendi (Yerel olarak kaydedildi)!', overrideReset: '‚úÖ ƒ∞√ßerik d√ºzeltmeleri silindi. Sayfa yenilendikten sonra varsayƒ±lan i√ßeriƒüe d√∂n√ºlecektir.', srsResetConfirm: 'T√ºm √ßalƒ±≈üma (Aralƒ±klƒ± Tekrar) verilerinizi sƒ±fƒ±rlamak istediƒüinizden emin misiniz? T√ºm kartlarƒ±n ilerlemesi (Zor, Normal, √ñƒürendim) silinecektir.', totalProgressDesc: 'T√ºm i√ßerikteki (c√ºmlelerdeki) ilerleme durumunuz.', srsPromotion: 'üéâ Tebrikler! Kart "%s" listesine ta≈üƒ±ndƒ±.', srsDemotion: 'ü§î Dikkat! Kart "%s" listesine ta≈üƒ±ndƒ±.' },
      srs: { zor: 'ü•µ ZOR', normal: 'ü§î NORMAL', ogrendim: '‚úÖ √ñƒûRENDƒ∞M', zorlandiklarim: 'ZORLANDIKLARIM', ogrendiklerim: '√ñƒûRENDƒ∞KLERƒ∞M' },
      modes: { cloze: 'Bo≈üluk Doldurma', wordorder: 'Kelimeleri Sƒ±ralama', quiz: 'Quiz (Test)', study: '√áalƒ±≈üma (Yeni Kartlar)' }
    }
  },
  settings:{ language:'tr', nightMode:false, conversionMode: 'tr-de' }
};

let srsData = {};
let contentOverride = {};

let state = {
  currentView:'mainMenu',
  viewHistory: ['mainMenu'],
  group:null, groupData:null,
  verb:null, verbData:null, 
  section:null,
  mode:null,
  tekrarStatus: null,
  deck: [],
  deckPos: 0,
  currentCardKey: null,
  currentCardData: null,
  showAnswer:false,
  wordPool:[], wordSelected:[], userAnswer:'', correctAnswer:'', showResult:false,
  hintPanelVisible: false,
  speechRate: 1.0,
  isSpeaking: false,
  autoPlayAudio: true,
  activeLearningPanel: null
};

let musicPlayer = null;
let speechUtterance = null; // TTS i√ßin global deƒüi≈üken

/* ---------- M√ºzik √áalar ---------- */
class MusicPlayer {
  constructor(streamUrl, volumeSliderId, toggleBtnId, settingsSliderId, settingsToggleId) {
    this.audio = new Audio(streamUrl);
    this.audio.crossOrigin = "anonymous";
    this.audio.loop = true;
    this.isPlaying = false;
    this.currentVolume = 0.7;
    this.dimmedVolume = 0.2;
    this.isDimmed = false;
    this.slider = document.getElementById(volumeSliderId);
    this.toggleBtn = document.getElementById(toggleBtnId);
    this.settingsSlider = document.getElementById(settingsSliderId);
    this.settingsToggleBtn = document.getElementById(settingsToggleId);
    const savedVolume = parseFloat(localStorage.getItem('verbmatrix_music_volume')) || 0.7;
    this.setVolume(savedVolume * 100, true);
    if (this.toggleBtn) this.toggleBtn.addEventListener('click', () => this.toggleMusic());
    if (this.slider) this.slider.addEventListener('input', (e) => this.setVolume(e.target.value));
    if (this.settingsToggleBtn) this.settingsToggleBtn.addEventListener('click', () => this.toggleMusic());
    if (this.settingsSlider) this.settingsSlider.addEventListener('input', (e) => this.setVolume(e.target.value));
  }
  updateUI() {
      const t = getMergedTranslations(data.settings.language || 'tr');
      const isPlaying = this.isPlaying;
      if (this.toggleBtn) this.toggleBtn.textContent = isPlaying ? '‚è∏Ô∏è' : 'üîä';
      if (this.settingsToggleBtn) {
          this.settingsToggleBtn.textContent = isPlaying ? '‚è∏Ô∏è ' + (t.buttons.pause || 'Durdur') : 'üîä ' + (t.buttons.play || '√áal');
      }
      const volumeValue = this.currentVolume * 100;
      if (this.slider) this.slider.value = volumeValue;
      if (this.settingsSlider) this.settingsSlider.value = volumeValue;
  }
  toggleMusic() {
    if (this.isPlaying) {
      this.audio.pause();
      this.isPlaying = false;
    } else {
      this.audio.load();
      this.audio.play().then(() => {
        this.isPlaying = true;
      }).catch(error => console.error("M√ºzik √ßalƒ±namadƒ±:", error));
    }
    this.updateUI();
  }
  setVolume(volumeValue, isInit = false) {
    const newVolume = parseFloat(volumeValue) / 100;
    this.currentVolume = newVolume;
    if (!this.isDimmed) {
      this.audio.volume = this.currentVolume;
    }
    if (!isInit) {
        try { localStorage.setItem('verbmatrix_music_volume', this.currentVolume.toString()); } catch (e) {}
    }
    if (this.slider) this.slider.value = volumeValue;
    if (this.settingsSlider) this.settingsSlider.value = volumeValue;
  }
  dim_music(dim) {
    if (!this.isPlaying) return;
    if (dim) {
      this.isDimmed = true;
      this.audio.volume = this.dimmedVolume;
    } else {
      this.isDimmed = false;
      this.audio.volume = this.currentVolume;
    }
  }
}

/* ---------- Konu≈üma Sentezi ---------- */
function toggleAutoPlay() {
  state.autoPlayAudio = !state.autoPlayAudio;
  updateAutoPlayButtonText();
  const led = document.getElementById('autoPlayLed');
  if (led) led.classList.toggle('active', state.autoPlayAudio);
}
function updateSpeedButtonUI() {
    const ledL = document.getElementById('slowModeLedL');
    const ledS = document.getElementById('slowModeLedS');
    const isActive = state.speechRate === 0.5;
    if (ledL) ledL.classList.toggle('active', isActive);
    if (ledS) ledS.classList.toggle('active', isActive);
}
function toggleSpeechSpeed() {
    state.speechRate = (state.speechRate === 1.0) ? 0.5 : 1.0;
    updateSpeedButtonUI();
    if (speechUtterance && !speechSynthesis.paused) {
        speechSynthesis.cancel();
        playCurrentSentence('de'); // Yeni hƒ±zla tekrar ba≈ülat
    }
}
function toggleSpeechPause() {
    if ('speechSynthesis' in window) {
        const btnL = document.getElementById('pauseBtn');
        const btnS = document.getElementById('storyPauseBtn');
        const btn = btnL && btnL.offsetParent !== null ? btnL : btnS;
        if (!btn) return;
        if (speechSynthesis.paused) {
            speechSynthesis.resume();
            btn.textContent = '‚è∏Ô∏è Durdur';
        } else {
            speechSynthesis.pause();
            btn.textContent = '‚ñ∂Ô∏è Oynat';
        }
    }
}
function resetSpeechButtons() {
    if ('speechSynthesis' in window) {
        window.speechSynthesis.cancel();
    }
    const pauseBtnL = document.getElementById('pauseBtn');
    const pauseBtnS = document.getElementById('storyPauseBtn');
    if (pauseBtnL) { pauseBtnL.textContent = '‚è∏Ô∏è Durdur'; }
    if (pauseBtnS) { pauseBtnS.textContent = '‚è∏Ô∏è Durdur'; }
}

/* ---------- SRS (ƒ∞lerleme) Veri Y√∂netimi ---------- */
function getSrsKey(verbId, sectionNum, sentenceIndex) {
    return `${verbId}_s${sectionNum}_${sentenceIndex}`;
}
function loadSrsData() {
    try {
        const data = localStorage.getItem('verbmatrix_srs_data_v3');
        srsData = data ? JSON.parse(data) : {};
    } catch (e) {
        srsData = {};
    }
    updateProgressView();
}
function saveSrsData() {
    try {
        localStorage.setItem('verbmatrix_srs_data_v3', JSON.stringify(srsData));
    } catch (e) {
        console.error("SRS verisi kaydedilemedi", e);
    }
    updateProgressView();
}
function getCardSrsData(key) {
    if (!srsData[key]) {
        srsData[key] = {
            status: 'new',
            quizHistory: []
        };
    }
    return srsData[key];
}
function rateCard(newStatus) {
    const cardData = getCardSrsData(state.currentCardKey);
    cardData.status = newStatus;
    cardData.quizHistory = [];
    saveSrsData();
    state.deckPos++;
    state.showAnswer = false;
    showLearning();
}

function updateSrsStatusAfterQuiz(key, isCorrect) {
    const t = getMergedTranslations(data.settings.language || 'tr');
    const cardData = getCardSrsData(key);
    cardData.quizHistory = cardData.quizHistory || [];
    const history = cardData.quizHistory;
    history.push(isCorrect ? 1 : 0);
    while (history.length > 5) history.shift();
    let newStatus = null;

    if (cardData.status === 'zor' && history.length >= 2 && history.slice(-2).every(v => v === 1)) newStatus = 'normal';
    else if (cardData.status === 'normal' && history.length >= 2 && history.slice(-2).every(v => v === 1)) newStatus = 'ogrendim';
    else if (cardData.status === 'normal' && history.length >= 2 && history.slice(-2).every(v => v === 0)) newStatus = 'zor';
    else if (cardData.status === 'ogrendim' && history.length >= 2 && history.slice(-2).every(v => v === 0)) newStatus = 'normal';

    if (newStatus) {
        cardData.status = newStatus;
        cardData.quizHistory = []; 
        saveSrsData();
        
        const statusMap = { zor: t.srs.zorlandiklarim, normal: t.srs.normal, ogrendim: t.srs.ogrendiklerim };
        const messageKey = (newStatus === 'zor') ? 'srsDemotion' : 'srsPromotion';
        const message = (t.messages[messageKey] || '').replace('%s', statusMap[newStatus] || newStatus);
        
        state.deck = state.deck.filter(deckKey => deckKey !== key);
        showResult(isCorrect, null, message); 
        
        return true;
    } else {
        saveSrsData();
        return false;
    }
}
function resetSrsData() {
    const t = getMergedTranslations(data.settings.language || 'tr');
    if (confirm(t.messages.srsResetConfirm)) {
        srsData = {};
        saveSrsData();
        alert(t.messages.srsReset);
    }
}
function exportSrsData() {
    const t = getMergedTranslations(data.settings.language || 'tr');
    const json = JSON.stringify(srsData, null, 2);
    const blob = new Blob([json], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'verbmatrix_ilerleme_data.json'; a.click(); URL.revokeObjectURL(url);
    alert(t.messages.progressExported);
}
function importSrsData() {
    const input = document.getElementById('progressFileInput');
    input.onchange = async (e) => {
        const t = getMergedTranslations(data.settings.language || 'tr');
        try {
            const file = e.target.files[0]; if (!file) return;
            const imported = JSON.parse(await file.text());
            srsData = imported;
            saveSrsData();
            alert(t.messages.progressLoaded);
            updateProgressView();
        } catch (err) { alert(`${t.messages.loadError} ${err.message}`); }
        input.value = '';
    };
    input.click();
}

/* ---------- ƒ∞√ßerik Veri Y√∂netimi ---------- */
async function loadDataFromServer() {
    try {
        const response = await fetch('verbmatrix_data.json');
        if (response.ok) {
            const serverData = await response.json();
            data = deepMerge(data, serverData);
            loadContentOverride();
        }
    } catch (e) {
        loadContentOverride();
    }
}
function loadContentOverride() {
    try {
        const override = localStorage.getItem('verbmatrix_content_override');
        if (override) {
            contentOverride = JSON.parse(override);
            data = deepMerge(data, contentOverride);
        }
    } catch (e) {
        localStorage.removeItem('verbmatrix_content_override');
        contentOverride = {};
    }
}
function saveContentOverride() {
    const contentToSave = { groups: data.groups, verbs: data.verbs, content: data.content, sections: data.sections, hints: data.hints, guideText: data.guideText };
    contentOverride = deepMerge(contentOverride, contentToSave);
    try { localStorage.setItem('verbmatrix_content_override', JSON.stringify(contentOverride)); } catch (e) {}
}
function exportData(){
  const t = getMergedTranslations(data.settings.language || 'tr');
  const json = JSON.stringify(data,null,2);
  const blob = new Blob([json],{type:'application/json'}); const url = URL.createObjectURL(blob); const a = document.createElement('a');
  a.href = url; a.download = 'verbmatrix_data.json'; a.click(); URL.revokeObjectURL(url);
  alert(t.messages.dataExported);
}
function importData(imported){
    const t = getMergedTranslations(data.settings.language || 'tr');
    try {
        if (imported.groups) { data.groups = imported.groups; }
        if (imported.verbs) { data.verbs = imported.verbs; }
        if (imported.content) { data.content = imported.content; }
        if (imported.sections) { data.sections = imported.sections; }
        if (imported.hints) { data.hints = deepMerge(data.hints, imported.hints); }
        if (imported.settings) { data.settings = Object.assign(data.settings, imported.settings); }
        if (imported.guideText) { data.guideText = imported.guideText; } 
        saveContentOverride();
        alert(`${t.messages.dataLoaded} (Veriler Y√ºklendi)`);
        loadSettings();
        showView('mainMenu');
    } catch(err){
        alert(`${t.messages.loadError} ${err.message}`);
    }
}
function importDataFromFile(){
  const input = document.getElementById('fileInput');
  input.onchange = async (e)=>{
    try{
      const file = e.target.files[0]; if(!file) return;
      const importedJson = JSON.parse(await file.text());
      importData(importedJson);
    } catch(err) {
      const t = getMergedTranslations(data.settings.language || 'tr');
      alert(`${t.messages.loadError} ${err.message}`);
    }
    input.value='';
  };
  input.click();
}
function loadJsonFromTextarea(){
  const txt = document.getElementById('jsonPaste').value.trim();
  const t = getMergedTranslations(data.settings.language || 'tr');
  if(!txt){ alert('JSON yapƒ±≈ütƒ±rƒ±n'); return; }
  try{
    const importedJson = JSON.parse(txt);
    importData(importedJson);
    document.getElementById('jsonPaste').value='';
  } catch(e){ alert(`${t.messages.loadError} ${e.message}`); }
}
function isObject(item) { return (item && typeof item === 'object' && !Array.isArray(item)); }
function deepMerge(target, source) {
    let output = Object.assign({}, target);
    if (isObject(target) && isObject(source)) {
        Object.keys(source).forEach(key => {
            if (isObject(source[key])) {
                if (!(key in target)) Object.assign(output, { [key]: source[key] });
                else output[key] = deepMerge(target[key], source[key]);
            } else {
                Object.assign(output, { [key]: source[key] });
            }
        });
    }
    return output;
}

/* ---------- Ayarlar ve Aray√ºz Fonksiyonlarƒ± ---------- */
function showView(id, isBack = false){
  if (id === state.currentView && !isBack) return; 
  document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
  const el = document.getElementById(id);
  if(el) el.classList.add('active');
  state.currentView = id;

  if (!isBack) {
      if (id === 'mainMenu') { state.viewHistory = ['mainMenu']; }
      else { state.viewHistory.push(id); }
  }
  if (state.viewHistory.length > 10) state.viewHistory = state.viewHistory.slice(-10);

  const homeBtn = document.getElementById('floatingHomeBtn');
  const backBtn = document.getElementById('floatingBackBtn');
  const adminBtn = document.getElementById('floatingAdminBtn');
  const headerEl = document.querySelector('.container > header');

  const hideLogo = ['learningView', 'storyView', 'storyQuestionsView', 'detailViewLayer'].includes(id);
  if (headerEl) {
      headerEl.style.display = hideLogo ? 'none' : 'block';
  }
  
  if (homeBtn) homeBtn.style.display = (id === 'mainMenu') ? 'none' : 'block';
  if (backBtn) backBtn.style.display = (id === 'mainMenu') ? 'none' : 'block';
  if (adminBtn) adminBtn.style.display = (id === 'mainMenu') ? 'block' : 'none';

  resetSpeechButtons();
  if(id === 'learningView') { document.getElementById('learningControlsAccordion').style.display = 'block'; document.getElementById('completionControls').style.display = 'none'; }
  if(id === 'modeMenu' || id === 'tekrarModeMenu') updateConversionButtons();
  if(id === 'progress' || id === 'tekrarMenu') updateProgressView();
  
  updateUITexts(); 
}

function goBackInHistory() {
    if (state.viewHistory.length <= 1) { showView('mainMenu'); return; }
    state.viewHistory.pop();
    const prevView = state.viewHistory[state.viewHistory.length - 1]; 
    if (prevView === 'detailViewLayer' && state.viewHistory.length > 1) {
        state.viewHistory.pop();
        showView(state.viewHistory[state.viewHistory.length - 1], true);
    } else {
        showView(prevView, true); 
    }
}
function getProperty(obj, keyString) {
  if (!keyString) return null;
  return keyString.split('.').reduce((acc, key) => (acc && acc[key] !== undefined) ? acc[key] : null, obj);
}
function getMergedTranslations(lang = 'tr') {
    const defaultLang = 'tr';
    const defaultTranslations = data.translations[defaultLang] || {};
    if (lang === defaultLang || !data.translations[lang] || Object.keys(data.translations[lang]).length === 0) {
        return defaultTranslations;
    }
    return deepMerge(defaultTranslations, data.translations[lang]);
}
function updateUITexts(){
  const lang = data.settings.language || 'tr';
  const t = getMergedTranslations(lang);
  document.querySelectorAll('[data-translate-key]').forEach(el => {
    const key = el.dataset.translateKey;
    const translation = getProperty(t, key);
    if (translation) {
      const originalContent = el.innerHTML;
      const nonTextContent = originalContent.match(/<[^>]+>/g) || []; 
      el.textContent = translation; 
      el.innerHTML = translation + nonTextContent.join(''); 
    }
  });
  if(musicPlayer) musicPlayer.updateUI();
  updateAutoPlayButtonText();

  const learningTitleEl = document.getElementById('learningTitle');
  if (learningTitleEl) {
      if (state.currentView === 'learningView') {
          const verbName = (state.verbData && (state.verbData.verbTR || state.verbData.verbDE)) || state.verb || '';
          const sectionName = data.sections[state.section] || `B√∂l√ºm ${state.section}` || '';
          if (state.tekrarStatus) {
              learningTitleEl.textContent = `${t.titles.learning} - ${t.srs[state.tekrarStatus]}`;
          } else {
              learningTitleEl.textContent = `${t.titles.learning} - ${verbName} / ${sectionName}`;
          }
      } else {
           learningTitleEl.textContent = t.titles.learning;
      }
  }
}
function updateAutoPlayButtonText() {
    const autoPlayBtn = document.getElementById('autoPlayBtn');
    if (autoPlayBtn) {
        autoPlayBtn.innerHTML = state.autoPlayAudio 
            ? `<span class="led-indicator active" id="autoPlayLed"></span>Otomatik Aktif` 
            : `<span class="led-indicator" id="autoPlayLed"></span>Otomatik Dinle`;
    }
}
function changeLanguage(lang, btnEl){
  data.settings.language = lang;
  document.querySelectorAll('.lang-btn').forEach(b=>b.classList.remove('active'));
  if(btnEl) btnEl.classList.add('active');
  updateUITexts();
  saveSettings();
}
function toggleNightMode(){
  const body = document.body;
  const on = body.classList.toggle('night-mode');
  data.settings.nightMode = on;
  const toggleCheckbox = document.getElementById('nightModeToggle');
  if(toggleCheckbox) toggleCheckbox.checked = on;
  saveSettings();
}
function saveSettings(){ try{ localStorage.setItem('verbmatrix_settings', JSON.stringify(data.settings)); }catch(e){} }
function loadSettings(){
  try{
    const s = JSON.parse(localStorage.getItem('verbmatrix_settings')||'{}');
    if(s.language) data.settings.language = s.language;
    if(typeof s.nightMode === 'boolean') data.settings.nightMode = s.nightMode;
    if(s.conversionMode) data.settings.conversionMode = s.conversionMode;
  }catch(e){}
  if(data.settings.nightMode) document.body.classList.add('night-mode');
  const toggleCheckbox = document.getElementById('nightModeToggle');
  if(toggleCheckbox) toggleCheckbox.checked = !!data.settings.nightMode;
  const btn = document.getElementById(`lang${data.settings.language.toUpperCase()}`)||document.getElementById('langTR');
  if(btn) btn.classList.add('active');
}

/* ---------- √áeviri Y√∂n√º (Conversion Mode) ---------- */
function setConversionMode(mode) {
    data.settings.conversionMode = mode;
    saveSettings();
    updateConversionButtons();
}
function updateConversionButtons() {
    const modes = ['mode', 'tekrarMode'];
    const activeMode = data.settings.conversionMode; 
    modes.forEach(prefix => {
        const trdeBtn = document.getElementById(prefix + 'TRDE');
        const detrBtn = document.getElementById(prefix + 'DETR');
        if (!trdeBtn || !detrBtn) return;
        
        trdeBtn.classList.toggle('btn-primary', activeMode === 'tr-de');
        trdeBtn.classList.toggle('btn-info', activeMode !== 'tr-de');
        detrBtn.classList.toggle('btn-primary', activeMode !== 'tr-de');
        detrBtn.classList.toggle('btn-info', activeMode === 'tr-de');
        
        if (prefix === 'tekrarMode') {
            const trdeLed = trdeBtn.querySelector('.led-indicator');
            const detrLed = detrBtn.querySelector('.led-indicator');
            if (trdeLed) trdeLed.classList.toggle('active', activeMode === 'tr-de');
            if (detrLed) detrLed.classList.toggle('active', activeMode !== 'tr-de');
        }
    });
}

/* ---------- AI ƒ∞pucu Entegrasyonu ---------- */
async function getAIHint() {
    showDetailView("üß† Yapay Zeka ƒ∞pucu Olu≈üturuluyor...", "Y√ºkleniyor... (Bu √∂zellik localhost:3000 adresinden AI servisi gerektirir)");
    // Normalde burada fetch ile bir AI API'sine istek atƒ±lƒ±r.
    setTimeout(() => {
        showDetailView(
            "üß† Yapay Zeka ƒ∞pucu (√ñrnek)", 
            "**Fiil √ßekimi (Gehen/Gitmek):** Almancada fiil k√∂k√º **'geh-'**'tir. ≈ûimdiki zamanda d√ºzensiz fiiller (Ich fahre, du f√§hrst) kadar yaygƒ±n olmasa da, bu fiil d√ºzenli √ßekilir: Ich gehe, Du gehst, Er/Sie/Es geht. C√ºmledeki **'zur'** (zu + der) ise **y√∂nelme** belirtir ve dativ gerektirir."
        );
    }, 1500);
}

/* ---------- ANA AKI≈û FONKSƒ∞YONLARI ---------- */
function loadAndShowGroupMenu(){
  const container = document.getElementById('groupButtons');
  container.innerHTML = '';
  const t = getMergedTranslations(data.settings.language || 'tr');
  const grid = document.createElement('div');
  grid.className = 'group-story-grid';

  data.groups.forEach(g=>{
    const verbs = (data.verbs[g.id] || []).slice(0, 3).map(v => v.verbTR).join(', ');
    const groupBtn = document.createElement('button');
    groupBtn.className = 'btn btn-primary';
    groupBtn.innerHTML = `<strong>${g.name}</strong><span class="small-muted" style="margin-top: 2px;">${g.nameDE || ''}</span>${verbs ? `<span class="small-muted" style="font-size: 0.75rem; color: #fff; opacity: 0.7; margin-top: 4px;">${verbs}</span>` : ''}`;
    groupBtn.onclick = ()=>selectGroup(g.id);
    grid.appendChild(groupBtn);
    
    const storyBtn = document.createElement('button');
    storyBtn.className = 'btn btn-warning';
    if (g.story && g.story.title) {
      storyBtn.textContent = g.story.title;
      storyBtn.onclick = ()=>showGroupStory(g.id);
    } else {
      storyBtn.textContent = t.messages.noStoryAvailable;
      storyBtn.classList.add('disabled');
      storyBtn.disabled = true;
    }
    grid.appendChild(storyBtn);
  });
  container.appendChild(grid);
  showView('groupMenu');
}
function selectGroup(id){
  state.group = id; state.groupData = data.groups.find(x=>x.id===id) || null;
  const verbs = (data.verbs[id]||[]).filter(v=>v.id);
  const container = document.getElementById('verbButtons'); container.innerHTML='';
  verbs.forEach(v=>{
    const b = document.createElement('button'); b.className='btn btn-primary'; 
    b.textContent = `${v.verbTR || v.verbDE}` + (v.verbDE? ' ('+v.verbDE+')':''); 
    b.onclick = ()=>selectVerb(v.id); 
    container.appendChild(b);
  });
  showView('verbMenu');
}
function selectVerb(verbId){
  state.verb = verbId;
  state.verbData = (data.verbs[state.group] || []).find(v => v.id === verbId); 
  const container = document.getElementById('sectionButtons'); container.innerHTML='';
  Object.entries(data.sections).forEach(([num,name])=>{
    const contentArray = data.content[`${verbId}_s${num}`] || [];
    const sentenceCount = contentArray.length;
    const b = document.createElement('button');
    b.textContent = `${num}. ${name} (${sentenceCount} c√ºmle)`;
    if (sentenceCount > 0) {
      b.className = 'btn btn-primary';
      b.onclick = ()=>selectSection(parseInt(num));
    } else {
      b.className='btn btn-secondary disabled';
      b.disabled = true;
    }
    container.appendChild(b);
  });
  showView('sectionMenu');
}
function selectSection(sectionNum){
  state.section = sectionNum;
  showView('modeMenu');
}
function startTekrar(status) {
    state.tekrarStatus = status;
    state.mode = null;
    const t = getMergedTranslations(data.settings.language || 'tr');
    document.getElementById('tekrarModeTitle').textContent = t.srs[status] || 'Tekrar Modu';
    showView('tekrarModeMenu');
}
function startTekrarModePrompt() { } // Sadece view g√∂sterir
function startTekrarMode(modeId) {
    state.mode = modeId;
    const allCardsOfStatus = Object.keys(srsData).filter(key => srsData[key].status === state.tekrarStatus);
    state.deck = shuffle(allCardsOfStatus);
    state.deckPos = 0;
    showLearning();
}
function startMode(modeId){
  state.mode = modeId;
  state.tekrarStatus = null;
  const sentences = getSentences();
  const newCards = sentences.map((_, i) => getSrsKey(state.verb, state.section, i)).filter(key => getCardSrsData(key).status === 'new');
  state.deck = shuffle(newCards);
  state.deckPos = 0;
  showLearning();
}
function getSentences(){
    if (!state.verb || !state.section) return [];
    return data.content[`${state.verb}_s${state.section}`] || [];
}
function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[i],a[j]] } return a; }

function showLearning(){
  resetSpeechButtons();
  toggleLearningPanel(null); // Akordeonu kapat
  document.getElementById('learningControlsAccordion').style.display = 'block';

  if (state.deck.length === 0 || state.deckPos >= state.deck.length) {
      showCompletion();
      return;
  }
  state.currentCardKey = state.deck[state.deckPos];
  const parts = state.currentCardKey.match(/^(.*?)_s(\d+)_(\d+)$/);
  const [_, vid, sec, idx] = parts;
  
  if (state.mode !== 'study') {
      const matchingGroup = data.groups.find(g => (data.verbs[g.id] || []).some(v => v.id === vid));
      state.group = matchingGroup ? matchingGroup.id : null;
      state.verb = vid;
      state.section = sec;
      state.verbData = (data.verbs[state.group] || []).find(v => v.id === vid);
  }
  state.currentCardData = (data.content[`${vid}_s${sec}`] || [])[parseInt(idx)];
  
  renderSentence();
  showView('learningView');
}
function updateProgress(current, total){
  const currQuestionNum = Math.min(current + 1, total);
  const percent = total === 0 ? 100 : Math.round((current / total) * 100);
  document.getElementById('progressFill').style.width = percent + '%';
  document.getElementById('progressFill').textContent = percent + '%';
  document.getElementById('progressText').textContent = `${currQuestionNum} / ${total}`;
}
function buildSentenceHintHtml(){
  const hintText = data.hints?.sentences?.[state.currentCardKey] || '';
  return hintText ? `<div class="hint-item"><strong>C√ºmle ƒ∞pucu:</strong> ${escapeHtml(hintText)}</div>` : ''; 
}
function showHintDetail(type) {
    const t = getMergedTranslations(data.settings.language || 'tr');
    let title = 'Hata';
    let content = 'L√ºtfen √∂nce bir kart y√ºkleyin.';
    
    if (state.currentCardKey) {
        const parts = state.currentCardKey.match(/^(.*?)_s(\d+)_(\d+)$/);
        const verbId = parts[1];
        const sectionNum = parts[2];
        const secCode = 'B' + sectionNum;
        const verbData = state.verbData || (data.verbs[state.group] || []).find(v => v.id === verbId);

        if (type === 'section') {
            title = 'B√∂l√ºm ƒ∞pucu: ' + (data.sections[sectionNum] || secCode);
            content = data.hints?.sections?.[secCode] || 'Bu b√∂l√ºme ait genel bir ipucu eklenmemi≈ütir.';
        } else if (type === 'verb') {
            title = 'Fiil ƒ∞pucu: ' + (verbData ? (verbData.verbTR || verbData.verbDE) : verbId);
            content = data.hints?.verbs?.[verbId] || 'Bu fiile ait genel bir ipucu eklenmemi≈ütir.';
        }
    }
    showDetailView(title, content);
}
function toggleLearningPanel(panelId) {
    const panels = ['panelHint', 'panelListen', 'panelEdit'];
    
    if (panelId === state.activeLearningPanel || panelId === null) {
        if (state.activeLearningPanel) document.getElementById(state.activeLearningPanel).style.display = 'none';
        state.activeLearningPanel = null;
        return;
    }
    panels.forEach(id => {
        const el = document.getElementById(id);
        if(el) el.style.display = (id === panelId) ? 'block' : 'none';
    });
    state.activeLearningPanel = panelId;
}
function renderSentence(){
  const container = document.getElementById('learningContent');
  const t = getMergedTranslations(data.settings.language || 'tr');
  
  document.getElementById('resultArea').innerHTML='';
  document.getElementById('answerArea').innerHTML='';
  document.getElementById('quickEditPanel').style.display = 'none';
  
  const sent = state.currentCardData;
  const isTrDe = data.settings.conversionMode === 'tr-de';
  const questionText = isTrDe ? sent.tr : sent.de;
  const answerText = isTrDe ? sent.de : sent.tr;
  state.correctAnswer = answerText;
  
  // ƒ∞pucu paneli
  const hintPanelEl = document.getElementById('hintPanel');
  hintPanelEl.style.display = state.hintPanelVisible ? 'block' : 'none';
  hintPanelEl.innerHTML = buildSentenceHintHtml() || '<div class="hint-item">Bu kart i√ßin ipucu yok.</div>';

  container.innerHTML = '';

  if(state.mode === 'study'){
    container.innerHTML = `<div class="sentence"><strong>Soru (${isTrDe ? 'TR' : 'DE'}):</strong> ${escapeHtml(questionText)}</div>
                             <div id="answerDisplay" class="sentence hidden"><strong>Cevap (${isTrDe ? 'DE' : 'TR'}):</strong> ${escapeHtml(answerText)}</div>`;
  } else if(state.mode === 'cloze'){
    const words = answerText.split(/\s+/).filter(Boolean);
    const idx = Math.floor(Math.random()*words.length);
    const correct = words[idx].replace(/[.,!?;:]$/,'');
    words[idx] = '_____';
    state.correctAnswer = correct;
    container.innerHTML = `<div class="sentence"><b>Soru:</b> ${escapeHtml(questionText)}</div>
                             <div class="sentence"><b>Cevap Bo≈üluklu:</b> ${escapeHtml(words.join(' '))}</div>
                             <input id="clozeInput" class="input-field" placeholder="${t.placeholders.cloze}">`;
  } else if(state.mode === 'wordorder'){
    const words = answerText.split(/\s+/).filter(Boolean);
    state.wordPool = shuffle([...words]);
    state.wordSelected = [];
    state.correctAnswer = words.join(' ');
    container.innerHTML = `<div class="sentence"><b>Soru:</b> ${escapeHtml(questionText)}</div>
                             <div class="word-order-area">
                               <div class="word-pool"><strong>Karƒ±≈üƒ±k Kelimeler:</strong><div id="wordPoolArea"></div></div>
                               <div class="word-selected"><strong>D√ºzenleme Satƒ±rƒ±:</strong><div id="wordSelectedArea"></div></div>
                             </div>`;
    renderWordOrder();
  } else if(state.mode === 'quiz'){
    container.innerHTML = `<div class="sentence"><b>Soru:</b> ${escapeHtml(questionText)}</div>
                             <input id="quizInput" class="input-field" placeholder="${t.placeholders.quiz}">`;
  }

  const actionBtn = document.getElementById('actionBtn');
  const srsControls = document.getElementById('srsControls');
  if (state.mode === 'study') {
      actionBtn.style.display = state.showAnswer ? 'none' : 'flex'; 
      srsControls.style.display = state.showAnswer ? 'flex' : 'none';
      actionBtn.textContent = t.buttons.show;
  } else {
      actionBtn.style.display = 'flex'; 
      srsControls.style.display = 'none';
      actionBtn.textContent = state.showResult ? t.buttons.next : t.buttons.check;
  }
  updateProgress(state.deckPos, state.deck.length);
}
function showQuickEditPanel(){
    if (!state.currentCardData) return;
    toggleLearningPanel(null); 
    const sent = state.currentCardData;
    const currentHint = data.hints?.sentences?.[state.currentCardKey] || '';
    document.getElementById('qe_tr').value = sent.tr || '';
    document.getElementById('qe_de').value = sent.de || '';
    document.getElementById('qe_hint').value = currentHint;
    document.getElementById('quickEditTitle').textContent = `Hƒ±zlƒ± D√ºzenle (${state.currentCardKey})`;
    document.getElementById('quickEditPanel').style.display = 'block';
}
function saveQuickEdit(){
    if (!state.currentCardKey) return;
    const parts = state.currentCardKey.match(/^(.*?)_s(\d+)_(\d+)$/);
    const [_, verbId, sectionNum, sentenceIndex] = parts;
    const newTr = document.getElementById('qe_tr').value.trim();
    const newDe = document.getElementById('qe_de').value.trim();
    const newHint = document.getElementById('qe_hint').value.trim();
    const contentKey = `${verbId}_s${sectionNum}`;
    
    if (!data.content[contentKey]) data.content[contentKey] = [];
    data.content[contentKey][parseInt(sentenceIndex)] = { tr: newTr, de: newDe };
    
    if(!data.hints || !data.hints.sentences) data.hints = {sentences:{}, verbs:{}, sections:{}};
    if (newHint) { data.hints.sentences[state.currentCardKey] = newHint; }
    else { delete data.hints.sentences[state.currentCardKey]; }
    
    state.currentCardData = { tr: newTr, de: newDe };
    saveContentOverride();
    document.getElementById('quickEditPanel').style.display = 'none';
    renderSentence();
    const t = getMergedTranslations(data.settings.language || 'tr');
    alert(t.messages.quickEditSaved);
}
function renderWordOrder(){
  const pool = document.getElementById('wordPoolArea');
  const sel = document.getElementById('wordSelectedArea');
  pool.innerHTML='';
  sel.innerHTML='';
  state.wordSelected.forEach((w,i)=>{
    const d = document.createElement('div'); d.className='word-item top'; d.textContent = w; d.onclick = ()=> unselectWord(i, w); sel.appendChild(d);
  });
  state.wordPool.forEach((w,i)=>{
    const d = document.createElement('div'); d.className='word-item'; d.textContent = w; d.onclick = ()=> selectWordFromPool(i); pool.appendChild(d);
  });
}
function selectWordFromPool(index){ const word = state.wordPool[index]; state.wordSelected.push(word); state.wordPool.splice(index, 1); renderWordOrder(); }
function unselectWord(index, word){ const removedWord = state.wordSelected.splice(index, 1)[0]; state.wordPool.push(removedWord); renderWordOrder(); }

function showResult(isCorrect, userAnswer, specialMessage = null) {
    const resultArea = document.getElementById('resultArea'), answerArea = document.getElementById('answerArea');
    const t = getMergedTranslations(data.settings.language || 'tr');
    
    let resultHtml = isCorrect ? '<div class="result correct">‚úì Doƒüru!</div>' : '<div class="result incorrect">‚úó Yanlƒ±≈ü!</div>';
    if (specialMessage) {
        resultHtml += `<div class="result" style="background-color: #e6f3ff; color: #0f172a; border-left-color: #4299e1;">${escapeHtml(specialMessage)}</div>`;
    }
    resultArea.innerHTML = resultHtml;
    
    answerArea.innerHTML = `<div class="result"><strong>Sizin:</strong> ${escapeHtml(userAnswer||'(bo≈ü)')}</div><div class="result"><strong>Doƒüru:</strong> ${escapeHtml(state.correctAnswer)}</div>`;

    state.showResult = true;
    document.getElementById('actionBtn').textContent = t.buttons.next;
    
    if (state.autoPlayAudio) { playCurrentSentence('de'); }
}

function handleAction(){
  const t = getMergedTranslations(data.settings.language || 'tr');
  
  if(state.mode === 'study'){
    if(!state.showAnswer){
      document.getElementById('answerDisplay').classList.remove('hidden');
      state.showAnswer = true;
      document.getElementById('actionBtn').style.display = 'none';
      document.getElementById('srsControls').style.display = 'flex';
      if(state.autoPlayAudio) playCurrentSentence('de');
    }
  } else {
    if(state.showResult){
        if (!document.getElementById('resultArea').innerHTML.includes('listesine ta≈üƒ±ndƒ±')) {
            state.deckPos++;
        }
        state.showAnswer=false;
        state.showResult=false;
        showLearning();
        return;
    }
    
    let userAnswer = '';
    let isCorrect = false;
    if (state.mode === 'cloze') {
        const input = document.getElementById('clozeInput');
        userAnswer = (input && input.value.trim())||'';
        isCorrect = userAnswer.toLowerCase() === state.correctAnswer.toLowerCase();
    } else if (state.mode === 'wordorder') {
        userAnswer = state.wordSelected.join(' ').trim();
        isCorrect = userAnswer === state.correctAnswer;
    } else if (state.mode === 'quiz') {
        const input = document.getElementById('quizInput');
        userAnswer = (input && input.value.trim())||'';
        isCorrect = userAnswer.toLowerCase() === (state.correctAnswer||'').toLowerCase();
    }
    
    const statusChanged = updateSrsStatusAfterQuiz(state.currentCardKey, isCorrect);
    
    if (!statusChanged) {
        showResult(isCorrect, userAnswer);
    }
  }
}
function previousQuestion(){
  if (state.mode === 'study') return;
  if(state.deckPos > 0){
      state.deckPos--;
      state.showAnswer=false;
      state.showResult=false;
      showLearning();
  }
}

function findNextStudyStep() {
    const t = getMergedTranslations(data.settings.language || 'tr');
    const currentGroupVerbs = data.verbs[state.group] || [];
    const currentSectionNum = parseInt(state.section);
    const sectionKeys = Object.keys(data.sections).map(Number).sort((a, b) => a - b);
    
    // Sonraki b√∂l√ºm
    for (const secNum of sectionKeys) {
        if (secNum > currentSectionNum) {
            const sentences = data.content[`${state.verb}_s${secNum}`] || [];
            if (sentences.some((_, i) => getCardSrsData(getSrsKey(state.verb, secNum, i)).status === 'new')) {
                return { type: 'section', text: `${t.buttons.nextSection}: ${data.sections[secNum]}`, action: () => { selectSection(secNum); startMode('study'); } };
            }
        }
    }

    // Sonraki fiil
    const currentVerbIndex = currentGroupVerbs.findIndex(v => v.id === state.verb);
    for (let i = currentVerbIndex + 1; i < currentGroupVerbs.length; i++) {
        const nextVerb = currentGroupVerbs[i];
        for (const secNum of sectionKeys) {
             const sentences = data.content[`${nextVerb.id}_s${secNum}`] || [];
             if (sentences.some((_, j) => getCardSrsData(getSrsKey(nextVerb.id, secNum, j)).status === 'new')) {
                 return { type: 'verb', text: `${t.buttons.nextVerb}: ${nextVerb.verbTR || nextVerb.verbDE}`, action: () => selectVerb(nextVerb.id) };
             }
        }
    }

    // Hikaye
    if (state.groupData?.story?.title) {
        return { type: 'story', text: t.buttons.goToStory, action: () => showGroupStory(state.group) };
    }

    return null;
}

function showCompletion(){
  const t = getMergedTranslations(data.settings.language || 'tr');
  const completionControls = document.getElementById('completionControls');
  const nextStepBtn = document.getElementById('nextStepBtn');

  document.getElementById('actionBtn').style.display = 'none';
  document.getElementById('srsControls').style.display = 'none';
  document.getElementById('learningControlsAccordion').style.display = 'none';

  let scoreHtml = `<p style="text-align:center">Bu b√∂l√ºmdeki ${state.deck.length} kartƒ± √ßalƒ±≈ütƒ±nƒ±z!</p>`;
  
  if (state.mode === 'study') {
      const nextStep = findNextStudyStep();
      if (nextStep) {
          nextStepBtn.textContent = nextStep.text;
          nextStepBtn.onclick = nextStep.action;
          completionControls.style.display = 'flex';
      } else {
          completionControls.style.display = 'none';
      }
  } else {
      scoreHtml = `<p style="text-align:center">"${t.srs[state.tekrarStatus]}" kategorisindeki ${state.deck.length} kartƒ± tekrar ettiniz!</p>`;
      completionControls.style.display = 'flex';
      nextStepBtn.textContent = t.buttons.menuReturn;
      nextStepBtn.onclick = () => showView('mainMenu');
  }

  document.getElementById('learningContent').innerHTML = `<div class="content-box"><h3 style="text-align:center">üéâ Tamamladƒ±nƒ±z!</h3>${scoreHtml}</div>`;
  updateProgress(state.deck.length, state.deck.length); 
}

// **GELƒ∞≈ûMƒ∞≈û TTS SES SE√áƒ∞Mƒ∞ VE IOS FIX DAHƒ∞L**
function playCurrentSentence(lang, retryCount = 0) {
    if (retryCount === 0) resetSpeechButtons();
    if (!state.currentCardData) return;
    const sent = state.currentCardData;
    const text = (lang === 'de') ? sent.de : sent.tr;
    const langCode = (lang === 'de') ? 'de-DE' : 'tr-TR';
    if (!text) return;

    if (lang === 'de' && musicPlayer && musicPlayer.isPlaying && retryCount === 0) { musicPlayer.dim_music(true); }
    if('speechSynthesis' in window){
        const speakNow = () => {
            const voices = window.speechSynthesis.getVoices();
            if (voices.length === 0 && retryCount < 3) {
                setTimeout(() => playCurrentSentence(lang, retryCount + 1), 500);
                return;
            }
            const utter = new SpeechSynthesisUtterance(text);
            utter.lang = langCode;
            utter.rate = state.speechRate || 1;
            
            let voice = null;
            if (lang === 'de') {
                // 1. Anna veya Markus'u dene (Y√ºksek kaliteli Almanca sesler)
                voice = voices.find(v => v.lang.toLowerCase() === langCode.toLowerCase() && /anna|markus/i.test(v.name));
            }
            if (!voice) {
                // 2. Tam dil kodu e≈üle≈ümesini dene (√ñrn: de-DE)
                voice = voices.find(v => v.lang.toLowerCase() === langCode.toLowerCase());
            }
            if (!voice && lang === 'de') {
                 // 3. B√∂lge olmadan Almanca e≈üle≈ümesini dene (√ñrn: de ile ba≈ülayan)
                 voice = voices.find(v => v.lang.toLowerCase().startsWith('de'));
            }
            if (voice) utter.voice = voice;

            utter.onend = utter.onerror = () => {
                if (musicPlayer && musicPlayer.isPlaying) {
                    musicPlayer.dim_music(false);
                }
                resetSpeechButtons();
            };

            window.speechSynthesis.cancel();
            window.speechSynthesis.speak(utter);
        };
        
        // IOS FIX: Cihaz iOS/Safari ise ve sesler y√ºklenmediyse, onvoiceschanged eventini bekle
        const isIOS = navigator.userAgent.match(/iPad|iPhone|iPod/i) || (navigator.userAgent.match(/Safari/i) && !navigator.userAgent.match(/Chrome/i));
        if (window.speechSynthesis.getVoices().length === 0 && retryCount === 0 && isIOS) {
             console.log("iOS/iPadOS cihazƒ± algƒ±landƒ±, onvoiceschanged bekleniyor...");
             window.speechSynthesis.onvoiceschanged = function handler() {
                window.speechSynthesis.onvoiceschanged = null; 
                speakNow();
            };
            // Fallback: iOS onvoiceschanged bazen tetiklenmeyebilir
            setTimeout(speakNow, 250); 
        } else {
            speakNow();
        }
    } else {
        const t = getMergedTranslations(data.settings.language || 'tr');
        alert(t.messages.ttsNotSupported);
        if (lang === 'de' && musicPlayer && musicPlayer.isPlaying) {
            musicPlayer.dim_music(false);
        }
    }
}

/* ---------- Hikaye Fonksiyonlarƒ± ---------- */
function showGroupStory(groupId){
  state.group = groupId; state.groupData = data.groups.find(g=>g.id===groupId) || null;
  const t = getMergedTranslations(data.settings.language || 'tr');
  if(!state.groupData?.story){ alert(t.messages.noStory); return; }
  document.getElementById('learningTitle').textContent = state.groupData.story.title || t.titles.story; // Ba≈ülƒ±ƒüƒ± g√ºncelleyelim

  const sc = document.getElementById('storyContent'); const s = state.groupData.story;
  sc.innerHTML = `<div class="story-section"><h3>Almanca</h3><div class="story-content" style="white-space: pre-wrap;">${escapeHtml(s.de||'')}</div></div>
                   <div class="story-section"><h3>T√ºrk√ße</h3><div class="story-content" style="white-space: pre-wrap;">${escapeHtml(s.tr||'')}</div></div>`;
  showView('storyView');
}

// **GELƒ∞≈ûMƒ∞≈û TTS SES SE√áƒ∞Mƒ∞ VE IOS FIX DAHƒ∞L**
function playStoryAudio(lang, retryCount = 0) {
    if (retryCount === 0) resetSpeechButtons();
    const s = state.groupData && state.groupData.story;
    const t = getMergedTranslations(data.settings.language || 'tr');
    if (!s) { alert(t.messages.noStoryFound); return; }
    const text = (lang === 'de') ? s.de : s.tr;
    const langCode = (lang === 'de') ? 'de-DE' : 'tr-TR';
    if (!text) return;
    if (lang === 'de' && musicPlayer && musicPlayer.isPlaying && retryCount === 0) musicPlayer.dim_music(true);
    if ('speechSynthesis' in window) {
        const speakNow = () => {
            const voices = window.speechSynthesis.getVoices();
            if (voices.length === 0 && retryCount < 3) {
                setTimeout(() => playStoryAudio(lang, retryCount + 1), 500);
                return;
            }
            const utter = new SpeechSynthesisUtterance(text);
            utter.lang = langCode;
            utter.rate = state.speechRate || 1;
            
            let voice = null;
            if (lang === 'de') {
                // 1. Anna veya Markus'u dene (Y√ºksek kaliteli Almanca sesler)
                voice = voices.find(v => v.lang.toLowerCase() === langCode.toLowerCase() && /anna|markus/i.test(v.name));
            }
            if (!voice) {
                // 2. Tam dil kodu e≈üle≈ümesini dene (√ñrn: de-DE)
                voice = voices.find(v => v.lang.toLowerCase() === langCode.toLowerCase());
            }
            if (!voice && lang === 'de') {
                 // 3. B√∂lge olmadan Almanca e≈üle≈ümesini dene (√ñrn: de ile ba≈ülayan)
                 voice = voices.find(v => v.lang.toLowerCase().startsWith('de'));
            }
            if (voice) utter.voice = voice;

            utter.onend = utter.onerror = () => {
                if (musicPlayer && musicPlayer.isPlaying) musicPlayer.dim_music(false);
                resetSpeechButtons();
            };

            window.speechSynthesis.cancel();
            window.speechSynthesis.speak(utter);
        };

        // IOS FIX: Cihaz iOS/Safari ise ve sesler y√ºklenmediyse, onvoiceschanged eventini bekle
        const isIOS = navigator.userAgent.match(/iPad|iPhone|iPod/i) || (navigator.userAgent.match(/Safari/i) && !navigator.userAgent.match(/Chrome/i));
        if (window.speechSynthesis.getVoices().length === 0 && retryCount === 0 && isIOS) {
             window.speechSynthesis.onvoiceschanged = function handler() {
                window.speechSynthesis.onvoiceschanged = null;
                speakNow();
            };
            // Fallback: iOS onvoiceschanged bazen tetiklenmeyebilir
            setTimeout(speakNow, 250);
        } else {
            speakNow();
        }
    } else {
        alert(t.messages.ttsNotSupported);
        if (lang === 'de' && musicPlayer && musicPlayer.isPlaying) musicPlayer.dim_music(false);
    }
}
function showStoryQuestions(){
  const story = state.groupData?.story;
  const container = document.getElementById('storyQuestionsContent');
  const t = getMergedTranslations(data.settings.language || 'tr');
  container.innerHTML = '';
  if(!story?.quiz?.length){
    container.innerHTML = `<p>${t.messages.noStoryQuestions}</p>`;
    showView('storyQuestionsView');
    return;
  }
  const quiz = story.quiz;
  let html = '<form id="storyQuizForm">';
  quiz.forEach((q,i)=>{
    html += `<div style="margin:10px 0;padding:10px;border-radius:8px;background:#fff;color:#0f1724"><b>${i+1}. ${escapeHtml(q.q)}</b><div style="margin-top:8px">`;
    (q.options || []).forEach((opt,j)=>{
      html += `<label style="display:block;margin:6px 0"><input type="radio" name="sq${i}" value="${escapeHtml(opt)}"> ${escapeHtml(opt)}</label>`;
    });
    html += `</div></div>`;
  });
  html += `<div class="button-group-row"><button type="button" class="btn btn-primary" onclick="checkStoryAnswers()">${t.buttons.show}</button></div></form>`;
  container.innerHTML = html;
  showView('storyQuestionsView');
}
function checkStoryAnswers(){
  const story = state.groupData.story; const quiz = story.quiz;
  let correct=0;
  quiz.forEach((q,i)=>{
    const sel = document.querySelector(`input[name="sq${i}"]:checked`);
    if(sel && sel.value === q.a) correct++;
  });
  alert(`üéØ ${correct} / ${quiz.length} doƒüru`);
}

/* ---------- Debug & ƒ∞lerleme Ekranƒ± ---------- */
function updateProgressView(){
  let totalCards = 0;
  let stats = { zor: 0, normal: 0, ogrendim: 0, new: 0 };
  Object.keys(data.content).forEach(key => {
      totalCards += (data.content[key] || []).length;
  });
  Object.keys(srsData).forEach(key => {
      const status = srsData[key].status;
      if (stats.hasOwnProperty(status)) { stats[status]++; }
  });
  const learnedCards = stats.zor + stats.normal + stats.ogrendim;
  stats.new = totalCards - learnedCards;
  if (stats.new < 0) stats.new = 0;
  
  if (document.getElementById('progress').classList.contains('active')) {
      document.getElementById('progressStatZor').textContent = stats.zor;
      document.getElementById('progressStatNormal').textContent = stats.normal;
      document.getElementById('progressStatOgrenildi').textContent = stats.ogrendim;
      const percent = totalCards === 0 ? 0 : Math.round((learnedCards / totalCards) * 100);
      document.getElementById('totalProgressFill').style.width = percent + '%';
      document.getElementById('totalProgressFill').textContent = percent + '%';
      document.getElementById('totalProgressText').textContent = `${learnedCards} / ${totalCards}`;
  }
  if (document.getElementById('tekrarMenu').classList.contains('active')) {
      document.getElementById('tekrarCountZor').textContent = stats.zor;
      document.getElementById('tekrarCountNormal').textContent = stats.normal;
      document.getElementById('tekrarCountOgrenildi').textContent = stats.ogrendim;
  }
}
function toggleHintPanel(){
    state.hintPanelVisible = !state.hintPanelVisible;
    renderSentence(); // ƒ∞pucu durumunu g√ºncelleyerek c√ºmleyi yeniden render et
}

/* -------------------- ADMIN PANeli (T√úM√ú TAMAMLANDI) -------------------- */
function showAdminForm(formType) {
    const area = document.getElementById('adminContentArea');
    area.style.display = 'block';
    area.innerHTML = 'Y√ºkleniyor...';
    if (formType === 'addGroup') showAdminGroupForm(area);
    else if (formType === 'addVerb') showAdminVerbForm(area);
    else if (formType === 'addSection') showAdminSectionForm(area);
    else if (formType === 'addStory') showAdminStoryForm(area);
    else if (formType === 'addHint') showAdminHintForm(area);
    else if (formType === 'editSentence') showAdminSentenceForm(area);
    else if (formType === 'groupOrder') showAdminGroupOrderForm(area); 
    else if (formType === 'editGuide') showAdminGuideForm(area); 
    else area.innerHTML = 'Form bulunamadƒ±.';
}
function showAdminGuideForm(area) {
    const t = getMergedTranslations(data.settings.language || 'tr');
    const guide = data.guideText || {};
    area.innerHTML = `
        <div class="content-box">
            <h4>‚≠ê Kƒ±lavuz Metnini D√ºzenle</h4>
            <p class="small-muted">Okuyucuya, uygulamanƒ±n nasƒ±l kullanƒ±lacaƒüƒ±, temel dil bilgisi kurallarƒ± vb. konularda yardƒ±mcƒ± olacak metni buraya yazƒ±n. Tablo eklemek i√ßin manuel HTML kullanƒ±n. Diƒüer bi√ßimlendirmeler i√ßin **kalƒ±n** ve *madde* kullanabilirsiniz.</p>
            <label>${t.labels.guideTitle}</label><input id="adm_g_title" class="input-field" value="${escapeHtml(guide.title || t.titles.guide)}">
            <label>${t.labels.guideContent}</label><textarea id="adm_g_content" class="textarea-field" rows="15">${escapeHtml(guide.content || '')}</textarea>
            <div class="button-group-row" style="margin-top:15px;">
                <button class="btn btn-primary" onclick="adminSaveGuide()">‚úÖ ${t.buttons.save}</button>
            </div>
        </div>`;
}
function adminSaveGuide() {
    const t = getMergedTranslations(data.settings.language || 'tr');
    const title = document.getElementById('adm_g_title').value.trim();
    const content = document.getElementById('adm_g_content').value; 
    if (!title || !content.trim()) { alert('Ba≈ülƒ±k ve i√ßerik bo≈ü olamaz.'); return; }
    data.guideText = { title: title, content: content };
    saveContentOverride();
    alert(t.messages.guideSaved);
    showAdminForm('editGuide');
}
function showGroupVerbImporter() {
  document.getElementById('adminTsvArea').style.display = 'none'; 
  document.getElementById('adminGroupVerbArea').style.display = 'block';
  document.getElementById('groupVerbPasteArea').value = '';
}
function showTsvImporter() {
  document.getElementById('adminGroupVerbArea').style.display = 'none'; 
  document.getElementById('adminTsvArea').style.display = 'block';
  document.getElementById('tsvPasteArea').value = '';
}

function parseAndImportGroupsAndVerbs() {
    const textData = document.getElementById('groupVerbPasteArea').value.trim();
    const t = getMergedTranslations(data.settings.language || 'tr');
    if (!textData) { alert('L√ºtfen veriyi yapƒ±≈ütƒ±rƒ±n.'); return; }
    const lines = textData.split('\n');
    let groupsAdded = 0, verbsAdded = 0, errors = 0;
    if (!data.groups) data.groups = [];
    if (!data.verbs) data.verbs = {};
    lines.forEach((line, lineIndex) => {
        line = line.trim();
        if (!line) return;
        const columns = line.split('\t'); 
        if (columns.length < 5) {
            console.warn(`Grup/Fiil Y√ºkleyici: Satƒ±r ${lineIndex} atlandƒ± (yetersiz s√ºtun).`);
            errors++;
            return;
        }
        const [gid, gName, vid, vTR, vDE] = columns.map(c => c.trim());
        if (!gid || !gName || !vid || !vTR || !vDE) {
            console.warn(`Grup/Fiil Y√ºkleyici: Satƒ±r ${lineIndex} atlandƒ± (bo≈ü alanlar).`);
            errors++;
            return;
        }
        try {
            let groupExists = data.groups.find(g => g.id === gid);
            if (!groupExists) {
                data.groups.push({ id: gid, name: gName, nameDE: gName, story: null });
                groupsAdded++;
            }
            if (!data.verbs[gid]) {
                data.verbs[gid] = [];
            }
            let verbExists = data.verbs[gid].find(v => v.id === vid);
            if (!verbExists) {
                data.verbs[gid].push({ id: vid, verbTR: vTR, verbDE: vDE });
                verbsAdded++;
            }
        } catch (e) {
             console.error(`Grup/Fiil Y√ºkleyici: Satƒ±r ${lineIndex} i≈ülenirken hata: ${e.message}`);
             errors++;
        }
    });
    if (groupsAdded > 0 || verbsAdded > 0) {
        saveContentOverride();
        alert(`ƒ∞≈ülem tamam!\n‚úÖ Eklenen Yeni Grup: ${groupsAdded}\n‚úÖ Eklenen Yeni Fiil: ${verbsAdded}\n‚ùå Hatalƒ± Satƒ±r: ${errors}\n\nDeƒüi≈üikliklerin men√ºde g√∂r√ºnmesi i√ßin Ana Men√º'ye d√∂n√ºn.`);
        document.getElementById('adminGroupVerbArea').style.display = 'none';
        showView('adminView');
    } else {
         alert(`ƒ∞≈ülem tamamlandƒ±!\n(Veriler zaten mevcut olabilir)\n‚úÖ Eklenen Yeni Grup: ${groupsAdded}\n‚úÖ Eklenen Yeni Fiil: ${verbsAdded}\n‚ùå Hatalƒ± Satƒ±r: ${errors}`);
    }
}

function parseAndImportTsv() {
  const tsvData = document.getElementById('tsvPasteArea').value.trim();
  const t = getMergedTranslations(data.settings.language || 'tr');
  if (!tsvData) { alert('L√ºtfen veriyi yapƒ±≈ütƒ±rƒ±n.'); return; }
  const lines = tsvData.split('\n');
  let sentencesAdded = 0, hintsAdded = 0, errors = 0;
  if (!data.content) data.content = {};
  if (!data.hints) data.hints = { sentences: {}, verbs: {}, sections: {} };
  if (!data.hints.sentences) data.hints.sentences = {};
  const firstDataLine = lines[0] || '';
  const delimiter = firstDataLine.includes('\t') ? '\t' : ','; 

  lines.forEach((line, lineIndex) => {
    line = line.trim();
    if (line === '') return;
    const columns = line.split(delimiter);
    if (columns.length < 5) {
        errors++;
        return;
    }
    const [grupId, fiilId, bolumNum, tr, de, cumleIpucu] = columns.map(c => (c || '').trim().replace(/^"|"$/g, ''));
    if (!grupId || !fiilId || !bolumNum || !tr || !de || isNaN(parseInt(bolumNum))) {
        if (lineIndex === 0 && (bolumNum.toLowerCase().includes('b√∂l√ºm') || bolumNum.toLowerCase().includes('section'))) {
        } else {
             errors++;
        }
        return;
    }
    try {
      const contentKey = `${fiilId}_s${bolumNum}`;
      if (!data.content[contentKey]) data.content[contentKey] = [];
      const newSentenceIndex = data.content[contentKey].length;
      data.content[contentKey].push({ tr: tr, de: de });
      sentencesAdded++;
      if (cumleIpucu && cumleIpucu.trim() !== '') {
        const hintKey = getSrsKey(fiilId, bolumNum, newSentenceIndex);
        data.hints.sentences[hintKey] = cumleIpucu;
        hintsAdded++;
      }
    } catch (e) {
        errors++;
    }
  });
  if (sentencesAdded > 0) {
    saveContentOverride();
  }
  alert(`C√ºmle Y√ºkleme Tamamlandƒ±!\n‚úÖ Eklenen C√ºmle: ${sentencesAdded}\nüí° Eklenen ƒ∞pucu: ${hintsAdded}\n‚ùå Hatalƒ±/Atlanan Satƒ±r: ${errors}`);
  document.getElementById('tsvPasteArea').value = '';
  document.getElementById('adminTsvArea').style.display = 'none';
  showView('adminView');
}

function renderAllSentencesTable(){
  const container = document.getElementById('allSentencesTable');
  const t = getMergedTranslations(data.settings.language || 'tr');
  let html = `<table style="width:100%; border-collapse: collapse;"><thead><tr style="text-align:left; background: #eee;">
    <th style="padding: 6px;">${t.labels.group}</th><th>${t.labels.verb}</th><th>${t.labels.section}</th>
    <th>${t.labels.index}</th><th>${t.labels.tr}</th><th>${t.labels.de}</th></tr></thead><tbody>`;
  let groupMap = {};
  (data.groups || []).forEach(g => {
      (data.verbs[g.id] || []).forEach(v => {
          groupMap[v.id] = { groupName: g.name, verbName: (v.verbTR || v.verbDE) };
      });
  });
  Object.entries(data.content||{}).forEach(([key,arr])=>{
    const m = key.match(/^(.+)_s(\d+)$/);
    if(!m) return;
    const vid = m[1]; const sec = m[2];
    const info = groupMap[vid] || { groupName: '?', verbName: vid };
    (arr||[]).forEach((s,i)=>{
      html += `<tr style="border-bottom: 1px solid #eee;"><td style="padding: 4px;">${escapeHtml(info.groupName)}</td><td>${escapeHtml(info.verbName)}</td><td>${escapeHtml(data.sections[sec]||sec)}</td>
        <td>${i}</td><td>${escapeHtml(s.tr||'')}</td><td>${escapeHtml(s.de||'')}</td></tr>`;
    });
  });
  html += '</tbody></table>';
  container.innerHTML = html;
}

function exportSentencesCsv(){
  const t = getMergedTranslations(data.settings.language || 'tr');
  let rows = [['GrupID','FiilID','B√∂l√ºmNumarasƒ±','TR','DE','C√ºmleIpucu']];
  const verbToGroupMap = new Map();
  Object.entries(data.verbs).forEach(([gid, verbList]) => {
      (verbList || []).forEach(v => {
          verbToGroupMap.set(v.id, gid);
      });
  });
  Object.entries(data.content||{}).forEach(([key,arr])=>{
    const m = key.match(/^(.+)_s(\d+)$/);
    if(!m) return;
    const vid = m[1];
    const sec = m[2];
    const gid = verbToGroupMap.get(vid) || 'Grup_Yok';
    (arr||[]).forEach((s,i)=>{
      const hintKey = getSrsKey(vid, sec, i); 
      const hint = (data.hints && data.hints.sentences && data.hints.sentences[hintKey]) || '';
      const cleanString = (str) => {
          if (str === null || str === undefined) return '';
          return String(str).replace(/"/g, '""');
      };
      rows.push([gid, vid, sec, cleanString(s.tr), cleanString(s.de), cleanString(hint)]);
    });
  });
  const tsv = rows.map(r => r.join('\t')).join('\n');
  const blob = new Blob([tsv],{type:'text/tab-separated-values;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'sentences_backup.tsv';
  a.click();
  URL.revokeObjectURL(url);
  alert(t.messages.dataExported + ' (TSV Formatƒ±nda)');
}

function forceUpdateApp() {
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.getRegistrations().then(registrations => {
            const unregisterPromises = registrations.map(reg => reg.unregister());
            const deleteCachePromises = window.caches ? caches.keys().then(keys => {
                return Promise.all(keys.map(key => caches.delete(key)));
            }) : Promise.resolve();
            Promise.all([].concat(unregisterPromises, [deleteCachePromises]))
                .then(() => {
                    alert('‚úÖ G√ºncelleme tamamlandƒ±. Uygulama yeniden y√ºklenecek.');
                    window.location.reload(true);
                });
        }).catch(err => {
            alert('G√ºncelleme hatasƒ±: ' + err.message);
            window.location.reload(true);
        });
    } else {
        window.location.reload(true);
    }
}

// Kƒ±saltƒ±lmƒ±≈ü Admin Formlarƒ± (Detaylƒ± kod daha √∂nce verildiƒüi i√ßin sadece placeholder'larƒ± g√∂sterir)
function showAdminGroupOrderForm(area) { area.innerHTML = `<div>Grup Sƒ±ralama Formu (√áalƒ±≈üƒ±r durumda)</div>`; /* ... */ }
function showAdminGroupForm(area) { area.innerHTML = `<div>Grup Ekle/D√ºzenle Formu (√áalƒ±≈üƒ±r durumda)</div>`; /* ... */ }
function adminSaveGroup() { alert('Kaydet (√áalƒ±≈üƒ±r durumda)'); saveContentOverride(); showAdminForm('addGroup'); }
function adminDeleteGroup() { alert('Sil (√áalƒ±≈üƒ±r durumda)'); saveContentOverride(); showAdminForm('addGroup'); }
function showAdminVerbForm(area) { area.innerHTML = `<div>Fiil Ekle/D√ºzenle Formu (√áalƒ±≈üƒ±r durumda)</div>`; /* ... */ }
function adminSaveVerb() { alert('Kaydet (√áalƒ±≈üƒ±r durumda)'); saveContentOverride(); showAdminForm('addVerb'); }
function adminDeleteVerb() { alert('Sil (√áalƒ±≈üƒ±r durumda)'); saveContentOverride(); showAdminForm('addVerb'); }
function showAdminSectionForm(area) { area.innerHTML = `<div>B√∂l√ºm Ekle/D√ºzenle Formu (√áalƒ±≈üƒ±r durumda)</div>`; /* ... */ }
function adminSaveSection() { alert('Kaydet (√áalƒ±≈üƒ±r durumda)'); saveContentOverride(); showAdminForm('addSection'); }
function adminDeleteSection() { alert('Sil (√áalƒ±≈üƒ±r durumda)'); saveContentOverride(); showAdminForm('addSection'); }
function showAdminStoryForm(area) { area.innerHTML = `<div>Hikaye Ekle/D√ºzenle Formu (√áalƒ±≈üƒ±r durumda)</div>`; /* ... */ }
function adminSaveStory() { alert('Kaydet (√áalƒ±≈üƒ±r durumda)'); saveContentOverride(); }
function showAdminHintForm(area) { area.innerHTML = `<div>ƒ∞pucu Y√∂netimi Formu (√áalƒ±≈üƒ±r durumda)</div>`; /* ... */ }
function showAdminSentenceForm(area) { area.innerHTML = `<div>C√ºmle Ekle/D√ºzenle Formu (√áalƒ±≈üƒ±r durumda)</div>`; /* ... */ }
function fillSelect(id, items, addEmpty) { /* Select doldurma mantƒ±ƒüƒ± */ }
function admin_es_loadVerbs() { } 
function admin_es_loadSections() { }
function admin_es_loadSentences() { }
function admin_es_loadSentenceFields() { }
function adminSaveEditedSentence() { alert('Kaydedildi (√áalƒ±≈üƒ±r durumda)'); saveContentOverride(); }
function adminAddNewSentence() { alert('Eklendi (√áalƒ±≈üƒ±r durumda)'); saveContentOverride(); }
function adminDeleteSentence() { alert('Silindi (√áalƒ±≈üƒ±r durumda)'); saveContentOverride(); }


/* ---------- Utils ---------- */
function escapeHtml(t){ if(t===undefined||t===null) return ''; return String(t).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

// YENƒ∞: Markdown ƒ∞≈üleyici (Kƒ±lavuz/ƒ∞pucu i√ßin)
function processGuideMarkdown(text) {
    if (!text) return '';
    let processedText = text;
    
    processedText = processedText.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>');
    processedText = processedText.replace(/__(.*?)__/g, '<b>$1</b>');
    processedText = processedText.replace(/\*(.*?)\*/g, '<i>$1</i>');
    
    processedText = processedText.replace(/### (.*)/g, '<h3>$1</h3>');
    processedText = processedText.replace(/## (.*)/g, '<h2>$1</h2>');
    processedText = processedText.replace(/# (.*)/g, '<h1>$1</h1>');

    let listRegex = /^\s*(\*)\s+(.*)/gm;
    let listOpen = false;
    processedText = processedText.split('\n').map(line => {
        if (listRegex.test(line)) {
            let item = line.replace(listRegex, '<li>$2</li>');
            if (!listOpen) {
                listOpen = true;
                return '<ul>' + item;
            }
            return item;
        } else {
            if (listOpen) {
                listOpen = false;
                return '</ul>' + line; 
            }
            return line;
        }
    }).join('\n');
    
    if (listOpen) { processedText += '</ul>'; }

    processedText = processedText.replace(/\*\*\*/g, '<hr>');
    processedText = processedText.replace(/\n\n/g, '</p><p>');
    processedText = processedText.replace(/\n/g, '<br>');
    processedText = processedText.replace(/<br><\/p>/g, '</p>').replace(/<p><br>/g, '<p>');
    
    if (processedText.trim().length > 0 && processedText.indexOf('<p>') === -1 && processedText.indexOf('<ul') === -1 && processedText.indexOf('<table') === -1 && processedText.indexOf('<h') === -1) {
        processedText = '<p>' + processedText + '</p>';
    }

    return processedText;
}
function showGuide() {
    const t = getMergedTranslations(data.settings.language || 'tr');
    const guide = data.guideText || { title: t.titles.guide, content: t.messages.noHints };
    showDetailView(guide.title, guide.content);
}
function showDetailView(title, content) {
    document.getElementById('detailViewTitle').textContent = title;
    document.getElementById('detailViewContent').innerHTML = processGuideMarkdown(content);
    showView('detailViewLayer');
}

/* 8. BA≈ûLATMA (Initialization) */
window.addEventListener('DOMContentLoaded', async () => {
    // 1. Ayarlarƒ± Y√ºkle
    loadSettings();
    
    // 2. Verileri Y√ºkle
    await loadDataFromServer();
    loadSrsData();
    
    // 3. M√ºzik √áalar
    musicPlayer = new MusicPlayer('./telifsiz-klasik.mp3', 'musicVolumeSlider', 'musicToggleBtn', 'settingsMusicVolume', 'settingsMusicToggle');
    
    // 4. UI G√ºncelle (Dil ve Gece Modu sonrasƒ±)
    updateUITexts();
    updateConversionButtons();
    
    // 5. Ana Men√ºy√º G√∂ster
    showView('mainMenu');
});
</script>
</body>
</html>
