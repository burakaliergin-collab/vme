<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Verb Matrix â€” v3.0 (Yeni AkÄ±ÅŸ)</title>

<link rel="icon" href="favicon.ico" type="image/x-icon">

<link rel="manifest" href="manifest.json"> 

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#667eea">

<style>
  /* --- Genel --- */
  *{box-sizing:border-box;margin:0;padding:0}
  body{font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); min-height:100vh;padding:18px; transition: background .25s,color .25s;}
  .container{max-width:1200px;margin:0 auto;background:#fff;border-radius:16px;padding:28px;box-shadow:0 18px 50px rgba(0,0,0,.18);transition:background .25s,color .25s}
  header{text-align:center;margin-bottom:18px}
  .subtitle{color:#6b7280;margin-top:6px}
   
  /* BÃ¶lÃ¼m BaÅŸlÄ±ÄŸÄ± */
  .section-title{font-size:1.25rem;color:#2d3748;margin:16px 0 10px;padding-bottom:8px;border-bottom:3px solid #667eea;font-weight:700}
   
  /* MODU SEÃ‡ iÃ§in bÃ¼yÃ¼k, ortalanmÄ±ÅŸ stil */
  .large-centered-title {
    text-align: center;
    font-size: 2.5rem; 
    color: #2d3748;
    font-weight: 800;
    margin: 24px 0;
    text-transform: uppercase;
  }
   
  .button-grid{display:grid;gap:12px;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));margin:12px 0}
  
  /* YENÄ°: Ana MenÃ¼ Grid (2x2 veya mobil iÃ§in 1x4) */
  #mainMenu .button-grid {
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 12px;
  }
  #mainMenu .btn {
    font-size: 1.1rem;
    padding: 16px 14px;
    height: 70px;
    justify-content: center;
  }
   
  /* GRUP SEÃ‡Ä°M BAÅLIKLARI */
  .group-select-header { text-align: center; margin-bottom: 24px; padding-top: 18px; }
  .group-select-header h2 { font-size: 2.5rem; color: #2d3748; font-weight: 800; letter-spacing: 2px; margin-bottom: 18px; }
  .group-select-columns { display: flex; justify-content: space-between; margin-bottom: 12px; }
  .group-column-title { font-size: 1.4rem; color: #2d3748; font-weight: 700; display: inline-block; padding: 0 10px 8px; border-bottom: 3px solid #667eea; }
   
  /* --- GENEL BUTON STÄ°LLERÄ° --- */
  /* --- GENEL BUTON STÄ°LLERÄ° (Metalik/Parlak v3.0) --- */
  .btn{
    padding:10px 14px;
    border-radius:10px;
    font-weight:700;
    cursor:pointer; 
    color:#fff; 
    text-align: left; 
    display:flex; 
    align-items:center; 
    transition: all .15s ease; /* GeÃ§iÅŸi 'all' yaptÄ±k */
    border-width: 1px;
    border-style: solid;
    /* ParlaklÄ±k iÃ§in iÃ§ gÃ¶lge ve metin gÃ¶lgesi */
    box-shadow: 0 2px 4px rgba(0,0,0,0.15), inset 0 1px 1px rgba(255,255,255,0.3);
    text-shadow: 0 1px 1px rgba(0,0,0,0.2);
  }
  .btn:active {
    /* BasÄ±lma efekti */
    transform: translateY(1px);
    box-shadow: 0 1px 2px rgba(0,0,0,0.2), inset 0 1px 1px rgba(0,0,0,0.1);
  }
  
  .btn-small{padding:8px 10px;font-size:.9rem}
   
  /* RENKLER (Gradient ile gÃ¼ncellendi) */
  .btn-danger { 
    background: linear-gradient(to bottom, #f87171 0%, #f56565 100%);
    border-color: #e53e3e;
  }
  .btn-danger:hover { 
    background: linear-gradient(to bottom, #f56565 0%, #e53e3e 100%);
  }
  
  .btn-primary { 
    background: linear-gradient(to bottom, #7a8efb 0%, #667eea 100%);
    border-color: #5a6ed0;
  }
  .btn-primary:hover { 
    background: linear-gradient(to bottom, #667eea 0%, #5a6ed0 100%);
  }
  
  .btn-secondary { 
    background: linear-gradient(to bottom, #cacedb 0%, #aeb4c5 100%);
    color: #1e293b;
    border-color: #949daf;
    text-shadow: 0 1px 0 rgba(255,255,255,0.3);
  }
  .btn-secondary:hover { 
    background: linear-gradient(to bottom, #aeb4c5 0%, #949daf 100%);
  }
  
  .btn-info { 
    background: linear-gradient(to bottom, #4fd1c5 0%, #38b2ac 100%);
    border-color: #319795;
  }
  .btn-info:hover { 
    background: linear-gradient(to bottom, #38b2ac 0%, #319795 100%);
  }
  
  .btn-warning { 
    background: linear-gradient(to bottom, #fbd38d 0%, #ecc94b 100%);
    color: #1e293b;
    border-color: #d69e2e;
    text-shadow: 0 1px 0 rgba(255,255,255,0.2);
  }
  .btn-warning:hover { 
    background: linear-gradient(to bottom, #ecc94b 0%, #d69e2e 100%);
  }
  
  /* YENÄ°: SRS Tekrar ButonlarÄ± (Metalik/Parlak) */
  .btn-srs-zor { 
    background: linear-gradient(to bottom, #f87171 0%, #f56565 100%);
    border-color: #e53e3e;
  }
  .btn-srs-zor:hover { 
    background: linear-gradient(to bottom, #f56565 0%, #e53e3e 100%);
  }
  
  .btn-srs-normal { 
    background: linear-gradient(to bottom, #fbd38d 0%, #ecc94b 100%);
    color: #1e293b;
    border-color: #d69e2e;
    text-shadow: 0 1px 0 rgba(255,255,255,0.2);
  }
  .btn-srs-normal:hover { 
    background: linear-gradient(to bottom, #ecc94b 0%, #d69e2e 100%);
  }
  
  .btn-srs-ogrendim { 
    background: linear-gradient(to bottom, #68d391 0%, #48bb78 100%);
    border-color: #38a169;
  }
  .btn-srs-ogrendim:hover { 
    background: linear-gradient(to bottom, #48bb78 0%, #38a169 100%);
  }


   
  /* Ã‡alÄ±ÅŸma SayfasÄ± Buton Gridi */
  .button-grid-learning { 
      display: grid; 
      gap: 8px; 
      grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); 
      margin-top: 15px; 
  }
  /* Buton metninin ortalanmasÄ± iÃ§in ayar (LED eklendiÄŸi iÃ§in) */
  .button-grid-learning .btn {
      min-width: 130px; 
      padding: 10px 8px; 
      font-size: 0.9rem;
      font-weight: 700;
      justify-content: center; /* Metni ve LED'i ortala */
      background: #aeb4c5; /* Pastel Gri/Mavi */
      color: #1e293b;
  }
  .button-grid-learning .btn:hover { background: #949daf; }
  .button-grid-learning .btn-danger { background: #f56565; color: #fff; } /* KÄ±rmÄ±zÄ± kalacak */
  .button-grid-learning .btn-danger:hover { background: #e53e3e; }

   
  .btn.disabled, .btn:disabled{background:#cbd5e1;color:#718096;cursor:not-allowed;opacity:0.7}
   
  .hidden { display: none; }
   
  .view{display:none}
  .view.active{display:block;animation:slideIn .18s ease}
  @keyframes slideIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
   
  .group-story-grid { display: grid; gap: 12px; grid-template-columns: 1fr 1fr; }
  .group-story-grid .btn { justify-content: center; text-align: center; flex-direction: column; height: 60px; } /* Grup/Hikaye butonlarÄ± */
   
  .button-group-row { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 12px; }
  .button-group-row .btn { justify-content: center; } /* Geri/Ana MenÃ¼ butonlarÄ± */
   
  .button-grid .btn { justify-content: center; } 


  /* YENÄ°: LED GÃ¶sterge Stilleri */
  .led-indicator {
    display: inline-block;
    width: 11px;
    height: 11px;
    border-radius: 50%;
    background-color: #555; /* VarsayÄ±lan: SÃ¶nÃ¼k */
    border: 1px solid #333;
    margin-right: 7px;
    vertical-align: middle;
    transition: background-color 0.2s, box-shadow 0.2s;
    flex-shrink: 0;
  }
  .led-indicator.active {
    background-color: #39e75f; /* Aktif: YeÅŸil */
    box-shadow: 0 0 6px #39e75f, 0 0 3px rgba(255,255,255,0.5) inset;
    border-color: #2b9e44;
  }
  /* Gece Modu LED */
  body.night-mode .led-indicator { background-color: #333; border-color: #111; }
  body.night-mode .led-indicator.active { background-color: #39e75f; box-shadow: 0 0 8px #39e75f; border-color: #2b9e44; }
  /* --- LED BitiÅŸ --- */


  /* YENÄ°: SRS Kontrol ButonlarÄ± (3'lÃ¼) */
  #srsControls {
      display: none; 
      justify-content: space-around;
      margin-top: 15px;
      gap: 10px;
  }
  #srsControls .btn {
      flex: 1;
      margin: 0;
      justify-content: center; /* SRS butonlarÄ± ortalÄ± */
      font-size: 1rem;
      padding: 12px 8px;
  }

  .mode-toggle{position:fixed;right:18px;top:18px;border-radius:50%;padding:10px;border:0;background:#fff;cursor:pointer;box-shadow:0 10px 28px rgba(0,0,0,.12);z-index:1200}
  .lang-btn{padding:8px 12px;border-radius:8px;border:2px solid #667eea;background:#fff;color:#667eea;cursor:pointer}
  .lang-btn.active{background:#667eea;color:#fff}
  .score-display{font-size:1.6rem;font-weight:800;color:#667eea;text-align:center;margin:12px 0}
  .small-muted{color:#6b7280;font-size:.9rem}
  .toggle-hint-btn{padding:8px 10px;border-radius:8px;border:0;background:#34495e;color:#fff;cursor:pointer}
  .content-box{background:#f9fafb;padding:16px;border-radius:12px;margin:12px 0;border-left:5px solid #667eea}
  .input-field, .textarea-field {width:100%;padding:10px;border-radius:8px;border:2px solid #e5e7eb;margin-top:8px;font-size:1rem;background:#fff;color:#0f1724}
  .select-field{width:100%;padding:10px;border-radius:8px;border:2px solid #e5e7eb;background:#fff;color:#0f1724; margin-top: 8px;}
  .progress-container{margin:12px 0}
  .progress-bar{height:28px;background:#e6eefc;border-radius:14px;overflow:hidden}
  .progress-fill{height:100%;background:linear-gradient(90deg,#667eea,#764ba2);width:0;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:800; transition: width .2s;}
   
  /* Ã–ÄŸrenme iÃ§eriÄŸi ortalandÄ± ve bÃ¼yÃ¼tÃ¼ldÃ¼ */
  .sentence{padding:12px;border-radius:8px;background:#fff;border-left:4px solid #667eea;margin:10px 0;font-weight:700;color:#0f1724; text-align: center;}
  #learningContent .sentence { font-size: 1.6rem; line-height: 1.4; }
  #learningContent #answerDisplay.sentence { font-size: 1.3rem; line-height: 1.4; background: #f0f4f8; }
   
  /* Kelime SÄ±ralama (WordOrder) Modunda dikey sÄ±ralama */
  .word-order-area { display: flex; flex-direction: column; gap: 12px; flex-wrap: nowrap; justify-content: center; align-items: center; padding: 10px 0; }
  .word-pool, .word-selected { width: 95%; min-width: 95%; text-align: center; border: 1px solid #ddd; border-radius: 8px; padding: 8px; }
  .word-item{display:inline-block;padding:8px 12px;border-radius:8px;background:#667eea;color:#fff;margin:6px;cursor:pointer;user-select:none}
  .word-item.top{background:#10b981}
  .word-item.disabled{background:#cbd5e1;color:#2d3748;cursor:not-allowed}
  
  .hint-area{margin-top:10px}
  .hint-item{background:#e6f3ff;padding:10px;border-left:4px solid #4299e1;border-radius:8px;margin:8px 0;color:#0f1724}
  .result{padding:10px;border-radius:8px;margin:8px 0;font-weight:700}
  .result.correct{background:#c6f6d5;color:#22543d;border-left:4px solid #48bb78}
  .result.incorrect{background:#fed7d7;color:#742a2a;border-left:4px solid #f56565}
   
  /* YENÄ°: Ä°lerleme (Progress) EkranÄ± Stilleri */
  .progress-stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
    gap: 12px;
    text-align: center;
    margin: 20px 0;
  }
  .stat-card {
    background: #f9fafb;
    padding: 20px 15px;
    border-radius: 12px;
  }
  .stat-card h4 {
    font-size: 1.1rem;
    color: #4a5568;
    margin-bottom: 8px;
  }
  .stat-card .stat-value {
    font-size: 2.5rem;
    font-weight: 800;
  }
  .stat-card-zor .stat-value { color: #f56565; }
  .stat-card-normal .stat-value { color: #d69e2e; }
  .stat-card-ogrendim .stat-value { color: #48bb78; }

  /* GECE MODU */
  body.night-mode{background:linear-gradient(135deg,#0f1724 0%,#071226 100%);color:#e6eef8}
  body.night-mode .container{background:#071226;color:#e6eef8;box-shadow:none}
  body.night-mode .section-title{border-bottom-color:#3b82f6;color:#e6eef8}
  body.night-mode .large-centered-title{color: #e6eef8;} 
  body.night-mode .group-column-title{color: #e6eef8;border-bottom-color: #3b82f6;}
  body.night-mode .content-box{background:#071831;border-left-color:#3b82f6}
  body.night-mode .input-field, .night-mode .textarea-field, .night-mode .select-field{background:#041226;color:#e6eef8;border-color:#082036}
  body.night-mode .sentence{background:#071226;color:#e6eef8;border-left-color:#3b82f6}
  body.night-mode #learningContent #answerDisplay.sentence { background: #0f2742; }
  body.night-mode .word-item{background:#3b82f6;color:#fff}
  body.night-mode .word-item.top{background:#10b981}
  body.night-mode .hint-item{background:#052033;color:#c8ecff;border-left-color:#3b82f6}
  body.night-mode .stat-card { background: #071831; }
  body.night-mode .stat-card h4 { color: #9ca3af; }
   
  /* GECE MODU RENKLER */
  body.night-mode .btn-primary { background: #3b82f6; }
  body.night-mode .btn-primary:hover { background: #2563eb; }
  body.night-mode .btn-secondary { background: #334155; color: #e2e8f0; }
  body.night-mode .btn-secondary:hover { background: #475569; }
  body.night-mode .btn-info { background: #0d9488; }
  body.night-mode .btn-info:hover { background: #0f766e; }
  body.night-mode .btn-warning { background: #d97706; color: #fff; }
  body.night-mode .btn-warning:hover { background: #b45309; }

  body.night-mode .btn.disabled, body.night-mode .btn:disabled {background:#1f2937;color:#4b5563;}
  body.night-mode .toggle-hint-btn{ background:#1f2937 }
  body.night-mode .group-story-grid .btn .small-muted { color: #9ca3af; }
  
  body.night-mode .button-grid-learning .btn { background: #334155; color: #e2e8f0; }
  body.night-mode .button-grid-learning .btn:hover { background: #475569; }
  body.night-mode .button-grid-learning .btn-danger { background: #f56565; color: #fff; }
   
  @media(max-width:768px){
    .container{padding:14px}
    #mainMenu .button-grid { grid-template-columns: 1fr; } /* Mobil ana menÃ¼ tek sÃ¼tun */
    #mainMenu .btn { height: auto; padding: 16px; }
  }

  /* --- MÃ¼zik Ã‡alar Stilleri --- */
  .music-player-container {
    position: fixed;
    left: 18px;
    top: 18px;
    z-index: 1200;
    background: rgba(255, 255, 255, 0.9);
    border-radius: 25px;
    padding: 5px;
    box-shadow: 0 5px 15px rgba(0, 0, 0, .1);
    display: flex;
    align-items: center;
    transition: background .25s;
  }
  .music-toggle-btn {
    border: 0;
    background: #667eea;
    color: #fff;
    border-radius: 50%;
    width: 38px;
    height: 38px;
    font-size: 1.2rem;
    cursor: pointer;
    z-index: 2;
  }
  .music-volume-slider {
    display: none; 
    margin-left: 8px;
    margin-right: 10px;
    width: 80px;
    vertical-align: middle;
    z-index: 1;
    transition: opacity 0.3s;
  }
  .music-player-container:hover .music-volume-slider {
    display: inline-block;
  }
  body.night-mode .music-player-container {
    background: rgba(31, 41, 55, 0.9); 
  }
  body.night-mode .music-toggle-btn {
    background: #3b82f6;
  }
  
  /* GÃ¶ster butonunu ortalamak iÃ§in */
  .primary-action-container {
    display: flex;
    justify-content: center;
    margin-top: 15px; 
    margin-bottom: 8px; 
  }
  .primary-action-container #actionBtn {
    padding: 12px 24px;
    font-size: 1.1rem;
    min-width: 200px;
    justify-content: center; 
    text-align: center;
    background: #aeb4c5; /* Pastel Gri/Mavi */
    color: #1e293b;
  }
  .primary-action-container #actionBtn:hover {
    background: #949daf;
  }
  body.night-mode .primary-action-container #actionBtn {
    background: #334155; 
    color: #e2e8f0; 
  }
  body.night-mode .primary-action-container #actionBtn:hover {
    background: #475569;
  }
  
</style>
</head>
<body>
<button id="modeToggleBtn" class="mode-toggle" title="Gece/GÃ¼ndÃ¼z toggle">ğŸŒ™</button>

<div id="musicPlayerContainer" class="music-player-container">
    <button id="musicToggleBtn" class="music-toggle-btn" title="MÃ¼zik Ã‡al/Durdur">ğŸ”Š</button>
    <input type="range" id="musicVolumeSlider" min="0" max="100" value="70" class="music-volume-slider" style="display: none;">
</div>
<div class="container">
  <header>
    <img src="logo.png" alt="Verb Matrix Logo" style="max-width: 280px; height: auto; margin: 10px auto 0; display: block;">
    <div class="subtitle" id="appSubtitle" data-translate-key="app.subtitle">Fiiller Ä°le Almanca Ã–ÄŸrenme Platformu</div>
  </header>

  <div id="mainMenu" class="view active">
    <div class="button-grid">
      <button class="btn btn-primary" id="btnCalis" data-translate-key="menu.calis" onclick="loadAndShowGroupMenu()">ğŸ“š Ã‡alÄ±ÅŸ</button>
      <button class="btn btn-info" id="btnTekrar" data-translate-key="menu.tekrar" onclick="showView('tekrarMenu')">ğŸ”„ Tekrar</button>
      <button class="btn btn-warning" id="btnProgress" data-translate-key="menu.progress" onclick="showView('progress')">ğŸ“Š Ä°lerleme</button>
      <button class="btn btn-secondary" id="btnSettings" data-translate-key="menu.settings" onclick="showView('settings')">âš™ï¸ Ayarlar</button>
      <button class="btn btn-secondary" style="background-color: #4a5568;" onclick="showView('adminView')" data-translate-key="menu.admin">ğŸ”§ YÃ¶netici</button>
    </div>
  </div>
<div id="tekrarMenu" class="view">
    <h2 class="large-centered-title" data-translate-key="titles.tekrar">ğŸ”„ TEKRAR</h2>
    <div class="button-grid">
      <button class="btn btn-srs-zor" onclick="startTekrar('zor')">
        <span data-translate-key="srs.zorlandiklarim">ZORLANDIKLARIM</span> (<span id="tekrarCountZor">0</span>)
      </button>
      <button class="btn btn-srs-normal" onclick="startTekrar('normal')">
        <span data-translate-key="srs.normal">NORMAL</span> (<span id="tekrarCountNormal">0</span>)
      </button>
      <button class="btn btn-srs-ogrendim" onclick="startTekrar('ogrendim')">
        <span data-translate-key="srs.ogrendiklerim">Ã–ÄRENDÄ°KLERÄ°M</span> (<span id="tekrarCountOgrenildi">0</span>)
      </button>
    </div>
    <div class="button-group-row">
      <button class="btn btn-danger btn-small" onclick="showView('mainMenu')" data-translate-key="buttons.mainMenu">â† Ana MenÃ¼</button>
    </div>
  </div>
  
  <div id="tekrarModeMenu" class="view">
    <h2 class="large-centered-title" id="tekrarModeTitle">TEKRAR MODU</h2>
    
    <div class="content-box" style="margin-bottom: 20px;">
      <h4 data-translate-key="titles.conversionSelect">Ã‡eviri YÃ¶nÃ¼nÃ¼ SeÃ§in:</h4>
      <div class="button-group-row">
        <button class="btn btn-primary" id="tekrarModeTRDE" onclick="setConversionMode('tr-de')">ğŸ‡¹ğŸ‡· TR â†’ DE ğŸ‡©ğŸ‡ª</button>
        <button class="btn btn-info" id="tekrarModeDETR" onclick="setConversionMode('de-tr')">ğŸ‡©ğŸ‡ª DE â†’ TR ğŸ‡¹ğŸ‡·</button>
      </div>
    </div>
    
    <div class="button-grid">
      <button class="btn btn-secondary" onclick="startTekrarMode('cloze')">ğŸ”² <span data-translate-key="modes.cloze">BoÅŸluk Doldurma</span></button>
      <button class="btn btn-secondary" onclick="startTekrarMode('wordorder')">ğŸ”¤ <span data-translate-key="modes.wordorder">Kelimeleri SÄ±ralama</span></button>
      <button class="btn btn-primary" onclick="startTekrarMode('quiz')">ğŸ¯ <span data-translate-key="modes.quiz">Quiz (Test)</span></button>
      </div>
    <div class="button-group-row">
      <button class="btn btn-danger btn-small" onclick="showView('tekrarMenu')" data-translate-key="buttons.goBack">â† Geri</button>
    </div>
  </div>

  <div id="groupMenu" class="view">
    <div class="group-select-header">
      <h2 data-translate-key="titles.start">BAÅLA</h2>
    </div>
    <div class="group-select-columns">
      <div class="group-column-title-container">
        <div class="group-column-title" data-translate-key="titles.groupSelect">Fiil SeÃ§</div>
      </div>
      <div class="group-column-title-container">
        <div class="group-column-title" data-translate-key="titles.storySelect">Hikaye SeÃ§</div>
      </div>
    </div>
    <div id="groupButtons"></div>
    <div class="button-group-row">
      <button class="btn btn-danger btn-small" onclick="showView('mainMenu')" data-translate-key="buttons.mainMenu">â† Ana MenÃ¼</button>
    </div>
  </div>

  <div id="verbMenu" class="view">
    <h2 class="section-title" data-translate-key="titles.verbSelect">FÄ°Ä°L SEÃ‡</h2>
    <div id="verbButtons" class="button-grid"></div>
    <div class="button-group-row">
      <button class="btn btn-danger btn-small" onclick="showView('groupMenu')" data-translate-key="buttons.goBack">â† Geri</button>
    </div>
  </div>

  <div id="sectionMenu" class="view">
    <h2 class="section-title" data-translate-key="titles.sectionSelect">BÃ–LÃœM SEÃ‡</h2>
    <div id="sectionButtons" class="button-grid"></div>
    <div class="button-group-row">
      <button class="btn btn-danger btn-small" onclick="showView('verbMenu')" data-translate-key="buttons.goBack">â† Geri</button>
    </div>
  </div>

  <div id="modeMenu" class="view">
    <h2 class="large-centered-title" data-translate-key="titles.conversionSelect">Ã‡EVÄ°RÄ° YÃ–NÃœ</h2>
    
    <div class="content-box" style="margin-bottom: 20px;">
      <h4 data-translate-key="titles.conversionSelect">Ã‡eviri YÃ¶nÃ¼nÃ¼ SeÃ§in:</h4>
      <div class="button-group-row">
        <button class="btn btn-primary" id="modeTRDE" onclick="setConversionMode('tr-de')">ğŸ‡¹ğŸ‡· TR â†’ DE ğŸ‡©ğŸ‡ª</button>
        <button class="btn btn-info" id="modeDETR" onclick="setConversionMode('de-tr')">ğŸ‡©ğŸ‡ª DE â†’ TR ğŸ‡¹ğŸ‡·</button>
      </div>
    </div>

    <div class="primary-action-container">
        <button class="btn btn-primary" style="min-width: 250px; padding: 14px;" onclick="startMode('study')" data-translate-key="buttons.startStudy">
          ğŸ“– <span data-translate-key="modes.study">Ã‡alÄ±ÅŸmaya BaÅŸla</span>
        </button>
    </div>
    
    <div class="button-group-row">
      <button class="btn btn-danger btn-small" onclick="showView('sectionMenu')" data-translate-key="buttons.goBack">â† Geri</button>
    </div>
  </div>

  <div id="learningView" class="view">
    <h2 class="section-title" id="learningTitle" data-translate-key="titles.learning">Ã‡alÄ±ÅŸma</h2>

    <div class="progress-container">
      <div class="progress-bar"><div id="progressFill" class="progress-fill">0%</div></div>
      <div style="text-align:center;margin-top:8px;font-weight:700;"><span id="progressText">0 / 0</span></div>
    </div>

    <div class="content-box">
      <div id="learningContent"></div>
      <div id="hintPanel" class="hint-area" style="display:none"></div>
      <div id="resultArea"></div>
      <div id="answerArea"></div>
    </div>

    <div id="srsControls" class="button-group-row">
        <button class="btn btn-srs-zor" onclick="rateCard('zor')">ğŸ¥µ <span data-translate-key="srs.zor">ZOR</span></button>
        <button class="btn btn-srs-normal" onclick="rateCard('normal')">ğŸ¤” <span data-translate-key="srs.normal">NORMAL</span></button>
        <button class="btn btn-srs-ogrendim" onclick="rateCard('ogrendim')">âœ… <span data-translate-key="srs.ogrendim">Ã–ÄRENDÄ°M</span></button>
    </div>

    <div id="quickEditPanel" class="content-box" style="display:none; margin-top: 15px;">
        <h4 id="quickEditTitle" style="margin-bottom: 10px;">Sayfa Ä°Ã§eriÄŸi HÄ±zlÄ± DÃ¼zenleme</h4>
        <label style="display:block;margin-top:12px;" data-translate-key="labels.tr">TR CÃ¼mle:</label>
        <textarea id="qe_tr" class="textarea-field" rows="3"></textarea>
        <label style="display:block;margin-top:12px;" data-translate-key="labels.de">DE CÃ¼mle:</label>
        <textarea id="qe_de" class="textarea-field" rows="3"></textarea>
        <label style="display:block;margin-top:12px;" data-translate-key="labels.hintText">CÃ¼mle Ä°pucu:</label>
        <textarea id="qe_hint" class="textarea-field" rows="3" placeholder="Bu cÃ¼mleye Ã¶zel ipucu ekleyin/dÃ¼zenleyin."></textarea>
        <div class="button-group-row">
            <button class="btn btn-secondary" onclick="saveQuickEdit()">âœ… <span data-translate-key="buttons.save">Kaydet</span> & Kapat</button>
            <button class="btn btn-danger" onclick="document.getElementById('quickEditPanel').style.display='none'" data-translate-key="buttons.cancel">Ä°ptal</button>
        </div>
    </div>
    
    <div class="primary-action-container">
      <button class="btn" id="actionBtn" data-translate-key="buttons.show" onclick="handleAction()">Kontrol Et / GÃ¶ster</button>
    </div>

    <div class="button-grid-learning">
      <button class="btn" id="toggleHintBtn" data-translate-key="buttons.hintToggle" onclick="toggleHintPanel()">Ä°puÃ§larÄ± AÃ§ / Kapat</button>
      <button class="btn" id="btnQuickEdit" onclick="showQuickEditPanel()">âœï¸ DÃ¼zelt/Ekle</button>
      <button class="btn btn-danger" onclick="resetLearning()" data-translate-key="buttons.reset">BaÅŸa DÃ¶n</button>
      
      <button class="btn" id="autoPlayBtn" onclick="toggleAutoPlay()">
        <span class="led-indicator" id="autoPlayLed"></span>Otomatik Dinle
      </button>
      
      <button class="btn" id="slowModeToggleBtn" onclick="toggleSpeechSpeed()">
        <span class="led-indicator" id="slowModeLedL"></span>ğŸ”Š YavaÅŸ Mod
      </button>
      
      <button class="btn" id="pauseBtn" onclick="toggleSpeechPause()">â¸ï¸ Durdur</button>
      
      <button class="btn" id="btnPlayDE" data-translate-key="buttons.playDE" onclick="playCurrentSentence('de')">ğŸ”Š Almanca Dinle</button>
      <button class="btn" id="btnPlayTR" data-translate-key="buttons.playTR" onclick="playCurrentSentence('tr')">ğŸ”Š TÃ¼rkÃ§e Dinle</button>
      
      <button class="btn" onclick="previousQuestion()" data-translate-key="buttons.previous">â† Ã–nceki</button>
      <button class="btn btn-danger" id="learningExitBtn" onclick="showView('modeMenu')" data-translate-key="buttons.menuReturn">MenÃ¼ye DÃ¶n</button>
    </div>

  </div>

  <div id="storyView" class="view">
    <h2 class="section-title" id="storyTitle" data-translate-key="titles.story">Hikaye</h2>
    <div class="content-box" id="storyContent"></div>
    <div class="button-grid-learning"> 
      <button class="btn btn-warning" onclick="showStoryQuestions()" data-translate-key="buttons.questions">ğŸ“ Sorular</button>
      
      <button class="btn" id="storySlowModeToggleBtn" onclick="toggleSpeechSpeed()">
        <span class="led-indicator" id="slowModeLedS"></span>ğŸ”Š YavaÅŸ Mod
      </button>
      <button class="btn" id="storyPauseBtn" onclick="toggleSpeechPause()">â¸ï¸ Durdur</button>
      
      <button class="btn" id="btnPlayDE" data-translate-key="buttons.playDE" onclick="playStoryAudio('de')">ğŸ”Š Almanca Dinle</button>
      <button class="btn" onclick="playStoryAudio('tr')" data-translate-key="buttons.playTR">ğŸ”Š TÃ¼rkÃ§e Dinle</button>
      <button class="btn btn-danger" onclick="showView('groupMenu')" data-translate-key="buttons.groupMenuReturn">â† Grup MenÃ¼sÃ¼ne DÃ¶n</button>
    </div>
  </div>

  <div id="storyQuestionsView" class="view">
    <h2 class="section-title" id="storyQuestionsTitle" data-translate-key="titles.storyQuestions">Hikaye SorularÄ±</h2>
    <div class="content-box" id="storyQuestionsContent"></div>
    <div class="button-group-row">
      <button class="btn btn-danger btn-small" onclick="showView('storyView')" data-translate-key="buttons.storyReturn">â† Hikayeye DÃ¶n</button>
    </div>
  </div>
  
  <div id="settings" class="view">
    <h2 class="section-title" data-translate-key="titles.settings">âš™ï¸ Ayarlar</h2>
    
    <div class="content-box">
      <h3 data-translate-key="settings.dataManagement">ğŸ’¾ Veri YÃ¶netimi</h3>
      <div class="button-grid" style="grid-template-columns: 1fr 1fr; margin-top: 10px;">
        <button class="btn btn-primary" style="width:100%;" onclick="importDataFromFile()" data-translate-key="buttons.importJSON">ğŸ“¥ Ä°Ã§erik YÃ¼kle (JSON)</button>
        <button class="btn btn-secondary" style="width:100%;" onclick="exportData()" data-translate-key="buttons.exportJSON">ğŸ“¤ Ä°Ã§erik Ä°ndir (JSON)</button>
      </div>
    </div>
    
    <div class="content-box">
      <h3 data-translate-key="settings.appearance">ğŸ¨ GÃ¶rÃ¼nÃ¼m ve DiÄŸer</h3>
      <div style="margin-top: 12px;">
          <label style="display:block;font-weight:700;margin-bottom:6px" data-translate-key="settings.language">Dil:</label>
          <div style="display:flex;gap:8px">
            <button class="lang-btn active" id="langTR" onclick="changeLanguage('tr', this)">TÃ¼rkÃ§e</button>
            <button class="lang-btn" id="langDE" onclick="changeLanguage('de', this)">Deutsch</button>
            </div>
      </div>
      <label style="display:flex;align-items:center;gap:8px;margin-top:15px;">
          <input type="checkbox" id="nightModeToggle" style="width: 20px; height: 20px;"> <span data-translate-key="settings.nightMode">Gece Modu</span>
      </label>
      <div style="margin-top: 15px;">
        <label style="display:block;font-weight:700;margin-bottom:6px" data-translate-key="settings.music">MÃ¼zik:</label>
        <div style="display:flex; align-items: center; gap: 10px;">
          <button id="settingsMusicToggle" class="btn btn-primary btn-small" onclick="musicPlayer.toggleMusic()">ğŸ”Š Ã‡al/Durdur</button>
          <input type="range" id="settingsMusicVolume" min="0" max="100" value="70" style="flex: 1;">
        </div>
      </div>
    </div>
    
    <div class="content-box">
        <h3 data-translate-key="settings.appUpdate">ğŸ”„ Uygulama</h3>
        <button class="btn btn-warning" style="width:100%; margin-top: 10px;" onclick="forceUpdateApp()" data-translate-key="buttons.forceUpdate">ğŸ”„ UygulamayÄ± GÃ¼ncelle</button>
    </div>

    <div class="content-box" style="margin-top:12px">
      <h3 data-translate-key="settings.pasteJSONTitle">ğŸ“ JSON YapÄ±ÅŸtÄ±r (Mobil)</h3>
      <textarea id="jsonPaste" class="textarea-field" data-translate-key="placeholders.jsonPaste" placeholder="JSON iÃ§eriÄŸinizi buraya yapÄ±ÅŸtÄ±rÄ±n..." rows="5"></textarea>
      <div class="button-group-row" style="margin-top:8px">
        <button class="btn btn-primary" onclick="loadJsonFromTextarea()" data-translate-key="buttons.pasteAndLoad">ğŸ“¥ YapÄ±ÅŸtÄ±r & YÃ¼kle</button>
        <button class="btn btn-danger" onclick="document.getElementById('jsonPaste').value=''" data-translate-key="buttons.clear">Temizle</button>
      </div>
    </div>

    <div class="button-group-row" style="margin-top:12px">
      <button class="btn btn-danger btn-small" onclick="showView('mainMenu')" data-translate-key="buttons.mainMenu">â† Ana MenÃ¼</button>
    </div>
  </div>

  <div id="progress" class="view">
    <h2 class="section-title" data-translate-key="titles.progress">ğŸ“Š Ä°lerleme</h2>
    
    <div class="content-box">
      <h3 data-translate-key="titles.srsStats">Tekrar Durumu</h3>
      <div class="progress-stats-grid">
        <div class="stat-card stat-card-zor">
          <h4 data-translate-key="srs.zorlandiklarim">ZORLANDIKLARIM</h4>
          <div class="stat-value" id="progressStatZor">0</div>
        </div>
        <div class="stat-card stat-card-normal">
          <h4 data-translate-key="srs.normal">NORMAL</h4>
          <div class="stat-value" id="progressStatNormal">0</div>
        </div>
        <div class="stat-card stat-card-ogrendim">
          <h4 data-translate-key="srs.ogrendiklerim">Ã–ÄRENDÄ°KLERÄ°M</h4>
          <div class="stat-value" id="progressStatOgrenildi">0</div>
        </div>
      </div>
    </div>
    
    <div class="content-box">
      <h3 data-translate-key="titles.totalProgress">Toplam Ã‡alÄ±ÅŸma Ä°lerlemesi</h3>
      <p class="small-muted" data-translate-key="messages.totalProgressDesc">TÃ¼m iÃ§erikteki (cÃ¼mlelerdeki) ilerleme durumunuz.</p>
      <div class="progress-container" style="margin-top: 15px;">
        <div class="progress-bar"><div id="totalProgressFill" class="progress-fill">0%</div></div>
        <div style="text-align:center;margin-top:8px;font-weight:700;"><span id="totalProgressText">0 / 0</span></div>
      </div>
    </div>

    <div class="content-box">
        <h3 data-translate-key="settings.progressManagement">ğŸ’¾ Ä°lerleme Veri YÃ¶netimi</h3>
        <div class="button-grid" style="grid-template-columns: 1fr 1fr; margin-top: 10px;">
           <button class="btn btn-primary" style="width:100%;" onclick="importSrsData()" data-translate-key="buttons.importProgress">ğŸ“¥ Ä°lerleme YÃ¼kle</button>
           <button class="btn btn-secondary" style="width:100%;" onclick="exportSrsData()" data-translate-key="buttons.exportProgress">ğŸ“¤ Ä°lerleme Ä°ndir</button>
        </div>
        <button class="btn btn-danger" style="width:100%; margin-top: 10px;" onclick="resetSrsData()" data-translate-key="buttons.resetSrs">âš ï¸ TÃ¼m Ä°lerlemeyi SÄ±fÄ±rla</button>
    </div>
    
    <div class="button-group-row">
      <button class="btn btn-danger btn-small" onclick="showView('mainMenu')" data-translate-key="buttons.mainMenu">â† Ana MenÃ¼</button>
    </div>
  </div>

  <div id="adminView" class="view">
    <h2 class="section-title" data-translate-key="titles.adminPanel">ğŸ”§ YÃ¶netici Paneli</h2>
    <div class="button-grid">
      <button class="btn btn-primary" onclick="showView('adminContentView')" data-translate-key="admin.contentManagement">ğŸ“š Ä°Ã§erik YÃ¶netimi</button>
      <button class="btn btn-info" onclick="showTsvImporter()">ğŸ“Š Toplu CÃ¼mle YÃ¼kle</button>
      <button class="btn btn-secondary" onclick="showView('adminSentenceListView')" data-translate-key="admin.listAllSentences">ğŸ“‹ TÃ¼m CÃ¼mleleri Listele</button>
    </div>
    
    <div id="adminTsvArea" class="content-box" style="display:none; margin-top: 15px; border-color: #10b981;">
        <h4 data-translate-key="admin.tsvTitle">ğŸ“Š Toplu CÃ¼mle YÃ¼kleme (Excel'den Kopyala-YapÄ±ÅŸtÄ±r)</h4>
        <p class="small-muted" data-translate-key="admin.tsvDesc">
          Excel veya Google E-Tablolar'da hazÄ±rladÄ±ÄŸÄ±nÄ±z veriyi buraya yapÄ±ÅŸtÄ±rÄ±n.<br>
          KullanmanÄ±z gereken sÃ¼tun sÄ±rasÄ± (BAÅLIK SATIRI OLMADAN):<br>
          <b>GrupID | FiilID | BÃ¶lÃ¼mNumarasÄ± | TR_CÃ¼mle | DE_CÃ¼mle | CÃ¼mleIpucu (Ä°steÄŸe baÄŸlÄ±)</b>
        </p>
        <textarea id="tsvPasteArea" class="textarea-field" rows="10" placeholder="GrupID (Tab) FiilID (Tab) BÃ¶lÃ¼mNo (Tab) TR CÃ¼mle (Tab) DE CÃ¼mle (Tab) Ä°pucu..."></textarea>
        <div class="button-group-row">
            <button class="btn btn-info" onclick="parseAndImportTsv()">âœ… <span data-translate-key="buttons.pasteAndLoadTsv">YÃ¼kle ve Ä°ÅŸle</span></button>
            <button class="btn btn-danger" onclick="document.getElementById('adminTsvArea').style.display='none'" data-translate-key="buttons.cancel">Ä°ptal</button>
        </div>
    </div>
    
    <div class="button-group-row" style="margin-top:12px">
      <button class="btn btn-danger btn-small" onclick="showView('mainMenu')" data-translate-key="buttons.mainMenu">â† Ana MenÃ¼</button>
    </div>
  </div>

  <div id="adminContentView" class="view">
     <h2 class="section-title" data-translate-key="admin.contentManagement">ğŸ“š Ä°Ã§erik YÃ¶netimi</h2>
     
     <div class="button-grid" style="grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));">
        <button class="btn btn-primary" onclick="showAdminForm('addGroup')">â• <span data-translate-key="admin.addGroup">Grup Ekle/DÃ¼zenle</span></button>
        <button class="btn btn-primary" onclick="showAdminForm('addVerb')">â• <span data-translate-key="admin.addVerb">Fiil Ekle/DÃ¼zenle</span></button>
        <button class="btn btn-primary" onclick="showAdminForm('addSection')">â• <span data-translate-key="admin.addSection">BÃ¶lÃ¼m Ekle/DÃ¼zenle</span></button>
        <button class="btn btn-info" onclick="showAdminForm('addStory')">â• <span data-translate-key="admin.addStory">Hikaye Ekle/DÃ¼zenle</span></button>
        <button class="btn btn-info" onclick="showAdminForm('addHint')">ğŸ’¡ <span data-translate-key="admin.hintManagement">Ä°pucu Ekle/DÃ¼zenle</span></button>
        <button class="btn btn-secondary" onclick="showAdminForm('editSentence')">âœï¸ <span data-translate-key="admin.editSentence">CÃ¼mle Ekle/DÃ¼zenle</span></button>
     </div>
     
     <div id="adminContentArea" class="content-box" style="margin-top: 15px; display: none;">
        </div>
     
     <div class="button-group-row" style="margin-top:12px">
      <button class="btn btn-danger btn-small" onclick="showView('adminView')" data-translate-key="buttons.adminReturn">â† YÃ¶netici Paneline DÃ¶n</button>
    </div>
  </div>
  
  <div id="adminSentenceListView" class="view">
    <h2 class="section-title" data-translate-key="admin.listAllSentences">ğŸ“‹ TÃ¼m CÃ¼mleleri Listele</h2>
    <div class="content-box">
      <div class="button-group-row" style="margin-bottom:8px;">
        <button class="btn btn-secondary" onclick="renderAllSentencesTable()" data-translate-key="buttons.refreshList">ğŸ”„ Yenile Liste</button>
        <button class="btn btn-warning" onclick="exportSentencesCsv()" data-translate-key="buttons.exportCSV">ğŸ“¤ CSV Ä°ndir (Tablo)</button>
      </div>
      <div id="allSentencesTable" style="max-height:60vh;overflow:auto"></div>
    </div>
    <div class="button-group-row" style="margin-top:12px">
      <button class="btn btn-danger btn-small" onclick="showView('adminView')" data-translate-key="buttons.adminReturn">â† YÃ¶netici Paneline DÃ¶n</button>
    </div>
  </div>


</div>

<input type="file" id="fileInput" accept=".json" style="display:none">
<input type="file" id="progressFileInput" accept=".json" style="display:none">

<script>
/* ===============================
    Verb Matrix â€” v3.0 (Yeni AkÄ±ÅŸ ve SRS Sistemi)
    - YENÄ°: Ana MenÃ¼ akÄ±ÅŸÄ± (Ã‡alÄ±ÅŸ, Tekrar, Ä°lerleme, Ayarlar)
    - YENÄ°: "Ã‡alÄ±ÅŸ" akÄ±ÅŸÄ± (Eski "study" modu), cÃ¼mleleri 'new' (yeni) statÃ¼sÃ¼nden 'zor', 'normal' veya 'ogrendim' statÃ¼sÃ¼ne taÅŸÄ±r.
    - YENÄ°: "Tekrar" akÄ±ÅŸÄ±, statÃ¼ye (zor, normal, Ã¶ÄŸrendim) gÃ¶re kartlarÄ± Ã§eker ve Quiz, Cloze, WordOrder modlarÄ±nÄ± sunar.
    - YENÄ°: SRS MantÄ±ÄŸÄ± (Zor, Normal, Ã–ÄŸrendim).
    - YENÄ°: SRS (Ä°lerleme) verisi (srsData), iÃ§erik verisinden (data) ayrÄ±ldÄ±.
    - YENÄ°: Ä°lerleme (srsData) iÃ§in ayrÄ± JSON iÃ§e/dÄ±ÅŸa aktarma.
    - YENÄ°: Ä°Ã§erik (data) artÄ±k sunucudan 'verbmatrix_data.json' olarak Ã§ekiliyor (fetch).
    - YENÄ°: Ä°lerleme (progress) ekranÄ± yeni SRS statÃ¼lerini (Zor, Normal, Ã–ÄŸrendim) ve toplam ilerlemeyi gÃ¶sterir.
    - YENÄ°: Admin Paneli, "BÃ¶lÃ¼m Ekle/DÃ¼zenle" Ã¶zelliÄŸi ile gÃ¼ncellendi ve tek bir 'Ä°Ã§erik YÃ¶netimi' ekranÄ±nda birleÅŸtirildi.
    - GÃœNCELLENDÄ°: 'modeMenu' artÄ±k sadece Ã§eviri yÃ¶nÃ¼ seÃ§tiriyor, 'Ã‡alÄ±ÅŸ' akÄ±ÅŸÄ± doÄŸrudan 'study' moduna (yeni kart Ã¶ÄŸrenme) yÃ¶nlendiriyor.
    - GÃœNCELLENDÄ°: 'learningView' artÄ±k 3'lÃ¼ SRS butonlarÄ±nÄ± (Zor, Normal, Ã–ÄŸrendim) gÃ¶steriyor.
    - GÃœNCELLENDÄ°: Ayarlar menÃ¼sÃ¼ yeniden dÃ¼zenlendi.
    - KALDIRILDI: Ä°ngilizce dil desteÄŸi ('en') kaldÄ±rÄ±ldÄ±.
    =============================== */

/* ---------------- VarsayÄ±lan Veri (Sunucu Ã‡Ã¶kmesi Durumunda) --------------- */
let data = {
  groups: [ { id: "g1", name: "VarsayÄ±lan Grup", nameDE: "Standardgruppe" } ],
  verbs: { g1: [ { id:'v1', verbTR:'YÃ¼kleniyor...', verbDE:'Laden...' } ] },
  content: {},
  sections: { 1: "BÃ¶lÃ¼m 1" },
  sectionsHints: {},
  hints: { sentences: {}, verbs: {}, sections: {} },
  translations: {
    tr: {
      app: { subtitle: 'Fiiller Ä°le Almanca Ã–ÄŸrenme Platformu' }, 
      menu: { 
        calis: 'ğŸ“š Ã‡alÄ±ÅŸ',
        tekrar: 'ğŸ”„ Tekrar',
        settings: 'âš™ï¸ Ayarlar', 
        progress: 'ğŸ“Š Ä°lerleme', 
        admin: 'ğŸ”§ YÃ¶netici' 
      },
      titles: {
        start: 'BAÅLA',
        tekrar: 'ğŸ”„ TEKRAR',
        groupSelect: 'Fiil SeÃ§', 
        storySelect: 'Hikaye SeÃ§', 
        verbSelect: 'FÄ°Ä°L SEÃ‡', 
        sectionSelect: 'BÃ–LÃœM SEÃ‡', 
        modeSelect: 'MODU SEÃ‡', 
        conversionSelect: 'Ã‡EVÄ°RÄ° YÃ–NÃœ',
        learning: 'Ã‡alÄ±ÅŸma', 
        story: 'Hikaye', 
        storyQuestions: 'Hikaye SorularÄ±',
        settings: 'âš™ï¸ Ayarlar', 
        progress: 'ğŸ“Š Ä°lerleme', 
        adminPanel: 'ğŸ”§ YÃ¶netici Paneli',
        srsStats: 'Tekrar Durumu',
        totalProgress: 'Toplam Ã‡alÄ±ÅŸma Ä°lerlemesi'
      },
      buttons: {
        mainMenu: 'â† Ana MenÃ¼', goBack: 'â† Geri', show: 'GÃ¶ster', next: 'â†’ Sonraki', check: 'Kontrol Et', start: 'BaÅŸla',
        previous: 'â† Ã–nceki', menuReturn: 'MenÃ¼ye DÃ¶n', reset: 'BaÅŸa DÃ¶n', hintToggle: 'Ä°puÃ§larÄ± AÃ§ / Kapat',
        questions: 'ğŸ“ Sorular', playDE: 'ğŸ”Š Almanca Dinle', playTR: 'ğŸ”Š TÃ¼rkÃ§e Dinle',
        groupMenuReturn: 'â† Grup MenÃ¼sÃ¼ne DÃ¶n', storyReturn: 'â† Hikayeye DÃ¶n', adminReturn: 'â† YÃ¶netici Paneline DÃ¶n',
        importJSON: 'ğŸ“¥ Ä°Ã§erik YÃ¼kle (JSON)', exportJSON: 'ğŸ“¤ Ä°Ã§erik Ä°ndir (JSON)',
        importProgress: 'ğŸ“¥ Ä°lerleme YÃ¼kle', exportProgress: 'ğŸ“¤ Ä°lerleme Ä°ndir',
        resetSrs: 'âš ï¸ TÃ¼m Ä°lerlemeyi SÄ±fÄ±rla',
        pasteAndLoad: 'ğŸ“¥ YapÄ±ÅŸtÄ±r & YÃ¼kle', clear: 'Temizle',
        refreshList: 'ğŸ”„ Yenile Liste', exportCSV: 'ğŸ“¤ CSV Ä°ndir (Tablo)',
        save: 'Kaydet', cancel: 'Ä°ptal', update: 'GÃ¼ncelle', add: 'Ekle', delete: 'Sil', edit: 'DÃ¼zenle',
        nextSection: 'â†’ Sonraki BÃ¶lÃ¼m',
        startStudy: 'ğŸ“– Ã‡alÄ±ÅŸmaya BaÅŸla',
        forceUpdate: 'ğŸ”„ UygulamayÄ± GÃ¼ncelle',
        pasteAndLoadTsv: 'YÃ¼kle ve Ä°ÅŸle'
      },
      settings: {
        appearance: 'ğŸ¨ GÃ¶rÃ¼nÃ¼m ve DiÄŸer', nightMode: 'Gece Modu', language: 'Dil:', music: 'MÃ¼zik:',
        dataManagement: 'ğŸ’¾ Ä°Ã§erik Veri YÃ¶netimi',
        progressManagement: 'ğŸ’¾ Ä°lerleme Veri YÃ¶netimi',
        appUpdate: 'ğŸ”„ Uygulama',
        pasteJSONTitle: 'ğŸ“ JSON YapÄ±ÅŸtÄ±r (Mobil)',
        pasteJSONDesc: 'Ä°Ã§erik JSON dosyanÄ±zÄ± buraya yapÄ±ÅŸtÄ±rabilirsiniz.'
      },
      admin: {
        contentManagement: 'ğŸ“š Ä°Ã§erik YÃ¶netimi',
        listAllSentences: 'ğŸ“‹ TÃ¼m CÃ¼mleleri Listele', 
        addGroup: 'Grup Ekle/DÃ¼zenle', addVerb: 'Fiil Ekle/DÃ¼zenle', addSection: 'BÃ¶lÃ¼m Ekle/DÃ¼zenle',
        editSentence: 'CÃ¼mle Ekle/DÃ¼zenle', addStory: 'Hikaye Ekle/DÃ¼zenle', 
        hintManagement: 'Ä°pucu Ekle/DÃ¼zenle',
        tsvTitle: 'ğŸ“Š Toplu CÃ¼mle YÃ¼kleme (Excel\'den Kopyala-YapÄ±ÅŸtÄ±r)',
        tsvDesc: 'Excel veya Google E-Tablolar\'da hazÄ±rladÄ±ÄŸÄ±nÄ±z veriyi buraya yapÄ±ÅŸtÄ±rÄ±n.\nKullanmanÄ±z gereken sÃ¼tun sÄ±rasÄ± (BAÅLIK SATIRI OLMADAN):\n<b>GrupID | FiilID | BÃ¶lÃ¼mNumarasÄ± | TR_CÃ¼mle | DE_CÃ¼mle | CÃ¼mleIpucu (Ä°steÄŸe baÄŸlÄ±)</b>'
      },
      labels: {
        group: 'Grup:', verb: 'Fiil:', section: 'BÃ¶lÃ¼m:', sentence: 'CÃ¼mle:', index: 'Index:',
        hintText: 'Ä°pucu metni:', tr: 'TR:', de: 'DE:', title: 'BaÅŸlÄ±k:', deText: 'DE metin:', trText: 'TR metin:',
        groupID: 'Grup ID (Ã¶r: g5):', groupNameTR: 'Ad (TR):', groupNameDE: 'Ad (DE):',
        verbID: 'Fiil ID (Ã¶rn v10):', verbTR: 'Fiil TR:', verbDE: 'Fiil DE:',
        sectionCode: 'BÃ¶lÃ¼m Kodu (Ã¶rn: B1):', 
        sectionNum: 'BÃ¶lÃ¼m NumarasÄ± (Ã¶rn: 1):', sectionName: 'BÃ¶lÃ¼m AdÄ± (Ã¶rn: KiÅŸi Zamiri):',
        question: 'Soru:', options: 'SeÃ§enekler (virgÃ¼lle ayÄ±r):',
        correctAnswer: 'DoÄŸru cevap (tam metin):'
      },
      placeholders: {
        jsonPaste: 'JSON iÃ§eriÄŸinizi buraya yapÄ±ÅŸtÄ±rÄ±n...',
        cloze: 'BoÅŸluÄŸu doldurun...',
        quiz: 'Ã‡eviriyi yazÄ±n...' 
      },
      messages: {
        noGroups: 'HenÃ¼z grup yok. JSON yÃ¼kleyin.',
        noVerbs: 'Bu grupta fiil bulunamadÄ±.',
        noSentences: 'Bu fiil ve bÃ¶lÃ¼m iÃ§in cÃ¼mle bulunamadÄ±!',
        noDueCards: 'Bu kategoride tekrar edilecek kart kalmadÄ±! ğŸ‰',
        noNewCards: 'Bu bÃ¶lÃ¼mdeki tÃ¼m kartlarÄ± Ã§alÄ±ÅŸtÄ±nÄ±z! ğŸ‰',
        noStory: 'Bu grup iÃ§in hikaye bulunamadÄ±!',
        noStoryAvailable: 'Hikaye Yok',
        noStoryQuestions: 'Bu hikaye iÃ§in henÃ¼z soru yok.',
        noProgress: 'HenÃ¼z ilerleme yok.',
        noHints: 'Yok',
        noStoryFound: 'Hikaye bulunamadÄ±',
        ttsNotSupported: 'TarayÄ±cÄ± TTS desteklemiyor.',
        dataLoaded: 'âœ“ Ä°Ã§erik verisi yÃ¼klendi. Grup sayÄ±sÄ±:',
        progressLoaded: 'âœ“ Ä°lerleme verisi yÃ¼klendi.',
        invalidJSON: 'âœ— GeÃ§ersiz JSON formatÄ±.',
        loadError: 'âœ— Hata:',
        dataExported: 'âœ“ Ä°Ã§erik verisi (verbmatrix_data.json) indirildi!',
        progressExported: 'âœ“ Ä°lerleme verisi (verbmatrix_ilerleme_data.json) indirildi!',
        srsReset: 'âœ“ TÃ¼m Ã§alÄ±ÅŸma (SRS) verisi sÄ±fÄ±rlandÄ±.',
        jsonStatus: 'ğŸ“Š JSON DURUMU',
        allFieldsError: 'TÃ¼m alanlarÄ± doldurun',
        hintSaved: 'âœ… Ä°pucu kaydedildi',
        quickEditSaved: 'âœ… CÃ¼mle ve ipucu gÃ¼ncellendi (Yerel olarak kaydedildi)!',
        overrideReset: 'âœ… Ä°Ã§erik dÃ¼zeltmeleri silindi. Sayfa yenilendikten sonra varsayÄ±lan iÃ§eriÄŸe dÃ¶nÃ¼lecektir.',
        srsResetConfirm: 'TÃ¼m Ã§alÄ±ÅŸma (AralÄ±klÄ± Tekrar) verilerinizi sÄ±fÄ±rlamak istediÄŸinizden emin misiniz? TÃ¼m kartlarÄ±n ilerlemesi (Zor, Normal, Ã–ÄŸrendim) silinecektir.',
        totalProgressDesc: 'TÃ¼m iÃ§erikteki (cÃ¼mlelerdeki) ilerleme durumunuz.'
      },
      srs: {
        zor: 'ğŸ¥µ ZOR',
        normal: 'ğŸ¤” NORMAL',
        ogrendim: 'âœ… Ã–ÄRENDÄ°M',
        zorlandiklarim: 'ZORLANDIKLARIM',
        ogrendiklerim: 'Ã–ÄRENDÄ°KLERÄ°M'
      },
      modes: {
          cloze: 'BoÅŸluk Doldurma',
          wordorder: 'Kelimeleri SÄ±ralama',
          quiz: 'Quiz (Test)',
          study: 'Ã‡alÄ±ÅŸma (Yeni Kartlar)'
      }
    },
    de: { 
      app: { subtitle: 'Deutsch-Lernplattform mit Verben' },
      menu: { 
        calis: 'ğŸ“š Lernen',
        tekrar: 'ğŸ”„ Wiederholen',
        settings: 'âš™ï¸ Einstellungen', 
        progress: 'ğŸ“Š Fortschritt', 
        admin: 'ğŸ”§ Admin' 
      },
      titles: {
        start: 'START',
        tekrar: 'ğŸ”„ WIEDERHOLEN',
        groupSelect: 'Verb wÃ¤hlen', 
        storySelect: 'Geschichte wÃ¤hlen',
        settings: 'âš™ï¸ Einstellungen',
        progress: 'ğŸ“Š Fortschritt',
        adminPanel: 'ğŸ”§ Admin-Panel',
        srsStats: 'Lernstatus',
        totalProgress: 'Gesamtfortschritt',
        conversionSelect: 'ÃœBERSETZUNG'
      },
      buttons: {
        mainMenu: 'â† HauptmenÃ¼', goBack: 'â† ZurÃ¼ck', show: 'Zeigen', next: 'â†’ NÃ¤chste', check: 'PrÃ¼fen',
        playDE: 'ğŸ”Š Deutsch hÃ¶ren', playTR: 'ğŸ”Š TÃ¼rkisch hÃ¶ren',
        resetSrs: 'âš ï¸ Lernfortschritt zurÃ¼cksetzen',
        startStudy: 'ğŸ“– Lernen starten'
      },
      settings: {
        appearance: 'ğŸ¨ Ansicht & Sonstiges', nightMode: 'Nachtmodus', language: 'Sprache:', music: 'Musik:',
        dataManagement: 'ğŸ’¾ Inhaltsdaten',
        progressManagement: 'ğŸ’¾ Fortschrittsdaten',
        appUpdate: 'ğŸ”„ App'
      },
      srs: {
        zor: 'ğŸ¥µ SCHWER',
        normal: 'ğŸ¤” NORMAL',
        ogrendim: 'âœ… GEKONNT',
        zorlandiklarim: 'SCHWIERIG',
        ogrendiklerim: 'GEKONNT'
      }
    }
    // Ä°ngilizce (en) kaldÄ±rÄ±ldÄ±
  },
  settings:{ language:'tr', nightMode:false, conversionMode: 'tr-de' }
};

// YENÄ°: Ä°Ã§erik ve Ä°lerleme Verisi AyrÄ± Tutuluyor
let srsData = {}; // { 'v1_s1_0': { status: 'zor', quizHistory: [1,1,0,1] }, ... }
let contentOverride = {}; // Yerel dÃ¼zenlemeler (Quick Edit, Admin)

/* ---------------- State ---------------- */
let state = {
  currentView:'mainMenu',
  group:null, groupData:null,
  verb:null, section:null, 
  mode:null, // 'study', 'quiz', 'cloze', 'wordorder'
  tekrarStatus: null, // 'zor', 'normal', 'ogrendim' (Tekrar modu iÃ§in)

  // --- Ã‡alÄ±ÅŸma & Tekrar State ---
  deck: [], // O an Ã§alÄ±ÅŸÄ±lan/tekrar edilen kartlarÄ±n index'leri
  deckPos: 0, 
  currentCardKey: null, // 'v1_s1_0' formatÄ±nda
  currentCardData: null, // {tr: '...', de: '...'}

  showAnswer:false,
  wordPool:[], wordSelected:[], userAnswer:'', correctAnswer:'', showResult:false,
  hintPanelVisible: false,

  speechRate: 1.0, // 1.0 = Normal, 0.5 = YavaÅŸ
  isSpeaking: false,
  autoPlayAudio: true 
};

/* ---------- MÃ¼zik Ã‡alar (DeÄŸiÅŸiklik yok) ---------- */
class MusicPlayer {
  constructor(streamUrl, volumeSliderId, toggleBtnId, settingsSliderId, settingsToggleId) {
    this.audio = new Audio(streamUrl);
    this.audio.crossOrigin = "anonymous";
    this.audio.loop = true; 

    this.isPlaying = false;
    this.currentVolume = 0.7; 
    this.dimmedVolume = 0.2;
    this.isDimmed = false;

    // Ana Ã§alar
    this.slider = document.getElementById(volumeSliderId);
    this.toggleBtn = document.getElementById(toggleBtnId);
    // Ayarlar menÃ¼sÃ¼ndeki kontroller
    this.settingsSlider = document.getElementById(settingsSliderId);
    this.settingsToggleBtn = document.getElementById(settingsToggleId);

    const savedVolume = parseFloat(localStorage.getItem('verbmatrix_music_volume')) || 0.7;
    this.setVolume(savedVolume * 100, true); // KayÄ±tlÄ± sesi yÃ¼kle
    
    // Olay dinleyicilerini ekle
    if (this.toggleBtn) this.toggleBtn.addEventListener('click', () => this.toggleMusic());
    if (this.slider) this.slider.addEventListener('input', (e) => this.setVolume(e.target.value));
    if (this.settingsToggleBtn) this.settingsToggleBtn.addEventListener('click', () => this.toggleMusic());
    if (this.settingsSlider) this.settingsSlider.addEventListener('input', (e) => this.setVolume(e.target.value));
  }
  
  updateUI() {
      const t = getMergedTranslations(data.settings.language || 'tr');
      const isPlaying = this.isPlaying;
      
      if (this.toggleBtn) this.toggleBtn.textContent = isPlaying ? 'â¸ï¸' : 'ğŸ”Š';
      if (this.settingsToggleBtn) {
          this.settingsToggleBtn.textContent = isPlaying ? 'â¸ï¸ ' + (t.buttons.pause || 'Durdur') : 'ğŸ”Š ' + (t.buttons.play || 'Ã‡al');
      }
      
      const volumeValue = this.currentVolume * 100;
      if (this.slider) this.slider.value = volumeValue;
      if (this.settingsSlider) this.settingsSlider.value = volumeValue;
  }

  toggleMusic() {
    if (this.isPlaying) {
      this.audio.pause();
      this.isPlaying = false;
      console.log("MÃ¼zik duraklatÄ±ldÄ±.");
    } else {
      this.audio.load(); 
      this.audio.play().then(() => {
        this.isPlaying = true;
        console.log("MÃ¼zik Ã§alÄ±nÄ±yor.");
      }).catch(error => {
        console.error("MÃ¼zik Ã§alÄ±namadÄ±:", error);
        alert("MÃ¼zik dosyasÄ± yÃ¼klenemedi. (telifsiz-klasik.mp3 dosyasÄ±nÄ± kontrol edin.)");
      });
    }
    this.updateUI();
  }

  setVolume(volumeValue, isInit = false) { 
    const newVolume = parseFloat(volumeValue) / 100;
    this.currentVolume = newVolume;
    
    if (!this.isDimmed) {
      this.audio.volume = this.currentVolume;
    }
    
    if (!isInit) {
        try {
          localStorage.setItem('verbmatrix_music_volume', this.currentVolume.toString());
        } catch (e) {}
    }
    
    // Her iki slider'Ä± da gÃ¼ncelle
    if (this.slider) this.slider.value = volumeValue;
    if (this.settingsSlider) this.settingsSlider.value = volumeValue;
  }

  dim_music(dim) {
    if (!this.isPlaying) return; 
    if (dim) {
      this.isDimmed = true;
      this.audio.volume = this.dimmedVolume;
    } else {
      this.isDimmed = false;
      this.audio.volume = this.currentVolume; 
    }
  }
}
let musicPlayer = null;

/* ---------- KonuÅŸma Sentezi (DeÄŸiÅŸiklik yok) ---------- */
let speechUtterance = null; 
function toggleAutoPlay() {
  state.autoPlayAudio = !state.autoPlayAudio;
  const btn = document.getElementById('autoPlayBtn');
  const led = document.getElementById('autoPlayLed');
  
  if (btn) {
    if (state.autoPlayAudio) {
      btn.innerHTML = `<span class'led-indicator active' id='autoPlayLed'></span>Otomatik Aktif`;
      led.classList.add('active');
    } else {
      btn.innerHTML = `<span class='led-indicator' id='autoPlayLed'></span>Otomatik Dinle`;
      led.classList.remove('active');
    }
  }
}
function updateSpeedButtonUI() {
    const ledL = document.getElementById('slowModeLedL');
    const ledS = document.getElementById('slowModeLedS');
    if (state.speechRate === 0.5) { 
        if(ledL) ledL.classList.add('active');
        if(ledS) ledS.classList.add('active');
    } else { 
        if(ledL) ledL.classList.remove('active');
        if(ledS) ledS.classList.remove('active');
    }
}
function toggleSpeechSpeed() {
    state.speechRate = (state.speechRate === 1.0) ? 0.5 : 1.0;
    updateSpeedButtonUI(); 
    if (speechUtterance && !speechSynthesis.paused) {
        speechSynthesis.cancel();
        speechSynthesis.speak(speechUtterance);
    }
}
function toggleSpeechPause() {
    if ('speechSynthesis' in window) {
        const btnL = document.getElementById('pauseBtn');
        const btnS = document.getElementById('storyPauseBtn');
        const btn = btnL && btnL.offsetParent !== null ? btnL : btnS;
        if (!btn) return;
        
        if (speechSynthesis.paused) {
            speechSynthesis.resume();
            btn.textContent = 'â¸ï¸ Durdur';
        } else {
            speechSynthesis.pause();
            btn.textContent = 'â–¶ï¸ Oynat';
        }
    }
}
function resetSpeechButtons() {
    if ('speechSynthesis' in window) {
        window.speechSynthesis.cancel();
    }
    const pauseBtnL = document.getElementById('pauseBtn');
    const pauseBtnS = document.getElementById('storyPauseBtn');
    if (pauseBtnL) { pauseBtnL.textContent = 'â¸ï¸ Durdur'; }
    if (pauseBtnS) { pauseBtnS.textContent = 'â¸ï¸ Durdur'; }
}
/* ---------- KonuÅŸma Sentezi SONU ---------- */


/* ---------- YENÄ°: SRS (Ä°lerleme) Veri YÃ¶netimi ---------- */

// CÃ¼mle iÃ§in global ID (key) oluÅŸturur
function getSrsKey(verbId, sectionNum, sentenceIndex) {
    return `${verbId}_s${sectionNum}_${sentenceIndex}`;
}

// Ä°lerleme verisini localStorage'dan yÃ¼kler
function loadSrsData() {
    try {
        const data = localStorage.getItem('verbmatrix_srs_data_v3');
        srsData = data ? JSON.parse(data) : {};
    } catch (e) {
        console.error("SRS verisi yÃ¼klenemedi", e);
        srsData = {};
    }
    updateProgressView(); // YÃ¼klendikten sonra ilerleme ekranÄ±nÄ± gÃ¼ncelle
}

// Ä°lerleme verisini localStorage'a kaydeder
function saveSrsData() {
    try {
        localStorage.setItem('verbmatrix_srs_data_v3', JSON.stringify(srsData));
    } catch (e) {
        console.error("SRS verisi kaydedilemedi", e);
    }
    updateProgressView(); // KayÄ±ttan sonra ilerleme ekranÄ±nÄ± gÃ¼ncelle
}

// Bir kartÄ±n SRS verisini alÄ±r veya oluÅŸturur
function getCardSrsData(key) {
    if (!srsData[key]) {
        srsData[key] = {
            status: 'new',      // new, zor, normal, ogrendim
            quizHistory: []     // 1 = doÄŸru, 0 = yanlÄ±ÅŸ
        };
    }
    return srsData[key];
}

// YENÄ°: Ä°lerlemeyi DÄ±ÅŸa Aktar
function exportSrsData() {
    const t = getMergedTranslations(data.settings.language || 'tr');
    const json = JSON.stringify(srsData, null, 2);
    const blob = new Blob([json], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'verbmatrix_ilerleme_data.json';
    a.click();
    URL.revokeObjectURL(url);
    alert(t.messages.progressExported);
}

// YENÄ°: Ä°lerlemeyi Ä°Ã§e Aktar
function importSrsData() {
    const input = document.getElementById('progressFileInput');
    input.onchange = async (e) => {
        const t = getMergedTranslations(data.settings.language || 'tr');
        try {
            const file = e.target.files[0]; if (!file) return;
            const text = await file.text();
            const imported = JSON.parse(text);
            
            // Basit bir doÄŸrulama: en az bir anahtarÄ±n 'status' Ã¶zelliÄŸi var mÄ±?
            if (Object.keys(imported).length > 0 && typeof Object.values(imported)[0].status !== 'string') {
                 throw new Error("Bu geÃ§erli bir ilerleme dosyasÄ± deÄŸil.");
            }

            srsData = imported;
            saveSrsData(); // localStorage'a kaydet
            alert(t.messages.progressLoaded);
            updateProgressView(); // GÃ¶rÃ¼nÃ¼mÃ¼ gÃ¼ncelle
        } catch (err) {
            alert(`${t.messages.loadError} ${err.message}`);
        }
        input.value = ''; 
    };
    input.click();
}


// YENÄ°: SRS StatÃ¼ DeÄŸiÅŸim MantÄ±ÄŸÄ±
// "Ã‡alÄ±ÅŸ" modundan (study) gelen derecelendirme (DÃœZELTÄ°LDÄ° v3.1)
function rateCard(newStatus) {
    const cardData = getCardSrsData(state.currentCardKey);
    cardData.status = newStatus;
    cardData.quizHistory = []; // Yeni Ã¶ÄŸrenildiÄŸi iÃ§in quiz geÃ§miÅŸi sÄ±fÄ±rlanÄ±r
    
    console.log(`Kart ${state.currentCardKey} -> ${newStatus} olarak ayarlandÄ±.`);
    
    saveSrsData(); // DeÄŸiÅŸikliÄŸi kaydet
    
    // --- DÃœZELTME ---
    // Bir sonraki karta geÃ§mek iÃ§in pozisyonu artÄ±r
    state.deckPos++;
    // Cevap gÃ¶sterme bayraÄŸÄ±nÄ± sÄ±fÄ±rla
    state.showAnswer = false; 
    
    // renderSentence() yerine showLearning() Ã§aÄŸrÄ±lmalÄ±.
    // showLearning() bir sonraki kartÄ±n verisini (currentCardKey, currentCardData) yÃ¼kler
    // ve *ardÄ±ndan* renderSentence()'i kendi iÃ§inde Ã§aÄŸÄ±rÄ±r.
    showLearning(); 
}

// "Tekrar" (Quiz) modundan gelen sonuÃ§
function updateSrsStatusAfterQuiz(key, isCorrect) {
    const cardData = getCardSrsData(key);
    const history = cardData.quizHistory || [];
    
    history.push(isCorrect ? 1 : 0);
    // Son 3 cevabÄ± tut (veya daha fazla)
    while (history.length > 5) {
        history.shift();
    }
    cardData.quizHistory = history;

    const currentStatus = cardData.status;
    
    // StatÃ¼ YÃ¼kseltme/DÃ¼ÅŸÃ¼rme MantÄ±ÄŸÄ±
    // Ã–rn: ZOR -> NORMAL (Ãœst Ã¼ste 2 doÄŸru)
    if (currentStatus === 'zor' && history.length >= 2 && history.slice(-2).every(v => v === 1)) {
        cardData.status = 'normal';
        cardData.quizHistory = []; // GeÃ§miÅŸi temizle
        console.log(`YÃœKSELDÄ°: ${key} -> NORMAL`);
    }
    // Ã–rn: NORMAL -> Ã–ÄRENDÄ°M (Ãœst Ã¼ste 3 doÄŸru)
    else if (currentStatus === 'normal' && history.length >= 3 && history.slice(-3).every(v => v === 1)) {
        cardData.status = 'ogrendim';
        cardData.quizHistory = []; // GeÃ§miÅŸi temizle
        console.log(`YÃœKSELDÄ°: ${key} -> Ã–ÄRENDÄ°M`);
    }
    // Ã–rn: NORMAL -> ZOR (Ãœst Ã¼ste 3 yanlÄ±ÅŸ)
    else if (currentStatus === 'normal' && history.length >= 3 && history.slice(-3).every(v => v === 0)) {
        cardData.status = 'zor';
        cardData.quizHistory = []; // GeÃ§miÅŸi temizle
        console.log(`DÃœÅTÃœ: ${key} -> ZOR`);
    }
    // Ã–rn: Ã–ÄRENDÄ°M -> NORMAL (Ãœst Ã¼ste 2 yanlÄ±ÅŸ)
    else if (currentStatus === 'ogrendim' && history.length >= 2 && history.slice(-2).every(v => v === 0)) {
        cardData.status = 'normal';
        cardData.quizHistory = []; // GeÃ§miÅŸi temizle
        console.log(`DÃœÅTÃœ: ${key} -> NORMAL`);
    }

    saveSrsData();
}

// YENÄ°: SRS Verisini SÄ±fÄ±rla
function resetSrsData() {
    const t = getMergedTranslations(data.settings.language || 'tr');
    if (confirm(t.messages.srsResetConfirm)) {
        srsData = {};
        saveSrsData();
        alert(t.messages.srsReset);
    }
}

/* ---------- Ä°Ã§erik (Content) Veri YÃ¶netimi ---------- */

// YENÄ°: Sunucudan ana JSON verisini yÃ¼kler
async function loadDataFromServer() {
    try {
        const response = await fetch('verbmatrix_data.json'); // AynÄ± dizinden Ã§ek
        if (!response.ok) {
            throw new Error(`HTTP hatasÄ±! Durum: ${response.status}`);
        }
        const serverData = await response.json();
        
        // Sunucu verisini 'data'ya yÃ¼kle
        data = deepMerge(data, serverData); // VarsayÄ±lan Ã§evirileri koruyarak birleÅŸtir
        console.log('âœ… Sunucudan iÃ§erik verisi yÃ¼klendi.');
        
        // Yerel dÃ¼zenlemeleri (override) yÃ¼kle
        loadContentOverride();

    } catch (e) {
        console.error("Sunucudan 'verbmatrix_data.json' yÃ¼klenemedi. VarsayÄ±lan veri kullanÄ±lacak.", e);
        // Hata durumunda, yerel dÃ¼zenlemeler varsa yÃ¼kle
        loadContentOverride();
    }
}

// Yerel iÃ§erik dÃ¼zenlemelerini (Admin, QuickEdit) yÃ¼kler
function loadContentOverride() {
    try {
        const override = localStorage.getItem('verbmatrix_content_override');
        if (override) {
            contentOverride = JSON.parse(override);
            data = deepMerge(data, contentOverride); // Ana 'data' objesinin Ã¼zerine yaz
            console.log('âœ… Yerel iÃ§erik dÃ¼zenlemeleri (Override) yÃ¼klendi.');
        } else {
            contentOverride = {};
        }
    } catch (e) {
        console.error("Yerel iÃ§erik dÃ¼zenlemeleri yÃ¼klenirken hata:", e);
        localStorage.removeItem('verbmatrix_content_override');
        contentOverride = {};
    }
}

// Yerel iÃ§erik dÃ¼zenlemelerini (Admin, QuickEdit) kaydeder
function saveContentOverride() {
    // Kaydedilecek veriyi, ana 'data' objesinden al
    const contentToSave = {
        groups: data.groups,
        verbs: data.verbs,
        content: data.content,
        sections: data.sections,
        sectionsHints: data.sectionsHints,
        hints: data.hints
    };
    
    // contentOverride objesini gÃ¼ncelle
    contentOverride = deepMerge(contentOverride, contentToSave);
    
    try {
        localStorage.setItem('verbmatrix_content_override', JSON.stringify(contentOverride));
        console.log('âœ… Ä°Ã§erik gÃ¼ncellendi ve yerel olarak kaydedildi (Override).');
    } catch (e) {
        console.error("Ä°Ã§erik depolanamadÄ±:", e);
    }
}

// YENÄ°: 'data' objesinin tamamÄ±nÄ± JSON olarak indirir
function exportData(){
  const t = getMergedTranslations(data.settings.language || 'tr');
  const json = JSON.stringify(data,null,2);
  const blob = new Blob([json],{type:'application/json'}); const url = URL.createObjectURL(blob); const a = document.createElement('a');
  a.href = url; a.download = 'verbmatrix_data.json'; a.click(); URL.revokeObjectURL(url); 
  alert(t.messages.dataExported);
}

// YENÄ°: JSON dosyasÄ±ndan 'data' objesini gÃ¼nceller ve 'override' olarak kaydeder
function importData(imported){
    const t = getMergedTranslations(data.settings.language || 'tr');
    try {
        const defaultTranslations = JSON.parse(JSON.stringify(data.translations));

        data.groups = imported.groups;
        data.verbs = imported.verbs;
        data.content = imported.content;
        if(imported.sections) data.sections = imported.sections;
        if(imported.sectionsHints) data.sectionsHints = imported.sectionsHints;
        if(imported.hints) data.hints = imported.hints;
        if(imported.settings) data.settings = Object.assign(data.settings || {}, imported.settings);

        if (imported.translations) {
            data.translations = deepMerge(defaultTranslations, imported.translations);
        }
        
        saveContentOverride(); // Ä°Ã§e aktarÄ±lan veriyi yerel 'override' olarak kaydet
        
        alert(`${t.messages.dataLoaded} ${data.groups.length}`);
        loadSettings(); 
        showView('mainMenu');
        
    } catch(err){ 
        alert(`${t.messages.loadError} ${err.message}`); 
    } 
}

// Dosyadan yÃ¼kleme tetikleyicisi
function importDataFromFile(){
  const input = document.getElementById('fileInput');
  input.onchange = async (e)=>{ 
    try{
      const file = e.target.files[0]; if(!file) return;
      const text = await file.text();
      const importedJson = JSON.parse(text);
      importData(importedJson); // Ana iÃ§e aktarma fonksiyonunu Ã§aÄŸÄ±r
    } catch(err) {
      const t = getMergedTranslations(data.settings.language || 'tr');
      alert(`${t.messages.loadError} ${err.message}`); 
    }
    input.value=''; 
  };
  input.click();
}

// Textarea'dan yÃ¼kleme
function loadJsonFromTextarea(){
  const txt = document.getElementById('jsonPaste').value.trim();
  const t = getMergedTranslations(data.settings.language || 'tr');
  if(!txt){ alert('JSON yapÄ±ÅŸtÄ±rÄ±n'); return; }
  try{
    const importedJson = JSON.parse(txt);
    importData(importedJson); // Ana iÃ§e aktarma fonksiyonunu Ã§aÄŸÄ±r
    document.getElementById('jsonPaste').value='';
  } catch(e){ alert(`${t.messages.loadError} ${e.message}`); }
}


/* -------------------------------------------------------- */
/* ---------- Ayarlar ve ArayÃ¼z FonksiyonlarÄ± ---------- */
/* -------------------------------------------------------- */

function showView(id){
  document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
  const el = document.getElementById(id);
  if(el) el.classList.add('active');
  state.currentView = id;
  
  const headerEl = document.querySelector('.container > header');
  const hideLogo = ['learningView', 'storyView', 'storyQuestionsView'].includes(id);
  if (headerEl) {
      headerEl.style.display = hideLogo ? 'none' : 'block';
  }

  resetSpeechButtons(); 

  if (id === 'learningView' || id === 'storyView') {
      updateSpeedButtonUI();
  }

  if(id === 'modeMenu' || id === 'tekrarModeMenu') { 
      updateConversionButtons();
  }
  if(id === 'adminView'){
    document.getElementById('adminTsvArea').style.display = 'none'; 
  }
  if(id === 'adminContentView'){
    document.getElementById('adminContentArea').style.display = 'none'; 
    document.getElementById('adminContentArea').innerHTML = '';
  }
  if(id === 'adminSentenceListView'){
    renderAllSentencesTable(); 
  }
  if(id === 'progress') {
    updateProgressView(); // Ä°lerleme ekranÄ±nÄ± her aÃ§Ä±ldÄ±ÄŸÄ±nda yenile
  }
  if(id === 'tekrarMenu') {
    updateProgressView(); // Tekrar menÃ¼sÃ¼ndeki sayÄ±larÄ± yenile
  }
}

function getProperty(obj, keyString) {
  if (!keyString) return null;
  return keyString.split('.').reduce((acc, key) => (acc && acc[key] !== undefined) ? acc[key] : null, obj);
}

// GÃœNCELLENDÄ° (v3.0): 'en' desteÄŸi kaldÄ±rÄ±ldÄ±
function getMergedTranslations(lang = 'tr') {
    const defaultLang = 'tr';
    const defaultTranslations = data.translations[defaultLang] || {};
    
    if (lang === defaultLang || !data.translations[lang] || Object.keys(data.translations[lang]).length === 0) {
        return defaultTranslations;
    }
    
    return deepMerge(defaultTranslations, data.translations[lang]);
}

function updateUITexts(){
  const lang = data.settings.language || 'tr';
  const t = getMergedTranslations(lang); 

  document.querySelectorAll('[data-translate-key]').forEach(el => {
    const key = el.dataset.translateKey;
    const translation = getProperty(t, key);
    
    if (translation) {
      if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
        if (el.placeholder !== undefined) el.placeholder = translation;
      } else {
        // Buton iÃ§indeki span'leri koru
        const firstChild = el.firstChild;
        if (firstChild && (firstChild.tagName === 'SPAN' || firstChild.tagName === 'I')) {
            // Sadece text node'u gÃ¼ncelle
            let textNode = firstChild.nextSibling;
            if (textNode && textNode.nodeType === Node.TEXT_NODE) {
                textNode.textContent = ' ' + translation;
            } else {
                el.appendChild(document.createTextNode(' ' + translation));
            }
        } else {
            el.textContent = translation;
        }
      }
    } else {
      console.warn(`Translation key not found: ${key} for lang: ${lang}`);
    }
  });
  
  // Kalan UI elementlerini gÃ¼ncelle
  if(musicPlayer) musicPlayer.updateUI();
  updateAutoPlayButtonText();
}

function updateAutoPlayButtonText() {
    const autoPlayBtn = document.getElementById('autoPlayBtn');
    if (autoPlayBtn) {
        if (state.autoPlayAudio) {
            autoPlayBtn.innerHTML = `<span class='led-indicator active' id='autoPlayLed'></span>Otomatik Aktif`;
        } else {
            autoPlayBtn.innerHTML = `<span class'led-indicator' id='autoPlayLed'></span>Otomatik Dinle`;
        }
    }
}

function changeLanguage(lang, btnEl){
  data.settings.language = lang;
  document.querySelectorAll('.lang-btn').forEach(b=>b.classList.remove('active'));
  if(btnEl) btnEl.classList.add('active');
  updateUITexts();
  saveSettings();
}

function toggleNightMode(){
  const body = document.body;
  const on = body.classList.toggle('night-mode');
  data.settings.nightMode = on;
  const toggleCheckbox = document.getElementById('nightModeToggle');
  if(toggleCheckbox) toggleCheckbox.checked = on;
  saveSettings();
}

function saveSettings(){ try{ localStorage.setItem('verbmatrix_settings', JSON.stringify(data.settings)); }catch(e){} }
function loadSettings(){
  try{
    const s = JSON.parse(localStorage.getItem('verbmatrix_settings')||'{}');
    if(s.language) data.settings.language = s.language;
    if(typeof s.nightMode === 'boolean') data.settings.nightMode = s.nightMode;
    if(s.conversionMode) data.settings.conversionMode = s.conversionMode; 
  }catch(e){}
  
  const toggleCheckbox = document.getElementById('nightModeToggle');
  if(toggleCheckbox) toggleCheckbox.checked = !!data.settings.nightMode;
  if(data.settings.nightMode) document.body.classList.add('night-mode');
  
  document.querySelectorAll('.lang-btn').forEach(b=>b.classList.remove('active'));
  const map = {tr:'langTR', de:'langDE'}; // 'en' kaldÄ±rÄ±ldÄ±
  const btn = document.getElementById(map[data.settings.language]||'langTR');
  if(btn) btn.classList.add('active');
  
  updateUITexts();
}

/* ---------- Ã‡eviri YÃ¶nÃ¼ (Conversion Mode) ---------- */
function setConversionMode(mode) {
    data.settings.conversionMode = mode;
    saveSettings(); 
    updateConversionButtons();
}
function updateConversionButtons() {
    const modes = ['mode', 'tekrarMode'];
    modes.forEach(prefix => {
        const trdeBtn = document.getElementById(prefix + 'TRDE');
        const detrBtn = document.getElementById(prefix + 'DETR');
        if (!trdeBtn || !detrBtn) return;
        
        if (data.settings.conversionMode === 'tr-de') {
            trdeBtn.classList.add('btn-primary');
            trdeBtn.classList.remove('btn-info');
            detrBtn.classList.add('btn-info');
            detrBtn.classList.remove('btn-primary');
        } else {
            trdeBtn.classList.add('btn-info');
            trdeBtn.classList.remove('btn-primary');
            detrBtn.classList.add('btn-primary');
            detrBtn.classList.remove('btn-info');
        }
    });
}

/* -------------------------------------------------------- */
/* ---------- ANA AKIÅ FONKSÄ°YONLARI (v3.0) ---------- */
/* -------------------------------------------------------- */

/* ---------- AkÄ±ÅŸ 1: Ã‡alÄ±ÅŸ (Grup/Fiil/BÃ¶lÃ¼m SeÃ§imi) ---------- */
function loadAndShowGroupMenu(){
  const container = document.getElementById('groupButtons');
  container.innerHTML = '';
  const t = getMergedTranslations(data.settings.language || 'tr');

  if(!data.groups || data.groups.length===0){
    container.innerHTML = `<div class="content-box">${t.messages.noGroups}</div>`;
    showView('groupMenu'); 
    return;
  }
  
  const grid = document.createElement('div');
  grid.className = 'group-story-grid';
  
  data.groups.forEach(g=>{
    const groupBtn = document.createElement('button');
    groupBtn.className = 'btn btn-primary';
    groupBtn.innerHTML = `<strong>${g.name}</strong><span class="small-muted">${g.nameDE || ''}</span>`;
    groupBtn.onclick = ()=>selectGroup(g.id);
    grid.appendChild(groupBtn);

    const storyBtn = document.createElement('button');
    storyBtn.className = 'btn btn-warning';
    if (g.story && g.story.title) {
      storyBtn.textContent = g.story.title;
      storyBtn.onclick = ()=>showGroupStory(g.id); 
    } else {
      storyBtn.textContent = t.messages.noStoryAvailable;
      storyBtn.classList.add('disabled');
      storyBtn.disabled = true;
    }
    grid.appendChild(storyBtn);
  });
  container.appendChild(grid);
  showView('groupMenu');
}

function selectGroup(id){
  state.group = id; state.groupData = data.groups.find(x=>x.id===id) || null;
  const verbs = (data.verbs[id]||[]).filter(v=>v.id);
  const container = document.getElementById('verbButtons'); container.innerHTML='';
  const t = getMergedTranslations(data.settings.language || 'tr');
  if(verbs.length===0){ 
    container.innerHTML = `<div class="content-box">${t.messages.noVerbs}</div>`; 
    showView('verbMenu'); 
    return; 
  }
  verbs.forEach(v=>{
    const b = document.createElement('button'); b.className='btn btn-primary'; b.textContent = `${v.verbTR || v.verbDE}` + (v.verbDE? ' ('+v.verbDE+')':''); b.onclick = ()=>selectVerb(v.id); container.appendChild(b);
  });
  showView('verbMenu');
}

function selectVerb(verbId){
  state.verb = verbId;
  const container = document.getElementById('sectionButtons'); container.innerHTML='';
  
  Object.entries(data.sections).forEach(([num,name])=>{
    const b = document.createElement('button');
    const key = `${verbId}_s${num}`;
    const contentArray = data.content[key] || [];
    const sentenceCount = contentArray.length;
    
    // YENÄ°: Ã‡alÄ±ÅŸÄ±lmamÄ±ÅŸ kart sayÄ±sÄ±nÄ± bul
    let newCount = 0;
    if (sentenceCount > 0) {
        for(let i=0; i < sentenceCount; i++) {
            const srsKey = getSrsKey(verbId, num, i);
            const cardData = getCardSrsData(srsKey); // Veriyi oluÅŸtur/al
            if (cardData.status === 'new') {
                newCount++;
            }
        }
    }
    
    b.textContent = `${num}. ${name} (${newCount}/${sentenceCount})`;
    
    if (sentenceCount > 0) {
      b.className = (newCount > 0) ? 'btn btn-primary' : 'btn btn-secondary'; // Yeni kart varsa mavi, yoksa gri
      b.onclick = ()=>selectSection(parseInt(num));
    } else {
      b.className='btn btn-danger disabled';
      b.disabled = true;
    }
    container.appendChild(b);
  });
  
  showView('sectionMenu');
}

function selectSection(sectionNum){
  state.section = sectionNum;
  // Mod seÃ§imi kaldÄ±rÄ±ldÄ±, direkt Ã§eviri yÃ¶nÃ¼ ekranÄ±na git
  showView('modeMenu');
}

/* ---------- AkÄ±ÅŸ 2: Tekrar (StatÃ¼/Mod SeÃ§imi) ---------- */

// StatÃ¼ seÃ§ildi (Zor, Normal, Ã–ÄŸrendim)
function startTekrar(status) {
    state.tekrarStatus = status;
    state.mode = null;
    const t = getMergedTranslations(data.settings.language || 'tr');
    
    const statusMap = {
        zor: t.srs.zorlandiklarim,
        normal: t.srs.normal,
        ogrendim: t.srs.ogrendiklerim
    };
    document.getElementById('tekrarModeTitle').textContent = statusMap[status] || 'Tekrar Modu';
    showView('tekrarModeMenu');
}

// Mod seÃ§ildi (Quiz, Cloze, WordOrder)
function startTekrarMode(modeId) {
    state.mode = modeId;
    
    // 1. Ä°lgili statÃ¼deki TÃœM kartlarÄ± bul
    const allCardsOfStatus = [];
    Object.keys(srsData).forEach(key => {
        if (srsData[key].status === state.tekrarStatus) {
            allCardsOfStatus.push(key);
        }
    });
    
    // 2. Desteyi (deck) oluÅŸtur
    state.deck = shuffle(allCardsOfStatus);
    state.deckPos = 0;
    
    console.log(`Tekrar modu: ${state.tekrarStatus} (${state.mode}). ${state.deck.length} kart bulundu.`);

    // 3. Ã‡alÄ±ÅŸma ekranÄ±nÄ± baÅŸlat
    showLearning();
}


/* ---------- AkÄ±ÅŸ 3: Ã‡alÄ±ÅŸma EkranÄ± (Learning View) ---------- */

// 'Ã‡alÄ±ÅŸ' (study) modu iÃ§in desteyi hazÄ±rlar
function startMode(modeId){
  state.mode = modeId; 
  state.tekrarStatus = null; // Ã‡alÄ±ÅŸ modunda statÃ¼ seÃ§imi yok
  
  // 1. Bu bÃ¶lÃ¼mdeki (verb+section) cÃ¼mleleri al
  const sentences = getSentences();
  
  // 2. Sadece statÃ¼sÃ¼ 'new' olanlarÄ± bul
  const newCards = [];
  for (let i = 0; i < sentences.length; i++) {
      const key = getSrsKey(state.verb, state.section, i);
      const cardData = getCardSrsData(key);
      if (cardData.status === 'new') {
          newCards.push(key); // AnahtarÄ± ('v1_s1_0') desteye ekle
      }
  }
  
  // 3. Desteyi (deck) oluÅŸtur
  state.deck = shuffle(newCards);
  state.deckPos = 0;
  
  console.log(`Ã‡alÄ±ÅŸma modu: ${state.verb}_s${state.section}. ${state.deck.length} YENÄ° kart bulundu.`);

  // 4. Ã‡alÄ±ÅŸma ekranÄ±nÄ± baÅŸlat
  showLearning();
}

function getSentences(){ 
    if (!state.verb || !state.section) return [];
    return data.content[`${state.verb}_s${state.section}`] || []; 
}
function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]] } return a; }


// GÃœNCELLENDÄ° (v3.0): showLearning (ArtÄ±k state.deck kullanÄ±yor)
function showLearning(){
  const t = getMergedTranslations(data.settings.language || 'tr');
  resetSpeechButtons(); 

  // Ã‡Ä±kÄ±ÅŸ butonunun hedefini ayarla
  const exitBtn = document.getElementById('learningExitBtn');
  if (state.mode === 'study') {
      exitBtn.onclick = () => showView('modeMenu');
  } else {
      exitBtn.onclick = () => showView('tekrarModeMenu');
  }

  // 1. Destede kart kaldÄ± mÄ±?
  if (state.deck.length === 0) {
      const message = (state.mode === 'study') ? t.messages.noNewCards : t.messages.noDueCards;
      document.getElementById('learningContent').innerHTML = `<div class="content-box"><h3 style="text-align:center">${message}</h3></div>`;
      updateProgress(0, 0);
      showView('learningView');
      return;
  }
  
  // 2. Deste bitti mi?
  if (state.deckPos >= state.deck.length) {
      showCompletion();
      return;
  }

  // 3. Mevcut kartÄ± ayarla
  state.currentCardKey = state.deck[state.deckPos];
  
  // Kart anahtarÄ±nÄ± ('v1_s1_0') parse et
  const parts = state.currentCardKey.match(/^(.*?)_s(\d+)_(\d+)$/);
  if (!parts) {
      console.error("GeÃ§ersiz kart anahtarÄ±:", state.currentCardKey);
      state.deckPos++;
      showLearning(); // Sonraki kartÄ± dene
      return;
  }
  
  const verbId = parts[1];
  const sectionNum = parts[2];
  const sentenceIndex = parseInt(parts[3]);

  // CÃ¼mle verisini 'data' objesinden Ã§ek
  const sentenceArray = data.content[`${verbId}_s${sectionNum}`] || [];
  state.currentCardData = sentenceArray[sentenceIndex];
  
  if (!state.currentCardData) {
      console.error(`CÃ¼mle verisi bulunamadÄ±: ${state.currentCardKey}`);
      state.deckPos++;
      showLearning(); // Sonraki kartÄ± dene
      return;
  }
  
  // 4. KartÄ± render et
  renderSentence(); 
  showView('learningView');
}

function updateProgress(current, total){
  const currQuestionNum = Math.min(current + 1, total); 
  const percent = total === 0 ? 100 : Math.round((current / total) * 100); 
  
  document.getElementById('progressFill').style.width = percent + '%';
  document.getElementById('progressFill').textContent = percent + '%';
  document.getElementById('progressText').textContent = `${currQuestionNum} / ${total}`;
}


function buildHintHtml(){
  // Kart anahtarÄ±nÄ± ('v1_s1_0') parse et
  const parts = state.currentCardKey.match(/^(.*?)_s(\d+)_(\d+)$/);
  const verbId = parts[1];
  const sectionNum = parts[2];
  const sentenceIndex = parseInt(parts[3]);
  const secCode = 'B' + sectionNum;

  let html = '';
  
  if(data.hints && data.hints.sentences && data.hints.sentences[state.currentCardKey]){
    html += `<div class="hint-item"><strong>Ä°pucu (CÃ¼mle):</strong> ${escapeHtml(data.hints.sentences[state.currentCardKey])}</div>`;
  }
  // ... diÄŸer ipucu tÃ¼rleri ...
  if(data.hints && data.hints.verbs && data.hints.verbs[verbId]){
    html += `<div class="hint-item"><strong>Ä°pucu (Fiil):</strong> ${escapeHtml(data.hints.verbs[verbId])}</div>`;
  }
  if(data.sectionsHints && data.sectionsHints[secCode]) {
      html += `<div class="hint-item"><strong>Ä°pucu (Genel BÃ¶lÃ¼m):</strong> ${escapeHtml(data.sectionsHints[secCode])}</div>`;
  }
  
  return html;
}

// GÃœNCELLENDÄ° (v3.0): renderSentence (ArtÄ±k state.currentCardData kullanÄ±yor)
function renderSentence(){
  const container = document.getElementById('learningContent');
  document.getElementById('resultArea').innerHTML=''; 
  document.getElementById('answerArea').innerHTML=''; 
  const hintPanelEl = document.getElementById('hintPanel');
  const quickEditPanel = document.getElementById('quickEditPanel');
  
  quickEditPanel.style.display = 'none';
  hintPanelEl.style.display = state.hintPanelVisible ? 'block' : 'none';
  hintPanelEl.innerHTML = ''; 
  state.showResult = false;
  state.wordPool = [];
  state.wordSelected = [];
  
  // Deste bittiyse tamamlanma ekranÄ±nÄ± gÃ¶ster
  if (state.deckPos >= state.deck.length) {
      showCompletion();
      return;
  }
  
  const sent = state.currentCardData;
  if (!sent) { 
      console.error("Render edilecek cÃ¼mle bulunamadÄ±", state.currentCardKey);
      return; 
  }
  
  container.innerHTML = '';
  const hintHtml = buildHintHtml();

  const t = getMergedTranslations(data.settings.language || 'tr');
  const isTrDe = data.settings.conversionMode === 'tr-de';
  
  const questionText = isTrDe ? sent.tr : sent.de;
  const answerText = isTrDe ? sent.de : sent.tr;
  const questionLang = isTrDe ? 'TR' : 'DE';
  const answerLang = isTrDe ? 'DE' : 'TR';
  
  // BaÅŸlÄ±ÄŸÄ± gÃ¼ncelle
  let title = '';
  if (state.mode === 'study') title = t.modes.study;
  else if (state.mode === 'quiz') title = t.modes.quiz;
  else if (state.mode === 'cloze') title = t.modes.cloze;
  else if (state.mode === 'wordorder') title = t.modes.wordorder;
  document.getElementById('learningTitle').textContent = title;

  if(state.mode === 'study'){
    container.innerHTML = `<div class="sentence"><strong>${questionLang}:</strong> ${escapeHtml(questionText)}</div>
                             <div id="answerDisplay" class="sentence hidden"><strong>${answerLang}:</strong> ${escapeHtml(answerText)}</div>`;
  } else if(state.mode === 'cloze'){
    const words = answerText.split(/\s+/).filter(Boolean); // Cevap metninden boÅŸluk doldur
    const idx = Math.floor(Math.random()*words.length);
    const correct = words[idx].replace(/[.,!?;:]$/,'');
    words[idx] = '_____';
    state.correctAnswer = correct;
    container.innerHTML = `<div class="sentence"><b>${questionLang}:</b> ${escapeHtml(questionText)}</div>
                             <div class="sentence"><b>${answerLang}:</b> ${escapeHtml(words.join(' '))}</div>
                             <input id="clozeInput" class="input-field" placeholder="${t.placeholders?.cloze || 'BoÅŸluÄŸu doldurun...'}">`;
  } else if(state.mode === 'wordorder'){
    const words = answerText.split(/\s+/).filter(Boolean); // Cevap metnini sÄ±rala
    state.wordPool = shuffle([...words]);
    state.wordSelected = []; 
    state.correctAnswer = words.join(' ');
    
    container.innerHTML = `<div class="sentence"><b>${questionLang}:</b> ${escapeHtml(questionText)}</div>
                             <div class="word-order-area">
                               <div class="word-pool"><strong>KarÄ±ÅŸÄ±k Kelimeler:</strong><div id="wordPoolArea"></div></div>
                               <div class="word-selected"><strong>DÃ¼zenleme SatÄ±rÄ±:</strong><div id="wordSelectedArea"></div></div>
                             </div>`;
    renderWordOrder();
  } else if(state.mode === 'quiz'){
    state.correctAnswer = answerText; 
    container.innerHTML = `<div class="sentence"><b>${questionLang}:</b> ${escapeHtml(questionText)}</div>
                             <input id="quizInput" class="input-field" placeholder="${t.placeholders?.quiz || 'Ã‡eviriyi yazÄ±n...'}">`;
  }
  
  if(hintHtml && state.hintPanelVisible){ 
    hintPanelEl.innerHTML = hintHtml; 
    hintPanelEl.style.display = 'block'; 
  } else {
    hintPanelEl.innerHTML = '';
    hintPanelEl.style.display = 'none';
  }

  // Dinleme butonlarÄ±nÄ±n durumu
  const btnDE = document.getElementById('btnPlayDE');
  const btnTR = document.getElementById('btnPlayTR');
  const canPlayDE = (state.mode === 'study' && state.showAnswer) || state.showResult || !isTrDe;
  const canPlayTR = (state.mode === 'study' && state.showAnswer) || state.showResult || isTrDe;
  btnDE.disabled = !canPlayDE; btnDE.classList.toggle('disabled', !canPlayDE);
  btnTR.disabled = !canPlayTR; btnTR.classList.toggle('disabled', !canPlayTR);

  // Ana Eylem ButonlarÄ± (GÃ¶ster / Kontrol Et / SRS)
  const actionBtn = document.getElementById('actionBtn');
  const srsControls = document.getElementById('srsControls');

  if (state.mode === 'study') {
      if (state.showAnswer) {
          actionBtn.style.display = 'none';
          srsControls.style.display = 'flex';
      } else {
          actionBtn.style.display = 'block';
          srsControls.style.display = 'none';
          actionBtn.textContent = t.buttons.show;
          actionBtn.onclick = handleAction;
      }
      document.querySelector('[onclick="previousQuestion()"]').style.display = 'none'; // Ã‡alÄ±ÅŸ modunda "Ã–nceki" yok
  } else { // quiz, cloze, wordorder
      actionBtn.style.display = 'block';
      srsControls.style.display = 'none';
      actionBtn.textContent = t.buttons.check;
      actionBtn.onclick = handleAction;
      document.querySelector('[onclick="previousQuestion()"]').style.display = 'block';
  }
  
  updateProgress(state.deckPos, state.deck.length);
}


function showQuickEditPanel(){
    if (!state.currentCardData) return;
    const sent = state.currentCardData;
    const currentHint = (data.hints && data.hints.sentences && data.hints.sentences[state.currentCardKey]) || '';

    document.getElementById('qe_tr').value = sent.tr || '';
    document.getElementById('qe_de').value = sent.de || '';
    document.getElementById('qe_hint').value = currentHint;
    document.getElementById('quickEditTitle').textContent = `HÄ±zlÄ± DÃ¼zenle (${state.currentCardKey})`;
    document.getElementById('quickEditPanel').style.display = 'block';
}

function saveQuickEdit(){
    if (!state.currentCardKey) return;
    
    // Kart anahtarÄ±nÄ± ('v1_s1_0') parse et
    const parts = state.currentCardKey.match(/^(.*?)_s(\d+)_(\d+)$/);
    const verbId = parts[1];
    const sectionNum = parts[2];
    const sentenceIndex = parseInt(parts[3]);

    const newTr = document.getElementById('qe_tr').value.trim();
    const newDe = document.getElementById('qe_de').value.trim();
    const newHint = document.getElementById('qe_hint').value.trim();

    // 1. Ana 'data' objesini gÃ¼ncelle
    const contentKey = `${verbId}_s${sectionNum}`;
    if (!data.content[contentKey]) data.content[contentKey] = [];
    data.content[contentKey][sentenceIndex] = { tr: newTr, de: newDe };
    
    if(!data.hints) data.hints = {sentences:{}, verbs:{}, sections:{}};
    if(!data.hints.sentences) data.hints.sentences = {};
    if (newHint) { data.hints.sentences[state.currentCardKey] = newHint; } 
    else { delete data.hints.sentences[state.currentCardKey]; }
    
    // 2. State'deki mevcut kartÄ± gÃ¼ncelle
    state.currentCardData = { tr: newTr, de: newDe };
    
    // 3. DeÄŸiÅŸiklikleri 'override' olarak kaydet
    saveContentOverride(); 
    
    document.getElementById('quickEditPanel').style.display = 'none';
    renderSentence(); // EkranÄ± yeniden Ã§iz
    
    const t = getMergedTranslations(data.settings.language || 'tr');
    alert(t.messages.quickEditSaved);
}


function renderWordOrder(){
  const pool = document.getElementById('wordPoolArea'); 
  const sel = document.getElementById('wordSelectedArea');
  pool.innerHTML=''; 
  sel.innerHTML='';
  state.wordSelected.forEach((w,i)=>{
    const d = document.createElement('div'); d.className='word-item top'; d.textContent = w; d.onclick = ()=> unselectWord(i, w); sel.appendChild(d);
  });
  state.wordPool.forEach((w,i)=>{
    const d = document.createElement('div'); d.className='word-item'; d.textContent = w; d.onclick = ()=> selectWordFromPool(i); pool.appendChild(d);
  });
}
function selectWordFromPool(index){ const word = state.wordPool[index]; state.wordSelected.push(word); state.wordPool.splice(index, 1); renderWordOrder(); }
function unselectWord(index, word){ const removedWord = state.wordSelected.splice(index, 1)[0]; state.wordPool.push(removedWord); renderWordOrder(); }

// GÃœNCELLENDÄ° (v3.0): handleAction (Yeni SRS mantÄ±ÄŸÄ±)
function handleAction(){
  const btn = document.getElementById('actionBtn');
  const resultArea = document.getElementById('resultArea'), answerArea = document.getElementById('answerArea');
  const t = getMergedTranslations(data.settings.language || 'tr');

  const triggerAutoPlay = () => {
      if (state.autoPlayAudio) {
          playCurrentSentence('de');
      }
  };

  if(state.mode === 'study'){
    // "GÃ¶ster" butonuna basÄ±ldÄ±
    if(!state.showAnswer){
      const ad = document.getElementById('answerDisplay'); 
      if(ad) ad.classList.remove('hidden'); 
      state.showAnswer = true; 
      
      btn.style.display = 'none';
      document.getElementById('srsControls').style.display = 'flex';
      
      // Dinleme butonlarÄ±nÄ± aktifleÅŸtir
      document.getElementById('btnPlayDE').disabled = false; document.getElementById('btnPlayDE').classList.remove('disabled');
      document.getElementById('btnPlayTR').disabled = false; document.getElementById('btnPlayTR').classList.remove('disabled');
      
      triggerAutoPlay();
    }
    // (SRS butonlarÄ±na basÄ±ldÄ±ÄŸÄ±nda 'rateCard' fonksiyonu Ã§aÄŸrÄ±lÄ±r)

  } else { // quiz, cloze, wordorder
  
    // "Sonraki" butonuna basÄ±ldÄ±
    if(state.showResult){
        state.deckPos++; 
        state.showAnswer=false; 
        state.showResult=false; 
        showLearning();
        return;
    }
  
    // "Kontrol Et" butonuna basÄ±ldÄ±
    let userAnswer = '';
    let isCorrect = false;
    
    if (state.mode === 'cloze') {
        const input = document.getElementById('clozeInput'); 
        userAnswer = (input && input.value.trim())||'';
        isCorrect = userAnswer.toLowerCase() === state.correctAnswer.toLowerCase();
    } else if (state.mode === 'wordorder') {
        userAnswer = state.wordSelected.join(' ').trim();
        isCorrect = userAnswer === state.correctAnswer;
    } else if (state.mode === 'quiz') {
        const input = document.getElementById('quizInput'); 
        userAnswer = (input && input.value.trim())||'';
        isCorrect = userAnswer.toLowerCase() === (state.correctAnswer||'').toLowerCase();
    }
    
    // Sonucu gÃ¶ster
    resultArea.innerHTML = isCorrect ? '<div class="result correct">âœ“ DoÄŸru!</div>' : '<div class="result incorrect">âœ— YanlÄ±ÅŸ!</div>';
    answerArea.innerHTML = `<div class="result"><strong>Sizin:</strong> ${escapeHtml(userAnswer||'(boÅŸ)')}</div><div class="result"><strong>DoÄŸru:</strong> ${escapeHtml(state.correctAnswer)}</div>`;
    
    // YENÄ°: SRS Ä°lerlemesini GÃ¼ncelle
    updateSrsStatusAfterQuiz(state.currentCardKey, isCorrect);
    
    state.showResult=true; 
    btn.textContent = t.buttons.next;
    
    // Dinleme butonlarÄ±nÄ± aktifleÅŸtir
    document.getElementById('btnPlayDE').disabled = false; document.getElementById('btnPlayDE').classList.remove('disabled');
    document.getElementById('btnPlayTR').disabled = false; document.getElementById('btnPlayTR').classList.remove('disabled');
    
    triggerAutoPlay();
  }
}

function previousQuestion(){ 
  if (state.mode === 'study') return; // Ã‡alÄ±ÅŸ modunda geri gitme yok
  if(state.deckPos > 0){ 
      state.deckPos--; 
      state.showAnswer=false; 
      state.showResult=false; 
      
      // state.currentCardKey ve state.currentCardData'yÄ± yeniden ayarla
      state.currentCardKey = state.deck[state.deckPos];
      const parts = state.currentCardKey.match(/^(.*?)_s(\d+)_(\d+)$/);
      const verbId = parts[1], sectionNum = parts[2], sentenceIndex = parseInt(parts[3]);
      state.currentCardData = (data.content[`${verbId}_s${sectionNum}`] || [])[sentenceIndex];
      
      renderSentence(); 
  } 
}

function resetLearning(){ 
  state.deckPos = 0;
  state.deck = shuffle(state.deck); // Desteyi tekrar karÄ±ÅŸtÄ±r
  state.showAnswer=false; 
  state.showResult=false; 
  showLearning(); // Ä°lk karttan baÅŸla
}

function goToNextSection(sectionNum) {
    // state.verb deÄŸiÅŸmedi, sadece state.section deÄŸiÅŸti
    selectSection(sectionNum);
    // modeMenu gÃ¶rÃ¼necek, oradan startMode('study') tetiklenecek
}

// GÃœNCELLENDÄ° (v3.0): showCompletion
function showCompletion(){
  const t = getMergedTranslations(data.settings.language || 'tr');
  let scoreHtml = '';
  
  if (state.mode === 'study') {
      scoreHtml = `<p style="text-align:center">Bu bÃ¶lÃ¼mdeki ${state.deck.length} yeni kartÄ± Ã§alÄ±ÅŸtÄ±nÄ±z!</p>`;
  } else {
      // Tekrar modunda basit bir tamamlanma mesajÄ±
      scoreHtml = `<p style="text-align:center">"${state.tekrarStatus}" kategorisindeki ${state.deck.length} kartÄ± tekrar ettiniz!</p>`;
  }
  
  // Sonraki BÃ¶lÃ¼m Butonu (Sadece 'study' modunda)
  let nextButtonHtml = '';
  if (state.mode === 'study') {
      const sectionKeys = Object.keys(data.sections).map(Number).sort((a, b) => a - b);
      const currentSectionIndex = sectionKeys.indexOf(state.section);
      let nextSectionNum = null;
      if (currentSectionIndex > -1 && currentSectionIndex < sectionKeys.length - 1) {
          for (let i = currentSectionIndex + 1; i < sectionKeys.length; i++) {
              const potentialNextSec = sectionKeys[i];
              const contentKey = `${state.verb}_s${potentialNextSec}`;
              if (data.content[contentKey] && data.content[contentKey].length > 0) {
                  nextSectionNum = potentialNextSec;
                  break;
              }
          }
      }
      if (nextSectionNum) {
          nextButtonHtml = `<button class="btn btn-secondary" style="margin-top:10px;" onclick="goToNextSection(${nextSectionNum})">${t.buttons.nextSection} (${data.sections[nextSectionNum]})</button>`;
      }
  }

  
  document.getElementById('learningContent').innerHTML = `<div class="content-box"><h3 style="text-align:center">ğŸ‰ TamamladÄ±nÄ±z!</h3>
    ${scoreHtml}
    ${nextButtonHtml} </div>`;
  
  document.getElementById('actionBtn').textContent='Tekrar BaÅŸla'; 
  document.getElementById('actionBtn').onclick = resetLearning;
  
  document.getElementById('actionBtn').style.display = 'block';
  document.getElementById('srsControls').style.display = 'none';

  updateProgress(state.deck.length, state.deck.length);
  
  document.getElementById('btnPlayDE').disabled = true; document.getElementById('btnPlayDE').classList.add('disabled');
  document.getElementById('btnPlayTR').disabled = true; document.getElementById('btnPlayTR').classList.add('disabled');
}

// GÃœNCELLENDÄ° (v3.0): playCurrentSentence
function playCurrentSentence(lang, retryCount = 0) {
    if (retryCount === 0) resetSpeechButtons(); 
    if (!state.currentCardData) return;

    const sent = state.currentCardData;
    const text = (lang === 'de') ? sent.de : sent.tr;
    const langCode = (lang === 'de') ? 'de-DE' : 'tr-TR';
    
    if (!text) return; 

    if (lang === 'de' && musicPlayer && musicPlayer.isPlaying && retryCount === 0) {
        musicPlayer.dim_music(true);
    }

    if('speechSynthesis' in window){
        const speakNow = () => {
            const voices = window.speechSynthesis.getVoices();
            if (voices.length === 0 && retryCount < 3) {
                setTimeout(() => playCurrentSentence(lang, retryCount + 1), 500);
                return;
            }

            const utter = new SpeechSynthesisUtterance(text);
            utter.lang = langCode;
            utter.rate = state.speechRate || 1;
            
            let voice = null;
            if (lang === 'de') {
                voice = voices.find(v => v.lang.toLowerCase() === langCode.toLowerCase() && /anna|markus/i.test(v.name));
            }
            if (!voice) {
                voice = voices.find(v => v.lang.toLowerCase() === langCode.toLowerCase());
            }
            if (!voice && lang === 'de') {
                 voice = voices.find(v => v.lang.toLowerCase().startsWith('de'));
            }
            if (voice) utter.voice = voice;

            utter.onend = utter.onerror = () => {
                if (musicPlayer && musicPlayer.isPlaying) musicPlayer.dim_music(false);
                resetSpeechButtons();
            };
            window.speechSynthesis.cancel();
            window.speechSynthesis.speak(utter);
        };

        if (window.speechSynthesis.getVoices().length === 0 && retryCount === 0 && navigator.userAgent.match(/iPad|iPhone|iPod/i)) {
            window.speechSynthesis.onvoiceschanged = function handler() {
                window.speechSynthesis.onvoiceschanged = null; 
                speakNow();
            };
        } else {
            speakNow();
        }
    } else {
        const t = getMergedTranslations(data.settings.language || 'tr');
        alert(t.messages.ttsNotSupported);
        if (lang === 'de' && musicPlayer && musicPlayer.isPlaying) musicPlayer.dim_music(false);
    }
}

/* ---------- Hikaye FonksiyonlarÄ± (DeÄŸiÅŸiklik yok) ---------- */
function showGroupStory(groupId){
  state.group = groupId; state.groupData = data.groups.find(g=>g.id===groupId) || null;
  const t = getMergedTranslations(data.settings.language || 'tr');
  if(!state.groupData || !state.groupData.story){ alert(t.messages.noStory); return; }
  document.getElementById('storyTitle').textContent = state.groupData.story.title || t.titles.story;
  renderStoryContent();
  showView('storyView');
}
function renderStoryContent(){
  const sc = document.getElementById('storyContent'); const s = state.groupData.story;
  sc.innerHTML = `<div class="story-section"><h3>Almanca</h3><div class="story-content">${escapeHtml(s.de||'').replace(/\n/g,'<br>')}</div></div>
                   <div class="story-section"><h3>TÃ¼rkÃ§e</h3><div class="story-content">${escapeHtml(s.tr||'').replace(/\n/g,'<br>')}</div></div>`;
}
function playStoryAudio(lang, retryCount = 0) {
    if (retryCount === 0) resetSpeechButtons(); 
    const s = state.groupData && state.groupData.story;
    const t = getMergedTranslations(data.settings.language || 'tr');
    if (!s) { alert(t.messages.noStoryFound); return; }
    const text = (lang === 'de') ? s.de : s.tr;
    const langCode = (lang === 'de') ? 'de-DE' : 'tr-TR';
    if (!text) return;
    if (lang === 'de' && musicPlayer && musicPlayer.isPlaying && retryCount === 0) musicPlayer.dim_music(true);

    if ('speechSynthesis' in window) {
        const speakNow = () => {
            const voices = window.speechSynthesis.getVoices();
            if (voices.length === 0 && retryCount < 3) {
                setTimeout(() => playStoryAudio(lang, retryCount + 1), 500);
                return;
            }
            const utter = new SpeechSynthesisUtterance(text);
            utter.lang = langCode;
            utter.rate = state.speechRate || 1;
            let voice = null;
            if (lang === 'de') voice = voices.find(v => v.lang.toLowerCase() === langCode.toLowerCase() && /anna|markus/i.test(v.name));
            if (!voice) voice = voices.find(v => v.lang.toLowerCase() === langCode.toLowerCase());
            if (!voice && lang === 'de') voice = voices.find(v => v.lang.toLowerCase().startsWith('de'));
            if (voice) utter.voice = voice;
            utter.onend = utter.onerror = () => {
                if (musicPlayer && musicPlayer.isPlaying) musicPlayer.dim_music(false);
                resetSpeechButtons();
            };
            window.speechSynthesis.cancel();
            window.speechSynthesis.speak(utter);
        };
        if (window.speechSynthesis.getVoices().length === 0 && retryCount === 0 && navigator.userAgent.match(/iPad|iPhone|iPod/i)) {
             window.speechSynthesis.onvoiceschanged = function handler() {
                window.speechSynthesis.onvoiceschanged = null; 
                speakNow();
            };
        } else {
            speakNow();
        }
    } else {
        alert(t.messages.ttsNotSupported);
        if (lang === 'de' && musicPlayer && musicPlayer.isPlaying) musicPlayer.dim_music(false);
    }
}
function showStoryQuestions(){
  const story = state.groupData && state.groupData.story;
  const container = document.getElementById('storyQuestionsContent');
  const t = getMergedTranslations(data.settings.language || 'tr');
  container.innerHTML = '';
  if(!story || !story.quiz || !Array.isArray(story.quiz) || story.quiz.length===0){ 
    container.innerHTML = `<p>${t.messages.noStoryQuestions}</p>`; 
    showView('storyQuestionsView'); 
    return; 
  }
  const quiz = story.quiz;
  let html = '<form id="storyQuizForm">';
  quiz.forEach((q,i)=>{
    html += `<div style="margin:10px 0;padding:10px;border-radius:8px;background:#fff;color:#0f1724"><b>${i+1}. ${escapeHtml(q.q)}</b><div style="margin-top:8px">`;
    (q.options || []).forEach((opt,j)=>{
      html += `<label style="display:block;margin:6px 0"><input type="radio" name="sq${i}" value="${escapeHtml(opt)}"> ${escapeHtml(opt)}</label>`;
    });
    html += `</div></div>`;
  });
  html += `<div class="button-group-row"><button type="button" class="btn btn-primary" onclick="checkStoryAnswers()">${t.buttons.show}</button></div></form>`;
  container.innerHTML = html;
  showView('storyQuestionsView');
}
function checkStoryAnswers(){
  const story = state.groupData.story; const quiz = story.quiz;
  let correct=0;
  quiz.forEach((q,i)=>{
    const sel = document.querySelector(`input[name="sq${i}"]:checked`);
    if(sel && sel.value === q.a) correct++;
  });
  alert(`ğŸ¯ ${correct} / ${quiz.length} doÄŸru`);
}

/* ---------- Debug & Ä°lerleme EkranÄ± ---------- */
function debugData(){
  const t = getMergedTranslations(data.settings.language || 'tr');
  let msg = `${t.messages.jsonStatus}\n\n`;
  msg += `Gruplar: ${(data.groups||[]).length}\n`;
  msg += `Fiil GruplarÄ±: ${Object.keys(data.verbs||{}).length}\n`;
  msg += `Ä°Ã§erik AnahtarlarÄ±: ${Object.keys(data.content||{}).length}\n`;
  msg += `Genel BÃ¶lÃ¼m Ä°puÃ§larÄ±: ${Object.keys((data.sectionsHints||{})).length}\n`;
  msg += `Ä°pucu (CÃ¼mle): ${Object.keys((data.hints&&data.hints.sentences)||{}).length}\n`;
  
  const srsCount = Object.keys(srsData).length;
  msg += `\nSRS Veri KayÄ±tlarÄ±: ${srsCount}\n`;
  
  alert(msg);
}

// GÃœNCELLENDÄ° (v3.0): Ä°lerleme EkranÄ±
function updateProgressView(){
  const t = getMergedTranslations(data.settings.language || 'tr');
  let totalCards = 0;
  let learnedCards = 0;
  let stats = { zor: 0, normal: 0, ogrendim: 0, new: 0 };

  // 1. Toplam kart sayÄ±sÄ±nÄ± 'data.content' Ã¼zerinden hesapla
  Object.keys(data.content).forEach(key => {
      totalCards += (data.content[key] || []).length;
  });

  // 2. SRS statÃ¼lerini 'srsData' Ã¼zerinden say
  Object.keys(srsData).forEach(key => {
      const status = srsData[key].status;
      if (stats.hasOwnProperty(status)) {
          stats[status]++;
      }
  });
  
  // 'new' statÃ¼sÃ¼ndeki kartlar, toplam kartlardan Ã¶ÄŸrenilenlerin Ã§Ä±karÄ±lmasÄ±yla bulunur
  learnedCards = stats.zor + stats.normal + stats.ogrendim;
  stats.new = totalCards - learnedCards;
  if (stats.new < 0) stats.new = 0; // Negatif olamaz

  // 3. Ä°lerleme EkranÄ± (Progress View) ArayÃ¼zÃ¼nÃ¼ GÃ¼ncelle
  const progressView = document.getElementById('progress');
  if (progressView && progressView.classList.contains('active')) {
      document.getElementById('progressStatZor').textContent = stats.zor;
      document.getElementById('progressStatNormal').textContent = stats.normal;
      document.getElementById('progressStatOgrenildi').textContent = stats.ogrendim;
      
      const percent = totalCards === 0 ? 0 : Math.round((learnedCards / totalCards) * 100);
      document.getElementById('totalProgressFill').style.width = percent + '%';
      document.getElementById('totalProgressFill').textContent = percent + '%';
      document.getElementById('totalProgressText').textContent = `${learnedCards} / ${totalCards}`;
  }
  
  // 4. Tekrar MenÃ¼sÃ¼ ArayÃ¼zÃ¼nÃ¼ GÃ¼ncelle
  const tekrarView = document.getElementById('tekrarMenu');
  if (tekrarView && tekrarView.classList.contains('active')) {
      document.getElementById('tekrarCountZor').textContent = stats.zor;
      document.getElementById('tekrarCountNormal').textContent = stats.normal;
      document.getElementById('tekrarCountOgrenildi').textContent = stats.ogrendim;
  }
}

function toggleHintPanel(){ 
    state.hintPanelVisible = !state.hintPanelVisible; 
    const hintPanelEl = document.getElementById('hintPanel'); 
    if(state.hintPanelVisible) {
        const hintHtml = buildHintHtml();
        hintPanelEl.innerHTML = hintHtml || '<div class="hint-item">Bu kart iÃ§in ipucu yok.</div>';
        hintPanelEl.style.display = 'block';
    } else {
        hintPanelEl.style.display = 'none';
    }
}


/* -------------------------------------------------------- */
/* ---------- YENÄ° ADMIN PANELÄ° (v3.0) ---------- */
/* -------------------------------------------------------- */

function showTsvImporter() {
  document.getElementById('adminTsvArea').style.display = 'block';
  document.getElementById('tsvPasteArea').value = ''; 
}

// Ana form gÃ¶sterici
function showAdminForm(formType) {
    const area = document.getElementById('adminContentArea');
    area.style.display = 'block';
    area.innerHTML = 'YÃ¼kleniyor...';
    
    if (formType === 'addGroup') showAdminGroupForm(area);
    else if (formType === 'addVerb') showAdminVerbForm(area);
    else if (formType === 'addSection') showAdminSectionForm(area); // YENÄ°
    else if (formType === 'addStory') showAdminStoryForm(area);
    else if (formType === 'addHint') showAdminHintForm(area);
    else if (formType === 'editSentence') showAdminSentenceForm(area);
    else area.innerHTML = 'Form bulunamadÄ±.';
}

// GÃœNCELLENDÄ°: GRUP formu (artÄ±k dÃ¼zenlemeyi de destekliyor)
function showAdminGroupForm(area) {
    const t = getMergedTranslations(data.settings.language || 'tr');
    let options = data.groups.map(g => `<option value="${g.id}">${g.name} (${g.id})</option>`).join('');
    
    area.innerHTML = `<div class="content-box"><h4>${t.admin.addGroup}</h4>
      <label>${t.labels.group} (DÃ¼zenlemek iÃ§in seÃ§in)</label>
      <select id="adm_g_select" class="select-field"><option value="">-- YENÄ° GRUP --</option>${options}</select>
      <label>${t.labels.groupID}</label><input id="adm_g_id" class="input-field">
      <label>${t.labels.groupNameTR}</label><input id="adm_g_name_tr" class="input-field">
      <label>${t.labels.groupNameDE}</label><input id="adm_g_name_de" class="input-field">
      <div class="button-group-row">
        <button class="btn btn-primary" onclick="adminSaveGroup()">âœ… ${t.buttons.save}</button>
        <button class="btn btn-danger" onclick="adminDeleteGroup()">ğŸ—‘ ${t.buttons.delete}</button>
      </div></div>`;
      
    document.getElementById('adm_g_select').onchange = (e) => {
        const gid = e.target.value;
        const g = data.groups.find(x => x.id === gid);
        if (g) {
            document.getElementById('adm_g_id').value = g.id;
            document.getElementById('adm_g_id').readOnly = true; // ID deÄŸiÅŸtirilemez
            document.getElementById('adm_g_name_tr').value = g.name;
            document.getElementById('adm_g_name_de').value = g.nameDE || '';
        } else {
            document.getElementById('adm_g_id').value = '';
            document.getElementById('adm_g_id').readOnly = false;
            document.getElementById('adm_g_name_tr').value = '';
            document.getElementById('adm_g_name_de').value = '';
        }
    };
}

function adminSaveGroup() {
    const selId = document.getElementById('adm_g_select').value;
    const id = document.getElementById('adm_g_id').value.trim();
    const name = document.getElementById('adm_g_name_tr').value.trim();
    const named = document.getElementById('adm_g_name_de').value.trim();
    if (!id || !name) { alert('ID ve TR Ä°sim gerekli'); return; }

    let g = data.groups.find(x => x.id === (selId || id));
    if (g) { // GÃ¼ncelleme
        g.name = name;
        g.nameDE = named;
        alert('Grup gÃ¼ncellendi');
    } else { // Yeni
        if (data.groups.find(x => x.id === id)) { alert('Bu ID zaten var'); return; }
        data.groups.push({ id: id, name: name, nameDE: named, story: null });
        if (!data.verbs[id]) data.verbs[id] = [];
        alert('Grup eklendi');
    }
    saveContentOverride();
    showAdminForm('addGroup'); // Formu yenile
}

function adminDeleteGroup() {
    const selId = document.getElementById('adm_g_select').value;
    if (!selId) { alert('Silmek iÃ§in bir grup seÃ§in'); return; }
    if (!confirm(`'${selId}' grubunu silmek istediÄŸinizden emin misiniz? (Ä°Ã§indeki fiiller ve iÃ§erikler de silinebilir!)`)) return;

    data.groups = data.groups.filter(g => g.id !== selId);
    delete data.verbs[selId];
    // Ä°lgili content'i silmek daha karmaÅŸÄ±k, ÅŸimdilik atlÄ±yoruz
    
    alert('Grup silindi');
    saveContentOverride();
    showAdminForm('addGroup'); // Formu yenile
}

// GÃœNCELLENDÄ°: FÄ°Ä°L formu
function showAdminVerbForm(area) {
    const t = getMergedTranslations(data.settings.language || 'tr');
    let groupOptions = data.groups.map(g => `<option value="${g.id}">${g.name}</option>`).join('');
    
    area.innerHTML = `<div class="content-box"><h4>${t.admin.addVerb}</h4>
      <label>${t.labels.group}</label>
      <select id="adm_v_group" class="select-field">${groupOptions}</select>
      <label>${t.labels.verb} (DÃ¼zenlemek iÃ§in seÃ§in)</label>
      <select id="adm_v_select" class="select-field"><option value="">-- YENÄ° FÄ°Ä°L --</option></select>
      <label>${t.labels.verbID}</label><input id="adm_v_id" class="input-field">
      <label>${t.labels.verbTR}</label><input id="adm_v_tr" class="input-field">
      <label>${t.labels.verbDE}</label><input id="adm_v_de" class="input-field">
      <div class="button-group-row">
        <button class="btn btn-primary" onclick="adminSaveVerb()">âœ… ${t.buttons.save}</button>
        <button class="btn btn-danger" onclick="adminDeleteVerb()">ğŸ—‘ ${t.buttons.delete}</button>
      </div></div>`;
      
    const groupSelect = document.getElementById('adm_v_group');
    const verbSelect = document.getElementById('adm_v_select');
    
    const loadVerbs = () => {
        const gid = groupSelect.value;
        verbSelect.innerHTML = '<option value="">-- YENÄ° FÄ°Ä°L --</option>';
        if (!gid || !data.verbs[gid]) return;
        const verbOptions = (data.verbs[gid] || []).map(v => `<option value="${v.id}">${v.verbTR || v.verbDE} (${v.id})</option>`).join('');
        verbSelect.innerHTML += verbOptions;
        adminLoadVerbFields(); // SeÃ§ili fiili yÃ¼kle
    };
    
    groupSelect.onchange = loadVerbs;
    verbSelect.onchange = adminLoadVerbFields;
    loadVerbs(); // Ä°lk yÃ¼kleme
}

function adminLoadVerbFields() {
    const gid = document.getElementById('adm_v_group').value;
    const vid = document.getElementById('adm_v_select').value;
    const v = (data.verbs[gid] || []).find(x => x.id === vid);
    if (v) {
        document.getElementById('adm_v_id').value = v.id;
        document.getElementById('adm_v_id').readOnly = true;
        document.getElementById('adm_v_tr').value = v.verbTR || '';
        document.getElementById('adm_v_de').value = v.verbDE || '';
    } else {
        document.getElementById('adm_v_id').value = '';
        document.getElementById('adm_v_id').readOnly = false;
        document.getElementById('adm_v_tr').value = '';
        document.getElementById('adm_v_de').value = '';
    }
}

function adminSaveVerb() {
    const gid = document.getElementById('adm_v_group').value;
    const selId = document.getElementById('adm_v_select').value;
    const id = document.getElementById('adm_v_id').value.trim();
    const vtr = document.getElementById('adm_v_tr').value.trim();
    const vde = document.getElementById('adm_v_de').value.trim();
    if (!gid || !id || (!vtr && !vde)) { alert('Grup, Fiil ID ve TR/DE adÄ± gerekli'); return; }

    if (!data.verbs[gid]) data.verbs[gid] = [];
    let v = data.verbs[gid].find(x => x.id === (selId || id));
    
    if (v) { // GÃ¼ncelle
        v.verbTR = vtr;
        v.verbDE = vde;
        alert('Fiil gÃ¼ncellendi');
    } else { // Yeni
        if (data.verbs[gid].find(x => x.id === id)) { alert('Bu ID bu grupta zaten var'); return; }
        data.verbs[gid].push({ id: id, verbTR: vtr, verbDE: vde });
        alert('Fiil eklendi');
    }
    saveContentOverride();
    showAdminForm('addVerb'); // Formu yenile
}

function adminDeleteVerb() {
    const gid = document.getElementById('adm_v_group').value;
    const selId = document.getElementById('adm_v_select').value;
    if (!selId || !gid) { alert('Silmek iÃ§in bir grup ve fiil seÃ§in'); return; }
    if (!confirm(`'${selId}' fiilini silmek istediÄŸinizden emin misiniz?`)) return;

    data.verbs[gid] = (data.verbs[gid] || []).filter(v => v.id !== selId);
    // Ä°lgili content'i silmek daha karmaÅŸÄ±k, ÅŸimdilik atlÄ±yoruz
    
    alert('Fiil silindi');
    saveContentOverride();
    showAdminForm('addVerb'); // Formu yenile
}

// YENÄ°: BÃ–LÃœM formu
function showAdminSectionForm(area) {
    const t = getMergedTranslations(data.settings.language || 'tr');
    let options = Object.entries(data.sections).map(([num, name]) => `<option value="${num}">${num}. ${name}</option>`).join('');
    
    area.innerHTML = `<div class="content-box"><h4>${t.admin.addSection}</h4>
      <label>BÃ¶lÃ¼m (DÃ¼zenlemek iÃ§in seÃ§in)</label>
      <select id="adm_s_select" class="select-field"><option value="">-- YENÄ° BÃ–LÃœM --</option>${options}</select>
      <label>${t.labels.sectionNum}</label><input id="adm_s_num" class="input-field" type="number">
      <label>${t.labels.sectionName}</label><input id="adm_s_name" class="input-field">
      <div class="button-group-row">
        <button class="btn btn-primary" onclick="adminSaveSection()">âœ… ${t.buttons.save}</button>
        <button class="btn btn-danger" onclick="adminDeleteSection()">ğŸ—‘ ${t.buttons.delete}</button>
      </div></div>`;
      
    document.getElementById('adm_s_select').onchange = (e) => {
        const num = e.target.value;
        const name = data.sections[num];
        if (name) {
            document.getElementById('adm_s_num').value = num;
            document.getElementById('adm_s_num').readOnly = true; // Numara deÄŸiÅŸtirilemez
            document.getElementById('adm_s_name').value = name;
        } else {
            document.getElementById('adm_s_num').value = '';
            document.getElementById('adm_s_num').readOnly = false;
            document.getElementById('adm_s_name').value = '';
        }
    };
}

function adminSaveSection() {
    const selNum = document.getElementById('adm_s_select').value;
    const num = document.getElementById('adm_s_num').value.trim();
    const name = document.getElementById('adm_s_name').value.trim();
    if (!num || !name) { alert('Numara ve Ä°sim gerekli'); return; }

    if (data.sections[num] && !selNum) {
        alert('Bu bÃ¶lÃ¼m numarasÄ± zaten var'); return;
    }
    
    data.sections[num] = name;
    if (selNum && selNum !== num) { // Numara deÄŸiÅŸtirildiyse (nadiren olmalÄ±)
        delete data.sections[selNum];
    }
    
    alert(selNum ? 'BÃ¶lÃ¼m gÃ¼ncellendi' : 'BÃ¶lÃ¼m eklendi');
    saveContentOverride();
    showAdminForm('addSection'); // Formu yenile
}

function adminDeleteSection() {
    const selNum = document.getElementById('adm_s_select').value;
    if (!selNum) { alert('Silmek iÃ§in bir bÃ¶lÃ¼m seÃ§in'); return; }
    if (!confirm(`'${selNum}' numaralÄ± bÃ¶lÃ¼mÃ¼ silmek istediÄŸinizden emin misiniz?`)) return;

    delete data.sections[selNum];
    alert('BÃ¶lÃ¼m silindi');
    saveContentOverride();
    showAdminForm('addSection'); // Formu yenile
}

// DiÄŸer Admin FormlarÄ± (CÃ¼mle, Hikaye, Ä°pucu) buraya eklenebilir...
// (KÄ±salÄ±k iÃ§in 'showAdminSentenceForm' ekleniyor, diÄŸerleri benzer ÅŸekilde birleÅŸtirilebilir)
function showAdminSentenceForm(area) {
    const t = getMergedTranslations(data.settings.language || 'tr');
    area.innerHTML = `<div class="content-box"><h4>${t.admin.editSentence}</h4>
      <label>${t.labels.group}</label><select id="adm_es_group" class="select-field"></select>
      <label>${t.labels.verb}</label><select id="adm_es_verb" class="select-field"></select>
      <label>${t.labels.section}</label><select id="adm_es_section" class="select-field"></select>
      <label>${t.labels.sentence}</label><select id="adm_es_sentence" class="select-field"></select>
      <label>${t.labels.tr}</label><textarea id="adm_es_tr" class="textarea-field" rows="3"></textarea>
      <label>${t.labels.de}</label><textarea id="adm_es_de" class="textarea-field" rows="3"></textarea>
      <div class="button-group-row">
        <button class="btn btn-primary" onclick="adminSaveEditedSentence()">âœ… ${t.buttons.update}</button>
        <button class="btn btn-info" onclick="adminAddNewSentence()">â• ${t.buttons.add}</button>
        <button class="btn btn-danger" onclick="adminDeleteSentence()">ğŸ—‘ ${t.buttons.delete}</button>
      </div></div>`;
    fillSelect('adm_es_group', data.groups.map(g => ({ v: g.id, t: g.name })), true);
    document.getElementById('adm_es_group').onchange = admin_es_loadVerbs;
    document.getElementById('adm_es_verb').onchange = admin_es_loadSections;
    document.getElementById('adm_es_section').onchange = admin_es_loadSentences;
    document.getElementById('adm_es_sentence').onchange = admin_es_loadSentenceFields;
}
// showAdminStoryForm ve showAdminHintForm benzer ÅŸekilde buraya entegre edilebilir...
// ... (admin_es_... yardÄ±mcÄ± fonksiyonlarÄ± aÅŸaÄŸÄ±da) ...

/* ---------- Admin: Toplu YÃ¼kleme AracÄ± ---------- */
function parseAndImportTsv() {
  const tsvData = document.getElementById('tsvPasteArea').value.trim();
  const t = getMergedTranslations(data.settings.language || 'tr');
  if (!tsvData) { alert('LÃ¼tfen veriyi yapÄ±ÅŸtÄ±rÄ±n.'); return; }

  const lines = tsvData.split('\n');
  let sentencesAdded = 0, hintsAdded = 0, errors = 0;

  if (!data.content) data.content = {};
  if (!data.hints) data.hints = { sentences: {}, verbs: {}, sections: {} };
  if (!data.hints.sentences) data.hints.sentences = {};

  lines.forEach((line, lineIndex) => {
    if (line.trim() === '') return; 
    const columns = line.split('\t');
    if (columns.length < 5) { errors++; return; }

    const [grupId, fiilId, bolumNum, tr, de, cumleIpucu] = columns.map(c => (c || '').trim());
    if (!grupId || !fiilId || !bolumNum || !tr || !de) { errors++; return; }

    try {
      const contentKey = `${fiilId}_s${bolumNum}`;
      if (!data.content[contentKey]) data.content[contentKey] = [];
      const newSentenceIndex = data.content[contentKey].length;
      
      data.content[contentKey].push({ tr: tr, de: de });
      sentencesAdded++;

      if (cumleIpucu) {
        const hintKey = getSrsKey(fiilId, bolumNum, newSentenceIndex);
        data.hints.sentences[hintKey] = cumleIpucu;
        hintsAdded++;
      }
    } catch (e) { errors++; }
  });

  if (sentencesAdded > 0) saveContentOverride(); 
  alert(`Toplu YÃ¼kleme TamamlandÄ±!\nâœ… Eklenen CÃ¼mle: ${sentencesAdded}\nğŸ’¡ Eklenen Ä°pucu: ${hintsAdded}\nâŒ HatalÄ± SatÄ±r: ${errors}`);
  document.getElementById('tsvPasteArea').value = '';
  document.getElementById('adminTsvArea').style.display = 'none';
}


/* ---------- Admin YardÄ±mcÄ± FonksiyonlarÄ± (CÃ¼mle DÃ¼zenleme) ---------- */
function fillSelect(id, items, addEmpty) {
    const s = document.getElementById(id); s.innerHTML = '';
    if (addEmpty) { const o = document.createElement('option'); o.value = ''; o.textContent = 'SeÃ§in...'; s.appendChild(o); }
    items.forEach(it => { const o = document.createElement('option'); o.value = it.v; o.textContent = it.t; s.appendChild(o); });
}
function admin_es_loadVerbs() {
    const gid = document.getElementById('adm_es_group').value;
    fillSelect('adm_es_verb', (data.verbs[gid] || []).map(v => ({ v: v.id, t: (v.verbTR || v.verbDE) })), true);
    admin_es_loadSections();
}
function admin_es_loadSections() {
    const verbId = document.getElementById('adm_es_verb').value;
    const items = Object.entries(data.sections).map(([num, name]) => {
        const count = (data.content[`${verbId}_s${num}`] || []).length;
        return { v: num, t: `${num}. ${name} (${count} cÃ¼mle)` };
    });
    fillSelect('adm_es_section', items, true);
    admin_es_loadSentences();
}
function admin_es_loadSentences() {
    const verbId = document.getElementById('adm_es_verb').value;
    const section = document.getElementById('adm_es_section').value;
    const arr = data.content[`${verbId}_s${section}`] || [];
    fillSelect('adm_es_sentence', arr.map((s, i) => ({ v: i, t: (s.tr || s.de || '').substring(0, 80) })), true);
    admin_es_loadSentenceFields();
}
function admin_es_loadSentenceFields() {
    const verbId = document.getElementById('adm_es_verb').value;
    const section = document.getElementById('adm_es_section').value;
    const idx = document.getElementById('adm_es_sentence').value;
    const trEl = document.getElementById('adm_es_tr');
    const deEl = document.getElementById('adm_es_de');
    if (!verbId || !section || idx === '') {
        trEl.value = ''; deEl.value = ''; return;
    }
    const s = (data.content[`${verbId}_s${section}`] || [])[idx];
    if (s) { trEl.value = s.tr || ''; deEl.value = s.de || ''; }
}
function adminSaveEditedSentence() {
    const verbId = document.getElementById('adm_es_verb').value;
    const section = document.getElementById('adm_es_section').value;
    const idx = document.getElementById('adm_es_sentence').value;
    const tr = document.getElementById('adm_es_tr').value.trim();
    const de = document.getElementById('adm_es_de').value.trim();
    if (!verbId || !section || idx === '') { alert('SeÃ§im yapÄ±n'); return; }
    
    const arr = data.content[`${verbId}_s${section}`] || [];
    arr[idx] = { tr, de };
    data.content[`${verbId}_s${section}`] = arr;
    
    alert('CÃ¼mle gÃ¼ncellendi');
    saveContentOverride();
    admin_es_loadSentences(); // Listeyi yenile
}
function adminAddNewSentence() {
    const verbId = document.getElementById('adm_es_verb').value;
    const section = document.getElementById('adm_es_section').value;
    const tr = document.getElementById('adm_es_tr').value.trim();
    const de = document.getElementById('adm_es_de').value.trim();
    if (!verbId || !section || (!tr && !de)) { alert('Fiil, BÃ¶lÃ¼m ve TR/DE gerekli'); return; }
    
    const key = `${verbId}_s${section}`;
    if (!data.content[key]) data.content[key] = [];
    data.content[key].push({ tr, de });
    
    alert('Yeni cÃ¼mle eklendi');
    saveContentOverride();
    admin_es_loadSections(); // BÃ¶lÃ¼m listesini (sayacÄ±) yenile
}
function adminDeleteSentence() {
    const verbId = document.getElementById('adm_es_verb').value;
    const section = document.getElementById('adm_es_section').value;
    const idx = parseInt(document.getElementById('adm_es_sentence').value);
    if (!verbId || !section || isNaN(idx)) { alert('Silmek iÃ§in cÃ¼mle seÃ§in'); return; }
    if (!confirm(`${idx + 1}. cÃ¼mleyi silmek istediÄŸinizden emin misiniz?`)) return;

    const key = `${verbId}_s${section}`;
    if (data.content[key] && data.content[key][idx]) {
        data.content[key].splice(idx, 1);
        alert('CÃ¼mle silindi');
        saveContentOverride();
        admin_es_loadSections(); // Listeyi yenile
    }
}
/* ---------- Admin Paneli SONU ---------- */


/* ---------- CÃ¼mle Listeleme / CSV (DeÄŸiÅŸiklik yok) ---------- */
function renderAllSentencesTable(){
  const container = document.getElementById('allSentencesTable'); 
  const t = getMergedTranslations(data.settings.language || 'tr');
  let html = `<table style="width:100%; border-collapse: collapse;"><thead><tr style="text-align:left; background: #eee;">
    <th style="padding: 6px;">${t.labels.group}</th><th>${t.labels.verb}</th><th>${t.labels.section}</th>
    <th>${t.labels.index}</th><th>${t.labels.tr}</th><th>${t.labels.de}</th></tr></thead><tbody>`;
  
  let groupMap = {}; // Cache
  (data.groups || []).forEach(g => {
      (data.verbs[g.id] || []).forEach(v => {
          groupMap[v.id] = { groupName: g.name, verbName: (v.verbTR || v.verbDE) };
      });
  });

  Object.entries(data.content||{}).forEach(([key,arr])=>{
    const m = key.match(/^(.+)_s(\d+)$/);
    if(!m) return;
    const vid = m[1]; const sec = m[2];
    const info = groupMap[vid] || { groupName: '?', verbName: vid };
    
    (arr||[]).forEach((s,i)=>{
      html += `<tr style="border-bottom: 1px solid #eee;"><td style="padding: 4px;">${escapeHtml(info.groupName)}</td><td>${escapeHtml(info.verbName)}</td><td>${escapeHtml(data.sections[sec]||sec)}</td>
        <td>${i}</td><td>${escapeHtml(s.tr||'')}</td><td>${escapeHtml(s.de||'')}</td></tr>`;
    });
  });
  html += '</tbody></table>';
  container.innerHTML = html;
}

function exportSentencesCsv(){
  let rows = [['Grup','Fiil','BÃ¶lÃ¼m','Index','TR','DE']];
  let groupMap = {};
  (data.groups || []).forEach(g => {
      (data.verbs[g.id] || []).forEach(v => {
          groupMap[v.id] = { groupName: g.name, verbName: (v.verbTR || v.verbDE) };
      });
  });
  
  Object.entries(data.content||{}).forEach(([key,arr])=>{
    const m = key.match(/^(.+)_s(\d+)$/); if(!m) return;
    const vid = m[1]; const sec = m[2];
    const info = groupMap[vid] || { groupName: '?', verbName: vid };
    (arr||[]).forEach((s,i)=>{
      rows.push([info.groupName, info.verbName, data.sections[sec]||sec, i, s.tr||'', s.de||'']);
    });
  });
  const csv = rows.map(r=>r.map(c=>`"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob = new Blob([csv],{type:'text/csv;charset=utf-t;'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'sentences.csv'; a.click(); URL.revokeObjectURL(url); alert('CSV indirildi');
}

/* ---------- Uygulama GÃ¼ncelleme (DeÄŸiÅŸiklik yok) ---------- */
function forceUpdateApp() {
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.getRegistrations().then(registrations => {
            const unregisterPromises = registrations.map(reg => reg.unregister());
            const deleteCachePromises = window.caches ? caches.keys().then(keys => {
                return Promise.all(keys.map(key => caches.delete(key)));
            }) : Promise.resolve(); 

            Promise.all([].concat(unregisterPromises, [deleteCachePromises]))
                .then(() => {
                    alert('âœ… GÃ¼ncelleme tamamlandÄ±. Uygulama yeniden yÃ¼klenecek.');
                    window.location.reload(true);
                });
        }).catch(err => {
            alert('GÃ¼ncelleme hatasÄ±: ' + err.message);
            window.location.reload(true);
        });
    } else {
        window.location.reload(true);
    }
}
/* ---------- Utils (DeÄŸiÅŸiklik yok) ---------- */
function escapeHtml(t){ if(t===undefined||t===null) return ''; return String(t).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
function isObject(item) { return (item && typeof item === 'object' && !Array.isArray(item)); }
function deepMerge(target, source) {
  let output = Object.assign({}, target);
  if (isObject(target) && isObject(source)) {
    Object.keys(source).forEach(key => {
      if (isObject(source[key])) {
        if (!(key in target)) Object.assign(output, { [key]: source[key] });
        else output[key] = deepMerge(target[key], source[key]);
      } else {
        Object.assign(output, { [key]: source[key] });
      }
    });
  }
  return output;
}

/* ---------- YENÄ°: BaÅŸlatma (Init v3.0) ---------- */
async function init(){
  // 1. Service Worker'Ä± kaydet
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('service-worker.js').then(reg => {
      console.log('SW kaydÄ± baÅŸarÄ±lÄ±: ', reg.scope);
    }, err => {
      console.log('SW kaydÄ± baÅŸarÄ±sÄ±z: ', err);
    }); 
  }

  // 2. TTS motorunu uyandÄ±r
  if ('speechSynthesis' in window) {
    window.speechSynthesis.onvoiceschanged = () => console.log("TTS Sesleri yÃ¼klendi.");
    window.speechSynthesis.getVoices(); 
  }
  
  // 3. Olay dinleyicilerini ekle (MÃ¼zik Ã§alar hariÃ§, o kendi iÃ§inde yapÄ±yor)
  document.getElementById('modeToggleBtn').addEventListener('click', toggleNightMode);
  document.getElementById('nightModeToggle').addEventListener('change', toggleNightMode);
  document.getElementById('fileInput').onchange = importDataFromFile; // Dosyadan iÃ§erik yÃ¼kle

  // 4. MÃ¼zik Ã‡alarÄ± BaÅŸlat
  musicPlayer = new MusicPlayer(
      './telifsiz-klasik.mp3', 
      'musicVolumeSlider', 
      'musicToggleBtn',
      'settingsMusicVolume',
      'settingsMusicToggle'
  );
  
  // 5. AyarlarÄ± yÃ¼kle (Dil, Gece Modu vb.)
  loadSettings(); 
  
  // 6. YENÄ°: Sunucudan ana iÃ§eriÄŸi (data) Ã§ek
  await loadDataFromServer();
  
  // 7. YENÄ°: Yerel ilerlemeyi (srsData) yÃ¼kle
  loadSrsData();  
  
  // 8. UI'Ä± son kez gÃ¼ncelle
  updateConversionButtons();
  updateUITexts(); // Ã‡evirileri uygula
  updateProgressView(); // Ä°lerleme ekranÄ± statÃ¼lerini gÃ¼ncelle

  console.log('Verb Matrix v3.0 (Yeni AkÄ±ÅŸ) hazÄ±r.');
}

window.addEventListener('DOMContentLoaded', init);

</script>
</body>
</html>
